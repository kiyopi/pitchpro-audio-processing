<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue #1 è§£æ±ºç¢ºèª - çµ±åˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¢</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .info { border-left: 4px solid #2196F3; }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        button:hover { background: #45a049; }
        button:disabled { 
            background: #666; 
            cursor: not-allowed; 
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        .volume-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .volume-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #f44336);
            width: 0%;
            transition: width 0.1s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ Issue #1 è§£æ±ºç¢ºèªãƒ‡ãƒ¢</h1>
        <p>MicrophoneController + PitchDetectorçµ±åˆãŒæ­£å¸¸å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª</p>

        <div class="controls">
            <button id="initBtn">ğŸ¤ çµ±åˆåˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ</button>
            <button id="startBtn" disabled>â–¶ï¸ éŸ³ç¨‹æ¤œå‡ºé–‹å§‹</button>
            <button id="stopBtn" disabled>â¹ï¸ åœæ­¢</button>
        </div>

        <div id="status" class="status info">
            âœ… Issue #1 ä¿®æ­£æ¸ˆã¿: MicrophoneController.audioManagerãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸ
        </div>

        <div class="metrics">
            <div class="metric">
                <div>ğŸµ æ¤œå‡ºéŸ³ç¨‹</div>
                <div class="metric-value" id="noteDisplay">--</div>
            </div>
            <div class="metric">
                <div>ğŸ“Š å‘¨æ³¢æ•°</div>
                <div class="metric-value" id="freqDisplay">-- Hz</div>
            </div>
            <div class="metric">
                <div>âœ¨ ä¿¡é ¼åº¦</div>
                <div class="metric-value" id="clarityDisplay">--%</div>
            </div>
            <div class="metric">
                <div>ğŸ“± ãƒ‡ãƒã‚¤ã‚¹</div>
                <div class="metric-value" id="deviceDisplay">--</div>
            </div>
        </div>

        <div class="metric">
            <div>ğŸ”Š éŸ³é‡ãƒ¬ãƒ™ãƒ«</div>
            <div class="volume-bar">
                <div class="volume-fill" id="volumeFill"></div>
            </div>
            <div id="volumeDisplay">0%</div>
        </div>

        <div id="logs" class="status info">
            ğŸ“‹ ãƒ­ã‚°å‡ºåŠ›:
        </div>
    </div>

    <script type="module">
        // UMDãƒ“ãƒ«ãƒ‰ã‚’æƒ³å®š
        const { MicrophoneController, PitchDetector } = window.PitchPro || {};

        let micController = null;
        let pitchDetector = null;

        const elements = {
            initBtn: document.getElementById('initBtn'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            status: document.getElementById('status'),
            logs: document.getElementById('logs'),
            noteDisplay: document.getElementById('noteDisplay'),
            freqDisplay: document.getElementById('freqDisplay'),
            clarityDisplay: document.getElementById('clarityDisplay'),
            deviceDisplay: document.getElementById('deviceDisplay'),
            volumeFill: document.getElementById('volumeFill'),
            volumeDisplay: document.getElementById('volumeDisplay')
        };

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            elements.logs.innerHTML += `<br><span style="opacity:0.7">[${timestamp}]</span> ${message}`;
            elements.logs.scrollTop = elements.logs.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            elements.status.textContent = message;
            elements.status.className = `status ${type}`;
        }

        // Issue #1 è§£æ±ºç¢ºèª: çµ±åˆåˆæœŸåŒ–
        elements.initBtn.addEventListener('click', async () => {
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
            const initTimeout = setTimeout(() => {
                updateStatus('â° åˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ30ç§’ï¼‰', 'error');
                addLog('âŒ åˆæœŸåŒ–ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
            }, 30000);
            
            try {
                updateStatus('ğŸ”„ Issue #1 ä¿®æ­£ç‰ˆã§ã®çµ±åˆåˆæœŸåŒ–ä¸­...', 'info');
                addLog('ğŸš€ çµ±åˆåˆæœŸåŒ–é–‹å§‹');
                
                // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å­˜åœ¨ç¢ºèª
                if (!window.PitchPro || !window.PitchPro.MicrophoneController) {
                    throw new Error('PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚UMDãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }

                // Step 1: MicrophoneControlleråˆæœŸåŒ–
                addLog('ğŸ“± MicrophoneControlleråˆæœŸåŒ–ä¸­...');
                micController = new MicrophoneController();
                
                micController.setCallbacks({
                    onError: (error) => {
                        addLog(`âŒ MicrophoneController Error: ${error.message}`, 'error');
                    },
                    onStateChange: (state) => {
                        addLog(`ğŸ”„ MicrophoneControllerçŠ¶æ…‹: ${state}`);
                    },
                    onDeviceChange: (specs) => {
                        addLog(`ğŸ“± ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º: ${specs.deviceType}`);
                        elements.deviceDisplay.textContent = specs.deviceType;
                    }
                });

                await micController.initialize();
                addLog('âœ… MicrophoneControlleråˆæœŸåŒ–å®Œäº†');

                // Step 2: Issue #1ä¿®æ­£ç¢ºèª - audioManagerã‚¢ã‚¯ã‚»ã‚¹
                addLog('ğŸ” Issue #1ä¿®æ­£ç¢ºèª: audioManagerã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ');
                if (micController.audioManager) {
                    addLog('âœ… micController.audioManagerã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ!');
                    
                    // ãƒ‡ãƒã‚¤ã‚¹ä»•æ§˜å–å¾—ãƒ†ã‚¹ãƒˆ
                    const deviceSpecs = micController.getDeviceSpecs();
                    addLog(`ğŸ“Š ãƒ‡ãƒã‚¤ã‚¹ä»•æ§˜: ${JSON.stringify(deviceSpecs)}`);
                    
                } else {
                    throw new Error('audioManagerã‚¢ã‚¯ã‚»ã‚¹å¤±æ•— - Issue #1æœªè§£æ±º');
                }

                // Step 3: PitchDetectorçµ±åˆãƒ†ã‚¹ãƒˆ
                addLog('ğŸµ PitchDetectorçµ±åˆåˆæœŸåŒ–ä¸­...');
                pitchDetector = new PitchDetector(micController.audioManager);

                pitchDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        if (result.frequency > 0) {
                            elements.noteDisplay.textContent = `${result.note}${result.octave || ''}`;
                            elements.freqDisplay.textContent = `${result.frequency.toFixed(1)} Hz`;
                            elements.clarityDisplay.textContent = `${(result.clarity * 100).toFixed(0)}%`;
                        } else {
                            elements.noteDisplay.textContent = '--';
                            elements.freqDisplay.textContent = '-- Hz';
                            elements.clarityDisplay.textContent = '--%';
                        }
                        
                        // éŸ³é‡ãƒãƒ¼æ›´æ–°
                        const volume = Math.min(100, Math.max(0, result.volume));
                        elements.volumeFill.style.width = `${volume}%`;
                        elements.volumeDisplay.textContent = `${volume.toFixed(1)}%`;
                    },
                    onError: (error) => {
                        addLog(`âŒ PitchDetector Error: ${error.message}`, 'error');
                    }
                });

                await pitchDetector.initialize();
                addLog('âœ… PitchDetectorçµ±åˆåˆæœŸåŒ–å®Œäº†');

                // æˆåŠŸ - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
                clearTimeout(initTimeout);
                updateStatus('âœ… Issue #1 è§£æ±ºç¢ºèªå®Œäº† - çµ±åˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹æ­£å¸¸å‹•ä½œ!', 'success');
                elements.initBtn.disabled = true;
                elements.startBtn.disabled = false;

            } catch (error) {
                clearTimeout(initTimeout);
                console.error('Integration Error:', error);
                
                // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’æä¾›
                let errorMessage = error.message || 'Unknown error';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'ãƒã‚¤ã‚¯ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else if (error.message.includes('AudioContext')) {
                    errorMessage = 'AudioContextã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å†èµ·å‹•ã—ã¦ã¿ã¦ãã ã•ã„ã€‚';
                }
                
                updateStatus(`âŒ çµ±åˆã‚¨ãƒ©ãƒ¼: ${errorMessage}`, 'error');
                addLog(`ğŸ’¥ çµ±åˆå¤±æ•—: ${errorMessage}`, 'error');
                
                // ã‚¨ãƒ©ãƒ¼å¾©æ—§ã®ææ¡ˆ
                if (error.name === 'NotAllowedError') {
                    addLog('ğŸ’¡ è§£æ±ºæ–¹æ³•: ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å·¦å´ã®ğŸ”’ãƒãƒ¼ã‚¯ã‹ã‚‰ã€Œãƒã‚¤ã‚¯ã€ã‚’ã€Œè¨±å¯ã€ã«è¨­å®šã—ã¦ãã ã•ã„', 'info');
                }
            }
        });

        // éŸ³ç¨‹æ¤œå‡ºé–‹å§‹
        elements.startBtn.addEventListener('click', () => {
            if (pitchDetector) {
                pitchDetector.startDetection();
                updateStatus('ğŸµ éŸ³ç¨‹æ¤œå‡ºå®Ÿè¡Œä¸­ - Issue #1ä¿®æ­£ç‰ˆã§æ­£å¸¸å‹•ä½œ', 'success');
                addLog('â–¶ï¸ éŸ³ç¨‹æ¤œå‡ºé–‹å§‹');
                elements.startBtn.disabled = true;
                elements.stopBtn.disabled = false;
            }
        });

        // åœæ­¢
        elements.stopBtn.addEventListener('click', () => {
            if (pitchDetector) {
                pitchDetector.stopDetection();
                updateStatus('â¹ï¸ éŸ³ç¨‹æ¤œå‡ºåœæ­¢', 'info');
                addLog('â¹ï¸ éŸ³ç¨‹æ¤œå‡ºåœæ­¢');
                elements.startBtn.disabled = false;
                elements.stopBtn.disabled = true;
                
                // è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
                elements.noteDisplay.textContent = '--';
                elements.freqDisplay.textContent = '-- Hz';
                elements.clarityDisplay.textContent = '--%';
                elements.volumeFill.style.width = '0%';
                elements.volumeDisplay.textContent = '0%';
            }
        });

        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        addLog('ğŸ¯ Issue #1è§£æ±ºãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†');
        addLog('ğŸ“ ä¿®æ­£å†…å®¹: MicrophoneController.audioManagerã‚’ public readonly ã«å¤‰æ›´');
        addLog('âœ… çµ±åˆåˆæœŸåŒ–ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‹•ä½œç¢ºèªã—ã¦ãã ã•ã„');
    </script>
</body>
</html>