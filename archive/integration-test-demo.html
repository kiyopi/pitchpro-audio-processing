<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue #1 解決確認 - 統合テストデモ</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .info { border-left: 4px solid #2196F3; }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        button:hover { background: #45a049; }
        button:disabled { 
            background: #666; 
            cursor: not-allowed; 
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        .volume-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .volume-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #f44336);
            width: 0%;
            transition: width 0.1s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 Issue #1 解決確認デモ</h1>
        <p>MicrophoneController + PitchDetector統合が正常動作することを確認</p>

        <div class="controls">
            <button id="initBtn">🎤 統合初期化テスト</button>
            <button id="startBtn" disabled>▶️ 音程検出開始</button>
            <button id="stopBtn" disabled>⏹️ 停止</button>
        </div>

        <div id="status" class="status info">
            ✅ Issue #1 修正済み: MicrophoneController.audioManagerが公開されました
        </div>

        <div class="metrics">
            <div class="metric">
                <div>🎵 検出音程</div>
                <div class="metric-value" id="noteDisplay">--</div>
            </div>
            <div class="metric">
                <div>📊 周波数</div>
                <div class="metric-value" id="freqDisplay">-- Hz</div>
            </div>
            <div class="metric">
                <div>✨ 信頼度</div>
                <div class="metric-value" id="clarityDisplay">--%</div>
            </div>
            <div class="metric">
                <div>📱 デバイス</div>
                <div class="metric-value" id="deviceDisplay">--</div>
            </div>
        </div>

        <div class="metric">
            <div>🔊 音量レベル</div>
            <div class="volume-bar">
                <div class="volume-fill" id="volumeFill"></div>
            </div>
            <div id="volumeDisplay">0%</div>
        </div>

        <div id="logs" class="status info">
            📋 ログ出力:
        </div>
    </div>

    <script type="module">
        // UMDビルドを想定
        const { MicrophoneController, PitchDetector } = window.PitchPro || {};

        let micController = null;
        let pitchDetector = null;

        const elements = {
            initBtn: document.getElementById('initBtn'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            status: document.getElementById('status'),
            logs: document.getElementById('logs'),
            noteDisplay: document.getElementById('noteDisplay'),
            freqDisplay: document.getElementById('freqDisplay'),
            clarityDisplay: document.getElementById('clarityDisplay'),
            deviceDisplay: document.getElementById('deviceDisplay'),
            volumeFill: document.getElementById('volumeFill'),
            volumeDisplay: document.getElementById('volumeDisplay')
        };

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            elements.logs.innerHTML += `<br><span style="opacity:0.7">[${timestamp}]</span> ${message}`;
            elements.logs.scrollTop = elements.logs.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            elements.status.textContent = message;
            elements.status.className = `status ${type}`;
        }

        // Issue #1 解決確認: 統合初期化
        elements.initBtn.addEventListener('click', async () => {
            // タイムアウト処理
            const initTimeout = setTimeout(() => {
                updateStatus('⏰ 初期化タイムアウト（30秒）', 'error');
                addLog('❌ 初期化がタイムアウトしました。ページを再読み込みしてください。', 'error');
            }, 30000);
            
            try {
                updateStatus('🔄 Issue #1 修正版での統合初期化中...', 'info');
                addLog('🚀 統合初期化開始');
                
                // ライブラリの存在確認
                if (!window.PitchPro || !window.PitchPro.MicrophoneController) {
                    throw new Error('PitchProライブラリが読み込まれていません。UMDビルドファイルを確認してください。');
                }

                // Step 1: MicrophoneController初期化
                addLog('📱 MicrophoneController初期化中...');
                micController = new MicrophoneController();
                
                micController.setCallbacks({
                    onError: (error) => {
                        addLog(`❌ MicrophoneController Error: ${error.message}`, 'error');
                    },
                    onStateChange: (state) => {
                        addLog(`🔄 MicrophoneController状態: ${state}`);
                    },
                    onDeviceChange: (specs) => {
                        addLog(`📱 デバイス検出: ${specs.deviceType}`);
                        elements.deviceDisplay.textContent = specs.deviceType;
                    }
                });

                await micController.initialize();
                addLog('✅ MicrophoneController初期化完了');

                // Step 2: Issue #1修正確認 - audioManagerアクセス
                addLog('🔍 Issue #1修正確認: audioManagerアクセステスト');
                if (micController.audioManager) {
                    addLog('✅ micController.audioManagerアクセス成功!');
                    
                    // デバイス仕様取得テスト
                    const deviceSpecs = micController.getDeviceSpecs();
                    addLog(`📊 デバイス仕様: ${JSON.stringify(deviceSpecs)}`);
                    
                } else {
                    throw new Error('audioManagerアクセス失敗 - Issue #1未解決');
                }

                // Step 3: PitchDetector統合テスト
                addLog('🎵 PitchDetector統合初期化中...');
                pitchDetector = new PitchDetector(micController.audioManager);

                pitchDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        if (result.frequency > 0) {
                            elements.noteDisplay.textContent = `${result.note}${result.octave || ''}`;
                            elements.freqDisplay.textContent = `${result.frequency.toFixed(1)} Hz`;
                            elements.clarityDisplay.textContent = `${(result.clarity * 100).toFixed(0)}%`;
                        } else {
                            elements.noteDisplay.textContent = '--';
                            elements.freqDisplay.textContent = '-- Hz';
                            elements.clarityDisplay.textContent = '--%';
                        }
                        
                        // 音量バー更新
                        const volume = Math.min(100, Math.max(0, result.volume));
                        elements.volumeFill.style.width = `${volume}%`;
                        elements.volumeDisplay.textContent = `${volume.toFixed(1)}%`;
                    },
                    onError: (error) => {
                        addLog(`❌ PitchDetector Error: ${error.message}`, 'error');
                    }
                });

                await pitchDetector.initialize();
                addLog('✅ PitchDetector統合初期化完了');

                // 成功 - タイムアウトをクリア
                clearTimeout(initTimeout);
                updateStatus('✅ Issue #1 解決確認完了 - 統合インターフェース正常動作!', 'success');
                elements.initBtn.disabled = true;
                elements.startBtn.disabled = false;

            } catch (error) {
                clearTimeout(initTimeout);
                console.error('Integration Error:', error);
                
                // より詳細なエラー情報を提供
                let errorMessage = error.message || 'Unknown error';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'マイクアクセスが拒否されました。ブラウザの設定を確認してください。';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'マイクデバイスが見つかりません。接続を確認してください。';
                } else if (error.message.includes('AudioContext')) {
                    errorMessage = 'AudioContextの初期化に失敗しました。ブラウザを再起動してみてください。';
                }
                
                updateStatus(`❌ 統合エラー: ${errorMessage}`, 'error');
                addLog(`💥 統合失敗: ${errorMessage}`, 'error');
                
                // エラー復旧の提案
                if (error.name === 'NotAllowedError') {
                    addLog('💡 解決方法: ブラウザのアドレスバー左側の🔒マークから「マイク」を「許可」に設定してください', 'info');
                }
            }
        });

        // 音程検出開始
        elements.startBtn.addEventListener('click', () => {
            if (pitchDetector) {
                pitchDetector.startDetection();
                updateStatus('🎵 音程検出実行中 - Issue #1修正版で正常動作', 'success');
                addLog('▶️ 音程検出開始');
                elements.startBtn.disabled = true;
                elements.stopBtn.disabled = false;
            }
        });

        // 停止
        elements.stopBtn.addEventListener('click', () => {
            if (pitchDetector) {
                pitchDetector.stopDetection();
                updateStatus('⏹️ 音程検出停止', 'info');
                addLog('⏹️ 音程検出停止');
                elements.startBtn.disabled = false;
                elements.stopBtn.disabled = true;
                
                // 表示リセット
                elements.noteDisplay.textContent = '--';
                elements.freqDisplay.textContent = '-- Hz';
                elements.clarityDisplay.textContent = '--%';
                elements.volumeFill.style.width = '0%';
                elements.volumeDisplay.textContent = '0%';
            }
        });

        // 初期メッセージ
        addLog('🎯 Issue #1解決テスト準備完了');
        addLog('📝 修正内容: MicrophoneController.audioManagerを public readonly に変更');
        addLog('✅ 統合初期化ボタンをクリックして動作確認してください');
    </script>
</body>
</html>