<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioDetectionComponent updateSelectors() ãƒ‡ãƒ¢</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #0d1117;
            color: #c9d1d9;
        }
        .container {
            background: #161b22;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #58a6ff;
            margin-bottom: 30px;
        }
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .mode-btn {
            padding: 10px 20px;
            background: #238636;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .mode-btn:hover {
            background: #2ea043;
        }
        .mode-btn.active {
            background: #1f6feb;
        }
        .mode-btn:disabled {
            background: #484f58;
            cursor: not-allowed;
        }
        .ui-section {
            margin: 20px 0;
            padding: 20px;
            background: #21262d;
            border-radius: 8px;
            border-left: 4px solid #f85149;
        }
        .ui-section.active {
            border-left-color: #3fb950;
            background: #0d2818;
        }
        .ui-section h3 {
            margin: 0 0 15px 0;
            color: #f0f6fc;
        }
        .meter-group {
            margin: 10px 0;
        }
        .meter-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #21262d;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3fb950 0%, #f85149 100%);
            width: 0%;
            transition: width 0.1s ease;
        }
        .frequency-display {
            font-size: 18px;
            font-weight: bold;
            color: #58a6ff;
            text-align: center;
            padding: 10px;
            background: #0d1117;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
            font-weight: 500;
        }
        .status.ready { 
            background: #033a16; 
            color: #3fb950; 
            border: 1px solid #238636;
        }
        .status.active { 
            background: #0c2d48; 
            color: #58a6ff; 
            border: 1px solid #1f6feb;
        }
        .status.error { 
            background: #490202; 
            color: #f85149; 
            border: 1px solid #da3633;
        }
        .log {
            background: #0d1117;
            color: #7d8590;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ updateSelectors() ãƒ‡ãƒ¢</h1>
        
        <div class="status" id="status">åˆæœŸåŒ–å‰...</div>
        
        <div class="mode-selector">
            <button class="mode-btn" id="initBtn">ğŸ¤ åˆæœŸåŒ–</button>
            <button class="mode-btn" id="startBtn" disabled>â–¶ï¸ é–‹å§‹</button>
            <button class="mode-btn" id="stopBtn" disabled>â¹ åœæ­¢</button>
            <button class="mode-btn" id="micModeBtn" disabled>ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</button>
            <button class="mode-btn" id="rangeModeBtn" disabled>éŸ³åŸŸãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</button>
            <button class="mode-btn" id="practiceModeBtn" disabled>ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</button>
        </div>

        <!-- ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®UI -->
        <div class="ui-section" id="mic-mode">
            <h3>ğŸ¤ ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</h3>
            <div class="meter-group">
                <div class="meter-label">
                    <span>éŸ³é‡ãƒ¬ãƒ™ãƒ«</span>
                    <span id="mic-volume-text">0.0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="mic-volume-bar"></div>
                </div>
            </div>
            <div class="frequency-display" id="mic-frequency">0.0 Hz</div>
        </div>

        <!-- éŸ³åŸŸãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®UI -->
        <div class="ui-section" id="range-mode">
            <h3>ğŸµ éŸ³åŸŸãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</h3>
            <div class="meter-group">
                <div class="meter-label">
                    <span>æ¤œå‡ºéŸ³é‡</span>
                    <span id="range-volume-text">0.0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="range-volume-bar"></div>
                </div>
            </div>
            <div class="frequency-display" id="range-frequency-value">0.0 Hz</div>
        </div>

        <!-- ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã®UI -->
        <div class="ui-section" id="practice-mode">
            <h3>ğŸ¶ ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</h3>
            <div class="meter-group">
                <div class="meter-label">
                    <span>ç·´ç¿’éŸ³é‡</span>
                    <span id="practice-volume-text">0.0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="practice-volume-bar"></div>
                </div>
            </div>
            <div class="frequency-display" id="practice-frequency">0.0 Hz</div>
            <div class="frequency-display" id="practice-note">-</div>
        </div>

        <div class="log" id="log">ãƒ­ã‚°å¾…æ©Ÿä¸­...</div>
    </div>

    <script type="module">
        import { AudioDetectionComponent } from './dist/index.esm.js';
        
        let audioDetector = null;
        let currentMode = 'mic';
        let logLines = [];
        
        const elements = {
            status: document.getElementById('status'),
            initBtn: document.getElementById('initBtn'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            micModeBtn: document.getElementById('micModeBtn'),
            rangeModeBtn: document.getElementById('rangeModeBtn'),
            practiceModeBtn: document.getElementById('practiceModeBtn'),
            log: document.getElementById('log'),
            
            micMode: document.getElementById('mic-mode'),
            rangeMode: document.getElementById('range-mode'),
            practiceMode: document.getElementById('practice-mode')
        };
        
        function updateStatus(message, type = 'ready') {
            elements.status.textContent = message;
            elements.status.className = `status ${type}`;
        }
        
        function addLog(message) {
            const time = new Date().toLocaleTimeString('ja-JP');
            logLines.push(`[${time}] ${message}`);
            if (logLines.length > 50) logLines.shift();
            elements.log.textContent = logLines.join('\n');
            elements.log.scrollTop = elements.log.scrollHeight;
        }
        
        function updateModeUI(mode) {
            // ã™ã¹ã¦ã®UIã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            Object.values(elements).forEach(el => {
                if (el && el.classList && el.classList.contains('ui-section')) {
                    el.classList.remove('active');
                }
            });
            
            // UIè¦ç´ ã®ãƒªã‚»ãƒƒãƒˆã¯PitchProã®updateSelectors()ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚å‰Šé™¤
            
            // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            if (mode === 'mic') {
                elements.micMode.classList.add('active');
                elements.micModeBtn.classList.add('active');
            } else if (mode === 'range') {
                elements.rangeMode.classList.add('active');
                elements.rangeModeBtn.classList.add('active');
            } else if (mode === 'practice') {
                elements.practiceMode.classList.add('active');
                elements.practiceModeBtn.classList.add('active');
            }
            
            currentMode = mode;
        }
        
        // åˆæœŸåŒ–
        elements.initBtn.addEventListener('click', async () => {
            try {
                updateStatus('åˆæœŸåŒ–ä¸­...', 'ready');
                addLog('AudioDetectionComponentåˆæœŸåŒ–é–‹å§‹');
                
                audioDetector = new AudioDetectionComponent({
                    volumeBarSelector: '#mic-volume-bar',
                    volumeTextSelector: '#mic-volume-text',
                    frequencySelector: '#mic-frequency',
                    clarityThreshold: 0.3,
                    minVolumeAbsolute: 0.002,
                    debug: true
                });
                
                audioDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        if (result.frequency > 0) {
                            addLog(`ğŸµ ${result.frequency.toFixed(1)}Hz, éŸ³é‡: ${result.volume.toFixed(1)}%`);
                        }
                    },
                    onError: (error) => {
                        addLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                        updateStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    },
                    onStateChange: (state) => {
                        addLog(`ğŸ”„ çŠ¶æ…‹å¤‰æ›´: ${state}`);
                    }
                });
                
                await audioDetector.initialize();
                
                // updateSelectors ãƒ¡ã‚½ãƒƒãƒ‰ã®å­˜åœ¨ç¢ºèª
                if (typeof audioDetector.updateSelectors === 'function') {
                    addLog('âœ… updateSelectors ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèªæ¸ˆã¿');
                } else {
                    addLog(`âŒ updateSelectors ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å‹: ${typeof audioDetector.updateSelectors}`);
                    addLog(`åˆ©ç”¨å¯èƒ½ãªãƒ¡ã‚½ãƒƒãƒ‰: ${Object.getOwnPropertyNames(Object.getPrototypeOf(audioDetector)).filter(name => typeof audioDetector[name] === 'function').join(', ')}`);
                }
                
                updateStatus('åˆæœŸåŒ–å®Œäº† - é–‹å§‹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯', 'ready');
                addLog('âœ… åˆæœŸåŒ–å®Œäº†');
                
                elements.initBtn.disabled = true;
                elements.startBtn.disabled = false;
                elements.micModeBtn.disabled = false;
                elements.rangeModeBtn.disabled = false;
                elements.practiceModeBtn.disabled = false;
                
                updateModeUI('mic'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒã‚¤ã‚¯ãƒ¢ãƒ¼ãƒ‰
                
            } catch (error) {
                addLog(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                updateStatus(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        });
        
        // é–‹å§‹
        elements.startBtn.addEventListener('click', () => {
            if (audioDetector) {
                const started = audioDetector.startDetection();
                if (started) {
                    updateStatus('ğŸ¤ æ¤œå‡ºä¸­...', 'active');
                    elements.startBtn.disabled = true;
                    elements.stopBtn.disabled = false;
                    addLog('ğŸ¤ éŸ³å£°æ¤œå‡ºé–‹å§‹');
                } else {
                    addLog('âŒ æ¤œå‡ºé–‹å§‹ã«å¤±æ•—');
                }
            }
        });
        
        // åœæ­¢
        elements.stopBtn.addEventListener('click', () => {
            if (audioDetector) {
                audioDetector.stopDetection();
                updateStatus('åœæ­¢', 'ready');
                elements.startBtn.disabled = false;
                elements.stopBtn.disabled = true;
                addLog('â¹ éŸ³å£°æ¤œå‡ºåœæ­¢');
            }
        });
        
        // ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰
        elements.micModeBtn.addEventListener('click', () => {
            if (audioDetector) {
                addLog(`ğŸ” updateSelectors ãƒ¡ã‚½ãƒƒãƒ‰å‹: ${typeof audioDetector.updateSelectors}`);
                if (typeof audioDetector.updateSelectors === 'function') {
                    addLog('ğŸ”„ ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®updateSelectorså®Ÿè¡Œä¸­...');
                    try {
                        audioDetector.updateSelectors({
                    volumeBarSelector: '#mic-volume-bar',
                    volumeTextSelector: '#mic-volume-text',
                    frequencySelector: '#mic-frequency'
                        });
                        addLog('âœ… ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ updateSelectors æˆåŠŸ');
                        updateModeUI('mic');
                        addLog('ğŸ”„ ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
                        addLog('ğŸ“Š ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ›´æ–°: #mic-volume-bar, #mic-volume-text, #mic-frequency');
                    } catch (error) {
                        addLog(`âŒ ãƒã‚¤ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                        console.error('Mic mode error:', error);
                    }
                } else {
                    addLog(`âŒ updateSelectors ãƒ¡ã‚½ãƒƒãƒ‰ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ (å‹: ${typeof audioDetector.updateSelectors})`);
                }
            } else {
                addLog('âŒ audioDetector ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        });
        
        // éŸ³åŸŸãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰
        elements.rangeModeBtn.addEventListener('click', () => {
            if (audioDetector) {
                addLog(`ğŸ” éŸ³åŸŸãƒ¢ãƒ¼ãƒ‰ - updateSelectors ãƒ¡ã‚½ãƒƒãƒ‰å‹: ${typeof audioDetector.updateSelectors}`);
                if (typeof audioDetector.updateSelectors === 'function') {
                    try {
                        audioDetector.updateSelectors({
                            volumeBarSelector: '#range-volume-bar',
                            volumeTextSelector: '#range-volume-text',
                            frequencySelector: '#range-frequency-value'
                        });
                        addLog('âœ… éŸ³åŸŸãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ updateSelectors æˆåŠŸ');
                        updateModeUI('range');
                        addLog('ğŸ”„ éŸ³åŸŸãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
                        addLog('ğŸ“Š ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ›´æ–°: #range-volume-bar, #range-volume-text, #range-frequency-value');
                    } catch (error) {
                        addLog(`âŒ éŸ³åŸŸãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                        console.error('Range mode error:', error);
                    }
                } else {
                    addLog(`âŒ updateSelectors ãƒ¡ã‚½ãƒƒãƒ‰ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ (å‹: ${typeof audioDetector.updateSelectors})`);
                }
            } else {
                addLog('âŒ audioDetector ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        });
        
        // ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰
        elements.practiceModeBtn.addEventListener('click', () => {
            if (audioDetector) {
                addLog(`ğŸ” ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ - updateSelectors ãƒ¡ã‚½ãƒƒãƒ‰å‹: ${typeof audioDetector.updateSelectors}`);
                if (typeof audioDetector.updateSelectors === 'function') {
                    try {
                        audioDetector.updateSelectors({
                            volumeBarSelector: '#practice-volume-bar',
                            volumeTextSelector: '#practice-volume-text',
                            frequencySelector: '#practice-frequency',
                            noteSelector: '#practice-note'
                        });
                        addLog('âœ… ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ updateSelectors æˆåŠŸ');
                        updateModeUI('practice');
                        addLog('ğŸ”„ ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
                        addLog('ğŸ“Š ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ›´æ–°: #practice-volume-bar, #practice-volume-text, #practice-frequency, #practice-note');
                    } catch (error) {
                        addLog(`âŒ ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                        console.error('Practice mode error:', error);
                    }
                } else {
                    addLog(`âŒ updateSelectors ãƒ¡ã‚½ãƒƒãƒ‰ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ (å‹: ${typeof audioDetector.updateSelectors})`);
                }
            } else {
                addLog('âŒ audioDetector ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
        });
        
        // åˆæœŸãƒ­ã‚°
        addLog('AudioDetectionComponent updateSelectors() ãƒ‡ãƒ¢æº–å‚™å®Œäº†');
        addLog('æ‰‹é †: 1) åˆæœŸåŒ– â†’ 2) é–‹å§‹ â†’ 3) ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ');
        
        updateModeUI('mic');
    </script>
</body>
</html>