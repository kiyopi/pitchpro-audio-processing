<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚²ã‚¤ãƒ³æ¤œè¨¼ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .result { margin: 10px 0; padding: 10px; background: #333; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>ğŸ” ã‚²ã‚¤ãƒ³æ¤œè¨¼ãƒ†ã‚¹ãƒˆ</h1>
    <p>ã“ã®ãƒ†ã‚¹ãƒˆã§ã€GainNodeã®å¢—å¹…ãŒAnalyserNodeã®éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã«å®Ÿéš›ã«åæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚</p>
    
    <button id="startTest">ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
    <button id="setGain1" disabled>ã‚²ã‚¤ãƒ³ 1.0x</button>
    <button id="setGain2" disabled>ã‚²ã‚¤ãƒ³ 2.0x</button>
    <button id="setGain5" disabled>ã‚²ã‚¤ãƒ³ 5.0x</button>
    
    <div id="results"></div>

    <script type="module">
        import { AudioManager } from './dist/index.esm.js';
        
        let audioManager = null;
        let analyser = null;
        let isMonitoring = false;
        
        const resultsDiv = document.getElementById('results');
        
        function addResult(message) {
            const div = document.createElement('div');
            div.className = 'result';
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            resultsDiv.appendChild(div);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        function measureRMS() {
            if (!analyser || !isMonitoring) return;
            
            const bufferLength = analyser.fftSize;
            const buffer = new Float32Array(bufferLength);
            analyser.getFloatTimeDomainData(buffer);
            
            // RMSè¨ˆç®—
            let sum = 0;
            for (let i = 0; i < bufferLength; i++) {
                sum += buffer[i] * buffer[i];
            }
            const rms = Math.sqrt(sum / bufferLength);
            
            // æœ€å¤§ã‚µãƒ³ãƒ—ãƒ«å€¤
            const maxSample = Math.max(...buffer.map(v => Math.abs(v)));
            
            const currentGain = audioManager.getSensitivity();
            
            // PitchDetectorã®éŸ³é‡è¨ˆç®—ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
            const platformSpecs = {
                gainCompensation: 1.0,  // PC default
                divisor: 6.0,           // PC default  
                noiseThreshold: 0.5     // PC fixed value
            };
            
            const adjustedRms = rms * platformSpecs.gainCompensation;
            const volumePercent = Math.max(0, Math.min(100, 
                (adjustedRms * 100) / platformSpecs.divisor * 67 - platformSpecs.noiseThreshold
            ));
            
            // Math.minåˆ¶é™ã‚’å¤–ã—ãŸè¨ˆç®—
            const volumePercentUnlimited = Math.max(0, 
                (adjustedRms * 100) / platformSpecs.divisor * 67 - platformSpecs.noiseThreshold
            );
            
            addResult(`ğŸšï¸ ã‚²ã‚¤ãƒ³: ${currentGain.toFixed(1)}x | RMS: ${rms.toFixed(6)} | éŸ³é‡: ${volumePercent.toFixed(1)}% | åˆ¶é™ãªã—: ${volumePercentUnlimited.toFixed(1)}%`);
            
            setTimeout(measureRMS, 500); // 0.5ç§’é–“éš”ã§æ¸¬å®š
        }
        
        document.getElementById('startTest').addEventListener('click', async () => {
            try {
                addResult('ğŸ¤ AudioManageråˆæœŸåŒ–ä¸­...');
                
                audioManager = new AudioManager({
                    sampleRate: 44100,
                    channelCount: 1,
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false
                });
                
                await audioManager.initialize();
                
                analyser = audioManager.createAnalyser('gain-test', {
                    fftSize: 2048,
                    smoothingTimeConstant: 0.8,
                    useFilters: false // ç›´æ¥æ¥ç¶šã§ãƒ†ã‚¹ãƒˆ
                });
                
                addResult('âœ… åˆæœŸåŒ–å®Œäº† - ãƒã‚¤ã‚¯ã«å‘ã‹ã£ã¦éŸ³ã‚’å‡ºã—ã¦ãã ã•ã„');
                
                document.getElementById('startTest').disabled = true;
                document.getElementById('setGain1').disabled = false;
                document.getElementById('setGain2').disabled = false;
                document.getElementById('setGain5').disabled = false;
                
                isMonitoring = true;
                measureRMS();
                
            } catch (error) {
                addResult(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        });
        
        document.getElementById('setGain1').addEventListener('click', () => {
            audioManager.setSensitivity(1.0);
            addResult('ğŸ”§ ã‚²ã‚¤ãƒ³ 1.0x ã«è¨­å®š');
        });
        
        document.getElementById('setGain2').addEventListener('click', () => {
            audioManager.setSensitivity(2.0);
            addResult('ğŸ”§ ã‚²ã‚¤ãƒ³ 2.0x ã«è¨­å®š');
        });
        
        document.getElementById('setGain5').addEventListener('click', () => {
            audioManager.setSensitivity(5.0);
            addResult('ğŸ”§ ã‚²ã‚¤ãƒ³ 5.0x ã«è¨­å®š');
        });
    </script>
</body>
</html>