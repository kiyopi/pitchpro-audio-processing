name: Demo Pages Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  demo-validation:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build project
      run: npm run build
      
    - name: Verify build outputs
      run: |
        echo "Checking build outputs..."
        ls -la dist/
        
        # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        test -f dist/index.js || (echo "âŒ CJS build missing" && exit 1)
        test -f dist/index.esm.js || (echo "âŒ ESM build missing" && exit 1) 
        test -f dist/pitchpro.umd.js || (echo "âŒ UMD build missing" && exit 1)
        test -f dist/index.d.ts || (echo "âŒ Type definitions missing" && exit 1)
        
        # å¾Œæ–¹äº’æ›æ€§ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã®ç¢ºèª
        test -L dist/pitchpro.esm.js || (echo "âš ï¸ Legacy ESM symlink missing" && exit 0)
        test -L dist/pitchpro.cjs.js || (echo "âš ï¸ Legacy CJS symlink missing" && exit 0)
        
        echo "âœ… All build outputs verified"
        
    - name: Run import path tests
      run: npm run test:imports
      
    - name: Run full test suite
      run: npm test -- --run
      
    - name: Install playwright for demo testing
      run: npx playwright install --with-deps chromium
      
    - name: Create demo validation script
      run: |
        cat > validate-demos.js << 'EOF'
        const { chromium } = require('playwright');
        const fs = require('fs');
        const path = require('path');

        async function validateDemo(page, filePath, testName) {
          console.log(`ðŸ” Testing ${testName}...`);
          
          const fullPath = `file://${path.resolve(filePath)}`;
          
          try {
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
            const errors = [];
            page.on('console', msg => {
              if (msg.type() === 'error') {
                errors.push(msg.text());
              }
            });
            
            // ãƒšãƒ¼ã‚¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£  
            const networkErrors = [];
            page.on('response', response => {
              if (!response.ok() && response.url().includes('.js')) {
                networkErrors.push(`${response.status()}: ${response.url()}`);
              }
            });
            
            await page.goto(fullPath, { waitUntil: 'networkidle' });
            
            // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã®ç¢ºèª
            const title = await page.title();
            console.log(`  ðŸ“„ Title: ${title}`);
            
            // å¿…é ˆè¦ç´ ã®å­˜åœ¨ç¢ºèª
            const hasContent = await page.locator('body').isVisible();
            if (!hasContent) {
              throw new Error('Page body not visible');
            }
            
            // JavaScriptã‚¨ãƒ©ãƒ¼ã®ãƒã‚§ãƒƒã‚¯
            if (errors.length > 0) {
              console.log(`  âš ï¸ Console errors: ${errors.length}`);
              errors.forEach(err => console.log(`    - ${err}`));
            }
            
            // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®ãƒã‚§ãƒƒã‚¯  
            if (networkErrors.length > 0) {
              console.log(`  âŒ Network errors: ${networkErrors.length}`);
              networkErrors.forEach(err => console.log(`    - ${err}`));
              throw new Error(`Network errors detected: ${networkErrors.join(', ')}`);
            }
            
            console.log(`  âœ… ${testName} validation passed`);
            return true;
            
          } catch (error) {
            console.log(`  âŒ ${testName} validation failed: ${error.message}`);
            return false;
          }
        }

        async function main() {
          const browser = await chromium.launch();
          const page = await browser.newPage();
          
          const demos = [
            ['integration-test-demo.html', 'Integration Test Demo'],
            ['demos/test-imports.html', 'Import Test Demo'],
            ['demos/silence-detection-test.html', 'Silence Detection Demo'],
            ['demos/quick-test.html', 'Quick Test Demo']
          ];
          
          let passed = 0;
          let failed = 0;
          
          for (const [file, name] of demos) {
            if (fs.existsSync(file)) {
              const success = await validateDemo(page, file, name);
              success ? passed++ : failed++;
            } else {
              console.log(`âš ï¸ Demo file not found: ${file}`);
            }
          }
          
          await browser.close();
          
          console.log(`\nðŸ“Š Demo Validation Results:`);
          console.log(`  âœ… Passed: ${passed}`);
          console.log(`  âŒ Failed: ${failed}`);
          
          if (failed > 0) {
            process.exit(1);
          }
        }

        main().catch(console.error);
        EOF
        
    - name: Run demo validation
      run: |
        npm install playwright
        node validate-demos.js
        
    - name: Check package.json consistency
      run: |
        echo "Verifying package.json exports..."
        node -e "
          const pkg = require('./package.json');
          const fs = require('fs');
          
          // main, module, types ã®ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª
          const files = [pkg.main, pkg.module, pkg.types];
          let allExist = true;
          
          files.forEach(file => {
            if (!fs.existsSync(file)) {
              console.log(\`âŒ Missing: \${file}\`);
              allExist = false;
            } else {
              console.log(\`âœ… Found: \${file}\`);
            }
          });
          
          if (!allExist) {
            process.exit(1);
          }
          
          console.log('âœ… Package.json exports validation passed');
        "
        
    - name: Performance benchmark
      run: |
        # åŸºæœ¬çš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        npm run test:performance
        
        # ãƒ“ãƒ«ãƒ‰ã‚µã‚¤ã‚ºã®ãƒã‚§ãƒƒã‚¯
        echo "ðŸ“ Build size analysis:"
        ls -lh dist/ | grep -E '\.(js|d\.ts)$'
        
        # gzipåœ§ç¸®å¾Œã®ã‚µã‚¤ã‚º
        gzip -c dist/index.esm.js | wc -c | xargs echo "ESM gzipped:"
        gzip -c dist/index.js | wc -c | xargs echo "CJS gzipped:"
        gzip -c dist/pitchpro.umd.js | wc -c | xargs echo "UMD gzipped:"
        
    - name: Generate validation report
      if: always()
      run: |
        cat > validation-report.md << 'EOF'
        # Demo Validation Report
        
        **Build**: ${{ github.sha }}
        **Node.js**: ${{ matrix.node-version }}
        **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        ## Build Outputs
        - âœ… CJS: `dist/index.js`
        - âœ… ESM: `dist/index.esm.js`  
        - âœ… UMD: `dist/pitchpro.umd.js`
        - âœ… Types: `dist/index.d.ts`
        
        ## Demo Pages Status
        $(node validate-demos.js 2>&1 || echo "See demo validation logs above")
        
        ## Package Integrity
        - âœ… Package.json exports verified
        - âœ… Import paths tested
        - âœ… Type definitions aligned
        
        EOF
        
        echo "Validation report generated"
        
    - name: Upload validation artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: demo-validation-${{ matrix.node-version }}
        path: |
          validation-report.md
          dist/
        retention-days: 7