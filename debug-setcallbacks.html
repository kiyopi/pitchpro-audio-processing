<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>setCallbacks() ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ccc;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log { margin: 5px 0; padding: 5px; background: #f8f9fa; border-left: 3px solid #007bff; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” setCallbacks() ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆ</h1>

    <div class="test-section info">
        <h2>ğŸ“‹ ãƒ†ã‚¹ãƒˆç›®çš„</h2>
        <p>é–‹ç™ºä¸­ã‚¢ãƒ—ãƒªã§å ±å‘Šã•ã‚ŒãŸã€ŒsetCallbacks: undefinedã€å•é¡Œã®åŸå› èª¿æŸ»</p>
        <ul>
            <li>âœ… UMDãƒ“ãƒ«ãƒ‰ã§ã®æ­£ç¢ºãªAudioDetectionComponentæ§‹é€ ç¢ºèª</li>
            <li>ğŸ” ãƒ¡ã‚½ãƒƒãƒ‰ä¸€è¦§ã¨ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒã‚§ãƒ¼ãƒ³è§£æ</li>
            <li>ğŸ“Š ç•°ãªã‚‹ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–¹æ³•ã§ã®å‹•ä½œæ¯”è¼ƒ</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸš€ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
        <button onclick="testUMDImport()">UMDã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testMethodAnalysis()">ãƒ¡ã‚½ãƒƒãƒ‰è§£æãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testInstanceCreation()">ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆãƒ†ã‚¹ãƒˆ</button>
        <button onclick="generateDebugReport()">è©³ç´°ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
    </div>

    <div id="results">
        <h2>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ</h2>
        <div id="log-container"></div>
    </div>

    <!-- PitchPro UMDãƒ“ãƒ«ãƒ‰ã®èª­ã¿è¾¼ã¿ -->
    <script src="./dist/pitchpro.umd.js"></script>

    <script>
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const logElement = document.createElement('div');
            logElement.className = `log ${type}`;
            logElement.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            logContainer.appendChild(logElement);
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log-container').innerHTML = '';
        }

        function testUMDImport() {
            clearLog();
            log('ğŸ” UMDã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆé–‹å§‹');

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç¢ºèª
            log(`ğŸŒ window.PitchPro: ${typeof window.PitchPro}`);

            if (window.PitchPro) {
                log('âœ… PitchPro ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç¢ºèª');
                log(`ğŸ“‹ PitchPro keys: ${Object.keys(window.PitchPro).join(', ')}`);

                // AudioDetectionComponentã®ç¢ºèª
                if (window.PitchPro.AudioDetectionComponent) {
                    log('âœ… AudioDetectionComponent å­˜åœ¨ç¢ºèª');
                    log(`ğŸ“‹ Constructor type: ${typeof window.PitchPro.AudioDetectionComponent}`);

                    // ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª
                    const proto = window.PitchPro.AudioDetectionComponent.prototype;
                    const methods = Object.getOwnPropertyNames(proto).filter(name =>
                        typeof proto[name] === 'function' && name !== 'constructor'
                    );
                    log(`ğŸ”§ ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒ¡ã‚½ãƒƒãƒ‰æ•°: ${methods.length}`);
                    log(`ğŸ“ åˆ©ç”¨å¯èƒ½ãƒ¡ã‚½ãƒƒãƒ‰: ${methods.join(', ')}`);

                    // setCallbacksç‰¹å®šç¢ºèª
                    if (methods.includes('setCallbacks')) {
                        log('âœ… setCallbacks ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèªæ¸ˆã¿', 'success');
                        log(`ğŸ” setCallbacks type: ${typeof proto.setCallbacks}`);
                    } else {
                        log('âŒ setCallbacks ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                    }
                } else {
                    log('âŒ AudioDetectionComponent ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                }
            } else {
                log('âŒ PitchPro ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
            }
        }

        function testMethodAnalysis() {
            clearLog();
            log('ğŸ” ãƒ¡ã‚½ãƒƒãƒ‰è§£æãƒ†ã‚¹ãƒˆé–‹å§‹');

            try {
                // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                const detector = new window.PitchPro.AudioDetectionComponent({
                    volumeBarSelector: '#test-volume'
                });

                log('âœ… AudioDetectionComponent ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ');

                // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª
                const instanceMethods = [];
                const prototypeChain = [];

                let current = detector;
                let level = 0;
                while (current && level < 5) {
                    const methods = Object.getOwnPropertyNames(current)
                        .filter(name => typeof current[name] === 'function');

                    if (methods.length > 0) {
                        prototypeChain.push({
                            level: level,
                            constructor: current.constructor.name,
                            methods: methods
                        });
                    }

                    instanceMethods.push(...methods);
                    current = Object.getPrototypeOf(current);
                    level++;
                }

                log(`ğŸ”§ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ç·æ•°: ${new Set(instanceMethods).size}`);

                // ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒã‚§ãƒ¼ãƒ³æƒ…å ±
                prototypeChain.forEach(chain => {
                    log(`ğŸ“Š Level ${chain.level} (${chain.constructor}): ${chain.methods.join(', ')}`);
                });

                // setCallbacksç›´æ¥ç¢ºèª
                log(`ğŸ” detector.setCallbacks: ${typeof detector.setCallbacks}`);

                if (typeof detector.setCallbacks === 'function') {
                    log('âœ… setCallbacks ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦ç¢ºèª', 'success');

                    // å®Ÿéš›ã«setCallbackså‘¼ã³å‡ºã—
                    try {
                        detector.setCallbacks({
                            onPitchUpdate: (result) => {
                                log('ğŸ“¢ Test callback triggered', 'success');
                            }
                        });
                        log('âœ… setCallbacks å‘¼ã³å‡ºã—æˆåŠŸ', 'success');
                    } catch (error) {
                        log(`âŒ setCallbacks å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    }
                } else {
                    log('âŒ setCallbacks ãŒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§åˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');

                    // ã‚ˆã‚Šè©³ç´°ãªèª¿æŸ»
                    log('ğŸ” è©³ç´°èª¿æŸ»é–‹å§‹...');
                    const allProps = [];
                    let obj = detector;
                    while (obj) {
                        allProps.push(...Object.getOwnPropertyNames(obj));
                        obj = Object.getPrototypeOf(obj);
                    }

                    const callbacksRelated = allProps.filter(prop =>
                        prop.toLowerCase().includes('callback')
                    );

                    log(`ğŸ” ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢é€£ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£: ${callbacksRelated.join(', ')}`);
                }

            } catch (error) {
                log(`âŒ ãƒ¡ã‚½ãƒƒãƒ‰è§£æã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        function testInstanceCreation() {
            clearLog();
            log('ğŸ” ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆãƒ†ã‚¹ãƒˆé–‹å§‹');

            try {
                // æ§˜ã€…ãªè¨­å®šã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                const configs = [
                    {},
                    { volumeBarSelector: '#test' },
                    { autoUpdateUI: false },
                    { deviceOptimization: true }
                ];

                configs.forEach((config, index) => {
                    try {
                        const detector = new window.PitchPro.AudioDetectionComponent(config);
                        log(`âœ… è¨­å®š${index + 1} ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ`);
                        log(`ğŸ” è¨­å®š${index + 1} setCallbacks: ${typeof detector.setCallbacks}`);

                        // åˆ©ç”¨å¯èƒ½ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸€éƒ¨è¡¨ç¤º
                        const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(detector))
                            .filter(name => typeof detector[name] === 'function' && name !== 'constructor')
                            .slice(0, 10);
                        log(`ğŸ“ è¨­å®š${index + 1} ãƒ¡ã‚½ãƒƒãƒ‰ä¾‹: ${methods.join(', ')}`);

                    } catch (error) {
                        log(`âŒ è¨­å®š${index + 1} ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆå¤±æ•—: ${error.message}`, 'error');
                    }
                });

            } catch (error) {
                log(`âŒ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        function generateDebugReport() {
            clearLog();
            log('ğŸ” è©³ç´°ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–‹å§‹');

            const report = {
                timestamp: new Date().toISOString(),
                environment: {
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    pitchProAvailable: typeof window.PitchPro !== 'undefined'
                },
                pitchPro: null,
                audioDetectionComponent: null,
                instanceTest: null
            };

            // PitchProè§£æ
            if (window.PitchPro) {
                report.pitchPro = {
                    type: typeof window.PitchPro,
                    keys: Object.keys(window.PitchPro),
                    exports: {}
                };

                Object.keys(window.PitchPro).forEach(key => {
                    report.pitchPro.exports[key] = typeof window.PitchPro[key];
                });
            }

            // AudioDetectionComponentè§£æ
            if (window.PitchPro && window.PitchPro.AudioDetectionComponent) {
                const Component = window.PitchPro.AudioDetectionComponent;
                const proto = Component.prototype;

                report.audioDetectionComponent = {
                    type: typeof Component,
                    hasPrototype: !!proto,
                    prototypeMethods: Object.getOwnPropertyNames(proto)
                        .filter(name => typeof proto[name] === 'function'),
                    setCallbacksInPrototype: 'setCallbacks' in proto,
                    setCallbacksType: typeof proto.setCallbacks
                };
            }

            // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
            try {
                const instance = new window.PitchPro.AudioDetectionComponent({});
                report.instanceTest = {
                    success: true,
                    setCallbacksAvailable: typeof instance.setCallbacks === 'function',
                    availableMethods: Object.getOwnPropertyNames(Object.getPrototypeOf(instance))
                        .filter(name => typeof instance[name] === 'function'),
                    hasSetCallbacks: 'setCallbacks' in instance
                };
            } catch (error) {
                report.instanceTest = {
                    success: false,
                    error: error.message
                };
            }

            // ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
            log('ğŸ“Š ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†');
            const reportElement = document.createElement('pre');
            reportElement.textContent = JSON.stringify(report, null, 2);
            document.getElementById('log-container').appendChild(reportElement);

            console.log('ğŸ” Complete Debug Report:', report);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸç¢ºèª
        window.addEventListener('load', () => {
            log('ğŸš€ setCallbacks() ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†');

            // åŸºæœ¬ç¢ºèª
            if (window.PitchPro) {
                log('âœ… PitchPro UMDãƒ“ãƒ«ãƒ‰æ­£å¸¸èª­ã¿è¾¼ã¿');
                if (window.PitchPro.AudioDetectionComponent) {
                    log('âœ… AudioDetectionComponent åˆ©ç”¨å¯èƒ½');

                    const proto = window.PitchPro.AudioDetectionComponent.prototype;
                    if (proto && typeof proto.setCallbacks === 'function') {
                        log('âœ… setCallbacks ãƒ¡ã‚½ãƒƒãƒ‰ ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ç¢ºèª', 'success');
                    } else {
                        log('âš ï¸ setCallbacks ãƒ¡ã‚½ãƒƒãƒ‰ ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§æœªç¢ºèª', 'error');
                    }
                } else {
                    log('âŒ AudioDetectionComponent åˆ©ç”¨ä¸å¯', 'error');
                }
            } else {
                log('âŒ PitchPro UMDãƒ“ãƒ«ãƒ‰èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
            }
        });
    </script>
</body>
</html>