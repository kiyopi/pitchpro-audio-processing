# v1.3.26 overrideSensitivity問題の調査記録

## 日付
2025-12-03

## 背景
iPhoneトレーニング中の無音検出問題を解決するため、v1.3.26で`overrideSensitivity`機能を追加した。

## v1.3.26の変更内容

### 1. overrideSensitivity機能追加
- `AudioDetectionConfig`に`overrideSensitivity`オプションを追加
- `_getProcessedResult()`でsensitivityを適用（音量計算時に倍率適用）
- `updateSelectors()`でoverrideSensitivityの設定に対応

### 2. clarity判定ロジック修正
- 問題: `frequency:0`でも`clarity >= threshold`で通過してしまう
- 修正: `hasValidFrequency && clarity >= clarityThreshold`に変更
- マイクテスト・音域テストで`frequency:0`になる問題を解決

## 発生した問題

### 問題1: 二重感度適用による波形クリッピング
**症状**: トレーニング中に全フレームで`clarity:0.00, frequency:0.0Hz`
**原因**: 
- `AudioManager.setSensitivity(20x)` - ゲインノード経由で音声信号を20倍増幅
- `overrideSensitivity: 2.5x` - `_getProcessedResult()`で音量計算時にさらに2.5倍
- 結果: 50倍の増幅 → 波形クリッピング → pitchy検出失敗

**対策（trainingController v4.12.9）**:
- `setSensitivity()`呼び出しを3箇所すべて削除
- `overrideSensitivity: 2.5x`のみで感度制御

### 問題2: 対策後も無音検出が発生
**症状**: v4.12.9（setSensitivity削除）でも8/8ステップで無音検出
**ログの特徴**:
- 準備ページ: 正常にピッチ検出（clarity: 0.86〜1.00）
- トレーニングページ: 全フレームでclarity:0.00, frequency:0.0Hz
- 音量は30-40%程度で十分ある

**考えられる原因**:
1. PitchShifter（参照音再生）との干渉
2. トレーニングページ遷移時にPitchDetectorの状態が壊れる
3. AudioContextまたはAnalyserNodeの問題
4. v1.3.26のコード変更に別のバグがある

## 現在の状態
- v1.3.25に一旦ロールバック
- 問題の切り分けのためテスト中

## 関連ファイル

### PitchProライブラリ
- `src/components/AudioDetectionComponent.ts` - overrideSensitivity追加、clarity判定修正
- `package.json` - バージョン1.3.26

### アプリ側
- `/Users/isao/Documents/Relative-pitch-app/PitchPro-SPA/index.html` - ライブラリ読み込み
- `/Users/isao/Documents/Relative-pitch-app/PitchPro-SPA/js/controllers/trainingController.js` - v4.12.9

## trainingController.js の変更履歴

### v4.12.8
- overrideSensitivity対応追加
- iPhone: `overrideNoiseGate:0.15, overrideVolumeMultiplier:1.0, overrideSensitivity:2.5`
- iPad: `overrideNoiseGate:0.08, overrideVolumeMultiplier:1.5, overrideSensitivity:3.0`

### v4.12.9
- `setSensitivity()`呼び出しを3箇所すべて削除（二重適用防止）
- `getTrainingSensitivity()`の呼び出しも削除

## 次のアクション
1. v1.3.25でテストし、問題が再現するか確認
2. v1.3.25で問題なければv1.3.26のコード変更に問題あり
3. v1.3.25でも同じならライブラリ以外（PitchShifter干渉等）の問題

## 設定値まとめ

### v1.3.25のデバイス設定（DeviceDetection.ts）
| デバイス | noiseGate | volumeMultiplier | sensitivity |
|---------|-----------|------------------|-------------|
| iPhone  | 0.25 (25%) | 1.2 | 2.0 |
| iPad    | 0.23 (23%) | 13.0 | 5.0 |
| PC      | 0.023 (2.3%) | 7.5 | 2.5 |

### trainingController override設定（v4.12.8）
| デバイス | overrideNoiseGate | overrideVolumeMultiplier | overrideSensitivity |
|---------|-------------------|--------------------------|---------------------|
| iPhone  | 0.15 (15%) | 1.0 | 2.5 |
| iPad    | 0.08 (8%) | 1.5 | 3.0 |

### AudioManager setSensitivity（以前）
- iPhone: 20x（DeviceDetector.getTrainingSensitivity()）
- iPad: 40x
