# PitchPro v1.3.14〜v1.3.16: iOSダッキング問題とノイズ修正

## 概要
2025年12月2日に実施したiOS環境での音量問題の修正記録。

---

## v1.3.14: displayMultiplier追加（iOSダッキング対策）

### 問題
トレーニングページでPitchPro（マイク入力）とTone.js（BGM出力）が同時に動作すると、iOSがハウリング防止のためマイク入力を約2.7倍減衰させる（音量バーが30%程度しか上がらない）。

### 解決策
`displayMultiplier`オプションを追加。UI表示専用の音量倍率で、検出精度に影響を与えずに音量バーの見た目を調整可能。

### 変更ファイル
- `src/components/AudioDetectionComponent.ts`
  - `AudioDetectionConfig`に`displayMultiplier?: number`追加
  - `updateSelectors()`で`displayMultiplier`を動的変更可能に
  - `updateUI()`内で`displayVolume = result.volume * displayMultiplier`を適用
- `src/core/AudioManager.ts`
  - `setSensitivity()`の上限を10.0→20.0に拡張

### アプリ側対応（trainingController.js v4.11.0）
```javascript
await audioDetector.updateSelectors({
    volumeBarSelector: '#training-volume-progress',
    autoUpdateUI: true,
    displayMultiplier: 3.0  // iOSダッキング補正
});
```

---

## v1.3.15〜v1.3.16: iPhone静寂時ノイズ修正

### 問題
iPhoneの準備ページで、声を出していないのに常時10%程度のノイズが音量バーに表示される。

### ログ分析結果
```
rawVolume:3.96% → volume:0.00% 【ノイズゲート適用】  ← 正常
rawVolume:6.99% → volume:6.99%                        ← 問題！
rawVolume:11.52% → volume:11.52%                      ← 問題！
```

静寂時でも**6.99%〜11.52%**のノイズが発生していた。

### v1.3.15での対応（不十分）
- `noiseGate`: 0.08 → 0.12 (12%)
- `volumeMultiplier`: 2.0 → 2.5

12%では11.52%のノイズをブロックできず。

### v1.3.16での最終修正
```typescript
case 'iPhone':
  return {
    sensitivity: 2.0,
    noiseGate: 0.15,           // 0.12→0.15 (15%)
    volumeMultiplier: 2.8,     // 2.5→2.8 (ノイズゲート上昇分を補填)
    smoothingFactor: 0.1
  };
```

### デバイス別最終設定値（v1.3.16）
| デバイス | noiseGate | volumeMultiplier | 備考 |
|---------|-----------|------------------|------|
| PC | 3% | 3.5 | 維持 |
| iPad | 5% | 3.0 | 維持 |
| iPhone | **15%** | **2.8** | 静寂時ノイズ11.5%対策 |

---

## 技術的発見

### iPhoneの環境ノイズ特性
- 静寂時でも6%〜12%程度のノイズが発生
- PCやiPadより高いノイズゲートが必要
- NC（ノイズキャンセリング）が逆にノイズフロアを上げている可能性

### displayMultiplierの設計意図
- **検出処理には影響しない**（ノイズゲート計算前の生データを使用）
- UI表示のみに適用される倍率
- iOSダッキングや感度調整に柔軟に対応可能

---

## テスト確認事項
1. ✅ トレーニングページ：displayMultiplier: 3.0で正常動作
2. ⏳ 準備ページ：noiseGate: 0.15でノイズ抑制確認待ち
