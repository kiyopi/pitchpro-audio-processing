<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOSéŸ³é‡ãƒãƒ¼è¨ºæ–­ãƒ†ã‚¹ãƒˆ v3</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a2e;
            color: #fff;
            padding: 15px;
            margin: 0;
            font-size: 14px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        h1 {
            font-size: 18px;
            text-align: center;
            margin-bottom: 20px;
            color: #00d4ff;
        }
        .section {
            background: #2d2d44;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffd700;
            font-size: 13px;
        }

        /* éŸ³é‡ãƒãƒ¼ */
        .volume-bar-container {
            background: #1a1a2e;
            border-radius: 8px;
            height: 30px;
            overflow: hidden;
            margin: 10px 0;
        }
        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00d4ff);
            width: 0%;
            transition: width 0.1s ease-out;
            border-radius: 8px;
        }
        .volume-text {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        /* ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º */
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
        }
        .data-item {
            background: #1a1a2e;
            padding: 8px;
            border-radius: 5px;
        }
        .data-label {
            color: #888;
            font-size: 10px;
        }
        .data-value {
            font-weight: bold;
            font-size: 14px;
            color: #00ff88;
        }
        .data-value.warning {
            color: #ff6b6b;
        }
        .data-value.highlight {
            color: #ffd700;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px 0;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            color: #000;
        }
        .btn-secondary {
            background: #444;
            color: #fff;
        }
        .btn:disabled {
            opacity: 0.5;
        }

        /* ãƒ­ã‚° */
        .log-container {
            background: #0d0d1a;
            border-radius: 8px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
        }
        .log-entry {
            margin: 3px 0;
            padding: 3px 5px;
            border-radius: 3px;
        }
        .log-info { background: #1a3a4a; }
        .log-warn { background: #4a3a1a; color: #ffd700; }
        .log-error { background: #4a1a1a; color: #ff6b6b; }
        .log-success { background: #1a4a2a; color: #00ff88; }

        /* è¨ˆç®—éç¨‹è¡¨ç¤º */
        .calculation {
            background: #1a1a2e;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            margin: 10px 0;
            border-left: 3px solid #00d4ff;
        }
        .calc-step {
            margin: 5px 0;
        }
        .calc-result {
            color: #00ff88;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” iOSéŸ³é‡ãƒãƒ¼è¨ºæ–­ãƒ†ã‚¹ãƒˆ v4</h1>

        <!-- ãƒ‡ãƒã‚¤ã‚¹æƒ…å ± -->
        <div class="section">
            <div class="section-title">ğŸ“± ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºçµæœ</div>
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-label">ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—</div>
                    <div class="data-value" id="deviceType">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">iOSåˆ¤å®š</div>
                    <div class="data-value" id="isIOS">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">noiseGate</div>
                    <div class="data-value" id="noiseGate">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">volumeMultiplier</div>
                    <div class="data-value highlight" id="volumeMultiplier">-</div>
                </div>
            </div>
        </div>

        <!-- éŸ³é‡ãƒãƒ¼ -->
        <div class="section">
            <div class="section-title">ğŸµ éŸ³é‡è¡¨ç¤º</div>
            <div class="volume-bar-container">
                <div class="volume-bar" id="volumeBar"></div>
            </div>
            <div class="volume-text" id="volumeText">0.0%</div>
        </div>

        <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ -->
        <div class="section">
            <div class="section-title">ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿</div>
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-label">rawVolume (ç”ŸRMS)</div>
                    <div class="data-value" id="rawVolume">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">å‡¦ç†å¾Œ volume</div>
                    <div class="data-value" id="processedVolume">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">å‘¨æ³¢æ•°</div>
                    <div class="data-value" id="frequency">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">éŸ³ç¨‹</div>
                    <div class="data-value" id="note">-</div>
                </div>
            </div>

            <!-- è¨ˆç®—éç¨‹ -->
            <div class="calculation" id="calculationDisplay">
                <div class="calc-step">å¾…æ©Ÿä¸­...</div>
            </div>
        </div>

        <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
        <div class="section">
            <button class="btn btn-primary" id="startBtn" onclick="startDetection()">ğŸ¤ æ¤œå‡ºé–‹å§‹</button>
            <button class="btn btn-secondary" id="stopBtn" onclick="stopDetection()" disabled>â¹ æ¤œå‡ºåœæ­¢</button>
        </div>

        <!-- ãƒ­ã‚° -->
        <div class="section">
            <div class="section-title">ğŸ“ ãƒ­ã‚°</div>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <script type="module">
        // UMDãƒ“ãƒ«ãƒ‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const timestamp = Date.now();
        const script = document.createElement('script');
        script.src = `./dist/pitchpro.umd.js?t=${timestamp}`;
        script.onload = () => {
            log('success', `PitchPro ${window.PitchPro?.VERSION || 'unknown'} loaded`);
            initializeApp();
        };
        script.onerror = () => {
            log('error', 'PitchProã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        };
        document.head.appendChild(script);

        let audioDetector = null;
        let isDetecting = false;

        function log(type, message) {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.insertBefore(entry, container.firstChild);

            // æœ€å¤§50ä»¶
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        function initializeApp() {
            // DeviceDetectionã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’å–å¾—
            const PitchPro = window.PitchPro;
            if (!PitchPro || !PitchPro.DeviceDetection) {
                log('error', 'DeviceDetection not available');
                return;
            }

            const specs = PitchPro.DeviceDetection.getDeviceSpecs();

            // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('deviceType').textContent = specs.deviceType;
            document.getElementById('isIOS').textContent = specs.isIOS ? 'Yes' : 'No';
            document.getElementById('noiseGate').textContent = `${(specs.noiseGate * 100).toFixed(1)}%`;
            document.getElementById('volumeMultiplier').textContent = `${specs.volumeMultiplier}x`;

            log('info', `Device: ${specs.deviceType}, iOS: ${specs.isIOS}`);
            log('info', `noiseGate: ${specs.noiseGate}, volumeMultiplier: ${specs.volumeMultiplier}`);

            // volumeMultiplierãŒé«˜ã™ãã‚‹è­¦å‘Š
            if (specs.volumeMultiplier > 5) {
                log('warn', `âš ï¸ volumeMultiplierãŒé«˜ã„å€¤ã§ã™: ${specs.volumeMultiplier}x`);
                document.getElementById('volumeMultiplier').classList.add('warning');
            }
        }

        window.startDetection = async function() {
            const PitchPro = window.PitchPro;
            if (!PitchPro) {
                log('error', 'PitchPro not loaded');
                return;
            }

            try {
                log('info', 'åˆæœŸåŒ–é–‹å§‹...');

                // autoUpdateUI: false ã«ã—ã¦ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§æ‰‹å‹•æ›´æ–°
                audioDetector = new PitchPro.AudioDetectionComponent({
                    volumeBarSelector: '#volumeBar',
                    volumeTextSelector: '#volumeText',
                    autoUpdateUI: false,  // â˜… è‡ªå‹•æ›´æ–°OFF
                    deviceOptimization: true,
                    debug: true  // â˜… ãƒ‡ãƒãƒƒã‚°ON
                });

                await audioDetector.initialize();
                log('success', 'åˆæœŸåŒ–å®Œäº†');

                // ãƒ‡ãƒã‚¤ã‚¹è¨­å®šã‚’å†ç¢ºèª
                const status = audioDetector.getStatus();
                if (status.deviceSpecs) {
                    log('info', `å®Ÿéš›ã®è¨­å®š - noiseGate: ${status.deviceSpecs.noiseGate}, volumeMultiplier: ${status.deviceSpecs.volumeMultiplier}`);
                }

                // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
                audioDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        updateDisplay(result);
                    },
                    onError: (error) => {
                        log('error', `Error: ${error.message}`);
                    }
                });

                const started = await audioDetector.startDetection();
                if (started) {
                    isDetecting = true;
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    log('success', 'æ¤œå‡ºé–‹å§‹');
                } else {
                    log('error', 'æ¤œå‡ºé–‹å§‹ã«å¤±æ•—');
                }

            } catch (error) {
                log('error', `åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        };

        window.stopDetection = function() {
            if (audioDetector) {
                audioDetector.stopDetection();
                isDetecting = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                log('info', 'æ¤œå‡ºåœæ­¢');
            }
        };

        let lastLogTime = 0;
        let logCount = 0;
        const LOG_INTERVAL = 500; // 500msé–“éš”ã§ãƒ­ã‚°å‡ºåŠ›

        function updateDisplay(result) {
            // æœ€åˆã®æ•°å›ã ã‘resultã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­èº«ã‚’ãƒ­ã‚°å‡ºåŠ›
            if (logCount < 5) {
                logCount++;
                const keys = Object.keys(result);
                console.log('ğŸ“¦ [v2] result object keys:', keys);
                console.log('ğŸ“¦ [v2] result full:', result);
                log('success', `ğŸ“¦ keys: ${keys.join(', ')}`);
                log('info', `ğŸ“¦ volume=${result.volume}, rawVolume=${result.rawVolume}`);
            }

            // ç”Ÿãƒ‡ãƒ¼ã‚¿ã¨å‡¦ç†å¾Œãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            const rawVol = result.rawVolume !== undefined ? result.rawVolume : 'N/A';
            const processedVol = result.volume;

            document.getElementById('rawVolume').textContent =
                typeof rawVol === 'number' ? rawVol.toFixed(4) : rawVol;
            document.getElementById('processedVolume').textContent =
                `${processedVol.toFixed(1)}%`;
            document.getElementById('frequency').textContent =
                result.frequency > 0 ? `${result.frequency.toFixed(1)} Hz` : '-';
            document.getElementById('note').textContent =
                result.note || '-';

            // â˜… æ‰‹å‹•ã§ãƒãƒ¼ã‚’æ›´æ–°ï¼ˆautoUpdateUI: false ãªã®ã§ï¼‰
            const volumeBar = document.getElementById('volumeBar');
            const clampedVol = Math.min(100, Math.max(0, processedVol));
            if (volumeBar) {
                volumeBar.style.width = `${clampedVol}%`;
            }
            document.getElementById('volumeText').textContent = `${clampedVol.toFixed(1)}%`;

            // ãƒãƒ¼ã®å®Ÿéš›ã®å¹…ã‚’å–å¾—
            const barWidth = volumeBar ? volumeBar.style.width : 'N/A';

            // è¨ˆç®—éç¨‹ã‚’è¡¨ç¤º
            const specs = window.PitchPro?.DeviceDetection?.getDeviceSpecs();
            if (specs && typeof rawVol === 'number') {
                const RMS_TO_PERCENT = 200;
                const volumeAsPercent = rawVol * RMS_TO_PERCENT;
                const noiseGateThreshold = specs.noiseGate * 100 * 2.0;
                const finalVolume = volumeAsPercent * specs.volumeMultiplier;

                const calcHtml = `
                    <div class="calc-step">1. rawVolume: ${rawVol.toFixed(4)}</div>
                    <div class="calc-step">2. Ã— 200 = ${volumeAsPercent.toFixed(2)}%</div>
                    <div class="calc-step">3. noiseGateé–¾å€¤: ${noiseGateThreshold.toFixed(2)}%</div>
                    <div class="calc-step">4. Ã— ${specs.volumeMultiplier} = ${finalVolume.toFixed(2)}%</div>
                    <div class="calc-step calc-result">â†’ æœ€çµ‚: ${Math.min(100, finalVolume).toFixed(1)}% | ãƒãƒ¼å¹…: ${barWidth}</div>
                `;
                document.getElementById('calculationDisplay').innerHTML = calcHtml;
            }

            // 100%åˆ°é”è­¦å‘Š
            if (processedVol >= 100) {
                document.getElementById('processedVolume').classList.add('warning');
            } else {
                document.getElementById('processedVolume').classList.remove('warning');
            }

            // å®šæœŸçš„ã«ãƒ­ã‚°å‡ºåŠ›ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›ï¼‰
            const now = Date.now();
            if (now - lastLogTime > LOG_INTERVAL) {
                lastLogTime = now;

                const rawVolStr = typeof rawVol === 'number' ? rawVol.toFixed(4) : 'N/A';
                const freqStr = result.frequency > 0 ? result.frequency.toFixed(1) : '0.0';

                // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ï¼ˆã‚¢ãƒ—ãƒªã¨åŒã˜å½¢å¼ï¼‰
                console.log(`ğŸ”Š ãƒã‚¤ã‚ºç¢ºèª: rawVolume:${rawVolStr} â†’ volume:${processedVol.toFixed(2)}% | ãƒãƒ¼å¹…:${barWidth}`);
                console.log(`ğŸ¤ PitchProæ¤œå‡º: freq:${freqStr}Hz vol:${processedVol.toFixed(1)}% clarity:${(result.clarity || 0).toFixed(2)}`);

                // ç”»é¢ãƒ­ã‚°
                if (processedVol > 0) {
                    log('info', `ğŸ”Š raw:${rawVolStr} â†’ vol:${processedVol.toFixed(1)}% | ãƒãƒ¼:${barWidth} | freq:${freqStr}Hz`);
                }

                // 100%åˆ°é”æ™‚ã¯è­¦å‘Šãƒ­ã‚°
                if (processedVol >= 100) {
                    log('warn', `âš ï¸ 100%åˆ°é”! rawVolume:${rawVolStr}`);
                }
            }
        }
    </script>
</body>
</html>
