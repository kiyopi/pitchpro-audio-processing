<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchPro Advanced Features Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #e5e5e5;
        }
        
        .section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4ade80;
        }
        
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .test-button:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }
        
        .test-results {
            background: #374151;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        
        .error {
            color: #ef4444;
        }
        
        .success {
            color: #10b981;
        }
        
        .warning {
            color: #f59e0b;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª PitchPro Advanced Features Test</h1>
    
    <div class="section">
        <h2>ğŸ”§ HarmonicCorrection Test</h2>
        <p>é«˜åº¦ãªãƒãƒ¼ãƒ¢ãƒ‹ãƒƒã‚¯è£œæ­£æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
        <button class="test-button" onclick="testHarmonicCorrection()">ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        <div id="harmonic-results" class="test-results"></div>
    </div>
    
    <div class="section">
        <h2>ğŸ¤ VoiceAnalyzer Test</h2>
        <p>éŸ³å£°å“è³ªåˆ†ææ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
        <button class="test-button" onclick="testVoiceAnalyzer()">ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        <div id="voice-results" class="test-results"></div>
    </div>
    
    <div class="section">
        <h2>âš™ï¸ CalibrationSystem Test</h2>
        <p>ãƒ‡ãƒã‚¤ã‚¹å›ºæœ‰ã®ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
        <button class="test-button" onclick="testCalibrationSystem()">ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        <div id="calibration-results" class="test-results"></div>
    </div>

    <script src="pitchpro.umd.js"></script>
    <script>
        let log = (elementId, message, type = 'info') => {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        };

        // HarmonicCorrection Test
        async function testHarmonicCorrection() {
            const resultId = 'harmonic-results';
            document.getElementById(resultId).innerHTML = '';
            
            try {
                log(resultId, 'ğŸ”§ HarmonicCorrection ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                const harmonicCorrection = new PitchPro.HarmonicCorrection({
                    historyWindowMs: 1000,
                    minConfidenceThreshold: 0.5
                });
                
                log(resultId, 'âœ… HarmonicCorrection ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ', 'success');
                
                // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: åŸºæœ¬å‘¨æ³¢æ•°
                let result1 = harmonicCorrection.correctFrequency(440, 0.8);
                log(resultId, `ãƒ†ã‚¹ãƒˆ1 - 440Hz: ${JSON.stringify(result1)}`, 'info');
                
                // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ãƒãƒ¼ãƒ¢ãƒ‹ãƒƒã‚¯ï¼ˆ880Hz = 440Hzã®2å€ï¼‰
                let result2 = harmonicCorrection.correctFrequency(880, 0.8);
                log(resultId, `ãƒ†ã‚¹ãƒˆ2 - 880Hz: ${JSON.stringify(result2)}`, 'info');
                
                // å±¥æ­´ã‚’è“„ç©ã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãƒ†ã‚¹ãƒˆ
                await new Promise(resolve => setTimeout(resolve, 100));
                result2 = harmonicCorrection.correctFrequency(880, 0.8);
                log(resultId, `ãƒ†ã‚¹ãƒˆ2(å†) - 880Hz: ${JSON.stringify(result2)}`, 'info');
                
                // çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
                const stats = harmonicCorrection.getAnalysisStats();
                log(resultId, `çµ±è¨ˆæƒ…å ±: ${JSON.stringify(stats)}`, 'info');
                
                log(resultId, 'âœ… HarmonicCorrection ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                
            } catch (error) {
                log(resultId, `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('HarmonicCorrection test error:', error);
            }
        }

        // VoiceAnalyzer Test
        async function testVoiceAnalyzer() {
            const resultId = 'voice-results';
            document.getElementById(resultId).innerHTML = '';
            
            try {
                log(resultId, 'ğŸ¤ VoiceAnalyzer ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                const voiceAnalyzer = new PitchPro.VoiceAnalyzer({
                    analysisWindowMs: 2000,
                    vibratoMinRate: 4.0
                });
                
                log(resultId, 'âœ… VoiceAnalyzer ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ', 'success');
                
                // æ¨¡æ“¬ãƒ‡ãƒ¼ã‚¿ã§è¤‡æ•°å›åˆ†æ
                const frequencies = [440, 442, 438, 441, 439, 443, 440, 441];
                const volumes = [0.6, 0.65, 0.58, 0.62, 0.60, 0.67, 0.61, 0.63];
                const clarities = [0.8, 0.82, 0.78, 0.81, 0.79, 0.83, 0.80, 0.82];
                
                log(resultId, 'ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨ã„ã¦éŸ³å£°åˆ†æå®Ÿè¡Œä¸­...', 'info');
                
                for (let i = 0; i < frequencies.length; i++) {
                    const result = voiceAnalyzer.analyzeVoice(
                        frequencies[i], 
                        volumes[i], 
                        clarities[i]
                    );
                    
                    if (i === frequencies.length - 1) { // æœ€å¾Œã®çµæœã®ã¿è¡¨ç¤º
                        log(resultId, `éŸ³å£°å“è³ª: ${result.quality}`, 'info');
                        log(resultId, `å®‰å®šæ€§: ${result.stability.toFixed(3)}`, 'info');
                        log(resultId, `æ¨å¥¨äº‹é …: ${result.recommendations.join(', ')}`, 'info');
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                // ãƒãƒƒãƒ•ã‚¡çµ±è¨ˆå–å¾—
                const bufferStats = voiceAnalyzer.getBufferStats();
                log(resultId, `ãƒãƒƒãƒ•ã‚¡çµ±è¨ˆ: ${JSON.stringify(bufferStats)}`, 'info');
                
                log(resultId, 'âœ… VoiceAnalyzer ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                
            } catch (error) {
                log(resultId, `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('VoiceAnalyzer test error:', error);
            }
        }

        // CalibrationSystem Test
        async function testCalibrationSystem() {
            const resultId = 'calibration-results';
            document.getElementById(resultId).innerHTML = '';
            
            try {
                log(resultId, 'âš™ï¸ CalibrationSystem ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                const calibrationSystem = new PitchPro.CalibrationSystem();
                
                log(resultId, 'âœ… CalibrationSystem ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ', 'success');
                
                // åˆæœŸçŠ¶æ…‹ç¢ºèª
                let status = calibrationSystem.getCalibrationStatus();
                log(resultId, `åˆæœŸçŠ¶æ…‹ - ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¸ˆã¿: ${status.isCalibrated}`, 'info');
                log(resultId, `ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—: ${status.deviceSpecs.deviceType}`, 'info');
                log(resultId, `æ„Ÿåº¦: ${status.deviceSpecs.sensitivity}`, 'info');
                
                // ä¿å­˜æ¸ˆã¿ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
                const loaded = calibrationSystem.loadCalibration();
                log(resultId, `ä¿å­˜æ¸ˆã¿ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿: ${loaded}`, loaded ? 'success' : 'warning');
                
                // AudioContextãŒå¿…è¦ãªå®Ÿéš›ã®ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã‚¹ã‚­ãƒƒãƒ—
                // ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒã‚¤ã‚¯æ¨©é™ãŒå¿…è¦ãªãŸã‚ï¼‰
                log(resultId, 'ğŸ“ æ³¨æ„: å®Ÿéš›ã®ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãƒã‚¤ã‚¯æ¨©é™ãŒå¿…è¦ãªãŸã‚ã‚¹ã‚­ãƒƒãƒ—', 'warning');
                log(resultId, 'å®Ÿéš›ã®ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã¯ã€AudioManagerã¨é€£æºã—ã¦è¡Œã£ã¦ãã ã•ã„', 'info');
                
                log(resultId, 'âœ… CalibrationSystem ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                
            } catch (error) {
                log(resultId, `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('CalibrationSystem test error:', error);
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('PitchPro Advanced Features Test loaded');
            
            // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (typeof PitchPro === 'undefined') {
                document.body.innerHTML = '<h1 style="color: red;">âŒ PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</h1>';
                return;
            }
            
            // åˆ©ç”¨å¯èƒ½ãªAdvancedæ©Ÿèƒ½ã‚’ç¢ºèª
            const availableFeatures = {
                HarmonicCorrection: !!PitchPro.HarmonicCorrection,
                VoiceAnalyzer: !!PitchPro.VoiceAnalyzer,
                CalibrationSystem: !!PitchPro.CalibrationSystem
            };
            
            console.log('åˆ©ç”¨å¯èƒ½ãªAdvancedæ©Ÿèƒ½:', availableFeatures);
        });
    </script>
</body>
</html>