<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchPro - æ¶ˆéŸ³æ¤œå‡ºæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }
        
        .control-group h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .button-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .setting-row label {
            min-width: 120px;
            font-size: 14px;
            color: #495057;
        }
        
        .setting-row input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .setting-row span {
            min-width: 40px;
            font-size: 12px;
            color: #6c757d;
        }
        
        .status-display {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .status-row:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 600;
            color: #495057;
        }
        
        .status-value {
            font-family: 'Monaco', 'Consolas', monospace;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .status-enabled {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-silent {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-active {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .log-container {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
        }
        
        .log-container h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            border-left: 4px solid transparent;
        }
        
        .log-info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        
        .log-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        
        .log-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        
        .log-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .timestamp {
            color: #6c757d;
            font-size: 11px;
            margin-right: 8px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .button-row {
                flex-direction: column;
            }
            
            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”‡ æ¶ˆéŸ³æ¤œå‡ºæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>
        
        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="controls">
            <!-- åŸºæœ¬åˆ¶å¾¡ -->
            <div class="control-group">
                <h3>ğŸ™ï¸ åŸºæœ¬åˆ¶å¾¡</h3>
                <div class="button-row">
                    <button id="initBtn" class="btn-primary">åˆæœŸåŒ–</button>
                    <button id="startBtn" class="btn-success" disabled>é–‹å§‹</button>
                    <button id="stopBtn" class="btn-danger" disabled>åœæ­¢</button>
                </div>
                <div class="button-row">
                    <button id="enableSilenceBtn" class="btn-warning" disabled>æ¶ˆéŸ³æ¤œå‡ºæœ‰åŠ¹</button>
                    <button id="disableSilenceBtn" class="btn-warning" disabled>æ¶ˆéŸ³æ¤œå‡ºç„¡åŠ¹</button>
                </div>
            </div>
            
            <!-- æ¶ˆéŸ³æ¤œå‡ºè¨­å®š -->
            <div class="control-group">
                <h3>âš™ï¸ æ¶ˆéŸ³æ¤œå‡ºè¨­å®š</h3>
                <div class="setting-row">
                    <label>è­¦å‘Šæ™‚é–“:</label>
                    <input type="number" id="warningThreshold" value="5000" min="1000" max="60000" step="1000">
                    <span>ms</span>
                </div>
                <div class="setting-row">
                    <label>ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ:</label>
                    <input type="number" id="timeoutThreshold" value="10000" min="2000" max="120000" step="1000">
                    <span>ms</span>
                </div>
                <div class="setting-row">
                    <label>éŸ³é‡é–¾å€¤:</label>
                    <input type="number" id="volumeThreshold" value="0.01" min="0.001" max="0.1" step="0.001">
                    <span>%</span>
                </div>
                <button id="updateSettingsBtn" class="btn-primary" style="width: 100%; margin-top: 10px;" disabled>è¨­å®šæ›´æ–°</button>
            </div>
        </div>
        
        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div class="status-display">
            <div class="status-row">
                <span class="status-label">æ¤œå‡ºçŠ¶æ…‹:</span>
                <span id="detectionStatus" class="status-value status-disabled">æœªé–‹å§‹</span>
            </div>
            <div class="status-row">
                <span class="status-label">æ¶ˆéŸ³æ¤œå‡º:</span>
                <span id="silenceDetectionStatus" class="status-value status-disabled">ç„¡åŠ¹</span>
            </div>
            <div class="status-row">
                <span class="status-label">ç¾åœ¨ã®çŠ¶æ…‹:</span>
                <span id="currentState" class="status-value status-disabled">éŸ³å£°æ¤œå‡ºä¸­</span>
            </div>
            <div class="status-row">
                <span class="status-label">æ¶ˆéŸ³ç¶™ç¶šæ™‚é–“:</span>
                <span id="silenceDuration" class="status-value">0ms</span>
            </div>
            <div class="status-row">
                <span class="status-label">è­¦å‘ŠçŠ¶æ…‹:</span>
                <span id="warningState" class="status-value status-disabled">æœªè­¦å‘Š</span>
            </div>
        </div>
        
        <!-- éŸ³å£°ãƒ¬ãƒ™ãƒ«è¡¨ç¤º -->
        <div class="status-display">
            <h3 style="margin-bottom: 15px; color: #495057;">ğŸ“Š éŸ³å£°ãƒ¬ãƒ™ãƒ«</h3>
            <div class="status-row">
                <span class="status-label">ç¾åœ¨ã®éŸ³é‡:</span>
                <span id="currentVolume" class="status-value">0%</span>
            </div>
            <div class="status-row">
                <span class="status-label">éŸ³é‡é–¾å€¤:</span>
                <span id="volumeThresholdDisplay" class="status-value">1%</span>
            </div>
            <div class="progress-bar">
                <div id="volumeProgressBar" class="progress-fill"></div>
            </div>
        </div>
        
        <!-- ãƒ­ã‚°è¡¨ç¤º -->
        <div class="log-container">
            <h3>ğŸ“‹ å‹•ä½œãƒ­ã‚°</h3>
            <div id="logEntries"></div>
        </div>
    </div>

    <!-- Core scripts -->
    <script type="module">
        import { MicrophoneController, PitchDetector } from '../dist/index.esm.js';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let micController = null;
        let pitchDetector = null;
        let isInitialized = false;
        let isDetecting = false;
        
        // DOMè¦ç´ 
        const elements = {
            initBtn: document.getElementById('initBtn'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            enableSilenceBtn: document.getElementById('enableSilenceBtn'),
            disableSilenceBtn: document.getElementById('disableSilenceBtn'),
            updateSettingsBtn: document.getElementById('updateSettingsBtn'),
            
            // è¨­å®š
            warningThreshold: document.getElementById('warningThreshold'),
            timeoutThreshold: document.getElementById('timeoutThreshold'),
            volumeThreshold: document.getElementById('volumeThreshold'),
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
            detectionStatus: document.getElementById('detectionStatus'),
            silenceDetectionStatus: document.getElementById('silenceDetectionStatus'),
            currentState: document.getElementById('currentState'),
            silenceDuration: document.getElementById('silenceDuration'),
            warningState: document.getElementById('warningState'),
            currentVolume: document.getElementById('currentVolume'),
            volumeThresholdDisplay: document.getElementById('volumeThresholdDisplay'),
            volumeProgressBar: document.getElementById('volumeProgressBar'),
            
            // ãƒ­ã‚°
            logEntries: document.getElementById('logEntries')
        };
        
        // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
            
            elements.logEntries.appendChild(logEntry);
            elements.logEntries.scrollTop = elements.logEntries.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus() {
            if (!pitchDetector) return;
            
            const status = pitchDetector.getSilenceStatus();
            
            // æ¤œå‡ºçŠ¶æ…‹
            elements.detectionStatus.textContent = isDetecting ? 'æ¤œå‡ºä¸­' : 'åœæ­¢ä¸­';
            elements.detectionStatus.className = `status-value ${isDetecting ? 'status-active' : 'status-disabled'}`;
            
            // æ¶ˆéŸ³æ¤œå‡ºçŠ¶æ…‹
            elements.silenceDetectionStatus.textContent = status.isEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹';
            elements.silenceDetectionStatus.className = `status-value ${status.isEnabled ? 'status-enabled' : 'status-disabled'}`;
            
            // ç¾åœ¨ã®çŠ¶æ…‹
            elements.currentState.textContent = status.isSilent ? 'æ¶ˆéŸ³ä¸­' : 'éŸ³å£°æ¤œå‡ºä¸­';
            elements.currentState.className = `status-value ${status.isSilent ? 'status-silent' : 'status-active'}`;
            
            // æ¶ˆéŸ³ç¶™ç¶šæ™‚é–“
            elements.silenceDuration.textContent = status.silenceDuration ? `${status.silenceDuration}ms` : '0ms';
            
            // è­¦å‘ŠçŠ¶æ…‹
            elements.warningState.textContent = status.hasWarned ? 'è­¦å‘Šæ¸ˆã¿' : 'æœªè­¦å‘Š';
            elements.warningState.className = `status-value ${status.hasWarned ? 'status-warning' : 'status-disabled'}`;
            
            // éŸ³é‡é–¾å€¤è¡¨ç¤ºæ›´æ–°
            const threshold = parseFloat(elements.volumeThreshold.value) * 100;
            elements.volumeThresholdDisplay.textContent = `${threshold.toFixed(1)}%`;
        }
        
        // åˆæœŸåŒ–
        elements.initBtn.addEventListener('click', async () => {
            try {
                addLog('ğŸ™ï¸ åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™...', 'info');
                elements.initBtn.disabled = true;
                
                // MicrophoneControlleråˆæœŸåŒ–
                micController = new MicrophoneController();
                micController.setCallbacks({
                    onError: (error) => addLog(`âŒ ãƒã‚¤ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error'),
                    onStateChange: (state) => addLog(`ğŸ”„ çŠ¶æ…‹å¤‰æ›´: ${state}`, 'info')
                });
                
                await micController.initialize();
                addLog('âœ… ãƒã‚¤ã‚¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼åˆæœŸåŒ–å®Œäº†', 'success');
                
                // PitchDetectoråˆæœŸåŒ–
                pitchDetector = new PitchDetector(micController.audioManager, {
                    fftSize: 2048,
                    clarityThreshold: 0.4,
                    minVolumeAbsolute: 0.003,
                    silenceDetection: {
                        enabled: false, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç„¡åŠ¹
                        warningThreshold: parseInt(elements.warningThreshold.value),
                        timeoutThreshold: parseInt(elements.timeoutThreshold.value),
                        minVolumeThreshold: parseFloat(elements.volumeThreshold.value),
                        onSilenceWarning: (duration) => {
                            addLog(`âš ï¸ æ¶ˆéŸ³è­¦å‘Š: ${duration}msé–“ç„¡éŸ³ã§ã™`, 'warning');
                            updateStatus();
                        },
                        onSilenceTimeout: () => {
                            addLog('â° æ¶ˆéŸ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: æ¤œå‡ºã‚’è‡ªå‹•åœæ­¢ã—ã¾ã™', 'error');
                            updateStatus();
                        },
                        onSilenceRecovered: () => {
                            addLog('ğŸ”Š éŸ³å£°å›å¾©: æ¶ˆéŸ³çŠ¶æ…‹ãŒè§£é™¤ã•ã‚Œã¾ã—ãŸ', 'success');
                            updateStatus();
                        }
                    }
                });
                
                pitchDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        // éŸ³é‡è¡¨ç¤ºæ›´æ–°
                        const volume = Math.round(result.volume);
                        elements.currentVolume.textContent = `${volume}%`;
                        elements.volumeProgressBar.style.width = `${Math.min(volume, 100)}%`;
                    },
                    onError: (error) => addLog(`âŒ æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error')
                });
                
                await pitchDetector.initialize();
                addLog('âœ… ãƒ”ãƒƒãƒæ¤œå‡ºå™¨åˆæœŸåŒ–å®Œäº†', 'success');
                
                isInitialized = true;
                elements.startBtn.disabled = false;
                elements.enableSilenceBtn.disabled = false;
                elements.disableSilenceBtn.disabled = false;
                elements.updateSettingsBtn.disabled = false;
                
                updateStatus();
                
            } catch (error) {
                addLog(`âŒ åˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error');
                elements.initBtn.disabled = false;
            }
        });
        
        // æ¤œå‡ºé–‹å§‹
        elements.startBtn.addEventListener('click', () => {
            if (!isInitialized || !pitchDetector) return;
            
            const success = pitchDetector.startDetection();
            if (success) {
                isDetecting = true;
                addLog('ğŸµ éŸ³ç¨‹æ¤œå‡ºã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
                elements.startBtn.disabled = true;
                elements.stopBtn.disabled = false;
            } else {
                addLog('âŒ æ¤œå‡ºé–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
            updateStatus();
        });
        
        // æ¤œå‡ºåœæ­¢
        elements.stopBtn.addEventListener('click', () => {
            if (!pitchDetector) return;
            
            pitchDetector.stopDetection();
            isDetecting = false;
            addLog('â¸ï¸ éŸ³ç¨‹æ¤œå‡ºã‚’åœæ­¢ã—ã¾ã—ãŸ', 'info');
            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
            updateStatus();
        });
        
        // æ¶ˆéŸ³æ¤œå‡ºæœ‰åŠ¹åŒ–
        elements.enableSilenceBtn.addEventListener('click', () => {
            if (!pitchDetector) return;
            
            pitchDetector.setSilenceDetectionConfig({
                enabled: true
            });
            addLog('ğŸ”‡ æ¶ˆéŸ³æ¤œå‡ºã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ', 'success');
            updateStatus();
        });
        
        // æ¶ˆéŸ³æ¤œå‡ºç„¡åŠ¹åŒ–
        elements.disableSilenceBtn.addEventListener('click', () => {
            if (!pitchDetector) return;
            
            pitchDetector.setSilenceDetectionConfig({
                enabled: false
            });
            addLog('ğŸ”‡ æ¶ˆéŸ³æ¤œå‡ºã‚’ç„¡åŠ¹ã«ã—ã¾ã—ãŸ', 'info');
            updateStatus();
        });
        
        // è¨­å®šæ›´æ–°
        elements.updateSettingsBtn.addEventListener('click', () => {
            if (!pitchDetector) return;
            
            const newConfig = {
                warningThreshold: parseInt(elements.warningThreshold.value),
                timeoutThreshold: parseInt(elements.timeoutThreshold.value),
                minVolumeThreshold: parseFloat(elements.volumeThreshold.value)
            };
            
            pitchDetector.setSilenceDetectionConfig(newConfig);
            addLog(`âš™ï¸ è¨­å®šæ›´æ–°: è­¦å‘Š=${newConfig.warningThreshold}ms, ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ=${newConfig.timeoutThreshold}ms, é–¾å€¤=${(newConfig.minVolumeThreshold*100).toFixed(1)}%`, 'info');
            updateStatus();
        });
        
        // å®šæœŸçš„ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        setInterval(() => {
            if (isInitialized) {
                updateStatus();
            }
        }, 100);
        
        // åˆæœŸãƒ­ã‚°
        addLog('ğŸš€ æ¶ˆéŸ³æ¤œå‡ºæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ', 'info');
        addLog('ğŸ“ ä½¿ç”¨æ–¹æ³•: 1) åˆæœŸåŒ– â†’ 2) é–‹å§‹ â†’ 3) æ¶ˆéŸ³æ¤œå‡ºæœ‰åŠ¹ â†’ 4) ãƒã‚¤ã‚¯ã«å‘ã‹ã£ã¦è©±ã—ã¦ãã ã•ã„', 'info');
    </script>
</body>
</html>