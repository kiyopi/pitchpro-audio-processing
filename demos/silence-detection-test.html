<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchPro - 消音検出機能テスト</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }
        
        .control-group h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .button-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .setting-row label {
            min-width: 120px;
            font-size: 14px;
            color: #495057;
        }
        
        .setting-row input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .setting-row span {
            min-width: 40px;
            font-size: 12px;
            color: #6c757d;
        }
        
        .status-display {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .status-row:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 600;
            color: #495057;
        }
        
        .status-value {
            font-family: 'Monaco', 'Consolas', monospace;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .status-enabled {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-silent {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-active {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .log-container {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
        }
        
        .log-container h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            border-left: 4px solid transparent;
        }
        
        .log-info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        
        .log-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        
        .log-error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        
        .log-success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .timestamp {
            color: #6c757d;
            font-size: 11px;
            margin-right: 8px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .button-row {
                flex-direction: column;
            }
            
            h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔇 消音検出機能テスト</h1>
        
        <!-- コントロールパネル -->
        <div class="controls">
            <!-- 基本制御 -->
            <div class="control-group">
                <h3>🎙️ 基本制御</h3>
                <div class="button-row">
                    <button id="initBtn" class="btn-primary">初期化</button>
                    <button id="startBtn" class="btn-success" disabled>開始</button>
                    <button id="stopBtn" class="btn-danger" disabled>停止</button>
                </div>
                <div class="button-row">
                    <button id="enableSilenceBtn" class="btn-warning" disabled>消音検出有効</button>
                    <button id="disableSilenceBtn" class="btn-warning" disabled>消音検出無効</button>
                </div>
            </div>
            
            <!-- 消音検出設定 -->
            <div class="control-group">
                <h3>⚙️ 消音検出設定</h3>
                <div class="setting-row">
                    <label>警告時間:</label>
                    <input type="number" id="warningThreshold" value="5000" min="1000" max="60000" step="1000">
                    <span>ms</span>
                </div>
                <div class="setting-row">
                    <label>タイムアウト:</label>
                    <input type="number" id="timeoutThreshold" value="10000" min="2000" max="120000" step="1000">
                    <span>ms</span>
                </div>
                <div class="setting-row">
                    <label>音量閾値:</label>
                    <input type="number" id="volumeThreshold" value="0.01" min="0.001" max="0.1" step="0.001">
                    <span>%</span>
                </div>
                <button id="updateSettingsBtn" class="btn-primary" style="width: 100%; margin-top: 10px;" disabled>設定更新</button>
            </div>
        </div>
        
        <!-- ステータス表示 -->
        <div class="status-display">
            <div class="status-row">
                <span class="status-label">検出状態:</span>
                <span id="detectionStatus" class="status-value status-disabled">未開始</span>
            </div>
            <div class="status-row">
                <span class="status-label">消音検出:</span>
                <span id="silenceDetectionStatus" class="status-value status-disabled">無効</span>
            </div>
            <div class="status-row">
                <span class="status-label">現在の状態:</span>
                <span id="currentState" class="status-value status-disabled">音声検出中</span>
            </div>
            <div class="status-row">
                <span class="status-label">消音継続時間:</span>
                <span id="silenceDuration" class="status-value">0ms</span>
            </div>
            <div class="status-row">
                <span class="status-label">警告状態:</span>
                <span id="warningState" class="status-value status-disabled">未警告</span>
            </div>
        </div>
        
        <!-- 音声レベル表示 -->
        <div class="status-display">
            <h3 style="margin-bottom: 15px; color: #495057;">📊 音声レベル</h3>
            <div class="status-row">
                <span class="status-label">現在の音量:</span>
                <span id="currentVolume" class="status-value">0%</span>
            </div>
            <div class="status-row">
                <span class="status-label">音量閾値:</span>
                <span id="volumeThresholdDisplay" class="status-value">1%</span>
            </div>
            <div class="progress-bar">
                <div id="volumeProgressBar" class="progress-fill"></div>
            </div>
        </div>
        
        <!-- ログ表示 -->
        <div class="log-container">
            <h3>📋 動作ログ</h3>
            <div id="logEntries"></div>
        </div>
    </div>

    <!-- Core scripts -->
    <script type="module">
        import { MicrophoneController, PitchDetector } from '../dist/index.esm.js';
        
        // グローバル変数
        let micController = null;
        let pitchDetector = null;
        let isInitialized = false;
        let isDetecting = false;
        
        // DOM要素
        const elements = {
            initBtn: document.getElementById('initBtn'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            enableSilenceBtn: document.getElementById('enableSilenceBtn'),
            disableSilenceBtn: document.getElementById('disableSilenceBtn'),
            updateSettingsBtn: document.getElementById('updateSettingsBtn'),
            
            // 設定
            warningThreshold: document.getElementById('warningThreshold'),
            timeoutThreshold: document.getElementById('timeoutThreshold'),
            volumeThreshold: document.getElementById('volumeThreshold'),
            
            // ステータス表示
            detectionStatus: document.getElementById('detectionStatus'),
            silenceDetectionStatus: document.getElementById('silenceDetectionStatus'),
            currentState: document.getElementById('currentState'),
            silenceDuration: document.getElementById('silenceDuration'),
            warningState: document.getElementById('warningState'),
            currentVolume: document.getElementById('currentVolume'),
            volumeThresholdDisplay: document.getElementById('volumeThresholdDisplay'),
            volumeProgressBar: document.getElementById('volumeProgressBar'),
            
            // ログ
            logEntries: document.getElementById('logEntries')
        };
        
        // ログ出力関数
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="timestamp">${timestamp}</span>${message}`;
            
            elements.logEntries.appendChild(logEntry);
            elements.logEntries.scrollTop = elements.logEntries.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }
        
        // ステータス更新
        function updateStatus() {
            if (!pitchDetector) return;
            
            const status = pitchDetector.getSilenceStatus();
            
            // 検出状態
            elements.detectionStatus.textContent = isDetecting ? '検出中' : '停止中';
            elements.detectionStatus.className = `status-value ${isDetecting ? 'status-active' : 'status-disabled'}`;
            
            // 消音検出状態
            elements.silenceDetectionStatus.textContent = status.isEnabled ? '有効' : '無効';
            elements.silenceDetectionStatus.className = `status-value ${status.isEnabled ? 'status-enabled' : 'status-disabled'}`;
            
            // 現在の状態
            elements.currentState.textContent = status.isSilent ? '消音中' : '音声検出中';
            elements.currentState.className = `status-value ${status.isSilent ? 'status-silent' : 'status-active'}`;
            
            // 消音継続時間
            elements.silenceDuration.textContent = status.silenceDuration ? `${status.silenceDuration}ms` : '0ms';
            
            // 警告状態
            elements.warningState.textContent = status.hasWarned ? '警告済み' : '未警告';
            elements.warningState.className = `status-value ${status.hasWarned ? 'status-warning' : 'status-disabled'}`;
            
            // 音量閾値表示更新
            const threshold = parseFloat(elements.volumeThreshold.value) * 100;
            elements.volumeThresholdDisplay.textContent = `${threshold.toFixed(1)}%`;
        }
        
        // 初期化
        elements.initBtn.addEventListener('click', async () => {
            try {
                addLog('🎙️ 初期化を開始します...', 'info');
                elements.initBtn.disabled = true;
                
                // MicrophoneController初期化
                micController = new MicrophoneController();
                micController.setCallbacks({
                    onError: (error) => addLog(`❌ マイクエラー: ${error.message}`, 'error'),
                    onStateChange: (state) => addLog(`🔄 状態変更: ${state}`, 'info')
                });
                
                await micController.initialize();
                addLog('✅ マイクコントローラー初期化完了', 'success');
                
                // PitchDetector初期化
                pitchDetector = new PitchDetector(micController.audioManager, {
                    fftSize: 2048,
                    clarityThreshold: 0.4,
                    minVolumeAbsolute: 0.003,
                    silenceDetection: {
                        enabled: false, // デフォルトは無効
                        warningThreshold: parseInt(elements.warningThreshold.value),
                        timeoutThreshold: parseInt(elements.timeoutThreshold.value),
                        minVolumeThreshold: parseFloat(elements.volumeThreshold.value),
                        onSilenceWarning: (duration) => {
                            addLog(`⚠️ 消音警告: ${duration}ms間無音です`, 'warning');
                            updateStatus();
                        },
                        onSilenceTimeout: () => {
                            addLog('⏰ 消音タイムアウト: 検出を自動停止します', 'error');
                            updateStatus();
                        },
                        onSilenceRecovered: () => {
                            addLog('🔊 音声回復: 消音状態が解除されました', 'success');
                            updateStatus();
                        }
                    }
                });
                
                pitchDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        // 音量表示更新
                        const volume = Math.round(result.volume);
                        elements.currentVolume.textContent = `${volume}%`;
                        elements.volumeProgressBar.style.width = `${Math.min(volume, 100)}%`;
                    },
                    onError: (error) => addLog(`❌ 検出エラー: ${error.message}`, 'error')
                });
                
                await pitchDetector.initialize();
                addLog('✅ ピッチ検出器初期化完了', 'success');
                
                isInitialized = true;
                elements.startBtn.disabled = false;
                elements.enableSilenceBtn.disabled = false;
                elements.disableSilenceBtn.disabled = false;
                elements.updateSettingsBtn.disabled = false;
                
                updateStatus();
                
            } catch (error) {
                addLog(`❌ 初期化失敗: ${error.message}`, 'error');
                elements.initBtn.disabled = false;
            }
        });
        
        // 検出開始
        elements.startBtn.addEventListener('click', () => {
            if (!isInitialized || !pitchDetector) return;
            
            const success = pitchDetector.startDetection();
            if (success) {
                isDetecting = true;
                addLog('🎵 音程検出を開始しました', 'success');
                elements.startBtn.disabled = true;
                elements.stopBtn.disabled = false;
            } else {
                addLog('❌ 検出開始に失敗しました', 'error');
            }
            updateStatus();
        });
        
        // 検出停止
        elements.stopBtn.addEventListener('click', () => {
            if (!pitchDetector) return;
            
            pitchDetector.stopDetection();
            isDetecting = false;
            addLog('⏸️ 音程検出を停止しました', 'info');
            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
            updateStatus();
        });
        
        // 消音検出有効化
        elements.enableSilenceBtn.addEventListener('click', () => {
            if (!pitchDetector) return;
            
            pitchDetector.setSilenceDetectionConfig({
                enabled: true
            });
            addLog('🔇 消音検出を有効にしました', 'success');
            updateStatus();
        });
        
        // 消音検出無効化
        elements.disableSilenceBtn.addEventListener('click', () => {
            if (!pitchDetector) return;
            
            pitchDetector.setSilenceDetectionConfig({
                enabled: false
            });
            addLog('🔇 消音検出を無効にしました', 'info');
            updateStatus();
        });
        
        // 設定更新
        elements.updateSettingsBtn.addEventListener('click', () => {
            if (!pitchDetector) return;
            
            const newConfig = {
                warningThreshold: parseInt(elements.warningThreshold.value),
                timeoutThreshold: parseInt(elements.timeoutThreshold.value),
                minVolumeThreshold: parseFloat(elements.volumeThreshold.value)
            };
            
            pitchDetector.setSilenceDetectionConfig(newConfig);
            addLog(`⚙️ 設定更新: 警告=${newConfig.warningThreshold}ms, タイムアウト=${newConfig.timeoutThreshold}ms, 閾値=${(newConfig.minVolumeThreshold*100).toFixed(1)}%`, 'info');
            updateStatus();
        });
        
        // 定期的なステータス更新
        setInterval(() => {
            if (isInitialized) {
                updateStatus();
            }
        }, 100);
        
        // 初期ログ
        addLog('🚀 消音検出機能テストページが読み込まれました', 'info');
        addLog('📝 使用方法: 1) 初期化 → 2) 開始 → 3) 消音検出有効 → 4) マイクに向かって話してください', 'info');
    </script>
</body>
</html>