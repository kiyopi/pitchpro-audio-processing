<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOSÈü≥Èáè„Éê„ÉºË®∫Êñ≠„ÉÜ„Çπ„Éà</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a2e;
            color: #fff;
            padding: 15px;
            margin: 0;
            font-size: 14px;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        h1 {
            font-size: 18px;
            text-align: center;
            margin-bottom: 20px;
            color: #00d4ff;
        }
        .section {
            background: #2d2d44;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffd700;
            font-size: 13px;
        }

        /* Èü≥Èáè„Éê„Éº */
        .volume-bar-container {
            background: #1a1a2e;
            border-radius: 8px;
            height: 30px;
            overflow: hidden;
            margin: 10px 0;
        }
        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00d4ff);
            width: 0%;
            transition: width 0.1s ease-out;
            border-radius: 8px;
        }
        .volume-text {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        /* „Éá„Éº„ÇøË°®Á§∫ */
        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
        }
        .data-item {
            background: #1a1a2e;
            padding: 8px;
            border-radius: 5px;
        }
        .data-label {
            color: #888;
            font-size: 10px;
        }
        .data-value {
            font-weight: bold;
            font-size: 14px;
            color: #00ff88;
        }
        .data-value.warning {
            color: #ff6b6b;
        }
        .data-value.highlight {
            color: #ffd700;
        }

        /* „Éú„Çø„É≥ */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px 0;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            color: #000;
        }
        .btn-secondary {
            background: #444;
            color: #fff;
        }
        .btn:disabled {
            opacity: 0.5;
        }

        /* „É≠„Ç∞ */
        .log-container {
            background: #0d0d1a;
            border-radius: 8px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
        }
        .log-entry {
            margin: 3px 0;
            padding: 3px 5px;
            border-radius: 3px;
        }
        .log-info { background: #1a3a4a; }
        .log-warn { background: #4a3a1a; color: #ffd700; }
        .log-error { background: #4a1a1a; color: #ff6b6b; }
        .log-success { background: #1a4a2a; color: #00ff88; }

        /* Ë®àÁÆóÈÅéÁ®ãË°®Á§∫ */
        .calculation {
            background: #1a1a2e;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            margin: 10px 0;
            border-left: 3px solid #00d4ff;
        }
        .calc-step {
            margin: 5px 0;
        }
        .calc-result {
            color: #00ff88;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç iOSÈü≥Èáè„Éê„ÉºË®∫Êñ≠„ÉÜ„Çπ„Éà</h1>

        <!-- „Éá„Éê„Ç§„ÇπÊÉÖÂ†± -->
        <div class="section">
            <div class="section-title">üì± „Éá„Éê„Ç§„ÇπÊ§úÂá∫ÁµêÊûú</div>
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-label">„Éá„Éê„Ç§„Çπ„Çø„Ç§„Éó</div>
                    <div class="data-value" id="deviceType">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">iOSÂà§ÂÆö</div>
                    <div class="data-value" id="isIOS">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">noiseGate</div>
                    <div class="data-value" id="noiseGate">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">volumeMultiplier</div>
                    <div class="data-value highlight" id="volumeMultiplier">-</div>
                </div>
            </div>
        </div>

        <!-- Èü≥Èáè„Éê„Éº -->
        <div class="section">
            <div class="section-title">üéµ Èü≥ÈáèË°®Á§∫</div>
            <div class="volume-bar-container">
                <div class="volume-bar" id="volumeBar"></div>
            </div>
            <div class="volume-text" id="volumeText">0.0%</div>
        </div>

        <!-- „É™„Ç¢„É´„Çø„Ç§„É†„Éá„Éº„Çø -->
        <div class="section">
            <div class="section-title">üìä „É™„Ç¢„É´„Çø„Ç§„É†„Éá„Éº„Çø</div>
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-label">rawVolume (ÁîüRMS)</div>
                    <div class="data-value" id="rawVolume">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Âá¶ÁêÜÂæå volume</div>
                    <div class="data-value" id="processedVolume">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Âë®Ê≥¢Êï∞</div>
                    <div class="data-value" id="frequency">-</div>
                </div>
                <div class="data-item">
                    <div class="data-label">Èü≥Á®ã</div>
                    <div class="data-value" id="note">-</div>
                </div>
            </div>

            <!-- Ë®àÁÆóÈÅéÁ®ã -->
            <div class="calculation" id="calculationDisplay">
                <div class="calc-step">ÂæÖÊ©ü‰∏≠...</div>
            </div>
        </div>

        <!-- Êìç‰Ωú„Éú„Çø„É≥ -->
        <div class="section">
            <button class="btn btn-primary" id="startBtn" onclick="startDetection()">üé§ Ê§úÂá∫ÈñãÂßã</button>
            <button class="btn btn-secondary" id="stopBtn" onclick="stopDetection()" disabled>‚èπ Ê§úÂá∫ÂÅúÊ≠¢</button>
        </div>

        <!-- „É≠„Ç∞ -->
        <div class="section">
            <div class="section-title">üìù „É≠„Ç∞</div>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <script type="module">
        // UMD„Éì„É´„Éâ„Çí„Ç§„É≥„Éù„Éº„Éà
        const timestamp = Date.now();
        const script = document.createElement('script');
        script.src = `./dist/pitchpro.umd.js?t=${timestamp}`;
        script.onload = () => {
            log('success', `PitchPro ${window.PitchPro?.VERSION || 'unknown'} loaded`);
            initializeApp();
        };
        script.onerror = () => {
            log('error', 'PitchPro„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        };
        document.head.appendChild(script);

        let audioDetector = null;
        let isDetecting = false;

        function log(type, message) {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.insertBefore(entry, container.firstChild);

            // ÊúÄÂ§ß50‰ª∂
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        function initializeApp() {
            // DeviceDetection„Åã„Çâ„Éá„Éê„Ç§„ÇπÊÉÖÂ†±„ÇíÂèñÂæó
            const PitchPro = window.PitchPro;
            if (!PitchPro || !PitchPro.DeviceDetection) {
                log('error', 'DeviceDetection not available');
                return;
            }

            const specs = PitchPro.DeviceDetection.getDeviceSpecs();

            // „Éá„Éê„Ç§„ÇπÊÉÖÂ†±„ÇíË°®Á§∫
            document.getElementById('deviceType').textContent = specs.deviceType;
            document.getElementById('isIOS').textContent = specs.isIOS ? 'Yes' : 'No';
            document.getElementById('noiseGate').textContent = `${(specs.noiseGate * 100).toFixed(1)}%`;
            document.getElementById('volumeMultiplier').textContent = `${specs.volumeMultiplier}x`;

            log('info', `Device: ${specs.deviceType}, iOS: ${specs.isIOS}`);
            log('info', `noiseGate: ${specs.noiseGate}, volumeMultiplier: ${specs.volumeMultiplier}`);

            // volumeMultiplier„ÅåÈ´ò„Åô„Åé„ÇãË≠¶Âëä
            if (specs.volumeMultiplier > 5) {
                log('warn', `‚ö†Ô∏è volumeMultiplier„ÅåÈ´ò„ÅÑÂÄ§„Åß„Åô: ${specs.volumeMultiplier}x`);
                document.getElementById('volumeMultiplier').classList.add('warning');
            }
        }

        window.startDetection = async function() {
            const PitchPro = window.PitchPro;
            if (!PitchPro) {
                log('error', 'PitchPro not loaded');
                return;
            }

            try {
                log('info', 'ÂàùÊúüÂåñÈñãÂßã...');

                audioDetector = new PitchPro.AudioDetectionComponent({
                    volumeBarSelector: '#volumeBar',
                    volumeTextSelector: '#volumeText',
                    autoUpdateUI: true,
                    deviceOptimization: true,
                    debug: false
                });

                await audioDetector.initialize();
                log('success', 'ÂàùÊúüÂåñÂÆå‰∫Ü');

                // „Éá„Éê„Ç§„ÇπË®≠ÂÆö„ÇíÂÜçÁ¢∫Ë™ç
                const status = audioDetector.getStatus();
                if (status.deviceSpecs) {
                    log('info', `ÂÆüÈöõ„ÅÆË®≠ÂÆö - noiseGate: ${status.deviceSpecs.noiseGate}, volumeMultiplier: ${status.deviceSpecs.volumeMultiplier}`);
                }

                // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØË®≠ÂÆö
                audioDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        updateDisplay(result);
                    },
                    onError: (error) => {
                        log('error', `Error: ${error.message}`);
                    }
                });

                const started = await audioDetector.startDetection();
                if (started) {
                    isDetecting = true;
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    log('success', 'Ê§úÂá∫ÈñãÂßã');
                } else {
                    log('error', 'Ê§úÂá∫ÈñãÂßã„Å´Â§±Êïó');
                }

            } catch (error) {
                log('error', `ÂàùÊúüÂåñ„Ç®„É©„Éº: ${error.message}`);
            }
        };

        window.stopDetection = function() {
            if (audioDetector) {
                audioDetector.stopDetection();
                isDetecting = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                log('info', 'Ê§úÂá∫ÂÅúÊ≠¢');
            }
        };

        function updateDisplay(result) {
            // Áîü„Éá„Éº„Çø„Å®Âá¶ÁêÜÂæå„Éá„Éº„Çø„ÇíË°®Á§∫
            const rawVol = result.rawVolume !== undefined ? result.rawVolume : 'N/A';
            const processedVol = result.volume;

            document.getElementById('rawVolume').textContent =
                typeof rawVol === 'number' ? rawVol.toFixed(4) : rawVol;
            document.getElementById('processedVolume').textContent =
                `${processedVol.toFixed(1)}%`;
            document.getElementById('frequency').textContent =
                result.frequency > 0 ? `${result.frequency.toFixed(1)} Hz` : '-';
            document.getElementById('note').textContent =
                result.note || '-';

            // Ë®àÁÆóÈÅéÁ®ã„ÇíË°®Á§∫
            const specs = window.PitchPro?.DeviceDetection?.getDeviceSpecs();
            if (specs && typeof rawVol === 'number') {
                const RMS_TO_PERCENT = 200;
                const volumeAsPercent = rawVol * RMS_TO_PERCENT;
                const noiseGateThreshold = specs.noiseGate * 100 * 2.0;
                const finalVolume = volumeAsPercent * specs.volumeMultiplier;

                const calcHtml = `
                    <div class="calc-step">1. rawVolume: ${rawVol.toFixed(4)}</div>
                    <div class="calc-step">2. √ó 200 = ${volumeAsPercent.toFixed(2)}%</div>
                    <div class="calc-step">3. noiseGateÈñæÂÄ§: ${noiseGateThreshold.toFixed(2)}%</div>
                    <div class="calc-step">4. √ó ${specs.volumeMultiplier} = ${finalVolume.toFixed(2)}%</div>
                    <div class="calc-step calc-result">‚Üí ÊúÄÁµÇ: ${Math.min(100, finalVolume).toFixed(1)}%</div>
                `;
                document.getElementById('calculationDisplay').innerHTML = calcHtml;
            }

            // 100%Âà∞ÈÅîË≠¶Âëä
            if (processedVol >= 100) {
                document.getElementById('processedVolume').classList.add('warning');
            } else {
                document.getElementById('processedVolume').classList.remove('warning');
            }
        }
    </script>
</body>
</html>
