(function($,Ne){typeof exports=="object"&&typeof module<"u"?Ne(exports):typeof define=="function"&&define.amd?define(["exports"],Ne):($=typeof globalThis<"u"?globalThis:$||self,Ne($.PitchPro={}))})(this,function($){"use strict";var od=Object.defineProperty;var ad=($,Ne,ot)=>Ne in $?od($,Ne,{enumerable:!0,configurable:!0,writable:!0,value:ot}):$[Ne]=ot;var Ge=($,Ne,ot)=>ad($,typeof Ne!="symbol"?Ne+"":Ne,ot);const Ne="1.3.1",ot=`PitchPro v${Ne}`,Xr=new Date().toISOString(),ue=class ue{static getDeviceSpecs(){if(ue.cachedSpecs)return ue.cachedSpecs;if(typeof window>"u"||typeof navigator>"u")return ue.getDefaultSpecs();const e=navigator.userAgent,t=ue.analyzeUserAgent(e);return ue.cachedSpecs=t,console.log("📱 [DeviceDetection] Device analysis:",{userAgent:e.substring(0,100)+"...",deviceType:t.deviceType,isIOS:t.isIOS,sensitivity:t.sensitivity,divisor:t.divisor}),t}static analyzeUserAgent(e){const t=/iPhone/.test(e),n=/iPad/.test(e),s=/Macintosh/.test(e)&&"ontouchend"in document,r=/iPad|iPhone|iPod/.test(e),o=/iPad|iPhone|iPod/.test(navigator.platform||""),a=t||n||s||r||o;let c="PC";t?c="iPhone":n||s?c="iPad":a&&(c=ue.detectIOSDeviceType());const l=ue.getDeviceOptimizations(c,a);return{deviceType:c,isIOS:a,sensitivity:l.sensitivity,noiseGate:l.noiseGate,volumeMultiplier:l.volumeMultiplier,smoothingFactor:l.smoothingFactor,divisor:6,gainCompensation:1,noiseThreshold:7}}static detectIOSDeviceType(){const e=window.screen.width,t=window.screen.height,n=Math.max(e,t),s=Math.min(e,t);return n>=768||n>=700&&s>=500?"iPad":"iPhone"}static getDeviceOptimizations(e,t){switch(e){case"iPad":return{sensitivity:4,noiseGate:.023,volumeMultiplier:4,smoothingFactor:.25};case"iPhone":return{sensitivity:3.5,noiseGate:.028,volumeMultiplier:3,smoothingFactor:.25};case"PC":default:return{sensitivity:1.7,noiseGate:.023,volumeMultiplier:2.5,smoothingFactor:.25}}}static getDefaultSpecs(){return{deviceType:"PC",isIOS:!1,sensitivity:1.7,noiseGate:.06,volumeMultiplier:3,smoothingFactor:.25,divisor:6,gainCompensation:1,noiseThreshold:7}}static supportsWebAudio(){return typeof window<"u"&&(typeof window.AudioContext<"u"||typeof window.webkitAudioContext<"u")}static supportsMediaDevices(){return typeof navigator<"u"&&typeof navigator.mediaDevices<"u"&&typeof navigator.mediaDevices.getUserMedia<"u"}static supportsMediaRecorder(){return typeof window<"u"&&typeof window.MediaRecorder<"u"}static getDeviceCapabilities(){return{deviceSpecs:ue.getDeviceSpecs(),webAudioSupport:ue.supportsWebAudio(),mediaDevicesSupport:ue.supportsMediaDevices(),mediaRecorderSupport:ue.supportsMediaRecorder(),touchSupport:"ontouchend"in document,userAgent:typeof navigator<"u"?navigator.userAgent:"Unknown",screenSize:typeof window<"u"?{width:window.screen.width,height:window.screen.height,pixelRatio:window.devicePixelRatio}:null,language:typeof navigator<"u"?navigator.language:"Unknown",platform:typeof navigator<"u"&&navigator.platform||"Unknown"}}static isMobile(){return ue.getDeviceSpecs().isIOS||/Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test((navigator==null?void 0:navigator.userAgent)||"")}static isTablet(){if(ue.getDeviceSpecs().deviceType==="iPad")return!0;const t=(navigator==null?void 0:navigator.userAgent)||"";return/Android/i.test(t)&&!/Mobile/i.test(t)}static isDesktop(){return!ue.isMobile()&&!ue.isTablet()}static getOptimalAudioConstraints(){const e=ue.getDeviceSpecs(),t={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:44100,channelCount:1,sampleSize:16,deviceId:{ideal:"default"}}};return e.isIOS&&t.audio&&typeof t.audio=="object"&&(t.audio={...t.audio,googAutoGainControl:!1,googNoiseSuppression:!1,googEchoCancellation:!1,googHighpassFilter:!1,googTypingNoiseDetection:!1,googBeamforming:!1,mozAutoGainControl:!1,mozNoiseSuppression:!1}),t}static clearCache(){ue.cachedSpecs=null}static getDebugInfo(){return{...ue.getDeviceCapabilities(),detectionMethods:{userAgentIPhone:/iPhone/.test((navigator==null?void 0:navigator.userAgent)||""),userAgentIPad:/iPad/.test((navigator==null?void 0:navigator.userAgent)||""),userAgentMacintosh:/Macintosh/.test((navigator==null?void 0:navigator.userAgent)||""),touchSupport:"ontouchend"in document,navigatorPlatform:(navigator==null?void 0:navigator.platform)||"Unknown",screenAspectRatio:typeof window<"u"?(window.screen.width/window.screen.height).toFixed(2):"Unknown"}}}};ue.cachedSpecs=null;let mt=ue;var gt=(i=>(i.AUDIO_CONTEXT_ERROR="AUDIO_CONTEXT_ERROR",i.MICROPHONE_ACCESS_DENIED="MICROPHONE_ACCESS_DENIED",i.PITCH_DETECTION_ERROR="PITCH_DETECTION_ERROR",i.BUFFER_OVERFLOW="BUFFER_OVERFLOW",i.INVALID_SAMPLE_RATE="INVALID_SAMPLE_RATE",i.DEVICE_NOT_SUPPORTED="DEVICE_NOT_SUPPORTED",i.PROCESSING_TIMEOUT="PROCESSING_TIMEOUT",i))(gt||{});class Ce extends Error{constructor(e,t,n){super(e),this.name="PitchProError",this.code=t,this.timestamp=new Date,this.context=n,Error.captureStackTrace&&Error.captureStackTrace(this,Ce)}toJSON(){return{name:this.name,message:this.message,code:this.code,timestamp:this.timestamp,context:this.context,stack:this.stack}}}class at extends Ce{constructor(e,t){super(e,"AUDIO_CONTEXT_ERROR",t),this.name="AudioContextError"}}class hs extends Ce{constructor(e,t){super(e,"MICROPHONE_ACCESS_DENIED",t),this.name="MicrophoneAccessError"}}class di extends Ce{constructor(e,t,n,s){super(e,"MICROPHONE_ACCESS_DENIED",{healthStatus:t,recoveryAttempts:n,timestamp:Date.now(),...s}),this.name="MicrophoneHealthError"}getHealthStatus(){var e;return(e=this.context)==null?void 0:e.healthStatus}getRecoveryAttempts(){var e;return(e=this.context)==null?void 0:e.recoveryAttempts}}class fi extends Ce{constructor(e,t){super(e,"PITCH_DETECTION_ERROR",t),this.name="PitchDetectionError"}}function pi(i){return["BUFFER_OVERFLOW","PROCESSING_TIMEOUT","PITCH_DETECTION_ERROR"].includes(i.code)}class Ie{static getUserFriendlyMessage(e){switch(e.code){case"MICROPHONE_ACCESS_DENIED":return{title:"マイクアクセスが拒否されました",message:"ピッチ検出を行うには、マイクへのアクセス許可が必要です。",actions:["ブラウザのアドレスバーにあるマイクアイコンをクリック","「このサイトでマイクを許可する」を選択","ページを再読み込みしてもう一度試す","プライベートブラウジングモードを無効にする（Safariの場合）"],severity:"high",canRetry:!0};case"AUDIO_CONTEXT_ERROR":return{title:"オーディオシステムエラー",message:"オーディオの初期化に失敗しました。デバイスの音響設定を確認してください。",actions:["他のアプリケーションでマイクが使用中でないか確認","ブラウザを再起動してもう一度試す","システムの音響設定でマイクが有効になっているか確認","外部マイクを使用している場合は接続を確認"],severity:"high",canRetry:!0};case"PITCH_DETECTION_ERROR":return{title:"ピッチ検出エラー",message:"音程の検出中に一時的な問題が発生しました。",actions:["マイクに向かって明確に歌ってみる","周囲のノイズを減らす","感度設定を調整する","数秒待ってからもう一度試す"],severity:"medium",canRetry:!0};case"BUFFER_OVERFLOW":return{title:"バッファオーバーフロー",message:"オーディオデータの処理が追いついていません。",actions:["他のタブやアプリケーションを閉じる","ブラウザのハードウェアアクセラレーションを有効にする","より高性能なデバイスを使用する","ページを再読み込みする"],severity:"medium",canRetry:!0};case"PROCESSING_TIMEOUT":return{title:"処理タイムアウト",message:"オーディオ処理の応答時間が長すぎます。",actions:["デバイスの負荷を減らす（他のアプリを閉じる）","ネットワーク接続を確認する","ブラウザを再起動する","しばらく待ってからもう一度試す"],severity:"medium",canRetry:!0};case"INVALID_SAMPLE_RATE":return{title:"サンプリングレート不適合",message:"お使いのデバイスのサンプリングレートがサポートされていません。",actions:["システムの音響設定で44.1kHz または 48kHzに設定","外部オーディオインターフェースの設定を確認","デバイスドライバを更新","別のマイクを試す"],severity:"high",canRetry:!1};case"DEVICE_NOT_SUPPORTED":return{title:"デバイス非対応",message:"お使いのデバイスまたはブラウザはサポートされていません。",actions:["Chrome、Firefox、Safari の最新版を使用","より新しいデバイスを使用","ブラウザの互換性情報を確認","技術サポートにお問い合わせ"],severity:"critical",canRetry:!1};default:return{title:"予期しないエラー",message:"システムで予期しない問題が発生しました。",actions:["ページを再読み込み","ブラウザを再起動","しばらく時間をおいて再試行","問題が続く場合はサポートへ連絡"],severity:"medium",canRetry:!0}}}static getTechnicalDetails(e){return{errorCode:e.code,timestamp:e.timestamp.toISOString(),context:e.context||{},stackTrace:e.stack,diagnosticInfo:{userAgent:typeof navigator<"u"?navigator.userAgent:"unknown",timestamp:Date.now(),url:typeof window<"u"?window.location.href:"unknown",isRecoverable:pi(e)}}}static logError(e,t){const n=this.getUserFriendlyMessage(e),s=this.getTechnicalDetails(e);console.group(`🚨 [PitchPro Error] ${n.title}`),console.log("👤 User Message:",n.message),console.log("📋 Suggested Actions:",n.actions),console.log("⚠️ Severity:",n.severity),console.log("🔄 Can Retry:",n.canRetry),console.log("🔧 Error Code:",s.errorCode),console.log("⏰ Timestamp:",s.timestamp),t&&console.log("📍 Context:",t),s.context&&Object.keys(s.context).length>0&&console.log("🔍 Additional Context:",s.context),s.stackTrace&&console.log("📜 Stack Trace:",s.stackTrace),console.groupEnd()}static getRecoveryStrategy(e,t){const n=this.getUserFriendlyMessage(e),s=n.actions.slice(0,2),r=n.actions.slice(2);let o=[];return t==="iPhone"||t==="iPad"?o=["感度を高めに設定（7.0x推奨）","Safari使用を推奨","iOS 14以上で使用","低電力モードを無効にする"]:t==="Android"?o=["Chrome使用を推奨","バックグラウンドアプリを制限","省電力モードを無効にする","マイク権限を常に許可に設定"]:o=["安定したネットワーク環境で使用","ブラウザを最新版に更新","ハードウェアアクセラレーションを有効化","外部ノイズの少ない環境で使用"],{immediate:s,fallback:r,preventive:o}}}class mi{constructor(e={}){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.gainNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null,this.gainMonitorInterval=null,this.isMuted=!1,console.log("🔍 [DIAGNOSTIC] AudioManager constructor - input config:",e),this.config={sampleRate:44100,channelCount:1,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,latency:.1,...e},console.log("🔍 [DIAGNOSTIC] AudioManager constructor - final config:",this.config),console.log("🔍 [DIAGNOSTIC] autoGainControl value after merge:",this.config.autoGainControl),this.currentSensitivity=this._getDefaultSensitivity()}_getDefaultSensitivity(){const e=mt.getDeviceSpecs();return console.log(`🔧 [AudioManager] ${e.deviceType} detected - setting default sensitivity ${e.sensitivity}x`),e.sensitivity}async initialize(){var e,t,n;if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream){const s=this.checkMediaStreamHealth();if(s.healthy)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};console.warn("⚠️ [AudioManager] Unhealthy MediaStream detected - force re-initialization:",s),console.log("🔄 [AudioManager] Unhealthy MediaStream details:",{mediaStreamActive:(e=this.mediaStream)==null?void 0:e.active,trackCount:(t=this.mediaStream)==null?void 0:t.getTracks().length,trackStates:(n=this.mediaStream)==null?void 0:n.getTracks().map(r=>({kind:r.kind,readyState:r.readyState,enabled:r.enabled,muted:r.muted}))}),this._cleanup(),this.isInitialized=!1,this.refCount=0,await new Promise(r=>setTimeout(r,100)),console.log("🔄 [AudioManager] Cleanup complete - starting re-initialization")}this.initPromise=this._doInitialize();try{const s=await this.initPromise;return this.initPromise=null,s}catch(s){throw this.initPromise=null,s}}async _doInitialize(){try{if(console.log("🎤 [AudioManager] Starting initialization"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("✅ [AudioManager] AudioContext creation complete")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("✅ [AudioManager] AudioContext resume complete")),!this.mediaStream){const e=this.getPlatformSpecs();console.log(`🔍 [AudioManager] Device detection: ${e.deviceType}`,navigator.userAgent),console.log(`🔍 [AudioManager] Touch support: ${"ontouchend"in document}`),console.log("🔍 [DIAGNOSTIC] Device specs from getPlatformSpecs():",e),console.log("🔍 [DIAGNOSTIC] Current this.config before constraints creation:",this.config);const t={audio:{echoCancellation:this.config.echoCancellation,noiseSuppression:this.config.noiseSuppression,autoGainControl:this.config.autoGainControl,...window.chrome&&{googAutoGainControl:!1,googNoiseSuppression:this.config.noiseSuppression,googEchoCancellation:this.config.echoCancellation,googHighpassFilter:!1,googTypingNoiseDetection:this.config.noiseSuppression,googBeamforming:this.config.noiseSuppression},...navigator.userAgent.includes("Firefox")&&{mozAutoGainControl:!1,mozNoiseSuppression:this.config.noiseSuppression},sampleRate:this.config.sampleRate,channelCount:this.config.channelCount,sampleSize:16,deviceId:{ideal:"default"}}};console.log("🎤 [AudioManager] Getting MediaStream with noiseSuppression settings:",{noiseSuppression:this.config.noiseSuppression,constraints:t}),this.mediaStream=await navigator.mediaDevices.getUserMedia(t),console.log("✅ [AudioManager] MediaStream acquisition complete");const n=this.mediaStream.getAudioTracks()[0];if(n&&typeof n.getConstraints=="function"&&typeof n.getSettings=="function")try{const s=n.getConstraints(),r=n.getSettings();console.log("🔍 [DIAGNOSTIC] Requested noiseSuppression:",this.config.noiseSuppression),console.log("🔍 [DIAGNOSTIC] Actually applied constraints:",s),console.log("🔍 [DIAGNOSTIC] Actual MediaStream settings:",r),r.noiseSuppression!==this.config.noiseSuppression?(console.warn("⚠️ [DIAGNOSTIC] noiseSuppression setting mismatch!"),console.warn(`⚠️ [DIAGNOSTIC] Requested: ${this.config.noiseSuppression}, Applied: ${r.noiseSuppression}`)):console.log("✅ [DIAGNOSTIC] noiseSuppression successfully applied by browser"),r.autoGainControl===!0?(console.warn("⚠️ [DIAGNOSTIC] CRITICAL: Browser ignored autoGainControl: false setting!"),console.warn("⚠️ [DIAGNOSTIC] This explains the gain drift issues - browser is automatically adjusting gain")):console.log("✅ [DIAGNOSTIC] autoGainControl successfully disabled by browser")}catch{console.log("ℹ️ [DIAGNOSTIC] MediaTrack constraint inspection not available in this environment")}else console.log("ℹ️ [DIAGNOSTIC] MediaTrack constraint inspection not supported in this environment")}if(!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("✅ [AudioManager] SourceNode creation complete");const e=this.mediaStream.getTracks();console.log("🎤 [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.gainNode||(this.gainNode=this.audioContext.createGain(),this.gainNode.gain.setValueAtTime(this.currentSensitivity,this.audioContext.currentTime),this.sourceNode.connect(this.gainNode),console.log(`✅ [AudioManager] GainNode creation complete (sensitivity: ${this.currentSensitivity}x)`)),this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`🎤 [AudioManager] Initialization complete (refCount: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){const t=this._createStructuredError(e,"initialization");throw Ie.logError(t,"AudioManager initialization"),this.lastError=t,this.isInitialized=!1,this._cleanup(),t}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode){const h=new at("AudioManagerが初期化されていません。initialize()メソッドを最初に呼び出してください。",{operation:"createAnalyser",analyserId:e,currentState:{isInitialized:this.isInitialized,hasAudioContext:!!this.audioContext,hasSourceNode:!!this.sourceNode}});throw Ie.logError(h,"Analyser creation"),h}this.removeAnalyser(e);const{fftSize:n=2048,smoothingTimeConstant:s=.8,minDecibels:r=-90,maxDecibels:o=-10,useFilters:a=!0}=t,c=this.audioContext.createAnalyser();c.fftSize=Math.min(n,2048),c.smoothingTimeConstant=Math.max(s,.7),c.minDecibels=Math.max(r,-80),c.maxDecibels=Math.min(o,-10);let l=this.gainNode||this.sourceNode;if(a){const h=this._createFilterChain();this.filters.set(e,h),l.connect(h.highpass),h.highpass.connect(h.lowpass),h.lowpass.connect(h.notch),h.notch.connect(c),console.log(`🔧 [AudioManager] Filtered Analyser created: ${e}`)}else l.connect(c),console.log(`🔧 [AudioManager] Raw signal Analyser created: ${e}`);return this.analysers.set(e,c),c}_createFilterChain(){if(!this.audioContext){const s=new at("AudioContextが利用できません。ブラウザでオーディオ機能が無効になっているか、デバイスがサポートされていません。",{operation:"_createFilterChain",audioContextState:"null"});throw Ie.logError(s,"Filter chain creation"),s}const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(50,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const n=this.audioContext.createBiquadFilter();return n.type="notch",n.frequency.setValueAtTime(50,this.audioContext.currentTime),n.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:n}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`🗑️ [AudioManager] Analyser removed: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`🗑️ [AudioManager] Filter chain removed: ${e}`)}}async _verifyGainChange(e,t=200,n=20){const s=Date.now();for(;Date.now()-s<t;){if(this.gainNode&&Math.abs(this.gainNode.gain.value-e)<=.1)return!0;await new Promise(r=>setTimeout(r,n))}return!1}setSensitivity(e){var n;const t=Math.max(.1,Math.min(10,e));this.gainNode?(this.gainNode.gain.setValueAtTime(t,((n=this.audioContext)==null?void 0:n.currentTime)||0),this.currentSensitivity=t,(async()=>{var r;if(await this._verifyGainChange(t))console.log(`✅ [AudioManager] Gain setting verified: ${(r=this.gainNode)==null?void 0:r.gain.value.toFixed(1)}x (expected: ${t.toFixed(1)}x)`);else if(this.gainNode){const o=this.gainNode.gain.value;console.warn("⚠️ [AudioManager] ゲイン検証失敗 (機能継続):",{期待値:`${t}x`,実際値:`${o}x`,差分:Math.abs(o-t).toFixed(2),理由:"ブラウザのautoGainControl制御による制限",影響:"音量計算には影響なし（動的SCALING_FACTOR使用）",状態:"正常動作中"})}})(),console.log(`🎤 [AudioManager] Microphone sensitivity updated: ${t.toFixed(1)}x`)):(this.currentSensitivity=t,console.log(`🎤 [AudioManager] Microphone sensitivity set (awaiting initialization): ${t.toFixed(1)}x`))}getSensitivity(){return this.currentSensitivity}mute(){if(!this.mediaStream){console.warn("⚠️ [AudioManager] Cannot mute, MediaStream is not available.");return}this.mediaStream.getAudioTracks().forEach(e=>{e.enabled=!1}),this.isMuted=!0,console.log("🔇 [AudioManager] Microphone muted.")}unmute(){if(!this.mediaStream){console.warn("⚠️ [AudioManager] Cannot unmute, MediaStream is not available.");return}this.mediaStream.getAudioTracks().forEach(e=>{e.enabled=!0}),this.isMuted=!1,console.log("🔊 [AudioManager] Microphone unmuted.")}getIsMuted(){return this.isMuted}stopGainMonitoring(){this.gainMonitorInterval&&(clearInterval(this.gainMonitorInterval),this.gainMonitorInterval=null)}getPlatformSpecs(){const e=mt.getDeviceSpecs();return{...e,sensitivity:this.currentSensitivity||e.sensitivity}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`📉 [AudioManager] Reference count decremented: ${this.refCount}`),this.refCount<=0&&(console.log("🧹 [AudioManager] Starting full resource cleanup"),this._cleanup())}forceCleanup(){console.log("🚨 [AudioManager] Force cleanup executed"),this._cleanup()}_cleanup(){var e;console.log("🧹 [AudioManager] Starting cleanup"),this.stopGainMonitoring();for(const t of this.analysers.keys())this.removeAnalyser(t);if(this.mediaStream){const t=this.mediaStream.getTracks();console.log(`🛑 [AudioManager] Stopping MediaStream: ${t.length} tracks`),t.forEach((n,s)=>{try{n.readyState!=="ended"?(n.stop(),console.log(`🛑 [AudioManager] Track ${s} stop complete`)):console.log(`⚠️ [AudioManager] Track ${s} already ended`)}catch(r){const o=new Ce(`メディアトラック ${s} の停止中にエラーが発生しました: ${r.message}`,gt.AUDIO_CONTEXT_ERROR,{operation:"track_cleanup",trackIndex:s,originalError:r.message,trackState:n.readyState});Ie.logError(o,"Media track cleanup")}}),this.mediaStream=null}if(this.audioContext&&this.audioContext.state!=="closed"){try{this.audioContext.close(),console.log("🛑 [AudioManager] AudioContext close complete")}catch(t){const n=new at(`AudioContextの終了中にエラーが発生しました: ${t.message}`,{operation:"audioContext_cleanup",contextState:(e=this.audioContext)==null?void 0:e.state,originalError:t.message});Ie.logError(n,"AudioContext cleanup")}this.audioContext=null}this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,this.currentSensitivity=this._getDefaultSensitivity(),console.log("✅ [AudioManager] Cleanup complete")}_createStructuredError(e,t){var n,s;return e.message.includes("Permission denied")||e.message.includes("NotAllowedError")||e.message.includes("permission")?new hs("マイクへのアクセス許可が拒否されました。ブラウザの設定でマイクアクセスを許可してください。",{operation:t,originalError:e.message,deviceSpecs:this.getPlatformSpecs(),userAgent:typeof navigator<"u"?navigator.userAgent:"unknown"}):e.message.includes("AudioContext")||e.message.includes("audio")||e.message.includes("context")?new at("オーディオシステムの初期化に失敗しました。デバイスの音響設定を確認するか、ブラウザを再起動してください。",{operation:t,originalError:e.message,audioContextState:((n=this.audioContext)==null?void 0:n.state)||"none",sampleRate:((s=this.audioContext)==null?void 0:s.sampleRate)||"unknown",deviceSpecs:this.getPlatformSpecs()}):new Ce(`${t}中に予期しないエラーが発生しました: ${e.message}`,gt.AUDIO_CONTEXT_ERROR,{operation:t,originalError:e.message,stack:e.stack,currentState:{isInitialized:this.isInitialized,refCount:this.refCount,hasResources:!!(this.audioContext&&this.mediaStream&&this.sourceNode)}})}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError,currentSensitivity:this.currentSensitivity}}checkMediaStreamHealth(){var s,r,o,a,c,l,h,u;if(!this.mediaStream)return{mediaStreamActive:!1,audioContextState:((s=this.audioContext)==null?void 0:s.state)||"none",trackStates:[],healthy:!1};if(!this.mediaStream.active)return{mediaStreamActive:!1,audioContextState:((r=this.audioContext)==null?void 0:r.state)||"none",trackStates:[],healthy:!1};const e=this.mediaStream.getTracks();if(e.length===0)return{mediaStreamActive:this.mediaStream.active,audioContextState:((o=this.audioContext)==null?void 0:o.state)||"none",trackStates:[],healthy:!1};const t=e.find(d=>d.kind==="audio");if(!t)return{mediaStreamActive:this.mediaStream.active,audioContextState:((a=this.audioContext)==null?void 0:a.state)||"none",trackStates:e.map(d=>({kind:d.kind,enabled:d.enabled,readyState:d.readyState,muted:d.muted})),healthy:!1};const n=e.map(d=>({kind:d.kind,enabled:d.enabled,readyState:d.readyState,muted:d.muted}));return t.readyState==="ended"?{mediaStreamActive:this.mediaStream.active,audioContextState:((c=this.audioContext)==null?void 0:c.state)||"none",trackStates:n,healthy:!1}:t.muted?{mediaStreamActive:this.mediaStream.active,audioContextState:((l=this.audioContext)==null?void 0:l.state)||"none",trackStates:n,healthy:!1}:this.mediaStream.active&&t.readyState!=="live"?{mediaStreamActive:this.mediaStream.active,audioContextState:((h=this.audioContext)==null?void 0:h.state)||"none",trackStates:n,healthy:!1}:{mediaStreamActive:this.mediaStream.active,audioContextState:((u=this.audioContext)==null?void 0:u.state)||"none",trackStates:n,healthy:!0,refCount:this.refCount}}}function Yr(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function ke(i){if(this.size=i|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=i<<1;for(var e=new Array(this.size*2),t=0;t<e.length;t+=2){const c=Math.PI*t/this.size;e[t]=Math.cos(c),e[t+1]=-Math.sin(c)}this.table=e;for(var n=0,s=1;this.size>s;s<<=1)n++;this._width=n%2===0?n-1:n,this._bitrev=new Array(1<<this._width);for(var r=0;r<this._bitrev.length;r++){this._bitrev[r]=0;for(var o=0;o<this._width;o+=2){var a=this._width-o-2;this._bitrev[r]|=(r>>>o&3)<<a}}this._out=null,this._data=null,this._inv=0}var Zr=ke;ke.prototype.fromComplexArray=function(e,t){for(var n=t||new Array(e.length>>>1),s=0;s<e.length;s+=2)n[s>>>1]=e[s];return n},ke.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var t=0;t<e.length;t++)e[t]=0;return e},ke.prototype.toComplexArray=function(e,t){for(var n=t||this.createComplexArray(),s=0;s<n.length;s+=2)n[s]=e[s>>>1],n[s+1]=0;return n},ke.prototype.completeSpectrum=function(e){for(var t=this._csize,n=t>>>1,s=2;s<n;s+=2)e[t-s]=e[s],e[t-s+1]=-e[s+1]},ke.prototype.transform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null},ke.prototype.realTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null},ke.prototype.inverseTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(var n=0;n<e.length;n++)e[n]/=this.size;this._out=null,this._data=null},ke.prototype._transform4=function(){var e=this._out,t=this._csize,n=this._width,s=1<<n,r=t/s<<1,o,a,c=this._bitrev;if(r===4)for(o=0,a=0;o<t;o+=r,a++){const m=c[a];this._singleTransform2(o,m,s)}else for(o=0,a=0;o<t;o+=r,a++){const m=c[a];this._singleTransform4(o,m,s)}var l=this._inv?-1:1,h=this.table;for(s>>=2;s>=2;s>>=2){r=t/s<<1;var u=r>>>2;for(o=0;o<t;o+=r)for(var d=o+u,f=o,p=0;f<d;f+=2,p+=s){const m=f,g=m+u,_=g+u,T=_+u,b=e[m],C=e[m+1],y=e[g],S=e[g+1],w=e[_],v=e[_+1],x=e[T],E=e[T+1],M=b,A=C,I=h[p],N=l*h[p+1],R=y*I-S*N,D=y*N+S*I,F=h[2*p],B=l*h[2*p+1],P=w*F-v*B,L=w*B+v*F,V=h[3*p],Q=l*h[3*p+1],ge=x*V-E*Q,_e=x*Q+E*V,U=M+P,X=A+L,le=M-P,O=A-L,Le=R+ge,Re=D+_e,Be=l*(R-ge),je=l*(D-_e),sn=U+Le,An=X+Re,k=U-Le,q=X-Re,oe=le+je,J=O-Be,H=le-je,ee=O+Be;e[m]=sn,e[m+1]=An,e[g]=oe,e[g+1]=J,e[_]=k,e[_+1]=q,e[T]=H,e[T+1]=ee}}},ke.prototype._singleTransform2=function(e,t,n){const s=this._out,r=this._data,o=r[t],a=r[t+1],c=r[t+n],l=r[t+n+1],h=o+c,u=a+l,d=o-c,f=a-l;s[e]=h,s[e+1]=u,s[e+2]=d,s[e+3]=f},ke.prototype._singleTransform4=function(e,t,n){const s=this._out,r=this._data,o=this._inv?-1:1,a=n*2,c=n*3,l=r[t],h=r[t+1],u=r[t+n],d=r[t+n+1],f=r[t+a],p=r[t+a+1],m=r[t+c],g=r[t+c+1],_=l+f,T=h+p,b=l-f,C=h-p,y=u+m,S=d+g,w=o*(u-m),v=o*(d-g),x=_+y,E=T+S,M=b+v,A=C-w,I=_-y,N=T-S,R=b-v,D=C+w;s[e]=x,s[e+1]=E,s[e+2]=M,s[e+3]=A,s[e+4]=I,s[e+5]=N,s[e+6]=R,s[e+7]=D},ke.prototype._realTransform4=function(){var e=this._out,t=this._csize,n=this._width,s=1<<n,r=t/s<<1,o,a,c=this._bitrev;if(r===4)for(o=0,a=0;o<t;o+=r,a++){const ui=c[a];this._singleRealTransform2(o,ui>>>1,s>>>1)}else for(o=0,a=0;o<t;o+=r,a++){const ui=c[a];this._singleRealTransform4(o,ui>>>1,s>>>1)}var l=this._inv?-1:1,h=this.table;for(s>>=2;s>=2;s>>=2){r=t/s<<1;var u=r>>>1,d=u>>>1,f=d>>>1;for(o=0;o<t;o+=r)for(var p=0,m=0;p<=f;p+=2,m+=s){var g=o+p,_=g+d,T=_+d,b=T+d,C=e[g],y=e[g+1],S=e[_],w=e[_+1],v=e[T],x=e[T+1],E=e[b],M=e[b+1],A=C,I=y,N=h[m],R=l*h[m+1],D=S*N-w*R,F=S*R+w*N,B=h[2*m],P=l*h[2*m+1],L=v*B-x*P,V=v*P+x*B,Q=h[3*m],ge=l*h[3*m+1],_e=E*Q-M*ge,U=E*ge+M*Q,X=A+L,le=I+V,O=A-L,Le=I-V,Re=D+_e,Be=F+U,je=l*(D-_e),sn=l*(F-U),An=X+Re,k=le+Be,q=O+sn,oe=Le-je;if(e[g]=An,e[g+1]=k,e[_]=q,e[_+1]=oe,p===0){var J=X-Re,H=le-Be;e[T]=J,e[T+1]=H;continue}if(p!==f){var ee=O,Pe=-Le,rt=X,Ot=-le,Mn=-l*sn,li=-l*je,hi=-l*Be,td=-l*Re,nd=ee+Mn,sd=Pe+li,id=rt+td,rd=Ot-hi,jr=o+d-p,Gr=o+u-p;e[jr]=nd,e[jr+1]=sd,e[Gr]=id,e[Gr+1]=rd}}}},ke.prototype._singleRealTransform2=function(e,t,n){const s=this._out,r=this._data,o=r[t],a=r[t+n],c=o+a,l=o-a;s[e]=c,s[e+1]=0,s[e+2]=l,s[e+3]=0},ke.prototype._singleRealTransform4=function(e,t,n){const s=this._out,r=this._data,o=this._inv?-1:1,a=n*2,c=n*3,l=r[t],h=r[t+n],u=r[t+a],d=r[t+c],f=l+u,p=l-u,m=h+d,g=o*(h-d),_=f+m,T=p,b=-g,C=f-m,y=p,S=g;s[e]=_,s[e+1]=0,s[e+2]=T,s[e+3]=b,s[e+4]=C,s[e+5]=0,s[e+6]=y,s[e+7]=S};const Jr=Yr(Zr);class rn{constructor(e,t){Ge(this,"_inputLength");Ge(this,"_fft");Ge(this,"_bufferSupplier");Ge(this,"_paddedInputBuffer");Ge(this,"_transformBuffer");Ge(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new Jr(no(2*e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new rn(e,t=>new Float32Array(t))}static forFloat64Array(e){return new rn(e,t=>new Float64Array(t))}static forNumberArray(e){return new rn(e,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(e,t=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let s=0;s<e.length;s++)this._paddedInputBuffer[s]=e[s];for(let s=e.length;s<this._paddedInputBuffer.length;s++)this._paddedInputBuffer[s]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const n=this._transformBuffer;for(let s=0;s<n.length;s+=2)n[s]=n[s]*n[s]+n[s+1]*n[s+1],n[s+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let s=0;s<e.length;s++)t[s]=this._inverseBuffer[2*s];return t}}function Kr(i){const e=[];let t=!1,n=-1/0,s=-1;for(let r=1;r<i.length-1;r++)i[r-1]<=0&&i[r]>0?(t=!0,s=r,n=i[r]):i[r-1]>0&&i[r]<=0?(t=!1,s!==-1&&e.push(s)):t&&i[r]>n&&(n=i[r],s=r);return e}function eo(i,e){const[t,n,s]=[i-1,i,i+1],[r,o,a]=[e[t],e[n],e[s]],c=r/2-o+a/2,l=-(r/2)*(n+s)+o*(t+s)-a/2*(t+n),h=r*n*s/2-o*t*s+a*t*n/2,u=-l/(2*c),d=c*u*u+l*u+h;return[u,d]}let to=class ls{constructor(e,t){Ge(this,"_autocorrelator");Ge(this,"_nsdfBuffer");Ge(this,"_clarityThreshold",.9);Ge(this,"_minVolumeAbsolute",0);Ge(this,"_maxInputAmplitude",1);this._autocorrelator=new rn(e,t),this._nsdfBuffer=t(e)}static forFloat32Array(e){return new ls(e,t=>new Float32Array(t))}static forFloat64Array(e){return new ls(e,t=>new Float64Array(t))}static forNumberArray(e){return new ls(e,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,t){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const n=Kr(this._nsdfBuffer);if(n.length===0)return[0,0];const s=Math.max(...n.map(c=>this._nsdfBuffer[c])),r=n.find(c=>this._nsdfBuffer[c]>=this._clarityThreshold*s),[o,a]=eo(r,this._nsdfBuffer);return[t/o,Math.min(a,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let n=0;n<e.length;n++)t+=e[n]**2;return Math.sqrt(t/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],n;for(n=0;n<this._nsdfBuffer.length&&t>0;n++)this._nsdfBuffer[n]=2*this._nsdfBuffer[n]/t,t-=e[n]**2+e[e.length-n-1]**2;for(;n<this._nsdfBuffer.length;n++)this._nsdfBuffer[n]=0}};function no(i){return i--,i|=i>>1,i|=i>>2,i|=i>>4,i|=i>>8,i|=i>>16,i++,i}class so{constructor(e=45){this.lastFrameTime=0,this.nextFrameTime=0,this.frameDrops=0,this.MIN_FPS=30,this.MAX_FPS=60,this.OPTIMAL_FPS=45,this.targetFPS=Math.max(this.MIN_FPS,Math.min(e,this.MAX_FPS)),this.frameInterval=1e3/this.targetFPS}shouldProcess(){const e=performance.now();return this.nextFrameTime===0?(this.nextFrameTime=e+this.frameInterval,this.lastFrameTime=e,!0):e>=this.nextFrameTime?(e-this.lastFrameTime>this.frameInterval*1.5&&(this.frameDrops++,this.adjustFrameRate()),this.nextFrameTime=e+this.frameInterval,this.lastFrameTime=e,!0):!1}adjustFrameRate(){if(this.frameDrops>5&&this.targetFPS>this.MIN_FPS){this.targetFPS=Math.max(this.MIN_FPS,this.targetFPS-5),this.frameInterval=1e3/this.targetFPS,this.frameDrops=0;const e=performance.now();this.nextFrameTime=e+this.frameInterval,console.log(`Adjusted FPS to ${this.targetFPS} due to high load`)}}recoverPerformance(){if(this.frameDrops===0&&this.targetFPS<this.OPTIMAL_FPS){this.targetFPS=Math.min(this.OPTIMAL_FPS,this.targetFPS+5),this.frameInterval=1e3/this.targetFPS;const e=performance.now();this.nextFrameTime=e+this.frameInterval}}reset(){this.lastFrameTime=0,this.nextFrameTime=0,this.frameDrops=0,this.targetFPS=this.OPTIMAL_FPS,this.frameInterval=1e3/this.targetFPS}getStats(){return{currentFPS:this.targetFPS,frameDrops:this.frameDrops,latency:this.frameInterval}}}class gi{constructor(e,t={}){this.pitchDetector=null,this.analyser=null,this.rawAnalyser=null,this.animationFrame=null,this.componentState="uninitialized",this.isInitialized=!1,this.isDetecting=!1,this.lastError=null,this.analyserIds=[],this.currentVolume=0,this.rawVolume=0,this.currentFrequency=0,this.detectedNote="--",this.detectedOctave=null,this.pitchClarity=0,this.previousFrequency=0,this.harmonicHistory=[],this.disableHarmonicCorrection=!1,this.callbacks={},this.deviceSpecs=null,this.silenceStartTime=null,this.silenceWarningTimer=null,this.silenceTimeoutTimer=null,this.isSilent=!1,this.hasWarned=!1,this.audioManager=e,this.config={fftSize:4096,smoothing:.9,clarityThreshold:.4,minVolumeAbsolute:t.minVolumeAbsolute??.015,deviceOptimization:!0,...t},this.harmonicConfig={enabled:!0,confidenceThreshold:.7,historyWindow:1e3,frequencyThreshold:.1,...t.harmonicCorrection},this.volumeHistoryConfig={historyLength:10,useTypedArray:!0,...t.volumeHistory},this.disableHarmonicCorrection=!this.harmonicConfig.enabled,this.silenceDetectionConfig={enabled:!1,warningThreshold:15e3,timeoutThreshold:3e4,minVolumeThreshold:.01,...t.silenceDetection},this.frameRateLimiter=new so(45),console.log(`${ot} PitchDetector created with config:`,this.config)}setCallbacks(e){this.callbacks={...this.callbacks,...e}}async initialize(){var e,t,n,s,r;try{this.componentState="initializing",this.lastError=null,await this.audioManager.initialize(),this.deviceSpecs=this.audioManager.getPlatformSpecs();const o=`pitch-detector-filtered-${Date.now()}`;this.analyser=this.audioManager.createAnalyser(o,{fftSize:this.config.fftSize,smoothingTimeConstant:this.config.smoothing,minDecibels:-90,maxDecibels:-10,useFilters:!0}),this.analyserIds.push(o);const a=`pitch-detector-raw-${Date.now()}`;this.rawAnalyser=this.audioManager.createAnalyser(a,{fftSize:this.config.fftSize,smoothingTimeConstant:this.config.smoothing,minDecibels:-90,maxDecibels:-10,useFilters:!1}),this.analyserIds.push(a),this.pitchDetector=to.forFloat32Array(this.analyser.fftSize),typeof process<"u"&&((e=process.env)==null?void 0:e.NODE_ENV)==="development"&&console.log(`[Debug] Pitchyインスタンス作成: ${!!this.pitchDetector}, FFTサイズ: ${this.analyser.fftSize}`),this.componentState="ready",this.isInitialized=!0,(n=(t=this.callbacks).onStateChange)==null||n.call(t,this.componentState)}catch(o){const a=o instanceof Ce?o:new at("PitchDetector initialization failed",{originalError:o instanceof Error?o.message:String(o),audioContextState:this.audioManager.getStatus().audioContextState,deviceSpecs:this.deviceSpecs});throw console.error("❌ [PitchDetector] Initialization error:",a.toJSON()),this.componentState="error",this.lastError=a,this.isInitialized=!1,(r=(s=this.callbacks).onError)==null||r.call(s,a),o}}startDetection(){var e,t,n,s,r,o;if(this.componentState!=="ready"){const a=new Error(`Cannot start detection: component state is ${this.componentState}`);return(t=(e=this.callbacks).onError)==null||t.call(e,a),!1}if(!this.analyser||!this.pitchDetector){const a=new fi("ピッチ検出に必要なコンポーネントが初期化されていません。initialize()メソッドを先に呼び出してください。",{operation:"startDetection",hasAnalyser:!!this.analyser,hasPitchDetector:!!this.pitchDetector,componentState:this.componentState,isInitialized:this.isInitialized});return Ie.logError(a,"Pitch detection startup"),this.componentState="error",(s=(n=this.callbacks).onError)==null||s.call(n,a),!1}return this.componentState="detecting",this.isDetecting=!0,(o=(r=this.callbacks).onStateChange)==null||o.call(r,this.componentState),this.detectPitch(),!0}stopDetection(){var e,t;this.isDetecting=!1,this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null),this.frameRateLimiter.reset(),this.resetSilenceTracking(),this.componentState==="detecting"&&this.isInitialized&&(this.componentState="ready",(t=(e=this.callbacks).onStateChange)==null||t.call(e,this.componentState))}detectPitch(){var g,_,T,b;const e=performance.now();if(!this.frameRateLimiter.shouldProcess()){this.animationFrame=requestAnimationFrame(()=>this.detectPitch());return}if(!this.isDetecting||!this.analyser||!this.rawAnalyser||!this.pitchDetector||!this.deviceSpecs)return;const t=this.analyser.fftSize,n=new Float32Array(t),s=new Float32Array(this.rawAnalyser.fftSize);this.analyser.getFloatTimeDomainData(n),this.rawAnalyser.getFloatTimeDomainData(s);let r=0;for(let C=0;C<t;C++)r+=Math.abs(n[C]);const a=Math.sqrt(r/t);this.currentVolume=a,this.rawVolume=a;const c=((g=this.analyser.context)==null?void 0:g.sampleRate)||44100;let l=0,h=0;try{const C=this.pitchDetector.findPitch(n,c);l=C[0]||0,h=C[1]||0}catch(C){const y=new fi("Pitch detection algorithm failed",{bufferLength:n.length,sampleRate:c,volume:this.currentVolume,originalError:C instanceof Error?C.message:String(C)});if(console.warn("⚠️ [PitchDetector] Pitch detection error (recoverable):",y.toJSON()),pi(y))l=0,h=0;else{(T=(_=this.callbacks).onError)==null||T.call(_,y);return}}const u=l>=30&&l<=1200;if(l&&h>this.config.clarityThreshold&&this.currentVolume>this.config.minVolumeAbsolute&&u){let C=l;if(!this.disableHarmonicCorrection){const S=Math.min(this.currentVolume/100,1);C=this.correctHarmonic(l,S)}this.currentFrequency=C;const y=this.frequencyToNoteAndOctave(this.currentFrequency);this.detectedNote=y.note,this.detectedOctave=y.octave,this.pitchClarity=h}else this.currentFrequency===0&&this.resetHarmonicHistory(),this.currentFrequency=0,this.detectedNote="--",this.detectedOctave=null,this.pitchClarity=0;this.processSilenceDetection(this.currentVolume);const d={frequency:this.currentFrequency,note:this.detectedNote,octave:this.detectedOctave||void 0,clarity:this.pitchClarity,volume:a,cents:this.currentFrequency>0?this.frequencyToCents(this.currentFrequency):void 0};this.processAudioData(d),this.updateVisuals(d);const p=performance.now()-e;this.frameRateLimiter.getStats().frameDrops===0&&this.frameRateLimiter.recoverPerformance(),typeof process<"u"&&((b=process.env)==null?void 0:b.NODE_ENV)==="development"&&p>16.67&&console.warn(`[PitchDetector] Frame processing took ${p.toFixed(2)}ms (>16.67ms threshold)`),this.animationFrame=requestAnimationFrame(()=>this.detectPitch())}correctHarmonic(e,t){var u,d;if(!this.harmonicConfig.enabled)return this.previousFrequency=e,e;const n=performance.now();if(this.harmonicHistory=this.harmonicHistory.filter(f=>n-f.timestamp<this.harmonicConfig.historyWindow),this.harmonicHistory.push({frequency:e,confidence:t,timestamp:n}),this.harmonicHistory.length<8)return this.previousFrequency=e,e;const s=this.harmonicHistory.reduce((f,p)=>f+p.frequency,0)/this.harmonicHistory.length,r=e*2,o=e/2,a=Math.abs(e-s),c=Math.abs(r-s),l=Math.abs(o-s);let h=e;return l<a&&l<c?(h=o,typeof process<"u"&&((u=process.env)==null||u.NODE_ENV)):c<a&&c<l&&(h=r,typeof process<"u"&&((d=process.env)==null||d.NODE_ENV)),this.previousFrequency=h,h}resetHarmonicHistory(){this.harmonicHistory=[],this.previousFrequency=0}frequencyToNoteAndOctave(e){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(e<=0)return{note:"--",octave:null};const s=Math.round(12*Math.log2(e/440)),r=(s+9+120)%12,o=Math.floor((s+9)/12)+4;return{note:t[r],octave:o}}frequencyToCents(e){const n=12*Math.log2(e/440),s=Math.round(n),r=(n-s)*100;return Math.round(r)}processSilenceDetection(e){if(!this.silenceDetectionConfig.enabled)return;const t=Date.now(),n=this.silenceDetectionConfig.minVolumeThreshold||.01;e<n?this.isSilent||(this.isSilent=!0,this.silenceStartTime=t,this.hasWarned=!1,this.silenceDetectionConfig.warningThreshold&&(this.silenceWarningTimer=window.setTimeout(()=>{this.handleSilenceWarning()},this.silenceDetectionConfig.warningThreshold)),this.silenceDetectionConfig.timeoutThreshold&&(this.silenceTimeoutTimer=window.setTimeout(()=>{this.handleSilenceTimeout()},this.silenceDetectionConfig.timeoutThreshold))):this.isSilent&&(this.resetSilenceTracking(),this.silenceDetectionConfig.onSilenceRecovered&&this.silenceDetectionConfig.onSilenceRecovered())}handleSilenceWarning(){if(!this.hasWarned&&this.silenceStartTime){const e=Date.now()-this.silenceStartTime;this.hasWarned=!0,this.silenceDetectionConfig.onSilenceWarning&&this.silenceDetectionConfig.onSilenceWarning(e)}}handleSilenceTimeout(){this.silenceDetectionConfig.onSilenceTimeout&&this.silenceDetectionConfig.onSilenceTimeout(),this.stopDetection(),this.resetSilenceTracking()}resetSilenceTracking(){this.isSilent=!1,this.silenceStartTime=null,this.hasWarned=!1,this.silenceWarningTimer&&(clearTimeout(this.silenceWarningTimer),this.silenceWarningTimer=null),this.silenceTimeoutTimer&&(clearTimeout(this.silenceTimeoutTimer),this.silenceTimeoutTimer=null)}resetDisplayState(){this.currentVolume=0,this.rawVolume=0,this.currentFrequency=0,this.detectedNote="--",this.detectedOctave=null,this.pitchClarity=0,this.resetHarmonicHistory(),this.resetSilenceTracking(),this.forceUIUpdate()}forceUIUpdate(){try{["#volume-bar","#mic-volume-bar","#range-volume-bar","#practice-volume-bar",'[id*="volume-bar"]',".volume-bar"].forEach(r=>{const o=document.querySelector(r);o&&(o instanceof HTMLProgressElement?o.value=0:o.style.width="0%")}),["#volume-text","#mic-volume-text","#range-volume-text","#practice-volume-text",'[id*="volume-text"]',".volume-text"].forEach(r=>{const o=document.querySelector(r);o&&(o.textContent="0.0%")}),["#frequency","#mic-frequency","#range-frequency","#practice-frequency",'[id*="frequency"]',".frequency","#freq-1","#freq-2","#freq-3"].forEach(r=>{const o=document.querySelector(r);o&&(o.textContent="0.0 Hz")}),["#note","#note-display","#mic-note","#range-note","#practice-note",'[id*="note"]',".note",".note-display"].forEach(r=>{const o=document.querySelector(r);o&&(o.textContent="--")})}catch(e){console.warn("⚠️ [PitchDetector] Error in forceUIUpdate:",e.message)}}setHarmonicCorrectionEnabled(e){this.disableHarmonicCorrection=!e,e||this.resetHarmonicHistory()}setSilenceDetectionConfig(e){this.silenceDetectionConfig={...this.silenceDetectionConfig,...e},this.silenceDetectionConfig.enabled||this.resetSilenceTracking()}getSilenceStatus(){const e=this.silenceStartTime&&this.isSilent?Date.now()-this.silenceStartTime:null;return{isEnabled:this.silenceDetectionConfig.enabled||!1,isSilent:this.isSilent,silenceDuration:e,hasWarned:this.hasWarned}}getIsInitialized(){return this.isInitialized&&this.componentState==="ready"}getState(){return{componentState:this.componentState,isInitialized:this.isInitialized,isDetecting:this.isDetecting,lastError:this.lastError,hasRequiredComponents:!!(this.analyser&&this.pitchDetector)}}getCurrentResult(){return{frequency:this.currentFrequency,note:this.detectedNote,clarity:this.pitchClarity,volume:this.currentFrequency>0?this.rawVolume:0}}processAudioData(e){var t,n;(n=(t=this.callbacks).onPitchUpdate)==null||n.call(t,e)}updateVisuals(e){}getPerformanceStats(){return this.frameRateLimiter.getStats()}async reinitialize(){this.cleanup(),await new Promise(e=>setTimeout(e,100)),await this.initialize()}cleanup(){this.stopDetection(),this.analyserIds.length>0&&(this.audioManager.release(this.analyserIds),this.analyserIds=[]),this.componentState="uninitialized",this.isInitialized=!1,this.lastError=null,this.analyser=null,this.rawAnalyser=null,this.pitchDetector=null,this.resetHarmonicHistory()}getLatestResult(){return!this.isDetecting||this.componentState!=="detecting"?null:{frequency:this.currentFrequency,note:this.detectedNote,octave:this.detectedOctave??0,volume:this.currentVolume,rawVolume:this.rawVolume,clarity:this.pitchClarity,timestamp:Date.now()}}destroy(){this.stopDetection(),this.analyserIds.length>0&&(this.audioManager.release(this.analyserIds),this.analyserIds=[]),this.componentState="uninitialized",this.isInitialized=!1,this.lastError=null,this.analyser=null}getStatus(){var e;return{componentState:this.componentState,isInitialized:this.isInitialized,isDetecting:this.isDetecting,isRunning:this.isDetecting,currentVolume:this.currentVolume,rawVolume:this.rawVolume,currentFrequency:this.currentFrequency,detectedNote:this.detectedNote,detectedOctave:this.detectedOctave,currentClarity:this.pitchClarity,lastError:this.lastError,frameRateStatus:(e=this.frameRateLimiter)==null?void 0:e.getStats(),deviceSpecs:this.deviceSpecs,hasRequiredComponents:!!(this.analyser&&this.pitchDetector),harmonicConfig:this.harmonicConfig,volumeHistoryConfig:this.volumeHistoryConfig}}updateHarmonicConfig(e){var t;this.harmonicConfig={...this.harmonicConfig,...e},this.resetHarmonicHistory(),typeof process<"u"&&((t=process.env)==null||t.NODE_ENV)}}class io{constructor(e,t={}){this.highpassFilter=null,this.lowpassFilter=null,this.notchFilter=null,this.isConnected=!1,this.inputNode=null,this.outputNode=null,this.audioContext=e,this.config={highpassFreq:50,lowpassFreq:800,notchFreq:50,highpassQ:.7,lowpassQ:.7,notchQ:10,useFilters:!0,...t},this.createFilterChain()}createFilterChain(){if(!this.config.useFilters){console.log("🔇 [NoiseFilter] Filters disabled - bypassing filter chain");return}try{this.highpassFilter=this.audioContext.createBiquadFilter(),this.highpassFilter.type="highpass",this.highpassFilter.frequency.setValueAtTime(this.config.highpassFreq,this.audioContext.currentTime),this.highpassFilter.Q.setValueAtTime(this.config.highpassQ,this.audioContext.currentTime),this.lowpassFilter=this.audioContext.createBiquadFilter(),this.lowpassFilter.type="lowpass",this.lowpassFilter.frequency.setValueAtTime(this.config.lowpassFreq,this.audioContext.currentTime),this.lowpassFilter.Q.setValueAtTime(this.config.lowpassQ,this.audioContext.currentTime),this.notchFilter=this.audioContext.createBiquadFilter(),this.notchFilter.type="notch",this.notchFilter.frequency.setValueAtTime(this.config.notchFreq,this.audioContext.currentTime),this.notchFilter.Q.setValueAtTime(this.config.notchQ,this.audioContext.currentTime),console.log("✅ [NoiseFilter] 3-stage filter chain created",{highpass:`${this.config.highpassFreq}Hz (Q=${this.config.highpassQ})`,lowpass:`${this.config.lowpassFreq}Hz (Q=${this.config.lowpassQ})`,notch:`${this.config.notchFreq}Hz (Q=${this.config.notchQ})`})}catch(e){const t=new at("ノイズフィルターチェーンの初期化に失敗しました。オーディオシステムのサポート状況を確認してください。",{operation:"createFilterChain",originalError:e.message,filterConfig:this.config,audioContextState:this.audioContext.state,sampleRate:this.audioContext.sampleRate});throw Ie.logError(t,"NoiseFilter initialization"),console.error("❌ [NoiseFilter] Failed to create filter chain:",t.toJSON()),t}}connect(e,t){if(!this.config.useFilters)return t&&e.connect(t),e;if(!this.highpassFilter||!this.lowpassFilter||!this.notchFilter){const n=new Ce("ノイズフィルターが正しく初期化されていません。コンストラクタでuseFilters: trueで初期化してください。",gt.AUDIO_CONTEXT_ERROR,{operation:"connect",useFilters:this.config.useFilters,hasHighpassFilter:!!this.highpassFilter,hasLowpassFilter:!!this.lowpassFilter,hasNotchFilter:!!this.notchFilter});throw Ie.logError(n,"NoiseFilter connection"),n}try{return this.disconnect(),this.inputNode=e,this.outputNode=t||null,e.connect(this.highpassFilter),this.highpassFilter.connect(this.lowpassFilter),this.lowpassFilter.connect(this.notchFilter),t&&this.notchFilter.connect(t),this.isConnected=!0,console.log("🔗 [NoiseFilter] Filter chain connected"),this.notchFilter}catch(n){const s=new at("ノイズフィルターの接続に失敗しました。オーディオノードの接続状態を確認してください。",{operation:"connect",originalError:n.message,hasInputNode:!!this.inputNode,hasOutputNode:!!this.outputNode,isConnected:this.isConnected,filterConfig:this.config});throw Ie.logError(s,"NoiseFilter audio connection"),console.error("❌ [NoiseFilter] Connection failed:",s.toJSON()),s}}disconnect(){try{this.highpassFilter&&this.highpassFilter.disconnect(),this.lowpassFilter&&this.lowpassFilter.disconnect(),this.notchFilter&&this.notchFilter.disconnect(),this.isConnected=!1,this.inputNode=null,this.outputNode=null,console.log("🔌 [NoiseFilter] Filter chain disconnected")}catch(e){console.warn("⚠️ [NoiseFilter] Disconnect warning:",e)}}updateFrequencies(e){const t=this.audioContext.currentTime;try{e.highpassFreq!==void 0&&this.highpassFilter&&(this.highpassFilter.frequency.setValueAtTime(e.highpassFreq,t),this.config.highpassFreq=e.highpassFreq),e.lowpassFreq!==void 0&&this.lowpassFilter&&(this.lowpassFilter.frequency.setValueAtTime(e.lowpassFreq,t),this.config.lowpassFreq=e.lowpassFreq),e.notchFreq!==void 0&&this.notchFilter&&(this.notchFilter.frequency.setValueAtTime(e.notchFreq,t),this.config.notchFreq=e.notchFreq),e.highpassQ!==void 0&&this.highpassFilter&&(this.highpassFilter.Q.setValueAtTime(e.highpassQ,t),this.config.highpassQ=e.highpassQ),e.lowpassQ!==void 0&&this.lowpassFilter&&(this.lowpassFilter.Q.setValueAtTime(e.lowpassQ,t),this.config.lowpassQ=e.lowpassQ),e.notchQ!==void 0&&this.notchFilter&&(this.notchFilter.Q.setValueAtTime(e.notchQ,t),this.config.notchQ=e.notchQ),console.log("🔧 [NoiseFilter] Filter parameters updated:",e)}catch(n){const s=new Ce("フィルターパラメータの更新に失敗しました。指定した値が範囲外であるか、フィルターが無効になっている可能性があります。",gt.INVALID_SAMPLE_RATE,{operation:"updateFrequencies",originalError:n.message,requestedParams:e,currentConfig:this.config,audioContextTime:this.audioContext.currentTime});throw Ie.logError(s,"NoiseFilter parameter update"),console.error("❌ [NoiseFilter] Parameter update failed:",s.toJSON()),s}}setEnabled(e){if(e!==this.config.useFilters){if(this.config.useFilters=e,this.isConnected&&this.inputNode){const t=this.outputNode;this.disconnect(),e&&(this.highpassFilter||this.createFilterChain()),this.connect(this.inputNode,t||void 0)}console.log(`🔘 [NoiseFilter] Filters ${e?"enabled":"disabled"}`)}}getFilterResponse(e){if(!this.config.useFilters||!this.highpassFilter||!this.lowpassFilter||!this.notchFilter)return{magnitude:1,phase:0};try{const t=new Float32Array([e]),n=new Float32Array(1),s=new Float32Array(1);this.highpassFilter.getFrequencyResponse(t,n,s);const r=n[0];this.lowpassFilter.getFrequencyResponse(t,n,s);const o=n[0];this.notchFilter.getFrequencyResponse(t,n,s);const a=n[0];return{magnitude:r*o*a,phase:s[0]}}catch(t){const n=new Ce("フィルター応答の計算に失敗しました。デフォルト値を返します。",gt.PROCESSING_TIMEOUT,{operation:"getFilterResponse",frequency:e,originalError:t.message,useFilters:this.config.useFilters});return Ie.logError(n,"Filter response calculation"),console.warn("⚠️ [NoiseFilter] Filter response calculation failed:",n.toJSON()),{magnitude:1,phase:0}}}getConfig(){return{...this.config}}getStatus(){return{isConnected:this.isConnected,useFilters:this.config.useFilters,hasFilters:!!(this.highpassFilter&&this.lowpassFilter&&this.notchFilter),filterTypes:this.config.useFilters?["highpass","lowpass","notch"]:[],frequencies:{highpass:this.config.highpassFreq,lowpass:this.config.lowpassFreq,notch:this.config.notchFreq},qFactors:{highpass:this.config.highpassQ,lowpass:this.config.lowpassQ,notch:this.config.notchQ}}}getOutputNode(){return!this.config.useFilters||!this.notchFilter?this.inputNode||null:this.notchFilter}destroy(){console.log("🗑️ [NoiseFilter] Destroying filter chain"),this.disconnect(),this.highpassFilter=null,this.lowpassFilter=null,this.notchFilter=null,console.log("✅ [NoiseFilter] Cleanup complete")}static getPresetConfig(e){switch(e){case"voice":return{highpassFreq:80,lowpassFreq:800,notchFreq:60,highpassQ:.7,lowpassQ:.7,notchQ:10,useFilters:!0};case"instrument":return{highpassFreq:40,lowpassFreq:2e3,notchFreq:60,highpassQ:.5,lowpassQ:.5,notchQ:8,useFilters:!0};case"wide":return{highpassFreq:20,lowpassFreq:5e3,notchFreq:60,highpassQ:.3,lowpassQ:.3,notchQ:5,useFilters:!0};case"minimal":return{highpassFreq:60,lowpassFreq:8e3,notchFreq:60,highpassQ:.1,lowpassQ:.1,notchQ:3,useFilters:!0};default:return{useFilters:!1}}}}var on=(i=>(i[i.DEBUG=0]="DEBUG",i[i.INFO=1]="INFO",i[i.WARN=2]="WARN",i[i.ERROR=3]="ERROR",i[i.SILENT=4]="SILENT",i))(on||{});class Rt{constructor(e=1,t="",n={}){this.listeners=[],this.level=e,this.prefix=t,this.context=n}setLevel(e){this.level=e}addListener(e){this.listeners.push(e)}removeListener(e){const t=this.listeners.indexOf(e);t!==-1&&this.listeners.splice(t,1)}child(e,t={}){const n=this.prefix?`${this.prefix}:${e}`:e,s={...this.context,...t},r=new Rt(this.level,n,s);return r.addListener(o=>{this.listeners.forEach(a=>a(o))}),r}debug(e,t){this.log(0,e,t)}info(e,t){this.log(1,e,t)}warn(e,t){this.log(2,e,t)}error(e,t,n){const s=t?{errorName:t.name,errorMessage:t.message,stack:t.stack,...n}:n;this.log(3,e,s)}log(e,t,n){if(e<this.level)return;const s={level:e,message:t,context:{...this.context,...n},timestamp:Date.now(),prefix:this.prefix};this.logToConsole(s),this.listeners.forEach(r=>{try{r(s)}catch(o){console.error("Logger listener error:",o)}})}logToConsole(e){const t=new Date(e.timestamp).toISOString(),n=on[e.level],s=e.prefix?`[${e.prefix}]`:"",r=`${t} ${n} ${s} ${e.message}`,o=this.getConsoleMethod(e.level);e.context&&Object.keys(e.context).length>0?o(r,e.context):o(r)}getConsoleMethod(e){switch(e){case 0:return console.debug;case 1:return console.info;case 2:return console.warn;case 3:return console.error;default:return console.log}}getLevel(){return this.level}isLevelEnabled(e){return e>=this.level}}const an=new Rt(1,"PitchPro"),ro=(i,e)=>an.debug(i,e),oo=(i,e)=>an.info(i,e),ao=(i,e)=>an.warn(i,e),co=(i,e,t)=>an.error(i,e,t);class _i{constructor(e,t={}){if(this.refCount=0,this.isActive=!1,this.lastHealthCheck=null,this.healthCheckInterval=null,this.idleCheckInterval=null,this.visibilityCheckInterval=null,this.lastActivityTime=Date.now(),this.isPageVisible=!0,this.isUserActive=!0,this.autoRecoveryAttempts=0,this.eventListeners=new Map,this.callbacks={},this.audioManager=e,this.config={healthCheckIntervalMs:t.healthCheckIntervalMs??5e3,idleTimeoutMs:t.idleTimeoutMs??3e5,autoRecoveryDelayMs:t.autoRecoveryDelayMs??2e3,maxIdleTimeBeforeRelease:t.maxIdleTimeBeforeRelease??6e5,maxAutoRecoveryAttempts:t.maxAutoRecoveryAttempts??3,logLevel:t.logLevel??on.INFO,enableDetailedLogging:t.enableDetailedLogging??!1},this.logger=new Rt(this.config.logLevel,"MicrophoneLifecycleManager",{component:"MicrophoneLifecycleManager",enableDetailedLogging:this.config.enableDetailedLogging}),typeof window>"u"){this.logger.info("SSR environment detected - skipping initialization");return}this.logger.debug("Initializing MicrophoneLifecycleManager",{config:this.config}),this.setupEventListeners()}setCallbacks(e){this.callbacks={...this.callbacks,...e}}removeAllTrackedEventListeners(){this.logger.debug("Removing all tracked event listeners",{count:this.eventListeners.size}),this.eventListeners.forEach(({target:e,listener:t,eventName:n},s)=>{try{e.removeEventListener(n,t)}catch(r){this.logger.warn("Failed to remove event listener",{eventName:n,key:s,error:r.message})}}),this.eventListeners.clear(),this.logger.debug("All event listeners removed")}async acquire(){var e,t,n,s;this.refCount++,console.log(`🎤 [MicrophoneLifecycleManager] Acquiring resources (refCount: ${this.refCount})`);try{if(!this.isActive){const o=await this.audioManager.initialize();return this.isActive=!0,this.lastActivityTime=Date.now(),this.autoRecoveryAttempts=0,this.startHealthMonitoring(),this.startIdleMonitoring(),this.startVisibilityMonitoring(),(t=(e=this.callbacks).onStateChange)==null||t.call(e,"active"),console.log("🟢 [MicrophoneLifecycleManager] Microphone activated"),o}return this.updateActivity(),await this.audioManager.initialize()}catch(r){throw console.error("❌ [MicrophoneLifecycleManager] Failed to acquire resources:",r),this.refCount=Math.max(0,this.refCount-1),(s=(n=this.callbacks).onError)==null||s.call(n,r),r}}release(){var e,t;this.refCount=Math.max(0,this.refCount-1),console.log(`📉 [MicrophoneLifecycleManager] Releasing resources (refCount: ${this.refCount})`),this.refCount<=0&&(this.stopAllMonitoring(),this.audioManager.release(),this.isActive=!1,(t=(e=this.callbacks).onStateChange)==null||t.call(e,"inactive"),console.log("🔴 [MicrophoneLifecycleManager] Microphone deactivated"))}forceRelease(){var e,t;console.log("🚨 [MicrophoneLifecycleManager] Force release - cleaning up all resources"),this.refCount=0,this.stopAllMonitoring(),this.audioManager.forceCleanup(),this.isActive=!1,(t=(e=this.callbacks).onStateChange)==null||t.call(e,"inactive")}setupEventListeners(){const e=()=>{this.isPageVisible=!document.hidden,this.handleVisibilityChange()},t=()=>{this.updateActivity()},n=()=>{this.forceRelease()},s=()=>{this.isPageVisible=!0,this.handleVisibilityChange()},r=()=>{this.isPageVisible=!1,this.handleVisibilityChange()};document.addEventListener("visibilitychange",e),document.addEventListener("mousemove",t),document.addEventListener("keydown",t),document.addEventListener("click",t),document.addEventListener("scroll",t),document.addEventListener("touchstart",t),window.addEventListener("beforeunload",n),window.addEventListener("unload",n),window.addEventListener("focus",s),window.addEventListener("blur",r),this.eventListeners.set("visibilitychange",{target:document,listener:e,eventName:"visibilitychange"}),this.eventListeners.set("mousemove",{target:document,listener:t,eventName:"mousemove"}),this.eventListeners.set("keydown",{target:document,listener:t,eventName:"keydown"}),this.eventListeners.set("click",{target:document,listener:t,eventName:"click"}),this.eventListeners.set("scroll",{target:document,listener:t,eventName:"scroll"}),this.eventListeners.set("touchstart",{target:document,listener:t,eventName:"touchstart"}),this.eventListeners.set("beforeunload",{target:window,listener:n,eventName:"beforeunload"}),this.eventListeners.set("unload",{target:window,listener:n,eventName:"unload"}),this.eventListeners.set("focus",{target:window,listener:s,eventName:"focus"}),this.eventListeners.set("blur",{target:window,listener:r,eventName:"blur"}),console.log("👂 [MicrophoneLifecycleManager] Event listeners setup complete")}handleVisibilityChange(){this.isActive&&(this.isPageVisible?(console.log("👁️ [MicrophoneLifecycleManager] Page became visible - resuming monitoring"),this.updateActivity(),setTimeout(()=>{this.performHealthCheck()},1e3)):(console.log("🙈 [MicrophoneLifecycleManager] Page became hidden - reducing monitoring frequency"),setTimeout(()=>{!this.isPageVisible&&this.isActive&&Date.now()-this.lastActivityTime>this.config.maxIdleTimeBeforeRelease&&(console.log("⏰ [MicrophoneLifecycleManager] Long inactivity detected - releasing resources"),this.forceRelease())},this.config.maxIdleTimeBeforeRelease)))}updateActivity(){this.lastActivityTime=Date.now(),this.isUserActive=!0}startHealthMonitoring(){this.healthCheckInterval&&clearInterval(this.healthCheckInterval),this.healthCheckInterval=window.setInterval(()=>{this.performHealthCheck()},this.config.healthCheckIntervalMs),console.log(`💓 [MicrophoneLifecycleManager] Health monitoring started (${this.config.healthCheckIntervalMs}ms interval)`)}startIdleMonitoring(){this.idleCheckInterval&&clearInterval(this.idleCheckInterval),this.idleCheckInterval=window.setInterval(()=>{this.checkIdleTimeout()},3e4),console.log("😴 [MicrophoneLifecycleManager] Idle monitoring started")}startVisibilityMonitoring(){this.visibilityCheckInterval&&clearInterval(this.visibilityCheckInterval),this.visibilityCheckInterval=window.setInterval(()=>{this.isPageVisible&&this.isActive&&this.performHealthCheck()},1e4),console.log("👁️ [MicrophoneLifecycleManager] Visibility monitoring started")}async performHealthCheck(){var e,t,n,s;if(this.isActive)try{const r=this.audioManager.checkMediaStreamHealth();if(this.lastHealthCheck=r,r.healthy)this.autoRecoveryAttempts>0&&(this.logger.info("Microphone health restored, resetting recovery attempts",{previousAttempts:this.autoRecoveryAttempts,healthStatus:r}),this.autoRecoveryAttempts=0);else if(this.logger.warn("Unhealthy microphone state detected",{healthStatus:r}),this.autoRecoveryAttempts<this.config.maxAutoRecoveryAttempts)this.autoRecoveryAttempts++,this.logger.warn("Attempting automatic recovery",{attempt:this.autoRecoveryAttempts,maxAttempts:this.config.maxAutoRecoveryAttempts,healthStatus:r}),setTimeout(async()=>{var o,a;try{await this.audioManager.initialize(),this.logger.info("Automatic recovery successful",{attempt:this.autoRecoveryAttempts,totalAttempts:this.autoRecoveryAttempts}),this.autoRecoveryAttempts=0,this.dispatchCustomEvent("pitchpro:lifecycle:autoRecoverySuccess",{})}catch(c){this.logger.error("Automatic recovery failed",c,{attempt:this.autoRecoveryAttempts,maxAttempts:this.config.maxAutoRecoveryAttempts}),(a=(o=this.callbacks).onError)==null||a.call(o,c),this.dispatchCustomEvent("pitchpro:lifecycle:autoRecoveryFailed",{error:c})}},this.config.autoRecoveryDelayMs);else{const o=new di(`Microphone health check failed after ${this.autoRecoveryAttempts} recovery attempts. Monitoring stopped to prevent infinite error loop.`,r,this.autoRecoveryAttempts,{operation:"performHealthCheck",maxAttemptsReached:!0,monitoringStopped:!0});this.logger.error("Maximum recovery attempts reached - stopping health checks",o,{attempts:this.autoRecoveryAttempts,maxAttempts:this.config.maxAutoRecoveryAttempts,healthStatus:r}),this.stopAllMonitoring(),this.isActive=!1,(t=(e=this.callbacks).onError)==null||t.call(e,o),this.dispatchCustomEvent("pitchpro:lifecycle:maxRecoveryAttemptsReached",{attempts:this.autoRecoveryAttempts,lastHealthStatus:r})}}catch(r){this.logger.error("Health check failed",r,{operation:"performHealthCheck",isActive:this.isActive,attempts:this.autoRecoveryAttempts}),(s=(n=this.callbacks).onError)==null||s.call(n,r)}}checkIdleTimeout(){if(!this.isActive)return;const e=Date.now()-this.lastActivityTime;e>this.config.idleTimeoutMs&&this.isUserActive&&(console.log("😴 [MicrophoneLifecycleManager] User idle detected"),this.isUserActive=!1),e>this.config.maxIdleTimeBeforeRelease&&(console.log("⏰ [MicrophoneLifecycleManager] Extreme idle detected - auto-releasing resources"),this.forceRelease())}stopAllMonitoring(){this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.idleCheckInterval&&(clearInterval(this.idleCheckInterval),this.idleCheckInterval=null),this.visibilityCheckInterval&&(clearInterval(this.visibilityCheckInterval),this.visibilityCheckInterval=null),console.log("⏹️ [MicrophoneLifecycleManager] All monitoring stopped")}dispatchCustomEvent(e,t){if(typeof window>"u")return;const n=new CustomEvent(e,{detail:t});window.dispatchEvent(n)}getStatus(){return{refCount:this.refCount,isActive:this.isActive,isPageVisible:this.isPageVisible,isUserActive:this.isUserActive,lastActivityTime:this.lastActivityTime,timeSinceActivity:Date.now()-this.lastActivityTime,autoRecoveryAttempts:this.autoRecoveryAttempts,lastHealthCheck:this.lastHealthCheck,audioManagerStatus:this.audioManager.getStatus()}}updateConfig(e){this.config={...this.config,...e},this.isActive&&(this.stopAllMonitoring(),this.startHealthMonitoring(),this.startIdleMonitoring(),this.startVisibilityMonitoring()),console.log("🔧 [MicrophoneLifecycleManager] Configuration updated:",e)}resetRecoveryAttempts(){const e=this.autoRecoveryAttempts;this.autoRecoveryAttempts=0,this.logger.info("Recovery attempts reset manually",{previousAttempts:e,refCount:this.refCount,wasActive:this.isActive,hasMonitoring:!!this.healthCheckInterval}),!this.healthCheckInterval&&this.refCount>0&&(this.logger.info("Restarting monitoring after manual reset",{refCount:this.refCount,reason:"Manual recovery reset with active references"}),this.isActive=!0,this.startHealthMonitoring(),this.startIdleMonitoring(),this.startVisibilityMonitoring(),this.dispatchCustomEvent("pitchpro:lifecycle:monitoringRestarted",{reason:"Manual recovery reset",refCount:this.refCount}))}destroy(){this.logger.info("Destroying MicrophoneLifecycleManager",{refCount:this.refCount,isActive:this.isActive,autoRecoveryAttempts:this.autoRecoveryAttempts,listenerCount:this.eventListeners.size}),this.stopAllMonitoring(),this.forceRelease(),this.removeAllTrackedEventListeners(),this.isActive=!1,this.refCount=0,this.autoRecoveryAttempts=0,this.logger.info("MicrophoneLifecycleManager cleanup complete")}}class yi{constructor(){if(this.container=null,this.notifications=new Map,this.notificationCounter=0,this.defaultDuration=5e3,this.maxNotifications=0,this.cssClasses={container:"pitchpro-notifications",notification:"pitchpro-notification",title:"pitchpro-notification-title",message:"pitchpro-notification-message",details:"pitchpro-notification-details",solution:"pitchpro-notification-solution",closeButton:"pitchpro-notification-close",error:"pitchpro-notification-error",warning:"pitchpro-notification-warning",success:"pitchpro-notification-success",info:"pitchpro-notification-info",high:"pitchpro-notification-priority-high",medium:"pitchpro-notification-priority-medium",low:"pitchpro-notification-priority-low"},typeof window>"u"){console.log("🔇 [ErrorNotificationSystem] SSR environment detected - skipping initialization");return}this.initializeContainer(),this.injectCSS()}initializeContainer(){let e=document.querySelector(`.${this.cssClasses.container}`);e?(this.container=e,console.log("📋 [ErrorNotificationSystem] Using existing notification container")):(this.container=document.createElement("div"),this.container.className=this.cssClasses.container,this.container.setAttribute("role","alert"),this.container.setAttribute("aria-live","polite"),document.body.appendChild(this.container),console.log("📋 [ErrorNotificationSystem] Notification container created"))}injectCSS(){if(document.querySelector("#pitchpro-notifications-styles"))return;const e=`
      .${this.cssClasses.container} {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        max-width: 400px;
        pointer-events: none;
      }

      .${this.cssClasses.notification} {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        margin-bottom: 12px;
        padding: 16px;
        pointer-events: auto;
        position: relative;
        animation: slideIn 0.3s ease-out;
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      }

      .${this.cssClasses.notification}.removing {
        opacity: 0;
        transform: translateX(100%);
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(100%);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .${this.cssClasses.notification}.${this.cssClasses.error} {
        border-left: 4px solid #ef4444;
      }

      .${this.cssClasses.notification}.${this.cssClasses.warning} {
        border-left: 4px solid #f59e0b;
      }

      .${this.cssClasses.notification}.${this.cssClasses.success} {
        border-left: 4px solid #10b981;
      }

      .${this.cssClasses.notification}.${this.cssClasses.info} {
        border-left: 4px solid #3b82f6;
      }

      .${this.cssClasses.title} {
        font-weight: 600;
        font-size: 14px;
        color: #1f2937;
        margin-bottom: 4px;
        padding-right: 24px;
      }

      .${this.cssClasses.message} {
        font-size: 13px;
        color: #4b5563;
        margin-bottom: 8px;
        line-height: 1.4;
      }

      .${this.cssClasses.details} {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 8px;
        padding-left: 12px;
        border-left: 2px solid #e5e7eb;
      }

      .${this.cssClasses.details} li {
        margin-bottom: 2px;
      }

      .${this.cssClasses.solution} {
        font-size: 12px;
        color: #059669;
        background: #ecfdf5;
        border: 1px solid #a7f3d0;
        border-radius: 4px;
        padding: 8px;
        margin-top: 8px;
      }

      .${this.cssClasses.closeButton} {
        position: absolute;
        top: 12px;
        right: 12px;
        background: none;
        border: none;
        font-size: 18px;
        color: #9ca3af;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .${this.cssClasses.closeButton}:hover {
        color: #6b7280;
      }

      .${this.cssClasses.notification}.${this.cssClasses.high} {
        border-width: 2px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      @media (max-width: 640px) {
        .${this.cssClasses.container} {
          top: 10px;
          left: 10px;
          right: 10px;
          max-width: none;
        }
      }
    `,t=document.createElement("style");t.id="pitchpro-notifications-styles",t.textContent=e,document.head.appendChild(t)}show(e){if(!this.container)return console.warn("⚠️ [ErrorNotificationSystem] Container not available - cannot show notification"),"";const t=`notification-${++this.notificationCounter}`,n=this.createNotificationElement(t,e);if(this.notifications.size>=this.maxNotifications){const s=Array.from(this.notifications.keys())[0];this.remove(s)}if(this.container.appendChild(n),this.notifications.set(t,n),e.autoHide!==!1){const s=e.duration||this.defaultDuration;setTimeout(()=>{this.remove(t)},s)}return console.log(`📢 [ErrorNotificationSystem] Notification shown: ${e.type} - ${e.title}`),t}createNotificationElement(e,t){const n=document.createElement("div");n.className=[this.cssClasses.notification,this.cssClasses[t.type],t.priority?this.cssClasses[t.priority]:""].filter(Boolean).join(" "),n["data-notification-id"]=e;const s=document.createElement("div");s.className=this.cssClasses.title,s.textContent=t.title,n.appendChild(s);const r=document.createElement("div");if(r.className=this.cssClasses.message,r.textContent=t.message,n.appendChild(r),t.details&&t.details.length>0){const a=document.createElement("div");a.className=this.cssClasses.details;const c=document.createElement("ul");c.style.margin="0",c.style.paddingLeft="16px",t.details.forEach(l=>{const h=document.createElement("li");h.textContent=l,c.appendChild(h)}),a.appendChild(c),n.appendChild(a)}if(t.solution){const a=document.createElement("div");a.className=this.cssClasses.solution,a.textContent=t.solution,n.appendChild(a)}const o=document.createElement("button");return o.className=this.cssClasses.closeButton,o.innerHTML="×",o.setAttribute("aria-label","Close notification"),o.addEventListener("click",()=>{this.remove(e)}),n.appendChild(o),n}remove(e){const t=this.notifications.get(e);t&&(t.classList.add("removing"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),this.notifications.delete(e)},300),console.log(`🗑️ [ErrorNotificationSystem] Notification removed: ${e}`))}clearAll(){Array.from(this.notifications.keys()).forEach(t=>this.remove(t)),console.log("🧹 [ErrorNotificationSystem] All notifications cleared")}showError(e,t,n={}){return this.show({type:"error",title:e,message:t,priority:"high",autoHide:!1,...n})}showWarning(e,t,n={}){return this.show({type:"warning",title:e,message:t,priority:"medium",duration:8e3,...n})}showSuccess(e,t,n={}){return this.show({type:"success",title:e,message:t,priority:"low",duration:3e3,...n})}showInfo(e,t,n={}){return this.show({type:"info",title:e,message:t,priority:"low",...n})}showMicrophoneError(e,t){return this.showError("マイクロフォンエラー",`マイクの初期化に失敗しました: ${e.message}`,{details:t?[`発生箇所: ${t}`,`エラー詳細: ${e.name}`]:[`エラー詳細: ${e.name}`],solution:"マイクの設定を確認し、ブラウザにマイクアクセスを許可してください。",priority:"high"})}showAudioContextError(e){return this.showError("オーディオシステムエラー",`音声処理システムの初期化に失敗しました: ${e.message}`,{details:["ブラウザがWeb Audio APIに対応していない可能性があります","または、音声デバイスに問題が発生しています"],solution:"ブラウザを最新版に更新するか、別のブラウザで試してください。",priority:"high"})}showLoadingError(e,t){return this.showError("読み込みエラー",`${e}の読み込みに失敗しました: ${t.message}`,{details:["ネットワーク接続を確認してください","ブラウザのキャッシュをクリアしてみてください"],solution:"ページを再読み込みするか、しばらく待ってから再度お試しください。",priority:"medium"})}getNotificationCount(){return this.notifications.size}getNotificationIds(){return Array.from(this.notifications.keys())}hasNotification(e){return this.notifications.has(e)}updateConfig(e){e.defaultDuration!==void 0&&(this.defaultDuration=e.defaultDuration),e.maxNotifications!==void 0&&(this.maxNotifications=e.maxNotifications),console.log("🔧 [ErrorNotificationSystem] Configuration updated:",e)}destroy(){console.log("🗑️ [ErrorNotificationSystem] Destroying notification system"),this.clearAll(),this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container);const e=document.querySelector("#pitchpro-notifications-styles");e&&e.parentNode&&e.parentNode.removeChild(e),this.container=null,this.notifications.clear(),console.log("✅ [ErrorNotificationSystem] Cleanup complete")}}class vi{constructor(e={}){var t,n,s,r,o,a,c,l,h,u,d;this.currentState="uninitialized",this.isPermissionGranted=!1,this.lastError=null,this.eventCallbacks={},this.deviceSpecs=null,this.pitchDetector=null,this.audioDetectionComponent=null,this.config={audioManager:{sampleRate:((t=e.audioManager)==null?void 0:t.sampleRate)??44100,echoCancellation:((n=e.audioManager)==null?void 0:n.echoCancellation)??!1,noiseSuppression:((s=e.audioManager)==null?void 0:s.noiseSuppression)??!1,autoGainControl:((r=e.audioManager)==null?void 0:r.autoGainControl)??!1},lifecycle:e.lifecycle??{},audioConstraints:{echoCancellation:((o=e.audioConstraints)==null?void 0:o.echoCancellation)??!1,noiseSuppression:((a=e.audioConstraints)==null?void 0:a.noiseSuppression)??!1,autoGainControl:((c=e.audioConstraints)==null?void 0:c.autoGainControl)??!1},notifications:{enabled:((l=e.notifications)==null?void 0:l.enabled)??!0,position:((h=e.notifications)==null?void 0:h.position)??"top-right"},logging:{level:((u=e.logging)==null?void 0:u.level)??on.INFO,prefix:((d=e.logging)==null?void 0:d.prefix)??"MicrophoneController"}},this.logger=new Rt(this.config.logging.level,this.config.logging.prefix,{component:"MicrophoneController"}),this.logger.debug("Initializing MicrophoneController",{config:this.config}),this.audioManager=new mi(this.config.audioManager),this.lifecycleManager=new _i(this.audioManager,this.config.lifecycle),this.errorSystem=this.config.notifications.enabled?new yi:null,this.setupEventHandlers(),this.detectDevice()}setCallbacks(e){this.eventCallbacks={...this.eventCallbacks,...e}}resetRecoveryAttempts(){this.logger.info("Resetting recovery attempts via public API");try{this.lifecycleManager.resetRecoveryAttempts(),this.logger.info("Recovery attempts reset successfully")}catch(e){throw this.logger.error("Failed to reset recovery attempts",e),e}}isActive(){return this.currentState==="active"}isReady(){return this.currentState==="ready"||this.currentState==="active"}isInitialized(){return this.currentState!=="uninitialized"}setupEventHandlers(){this.lifecycleManager.setCallbacks({onStateChange:e=>{this.updateState(e==="active"?"active":"ready")},onError:e=>{this.handleError(e,"lifecycle")}})}detectDevice(){var e,t;this.deviceSpecs=this.audioManager.getPlatformSpecs(),console.log("📱 [MicrophoneController] Device detected:",this.deviceSpecs),(t=(e=this.eventCallbacks).onDeviceChange)==null||t.call(e,this.deviceSpecs),this.dispatchCustomEvent("pitchpro:deviceDetected",{specs:this.deviceSpecs})}async initialize(){var e,t,n,s;try{this.updateState("initializing"),console.log("🎤 [MicrophoneController] Starting initialization");const r=await this.lifecycleManager.acquire();return this.isPermissionGranted=!0,this.updateState("ready"),this.lastError=null,(t=(e=this.eventCallbacks).onPermissionChange)==null||t.call(e,!0),this.dispatchCustomEvent("pitchpro:microphoneGranted",{stream:r.mediaStream}),console.log("✅ [MicrophoneController] Initialization complete"),r}catch(r){throw this.logger.error("Initialization failed",r,{operation:"initialize",currentState:this.currentState}),this.isPermissionGranted=!1,this.handleError(r,"initialization"),(s=(n=this.eventCallbacks).onPermissionChange)==null||s.call(n,!1),this.dispatchCustomEvent("pitchpro:microphoneDenied",{error:r}),r}}async requestPermission(){try{return await this.initialize(),!0}catch{return!1}}async checkPermissionStatus(){if(typeof navigator>"u"||!navigator.mediaDevices)return"denied";try{return(await navigator.permissions.query({name:"microphone"})).state}catch{try{return(await navigator.mediaDevices.getUserMedia({audio:this.config.audioConstraints})).getTracks().forEach(t=>t.stop()),"granted"}catch{return"denied"}}}stop(){console.log("🛑 [MicrophoneController] Stopping microphone"),this.lifecycleManager.release(),this.updateState("ready"),this.dispatchCustomEvent("pitchpro:microphoneStopped",{}),console.log("✅ [MicrophoneController] Microphone stopped")}forceStop(){console.log("🚨 [MicrophoneController] Force stopping microphone"),this.lifecycleManager.forceRelease(),this.updateState("uninitialized"),this.isPermissionGranted=!1,console.log("✅ [MicrophoneController] Force stop complete")}setSensitivity(e){var s,r;const t=this.audioManager.getSensitivity();this.audioManager.setSensitivity(e);const n=this.audioManager.getSensitivity();t!==n&&(console.log(`🔧 [MicrophoneController] Sensitivity changed: ${t}x → ${n}x`),(r=(s=this.eventCallbacks).onSensitivityChange)==null||r.call(s,n),this.dispatchCustomEvent("pitchpro:sensitivityChanged",{sensitivity:n}))}getSensitivity(){return this.audioManager.getSensitivity()}mute(){this.logger.info("Muting microphone via controller"),this.audioManager.mute(),this.dispatchCustomEvent("pitchpro:microphoneMuted",{timestamp:Date.now(),controllerState:this.currentState})}unmute(){this.logger.info("Unmuting microphone via controller"),this.audioManager.unmute(),this.dispatchCustomEvent("pitchpro:microphoneUnmuted",{timestamp:Date.now(),controllerState:this.currentState})}toggleMute(){return this.audioManager.getIsMuted()?(this.unmute(),!1):(this.mute(),!0)}isMuted(){return this.audioManager.getIsMuted()}registerAudioDetectionComponent(e){this.audioDetectionComponent=e,this.logger.info("AudioDetectionComponent registered for UI control"),console.log("🎛️ [MicrophoneController] AudioDetectionComponent registered for UI management")}registerDetector(e){this.pitchDetector=e,this.logger.info("PitchDetector instance has been registered to the controller."),console.log("🎯 [MicrophoneController] PitchDetector registered for unified management")}start(){this.logger.info("Starting microphone and pitch detection systems..."),console.log("▶️ [MicrophoneController] Starting comprehensive system startup");try{this.unmute(),console.log("✅ [MicrophoneController] Microphone unmuted")}catch(e){return this.logger.error("Error during microphone unmute",e),console.warn("⚠️ [MicrophoneController] Microphone unmute failed:",e.message),!1}if(this.pitchDetector)try{return this.pitchDetector.startDetection()?(this.logger.info("PitchDetector detection started successfully"),console.log("✅ [MicrophoneController] Pitch detection started"),console.log("🎉 [MicrophoneController] System startup completed successfully"),!0):(this.logger.warn("PitchDetector failed to start detection"),console.warn("⚠️ [MicrophoneController] Pitch detection failed to start"),!1)}catch(e){return this.logger.error("Error during PitchDetector start",e),console.warn("⚠️ [MicrophoneController] PitchDetector start encountered error:",e.message),!1}else return this.logger.warn("No PitchDetector registered, cannot start detection"),console.log("⚠️ [MicrophoneController] No PitchDetector registered - skipping detection start"),console.log("ℹ️ [MicrophoneController] Only microphone unmuted, detection not available"),!1}reset(){if(this.logger.info("Performing full system reset..."),console.log("🔄 [MicrophoneController] Starting comprehensive system reset"),this.pitchDetector)try{this.pitchDetector.stopDetection(),console.log("✅ [MicrophoneController] PitchDetector stopped"),this.pitchDetector.resetDisplayState(),console.log("✅ [MicrophoneController] Display state reset")}catch(e){this.logger.error("Error during PitchDetector reset",e),console.warn("⚠️ [MicrophoneController] PitchDetector reset encountered error:",e.message)}else this.logger.warn("No PitchDetector registered, skipping detector reset."),console.log("⚠️ [MicrophoneController] No PitchDetector registered - skipping detection reset");if(this.audioDetectionComponent)try{typeof this.audioDetectionComponent.resetDisplayElements=="function"?(this.audioDetectionComponent.resetDisplayElements(),console.log("✅ [MicrophoneController] AudioDetectionComponent UI reset")):console.warn("⚠️ [MicrophoneController] AudioDetectionComponent does not have resetDisplayElements method")}catch(e){this.logger.error("Error during AudioDetectionComponent UI reset",e),console.warn("⚠️ [MicrophoneController] AudioDetectionComponent UI reset encountered error:",e.message)}else console.log("ℹ️ [MicrophoneController] No AudioDetectionComponent registered - skipping comprehensive UI reset");try{this.mute(),console.log("✅ [MicrophoneController] Microphone muted")}catch(e){this.logger.error("Error during microphone mute",e),console.warn("⚠️ [MicrophoneController] Microphone mute encountered error:",e.message)}try{this.resetRecoveryAttempts(),console.log("✅ [MicrophoneController] Recovery attempts reset")}catch(e){this.logger.error("Error during recovery reset",e),console.warn("⚠️ [MicrophoneController] Recovery reset encountered error:",e.message)}this.logger.info("System reset complete."),console.log("🎉 [MicrophoneController] Comprehensive system reset completed"),console.log("ℹ️ [MicrophoneController] Note: Muted state is normal and will not trigger health check errors")}getDeviceSpecs(){return this.deviceSpecs}getState(){return this.currentState}hasPermission(){return this.isPermissionGranted}getStatus(){return{state:this.currentState,isPermissionGranted:this.isPermissionGranted,isActive:this.isActive(),isReady:this.isReady(),sensitivity:this.getSensitivity(),deviceSpecs:this.deviceSpecs,lastError:this.lastError,audioManagerStatus:this.audioManager.getStatus(),lifecycleStatus:this.lifecycleManager.getStatus()}}checkHealth(){return this.audioManager.checkMediaStreamHealth()}async testMicrophone(e=2e3){const t=Date.now();try{!this.isReady()&&!this.isActive()&&await this.initialize();const n=this.audioManager.createAnalyser("microphone-test",{fftSize:1024,smoothingTimeConstant:.8});let s=0,r=null;const o=t+e;await new Promise(h=>{const u=()=>{if(Date.now()>=o){h();return}const d=n.fftSize,f=new Float32Array(d);n.getFloatTimeDomainData(f);let p=0;for(let _=0;_<d;_++)p+=Math.abs(f[_]);const g=Math.sqrt(p/d)*100;if(g>s&&(s=g),g>5){let _=0,T=0;for(let b=1;b<d/2;b++){const C=Math.abs(f[b]);C>T&&(T=C,_=b)}_>0&&(r=_*44100/d)}requestAnimationFrame(u)};u()}),this.audioManager.removeAnalyser("microphone-test");const a=Date.now()-t,c=s>1,l=r?r.toFixed(0):"none";return console.log(`🧪 [MicrophoneController] Microphone test complete: volume=${s.toFixed(2)}, frequency=${l}, duration=${a}ms`),{success:c,volume:s,frequency:r,duration:a}}catch(n){const s=Date.now()-t,r=this._createStructuredError(n,"microphone_test");return Ie.logError(r,"Microphone functionality test"),console.error("❌ [MicrophoneController] Microphone test failed:",r.toJSON()),{success:!1,volume:0,frequency:null,duration:s,error:n}}}updateState(e){var t,n;if(this.currentState!==e){const s=this.currentState;this.currentState=e,console.log(`🔄 [MicrophoneController] State changed: ${s} → ${e}`),(n=(t=this.eventCallbacks).onStateChange)==null||n.call(t,e)}}handleError(e,t){var s,r;const n=e instanceof Ce?e:this._createStructuredError(e,t);Ie.logError(n,`MicrophoneController ${t}`),console.error(`❌ [MicrophoneController] Error in ${t}:`,n.toJSON()),this.lastError=e,this.updateState("error"),this.errorSystem&&(t==="initialization"||t==="lifecycle"?this.errorSystem.showMicrophoneError(e,t):this.errorSystem.showError("マイクエラー",`${t}でエラーが発生しました: ${e.message}`,{priority:"medium"})),(r=(s=this.eventCallbacks).onError)==null||r.call(s,e)}dispatchCustomEvent(e,t){if(typeof window>"u")return;const n=new CustomEvent(e,{detail:t});window.dispatchEvent(n)}addEventListener(e,t){typeof window>"u"||window.addEventListener(e,t)}removeEventListener(e,t){typeof window>"u"||window.removeEventListener(e,t)}destroy(){var e;console.log("🗑️ [MicrophoneController] Destroying controller"),this.forceStop(),this.lifecycleManager.destroy(),(e=this.errorSystem)==null||e.destroy(),this.eventCallbacks={},this.currentState="uninitialized",this.isPermissionGranted=!1,this.lastError=null,this.deviceSpecs=null,console.log("✅ [MicrophoneController] Cleanup complete")}_createStructuredError(e,t){return e.message.includes("Permission denied")||e.message.includes("NotAllowedError")||e.message.includes("permission")||e.message.includes("denied")?new hs("マイクへのアクセス許可が拒否されました。ブラウザの設定でマイクアクセスを許可してください。",{operation:t,originalError:e.message,deviceSpecs:this.deviceSpecs,permissionState:this.isPermissionGranted,controllerState:this.currentState,userAgent:typeof navigator<"u"?navigator.userAgent:"unknown"}):e.message.includes("AudioContext")||e.message.includes("audio")||e.message.includes("context")||e.message.includes("initialization")?new at("オーディオシステムの初期化に失敗しました。デバイスの音響設定を確認するか、ブラウザを再起動してください。",{operation:t,originalError:e.message,controllerState:this.currentState,audioManagerStatus:this.audioManager.getStatus(),deviceSpecs:this.deviceSpecs}):new Ce(`${t}中に予期しないエラーが発生しました: ${e.message}`,gt.MICROPHONE_ACCESS_DENIED,{operation:t,originalError:e.message,stack:e.stack,currentState:{controllerState:this.currentState,isPermissionGranted:this.isPermissionGranted,isActive:this.isActive(),isReady:this.isReady(),deviceSpecs:this.deviceSpecs}})}}const se=class se{static frequencyToMidi(e){return e<=0?0:Math.round(12*Math.log2(e/se.A4_FREQUENCY)+se.A4_MIDI_NUMBER)}static midiToFrequency(e){return se.A4_FREQUENCY*Math.pow(2,(e-se.A4_MIDI_NUMBER)/12)}static frequencyToNote(e,t=!1){if(e<=0)return{name:"--",octave:0,midi:0,frequency:0};const n=se.frequencyToMidi(e),s=t?se.FLAT_NOTE_NAMES:se.NOTE_NAMES,r=(n-12)%12,o=Math.floor((n-12)/12);return{name:s[r]+o,octave:o,midi:n,frequency:se.midiToFrequency(n)}}static frequencyToCents(e){if(e<=0)return 0;const t=12*Math.log2(e/se.A4_FREQUENCY)+se.A4_MIDI_NUMBER,n=Math.round(t),s=(t-n)*100;return Math.round(s)}static centsToRatio(e){return Math.pow(2,e/1200)}static ratioToCents(e){return e<=0?0:Math.round(1200*Math.log2(e))}static getClosestNoteFrequency(e){if(e<=0)return 0;const t=se.frequencyToMidi(e);return se.midiToFrequency(t)}static getInterval(e,t){if(e<=0||t<=0)return 0;const n=se.frequencyToMidi(e),s=se.frequencyToMidi(t);return Math.abs(s-n)}static getSignedInterval(e,t){if(e<=0||t<=0)return 0;const n=se.frequencyToMidi(e);return se.frequencyToMidi(t)-n}static getIntervalInfo(e){const t={0:"Perfect Unison",1:"Minor Second",2:"Major Second",3:"Minor Third",4:"Major Third",5:"Perfect Fourth",6:"Tritone",7:"Perfect Fifth",8:"Minor Sixth",9:"Major Sixth",10:"Minor Seventh",11:"Major Seventh",12:"Perfect Octave"},n=(e%12+12)%12,s=Math.floor(e/12),r=t[n]||"Unknown";return{name:s>0?`${r} + ${s} octave(s)`:r,semitones:e,cents:e*100,ratio:Math.pow(2,e/12)}}static isInVocalRange(e){return e>=80&&e<=1100}static isInPianoRange(e){return e>=27.5&&e<=4186}static getInstrumentRange(e){return{piano:{min:27.5,max:4186},guitar:{min:82.4,max:1397},violin:{min:196,max:3520},cello:{min:65.4,max:1397},voice_bass:{min:87.3,max:349},voice_tenor:{min:131,max:523},voice_alto:{min:175,max:698},voice_soprano:{min:262,max:1047}}[e]||null}static generateChromaticScale(e,t=1){const n=[];for(let s=0;s<12*t;s++){const r=e*Math.pow(2,s/12);n.push(r)}return n}static generateMajorScale(e){return[0,2,4,5,7,9,11,12].map(n=>e*Math.pow(2,n/12))}static generateMinorScale(e){return[0,2,3,5,7,8,10,12].map(n=>e*Math.pow(2,n/12))}static findHarmonics(e,t=8){const n=[];for(let s=1;s<=t;s++)n.push(e*s);return n}static isHarmonic(e,t,n=.05){if(t<=0||e<=0)return{isHarmonic:!1,harmonicNumber:null,exactFrequency:null};const s=e/t,r=Math.round(s);return r>=1&&Math.abs(s-r)<=n?{isHarmonic:!0,harmonicNumber:r,exactFrequency:t*r}:{isHarmonic:!1,harmonicNumber:null,exactFrequency:null}}static calculateFundamental(e,t){return t<=0||e<=0?0:e/t}static frequencyToScientificPitch(e){return se.frequencyToNote(e).name}static scientificPitchToFrequency(e){const t=e.match(/^([A-G][#b]?)(-?\d+)$/);if(!t)return 0;const[,n,s]=t,r=parseInt(s,10);let o=0;const a=n[0],c=n.slice(1);o={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[a]||0,c==="#"?o+=1:c==="b"&&(o-=1);const h=(r+1)*12+o;return se.midiToFrequency(h)}static formatFrequency(e,t=1){return e===0?"0 Hz":e<.1?"<0.1 Hz":e>=1e4?`${Math.round(e/1e3)}k Hz`:`${e.toFixed(t)} Hz`}static formatCents(e){return e===0?"0¢":`${e>0?"+":""}${e}¢`}};se.A4_FREQUENCY=440,se.A4_MIDI_NUMBER=69,se.NOTE_NAMES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],se.FLAT_NOTE_NAMES=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],se.INTERVALS={unison:0,minorSecond:1,majorSecond:2,minorThird:3,majorThird:4,perfectFourth:5,tritone:6,perfectFifth:7,minorSixth:8,majorSixth:9,minorSeventh:10,majorSeventh:11,octave:12};let be=se;/**
 * PitchPro Audio Processing Library
 * High-precision pitch detection and audio processing for web applications
 * 
 * @description A comprehensive audio detection component that provides real-time pitch detection,
 * volume analysis, and frequency display with automatic device optimization and UI management.
 * 
 * Supports unified management through MicrophoneController for centralized system control.
 * 
 * @version 1.3.0 (自動同期)
 * @author PitchPro Team
 * @license MIT
 * 
 * @example
 * ```typescript
 * // Basic usage with automatic device optimization
 * const audioDetector = new AudioDetectionComponent({
 *   volumeBarSelector: '#volume-bar',
 *   frequencySelector: '#frequency-display'
 * });
 * 
 * // Initialize the component
 * await audioDetector.initialize();
 * 
 * // Start pitch detection (v1.3.0 API)
 * const success = await audioDetector.startDetection();
 * if (success) {
 *   console.log('Detection started successfully');
 * }
 * 
 * // Stop detection but preserve UI state
 * audioDetector.stopDetection();
 * 
 * // Complete reset including UI (recommended)
 * audioDetector.microphoneController?.reset();
 * 
 * // Clean up when done
 * audioDetector.destroy();
 * ```
 * 
 * @example
 * ```typescript
 * // Advanced configuration for custom processing
 * const audioDetector = new AudioDetectionComponent({
 *   clarityThreshold: 0.3,
 *   minVolumeAbsolute: 0.001,
 *   deviceOptimization: true,
 *   autoUpdateUI: false, // Manual UI control
 *   onPitchUpdate: (result) => {
 *     // Custom processing with device-optimized results
 *     console.log(`Frequency: ${result.frequency}Hz, Volume: ${result.volume}%`);
 *   }
 * });
 * 
 * await audioDetector.initialize();
 * await audioDetector.startDetection();
 * ```
 * 
 * @example
 * ```typescript
 * // Using MicrophoneController for unified system management
 * const audioDetector = new AudioDetectionComponent({
 *   volumeBarSelector: '#volume-bar',
 *   frequencySelector: '#frequency-display'
 * });
 * 
 * await audioDetector.initialize();
 * const micController = audioDetector.microphoneController;
 * 
 * if (micController) {
 *   // Unified system control
 *   micController.start();     // Start detection
 *   micController.toggleMute(); // Mute/unmute
 *   micController.reset();      // Complete reset
 * }
 * ```
 */const pt=class pt{constructor(e={}){this.pitchDetector=null,this.micController=null,this.currentState="uninitialized",this.callbacks={},this.deviceSpecs=null,this.deviceSettings=null,this.uiUpdateTimer=null,this.isUpdatingSelectors=!1,this.uiElements={},this.lastError=null,this.isInitialized=!1,this.noteResetTimer=null,this.config={volumeBarSelector:e.volumeBarSelector,volumeTextSelector:e.volumeTextSelector,frequencySelector:e.frequencySelector,noteSelector:e.noteSelector,clarityThreshold:e.clarityThreshold??.4,minVolumeAbsolute:e.minVolumeAbsolute,fftSize:e.fftSize??4096,smoothing:e.smoothing??.1,deviceOptimization:e.deviceOptimization??!0,uiUpdateInterval:e.uiUpdateInterval??50,autoUpdateUI:e.autoUpdateUI??!0,onPitchUpdate:e.onPitchUpdate,debug:e.debug??!1,logPrefix:e.logPrefix??"🎵 AudioDetection"},this.config.deviceOptimization&&this.detectAndOptimizeDevice(),this.checkAutoUpdateUIWarnings(),this.debugLog(`${ot} AudioDetectionComponent created with config:`,this.config)}delay(e){return new Promise(t=>setTimeout(t,e))}checkAutoUpdateUIWarnings(){const e=!!(this.config.volumeBarSelector||this.config.volumeTextSelector||this.config.frequencySelector||this.config.noteSelector);e&&!this.config.autoUpdateUI&&console.warn("⚠️ [PitchPro v1.1.9] UI selectors provided without autoUpdateUI=true. Set autoUpdateUI=true to enable automatic updates, or remove selectors for manual control in onPitchUpdate callback."),e&&this.config.autoUpdateUI&&console.info("ℹ️ [PitchPro] Automatic UI updates enabled. Note: Values applied may include device-specific multipliers and may differ from callback result.volume. For precise control, set autoUpdateUI=false and handle UI manually.")}async initialize(){var e,t,n,s,r,o;if(this.isInitialized){this.debugLog("Already initialized");return}try{this.updateState("initializing"),this.debugLog(`${ot} Starting initialization...`),this.micController=new vi({audioManager:{sampleRate:44100,echoCancellation:!1,autoGainControl:!1},lifecycle:{maxAutoRecoveryAttempts:3,healthCheckIntervalMs:1e3},notifications:{enabled:this.config.debug}}),this.micController.setCallbacks({onStateChange:h=>{this.debugLog("MicrophoneController state:",h)},onError:h=>{this.handleError(h,"microphone_controller")},onDeviceChange:h=>{var u,d;this.deviceSpecs=h,(d=(u=this.callbacks).onDeviceDetected)==null||d.call(u,h)}}),await this.micController.initialize(),this.audioManager=this.micController.audioManager,this.debugLog("✅ AudioManager reference obtained from MicrophoneController"),this.debugLog("DeviceDetection values:",{device:(e=this.deviceSpecs)==null?void 0:e.deviceType,noiseGate:(t=this.deviceSpecs)==null?void 0:t.noiseGate,volumeMultiplier:(n=this.deviceSpecs)==null?void 0:n.volumeMultiplier,smoothingFactor:(s=this.deviceSpecs)==null?void 0:s.smoothingFactor});const a=mt.getDeviceSpecs(),c={clarityThreshold:this.config.clarityThreshold,minVolumeAbsolute:((r=this.deviceSpecs)==null?void 0:r.noiseGate)??a.noiseGate,fftSize:this.config.fftSize,smoothing:((o=this.deviceSpecs)==null?void 0:o.smoothingFactor)??a.smoothingFactor,deviceOptimization:this.config.deviceOptimization};this.debugLog("PitchDetector config object:",c),this.pitchDetector=new gi(this.audioManager,c),this.pitchDetector.setCallbacks({onPitchUpdate:h=>{this.handlePitchUpdate(h)},onError:h=>{this.handleError(h,"pitch_detector")},onStateChange:h=>{this.debugLog("PitchDetector state:",h),h==="detecting"&&this.config.autoUpdateUI?(this.debugLog("🔄 Starting UI updates (state: detecting)"),this.startUIUpdates()):h!=="detecting"&&this.uiUpdateTimer&&(this.debugLog("⏹️ Stopping UI updates (state: "+h+")"),clearInterval(this.uiUpdateTimer),this.uiUpdateTimer=null)}}),await this.pitchDetector.initialize();const l=this.pitchDetector.getStatus();this.debugLog("After PitchDetector initialization:",{status:l,componentState:l.componentState,isInitialized:l.isInitialized}),this.micController&&this.pitchDetector&&(this.micController.registerDetector(this.pitchDetector),this.micController.registerAudioDetectionComponent(this),this.debugLog("✅ PitchDetector and AudioDetectionComponent registered with MicrophoneController for unified management")),this.cacheUIElements(),this.deviceSpecs&&this.micController&&(this.micController.setSensitivity(this.deviceSpecs.sensitivity),this.debugLog("Applied DeviceDetection sensitivity:",this.deviceSpecs.sensitivity)),this.isInitialized=!0,this.updateState("ready"),this.debugLog("Initialization complete")}catch(a){const c=this.createStructuredError(a,"initialization");throw Ie.logError(c,"AudioDetectionComponent initialization"),this.lastError=c,this.updateState("error"),c}}updateUI(e){if(this.config.autoUpdateUI){if(this.isUpdatingSelectors){this.debugLog("UI update skipped - selectors are being updated");return}try{if(this.uiElements.volumeBar&&this.config.volumeBarSelector){const t=document.querySelector(this.config.volumeBarSelector);if(t&&t===this.uiElements.volumeBar){const n=Math.min(100,Math.max(0,e.volume));this.uiElements.volumeBar instanceof HTMLProgressElement?this.uiElements.volumeBar.value=n:this.uiElements.volumeBar.style.width=`${n}%`}}if(this.uiElements.volumeText&&this.config.volumeTextSelector){const t=document.querySelector(this.config.volumeTextSelector);if(t&&t===this.uiElements.volumeText){const n=Math.min(100,Math.max(0,e.volume));this.uiElements.volumeText.textContent=`${n.toFixed(1)}%`}}if(this.uiElements.frequency&&this.config.frequencySelector){const t=document.querySelector(this.config.frequencySelector);t&&t===this.uiElements.frequency&&(e.frequency&&e.frequency>0?this.uiElements.frequency.textContent=be.formatFrequency(e.frequency):this.uiElements.frequency.textContent="0.0 Hz")}if(this.uiElements.note&&this.config.noteSelector&&this.config.noteSelector!=="#note-display"){const t=document.querySelector(this.config.noteSelector);if(t&&t===this.uiElements.note)if(e.frequency&&e.frequency>0){this.noteResetTimer&&(clearTimeout(this.noteResetTimer),this.noteResetTimer=null);const n=be.frequencyToNote(e.frequency);this.debugLog(`Updating note display: ${this.uiElements.note.id||"unknown-id"} with note: ${n.name} (selector: ${this.config.noteSelector})`),this.uiElements.note.textContent=n.name}else this.noteResetTimer||(this.noteResetTimer=window.setTimeout(()=>{this.uiElements.note&&(this.debugLog(`Resetting note display: ${this.uiElements.note.id||"unknown-id"} to "-" (delayed, selector: ${this.config.noteSelector})`),this.uiElements.note.textContent="-"),this.noteResetTimer=null},pt.NOTE_RESET_DELAY_MS));else this.debugLog(`Note element mismatch: cached element does not match current selector ${this.config.noteSelector} - skipping update to prevent cross-mode interference`)}else this.config.noteSelector?this.debugLog("Note element not found in uiElements.note - check selector caching"):this.debugLog("Note updates skipped - no noteSelector configured")}catch(t){this.debugLog("UI update error:",t)}}}async updateSelectors(e){this.debugLog("Updating selectors:",e),this.isUpdatingSelectors=!0;const t=this.uiUpdateTimer!==null;t&&this.stopUIUpdates(),await this.delay(pt.SELECTOR_UPDATE_DELAY_MS),this.resetAllUIElements(),e.volumeBarSelector!==void 0&&(this.config.volumeBarSelector=e.volumeBarSelector),e.volumeTextSelector!==void 0&&(this.config.volumeTextSelector=e.volumeTextSelector),e.frequencySelector!==void 0&&(this.config.frequencySelector=e.frequencySelector),e.noteSelector!==void 0?this.config.noteSelector=e.noteSelector:(this.config.noteSelector="",this.debugLog("noteSelector cleared automatically to prevent cross-mode interference")),this.cacheUIElements(),await this.delay(pt.SELECTOR_UPDATE_DELAY_MS),this.resetAllUIElements(),this.isUpdatingSelectors=!1,t&&(await this.delay(pt.UI_RESTART_DELAY_MS),this.startUIUpdates()),this.debugLog("Selectors updated, all elements reset, and UI elements re-cached:",Object.keys(this.uiElements))}setCallbacks(e){this.debugLog("Setting callbacks:",Object.keys(e)),this.callbacks={...this.callbacks,...e},this.pitchDetector&&this.pitchDetector.setCallbacks({onPitchUpdate:e.onPitchUpdate,onError:e.onError?t=>{var s;const n=t instanceof Error&&"code"in t?t:this.createStructuredError(t,"pitch_detector");(s=e.onError)==null||s.call(e,n)}:void 0})}resetRecoveryAttempts(){this.debugLog("Resetting recovery attempts...");try{this.micController?(this.micController.resetRecoveryAttempts(),this.debugLog("Recovery attempts reset successfully")):this.debugLog("No microphone controller available to reset")}catch(e){throw this.debugLog("Error resetting recovery attempts:",e),e}}destroy(){this.debugLog("Destroying AudioDetectionComponent...");try{this.stopUIUpdates(),this.noteResetTimer&&(clearTimeout(this.noteResetTimer),this.noteResetTimer=null),this.pitchDetector&&(this.pitchDetector.destroy(),this.pitchDetector=null),this.micController&&(this.micController.destroy(),this.micController=null),this.uiElements={},this.isInitialized=!1,this.currentState="uninitialized",this.callbacks={},this.lastError=null,this.debugLog("AudioDetectionComponent destroyed")}catch(e){console.error("Error during AudioDetectionComponent destruction:",e)}}getStatus(){var e,t;return{state:this.currentState,isInitialized:this.isInitialized,deviceSpecs:this.deviceSpecs,deviceSettings:this.deviceSettings,config:this.config,lastError:this.lastError,pitchDetectorStatus:(e=this.pitchDetector)==null?void 0:e.getStatus(),micControllerStatus:(t=this.micController)==null?void 0:t.getStatus()}}get microphoneController(){return this.micController}detectAndOptimizeDevice(){this.deviceSpecs=mt.getDeviceSpecs(),this.debugLog("Using DeviceDetection values directly:",{device:this.deviceSpecs.deviceType,noiseGate:`${this.deviceSpecs.noiseGate} (${(this.deviceSpecs.noiseGate*100).toFixed(2)}% threshold)`,volumeMultiplier:this.deviceSpecs.volumeMultiplier,sensitivity:this.deviceSpecs.sensitivity,smoothingFactor:this.deviceSpecs.smoothingFactor}),this.debugLog("Device optimization applied:",{device:this.deviceSpecs.deviceType,settings:this.deviceSpecs})}cacheUIElements(){var e;if(!this.config.autoUpdateUI){this.debugLog("UI element caching skipped - autoUpdateUI is disabled");return}this.config.volumeBarSelector&&(this.uiElements.volumeBar=document.querySelector(this.config.volumeBarSelector)||void 0),this.config.volumeTextSelector&&(this.uiElements.volumeText=document.querySelector(this.config.volumeTextSelector)||void 0),this.config.frequencySelector&&(this.uiElements.frequency=document.querySelector(this.config.frequencySelector)||void 0),this.config.noteSelector&&(this.uiElements.note=document.querySelector(this.config.noteSelector)||void 0,this.debugLog(`Note element cached: selector="${this.config.noteSelector}", found=${!!this.uiElements.note}, id="${((e=this.uiElements.note)==null?void 0:e.id)||"no-id"}"`)),this.debugLog("UI elements cached:",Object.keys(this.uiElements))}resetDisplayElements(){this.resetAllUIElements()}async startDetection(){if(this.debugLog("Starting detection via AudioDetectionComponent..."),!this.isInitialized)return this.debugLog("Cannot start detection - component not initialized"),!1;if(!this.micController)return this.debugLog("Cannot start detection - no MicrophoneController available"),!1;try{return this.micController.start()?(this.debugLog("✅ Detection started successfully via MicrophoneController"),this.updateState("detecting"),!0):(this.debugLog("❌ Failed to start detection via MicrophoneController"),!1)}catch(e){const t=this.createStructuredError(e,"start_detection");return this.debugLog("Error starting detection:",t),this.lastError=t,this.updateState("error"),!1}}stopDetection(){if(this.debugLog("Stopping detection via AudioDetectionComponent..."),!this.pitchDetector)return this.debugLog("Cannot stop detection - no PitchDetector available"),!1;try{return this.pitchDetector.stopDetection(),this.debugLog("✅ Detection stopped successfully, UI state preserved"),this.updateState("ready"),!0}catch(e){const t=this.createStructuredError(e,"stop_detection");return this.debugLog("Error stopping detection:",t),this.lastError=t,!1}}resetAllUIElements(){try{if(this.uiElements.volumeBar&&this.config.volumeBarSelector){const n=document.querySelector(this.config.volumeBarSelector);n&&n===this.uiElements.volumeBar&&(this.uiElements.volumeBar instanceof HTMLProgressElement?this.uiElements.volumeBar.value=0:this.uiElements.volumeBar.style.width="0%",this.debugLog(`Reset cached volume bar: ${this.config.volumeBarSelector}`))}if(this.uiElements.volumeText&&this.config.volumeTextSelector){const n=document.querySelector(this.config.volumeTextSelector);n&&n===this.uiElements.volumeText&&(this.uiElements.volumeText.textContent="0.0%",this.debugLog(`Reset cached volume text: ${this.config.volumeTextSelector}`))}if(this.uiElements.frequency&&this.config.frequencySelector){const n=document.querySelector(this.config.frequencySelector);n&&n===this.uiElements.frequency&&(this.uiElements.frequency.textContent="0.0 Hz",this.debugLog(`Reset cached frequency: ${this.config.frequencySelector}`))}if(this.uiElements.note&&this.config.noteSelector){const n=document.querySelector(this.config.noteSelector);n&&n===this.uiElements.note&&(this.uiElements.note.textContent="-",this.debugLog(`Reset cached note: ${this.config.noteSelector}`))}const e=["#mic-volume-bar","#mic-volume-text","#mic-frequency","#mic-frequency-display","#range-volume-bar","#range-volume-text","#range-frequency","#range-frequency-value","#range-frequency-display","#practice-volume-bar","#practice-volume-text","#practice-frequency","#practice-note","#freq-1","#freq-2","#freq-3","#freq-4","#freq-5","#frequency-1","#frequency-2","#frequency-3","#pitch-1","#pitch-2","#pitch-3"];document.querySelectorAll('[id*="freq"]:not(.frequency-group):not(.frequency-box), [id*="frequency"]:not(.frequency-group):not(.frequency-box), [id*="pitch"]:not(.frequency-group):not(.frequency-box)').forEach(n=>{const s=n.textContent||"";(s.includes("Hz")||s.match(/^\d+\.?\d*$/))&&(n.classList.contains("frequency-display")||n.id.includes("freq-"))&&(n.textContent="0.0 Hz")}),e.forEach(n=>{if(n&&n!==this.config.volumeBarSelector&&n!==this.config.volumeTextSelector&&n!==this.config.frequencySelector&&n!==this.config.noteSelector){const s=document.querySelector(n);if(s){if(this.debugLog(`Processing additional selector: ${n}`),n.includes("volume-bar"))s instanceof HTMLProgressElement?s.value=0:s.style.width="0%";else if(n.includes("volume-text"))s.textContent="0.0%";else if(n.includes("frequency"))s.textContent="0.0 Hz",s.innerHTML="0.0 Hz",s.setAttribute("data-frequency","0"),s.style.display!=="none"&&(s.style.opacity="0.99",s.offsetHeight,s.style.opacity="");else if(n.includes("note")){const r=s.textContent,o=s.innerHTML;this.debugLog(`Resetting note element: ${n}, textContent: "${r}", innerHTML: "${o}"`),s.textContent="-",s.innerHTML="-",s.style.opacity="0.99",s.offsetHeight,s.style.opacity="",this.debugLog(`Note reset complete: ${n}, new textContent: "${s.textContent}", new innerHTML: "${s.innerHTML}"`)}}}}),this.debugLog("All UI elements reset to initial state (cached elements processed first)")}catch(e){this.debugLog("Error resetting UI elements:",e)}}handlePitchUpdate(e){var n,s,r,o;const t=this._getProcessedResult(e);t&&((s=(n=this.callbacks).onPitchUpdate)==null||s.call(n,t),(o=(r=this.callbacks).onVolumeUpdate)==null||o.call(r,t.volume))}startUIUpdates(){this.uiUpdateTimer&&clearInterval(this.uiUpdateTimer),this.uiUpdateTimer=window.setInterval(()=>{if(this.pitchDetector&&this.pitchDetector.getStatus().componentState==="detecting"){const e=this.pitchDetector.getLatestResult(),t=this._getProcessedResult(e);if(t)this.config.autoUpdateUI&&this.updateUI(t),this.config.onPitchUpdate?(this.debugLog("Calling onPitchUpdate callback with result:",t),this.config.onPitchUpdate(t)):this.debugLog("onPitchUpdate callback not set - skipping callback execution");else{const n={frequency:0,note:"-",octave:0,volume:0,rawVolume:0,clarity:0};this.config.autoUpdateUI&&this.updateUI(n),this.config.onPitchUpdate&&this.config.onPitchUpdate(n)}}},this.config.uiUpdateInterval)}stopUIUpdates(){this.uiUpdateTimer&&(clearInterval(this.uiUpdateTimer),this.uiUpdateTimer=null)}_getProcessedResult(e){var l,h,u,d,f;if(!e)return null;const t={...e},s=e.volume*200,o=(((l=this.deviceSpecs)==null?void 0:l.noiseGate)??.06)*100*10;if(s<o)return t.volume=0,t.frequency=0,t.note="--",t.rawVolume=e.volume,this.config.debug&&this.debugLog("UnifiedVolumeProcessing: BLOCKED",{device:(h=this.deviceSpecs)==null?void 0:h.deviceType,volumeAsPercent:s.toFixed(2),noiseGateThreshold:`${o.toFixed(2)}%`,note:"Environment noise filtering active"}),t;const a=((u=this.deviceSpecs)==null?void 0:u.volumeMultiplier)??1,c=s*a;return t.volume=Math.min(100,Math.max(0,c)),t.rawVolume=e.volume,this.config.debug&&this.debugLog("UnifiedVolumeProcessing: PASSED",{device:(d=this.deviceSpecs)==null?void 0:d.deviceType,initialPercent:s.toFixed(2),noiseGate:`${o.toFixed(2)}%`,multiplier:a,finalVolume:`${t.volume.toFixed(2)}%`,frequency:`${(f=e.frequency)==null?void 0:f.toFixed(2)}Hz`}),t}updateState(e){var t,n;if(this.currentState!==e){const s=this.currentState;this.currentState=e,this.debugLog(`State changed: ${s} → ${e}`),(n=(t=this.callbacks).onStateChange)==null||n.call(t,e)}}handleError(e,t){var s,r;const n=e instanceof Ce?e:this.createStructuredError(e,t);this.lastError=n,this.updateState("error"),(r=(s=this.callbacks).onError)==null||r.call(s,n),this.debugLog("Error handled:",n.toJSON())}createStructuredError(e,t){return e.message.includes("Permission denied")||e.message.includes("NotAllowedError")||e.message.includes("permission")?new hs("マイクへのアクセス許可が拒否されました。ブラウザの設定でマイクアクセスを許可してください。",{operation:t,originalError:e.message,deviceSpecs:this.deviceSpecs,componentState:this.currentState}):e.message.includes("AudioContext")||e.message.includes("audio")||e.message.includes("initialization")?new at("オーディオシステムの初期化に失敗しました。デバイスの音響設定を確認するか、ブラウザを再起動してください。",{operation:t,originalError:e.message,componentState:this.currentState,deviceSpecs:this.deviceSpecs}):new Ce(`${t}中に予期しないエラーが発生しました: ${e.message}`,gt.PITCH_DETECTION_ERROR,{operation:t,originalError:e.message,stack:e.stack,componentState:this.currentState,isInitialized:this.isInitialized})}debugLog(e,...t){this.config.debug&&console.log(`${this.config.logPrefix} ${e}`,...t)}};pt.NOTE_RESET_DELAY_MS=300,pt.SELECTOR_UPDATE_DELAY_MS=50,pt.UI_RESTART_DELAY_MS=200;let us=pt;class lo{constructor(e={}){this.historyBuffer=[],this.config={historyWindowMs:2e3,minConfidenceThreshold:.6,harmonicToleranceCents:30,maxHarmonicNumber:8,stabilityWeight:.7,volumeWeight:.3},this.config={...this.config,...e}}correctFrequency(e,t=1){const n=Date.now();this.cleanHistory(n),this.addToHistory(e,t,n);const s=this.analyzeHarmonics(e);return s.confidence>=this.config.minConfidenceThreshold?{correctedFreq:s.correctedFrequency,confidence:s.confidence,correctionApplied:Math.abs(s.correctedFrequency-e)>1}:{correctedFreq:e,confidence:s.confidence,correctionApplied:!1}}analyzeHarmonics(e){if(this.historyBuffer.length<3)return{correctedFrequency:e,confidence:.1};const t=this.historyBuffer.slice(-10).map(r=>r.frequency),n=this.findFundamentalCandidates(e);let s={frequency:e,confidence:.1,harmonicNumber:1};for(const r of n){const o=this.calculateHarmonicConfidence(r.fundamental,r.harmonicNumber,t);o>s.confidence&&(s={frequency:r.fundamental,confidence:o,harmonicNumber:r.harmonicNumber})}return s.harmonicNumber>1&&s.confidence>this.config.minConfidenceThreshold?{correctedFrequency:s.frequency,confidence:s.confidence,harmonicNumber:s.harmonicNumber,fundamentalCandidate:s.frequency}:{correctedFrequency:e,confidence:s.confidence}}findFundamentalCandidates(e){const t=[];for(let n=2;n<=this.config.maxHarmonicNumber;n++){const s=e/n;if(s<60)continue;const r=s*n,o=Math.abs(1200*Math.log2(e/r));if(o<=this.config.harmonicToleranceCents){const a=1-o/this.config.harmonicToleranceCents;t.push({fundamental:s,harmonicNumber:n,likelihood:a})}}return t.push({fundamental:e,harmonicNumber:1,likelihood:.5}),t.sort((n,s)=>s.likelihood-n.likelihood)}calculateHarmonicConfidence(e,t,n){if(n.length<3)return .1;let s=0,r=0;for(const c of n){let l=Math.round(c/e);l<1&&(l=1);const h=e*l,u=Math.abs(1200*Math.log2(c/h));if(u<=this.config.harmonicToleranceCents*2){const d=1-u/(this.config.harmonicToleranceCents*2);s+=d,r++}}if(r===0)return .1;const o=s/r,a=Math.min(r/n.length,1);return Math.min(o*this.config.stabilityWeight+a*(1-this.config.stabilityWeight),1)}addToHistory(e,t,n){const s=Math.min(t,1);let r=.5;if(this.historyBuffer.length>0){const a=this.historyBuffer[this.historyBuffer.length-1].frequency,c=Math.max(e,a)/Math.min(e,a);r=Math.max(0,1-(c-1)*5)}const o=s*this.config.volumeWeight+r*(1-this.config.volumeWeight);this.historyBuffer.push({frequency:e,confidence:o,timestamp:n,volume:t}),this.historyBuffer.length>50&&this.historyBuffer.shift()}cleanHistory(e){const t=e-this.config.historyWindowMs;this.historyBuffer=this.historyBuffer.filter(n=>n.timestamp>t)}resetHistory(){this.historyBuffer=[]}getAnalysisStats(){if(this.historyBuffer.length===0)return{historyLength:0,averageConfidence:0,frequencyRange:null,stabilityScore:0};const e=this.historyBuffer.map(h=>h.frequency),t=this.historyBuffer.map(h=>h.confidence),n=t.reduce((h,u)=>h+u,0)/t.length,s=Math.min(...e),r=Math.max(...e),o=e.reduce((h,u)=>h+u,0)/e.length,a=e.reduce((h,u)=>h+Math.pow(u-o,2),0)/e.length,c=Math.sqrt(a)/o,l=Math.max(0,1-c);return{historyLength:this.historyBuffer.length,averageConfidence:n,frequencyRange:{min:s,max:r},stabilityScore:l}}updateConfig(e){this.config={...this.config,...e}}}const _t={EXCELLENT:"excellent",GOOD:"good",FAIR:"fair",POOR:"poor"};class ho{constructor(e={}){this.analysisBuffer=[],this.config={analysisWindowMs:3e3,stabilityThresholdCents:20,vibratoMinRate:4.5,vibratoMaxRate:7.5,vibratoMinDepthCents:50,breathinessThreshold:.3,minAnalysisTime:1e3},this.config={...this.config,...e}}analyzeVoice(e,t,n,s){const r=Date.now();this.addToBuffer(e,t,n,r),this.cleanBuffer(r);const o=this.calculateStability(),a=this.detectVibrato(),c=s?this.analyzeBreathiness(s):null,l=this.analyzeConsistency(),h=this.calculateOverallQuality(o,a,c,l),u=this.generateRecommendations(h,o,a,c,l);return{quality:h,stability:o,recommendations:u}}calculateStability(){if(this.analysisBuffer.length<10)return .5;const t=this.analysisBuffer.map(c=>c.frequency).filter(c=>c>0);if(t.length<5)return .3;const n=t.reduce((c,l)=>c+l,0)/t.length,s=t.reduce((c,l)=>c+Math.pow(l-n,2),0)/t.length,a=Math.sqrt(s)/n*1200;return Math.max(0,Math.min(1,1-a/100))}detectVibrato(){if(this.analysisBuffer.length<30)return{detected:!1,rate:null,depth:null,regularity:null};const e=this.analysisBuffer.map(d=>d.frequency).filter(d=>d>0);if(e.length<20)return{detected:!1,rate:null,depth:null,regularity:null};const t=this.smoothFrequencies(e,3),n=this.findExtrema(t);if(n.length<4)return{detected:!1,rate:null,depth:null,regularity:null};const s=(this.analysisBuffer[this.analysisBuffer.length-1].timestamp-this.analysisBuffer[0].timestamp)/1e3,o=n.length/2/s,a=[];for(let d=0;d<n.length-1;d++){const f=t[n[d].index],p=t[n[d+1].index];if(f>0&&p>0){const m=Math.abs(1200*Math.log2(f/p));a.push(m)}}const c=a.length>0?a.reduce((d,f)=>d+f,0)/a.length:0,l=[];for(let d=0;d<n.length-2;d+=2){const f=n[d+2].index-n[d].index;l.push(f)}let h=0;if(l.length>2){const d=l.reduce((p,m)=>p+m,0)/l.length,f=l.reduce((p,m)=>p+Math.pow(m-d,2),0)/l.length;h=Math.max(0,1-Math.sqrt(f)/d)}return{detected:o>=this.config.vibratoMinRate&&o<=this.config.vibratoMaxRate&&c>=this.config.vibratoMinDepthCents,rate:o,depth:c,regularity:h}}analyzeBreathiness(e){const t=Math.floor(e.length*.1),n=e.slice(Math.floor(e.length*.7)),s=e.slice(0,t*2).reduce((a,c)=>a+c*c,0),r=n.reduce((a,c)=>a+c*c,0);if(s===0)return 1;const o=r/s;return Math.min(1,o)}analyzeConsistency(){if(this.analysisBuffer.length<10)return .5;const e=this.analysisBuffer.map(r=>r.volume),t=this.analysisBuffer.map(r=>r.clarity),n=this.calculateConsistencyScore(e),s=this.calculateConsistencyScore(t);return(n+s)/2}calculateConsistencyScore(e){if(e.length<3)return .5;const t=e.reduce((r,o)=>r+o,0)/e.length,n=e.reduce((r,o)=>r+Math.pow(o-t,2),0)/e.length,s=Math.sqrt(n)/(t||1);return Math.max(0,Math.min(1,1-s))}calculateOverallQuality(e,t,n,s){const r={stability:.4,consistency:.3,breathiness:.2,vibrato:.1};let o=e*r.stability+s*r.consistency;return n!==null?o+=(1-Math.min(n,1))*r.breathiness:o+=.7*r.breathiness,t.detected&&t.regularity>.7?o+=.9*r.vibrato:t.detected?o+=.6*r.vibrato:o+=.5*r.vibrato,o>=.85?_t.EXCELLENT:o>=.7?_t.GOOD:o>=.5?_t.FAIR:_t.POOR}generateRecommendations(e,t,n,s,r){const o=[];return t<.5?(o.push("音程の安定性を向上させるため、ゆっくりとした発声練習を行ってください"),o.push("腹式呼吸を意識して、息の流れを一定に保つ練習をしてください")):t<.7&&o.push("音程の微調整練習で、より正確なピッチコントロールを目指しましょう"),r<.5&&(o.push("音量と音質の一貫性を保つため、定期的な発声練習を継続してください"),o.push("録音を聞き返して、自分の声の特徴を把握しましょう")),s!==null&&s>.6&&(o.push("声の息漏れが気になります。発声時の喉の締まりを意識してください"),o.push("ハミング練習で、クリアな声質を目指しましょう")),n.detected?n.regularity<.5?o.push("ビブラートの規則性を改善するため、メトロノームに合わせた練習をしてください"):n.rate>7.5&&o.push("ビブラートの速度が速すぎます。よりゆったりとしたビブラートを練習してください"):(e===_t.GOOD||e===_t.EXCELLENT)&&o.push("美しいビブラートの習得に挑戦してみましょう"),e===_t.POOR?(o.push("基礎的な発声練習から始めることをお勧めします"),o.push("専門的な指導を受けることを検討してください")):e===_t.EXCELLENT&&o.push("素晴らしい声質です。この状態を維持する練習を続けてください"),o}smoothFrequencies(e,t){const n=[];for(let s=0;s<e.length;s++){let r=0,o=0;const a=Math.max(0,s-Math.floor(t/2)),c=Math.min(e.length,s+Math.floor(t/2)+1);for(let l=a;l<c;l++)r+=e[l],o++;n.push(r/o)}return n}findExtrema(e){const t=[];for(let n=1;n<e.length-1;n++){const s=e[n-1],r=e[n],o=e[n+1];r>s&&r>o?t.push({index:n,value:r,type:"peak"}):r<s&&r<o&&t.push({index:n,value:r,type:"valley"})}return t}addToBuffer(e,t,n,s){this.analysisBuffer.push({frequency:e,volume:t,clarity:n,timestamp:s}),this.analysisBuffer.length>200&&this.analysisBuffer.shift()}cleanBuffer(e){const t=e-this.config.analysisWindowMs;this.analysisBuffer=this.analysisBuffer.filter(n=>n.timestamp>t)}reset(){this.analysisBuffer=[]}getBufferStats(){if(this.analysisBuffer.length===0)return{entryCount:0,timeSpanMs:0,averageVolume:0,averageClarity:0};const e=this.analysisBuffer.map(s=>s.volume),t=this.analysisBuffer.map(s=>s.clarity),n=this.analysisBuffer[this.analysisBuffer.length-1].timestamp-this.analysisBuffer[0].timestamp;return{entryCount:this.analysisBuffer.length,timeSpanMs:n,averageVolume:e.reduce((s,r)=>s+r,0)/e.length,averageClarity:t.reduce((s,r)=>s+r,0)/t.length}}}class uo{constructor(){this.calibrationData=null,this.isCalibrated=!1,this.calibrationInProgress=!1,this.deviceSpecs=mt.getDeviceSpecs()}async calibrate(e,t){if(this.calibrationInProgress)throw new Error("Calibration already in progress");this.calibrationInProgress=!0;try{console.log("🎛️ [CalibrationSystem] Starting device calibration");const n=await this.measureBackgroundNoise(e,t),s=await this.calibrateVolumeLevels(e,t),r=await this.measureFrequencyResponse(e,t),o=this.calculateOptimalSettings(n,s,r);return this.calibrationData={volumeOffset:s.offset,frequencyResponse:r,noiseProfile:n,optimalSettings:o},this.isCalibrated=!0,this.calibrationInProgress=!1,console.log("✅ [CalibrationSystem] Calibration completed successfully"),{success:!0,calibrationData:this.calibrationData,recommendedSettings:o}}catch(n){return console.error("❌ [CalibrationSystem] Calibration failed:",n),this.calibrationInProgress=!1,{success:!1,calibrationData:null,recommendedSettings:this.getDefaultSettings(),error:n}}}async measureBackgroundNoise(e,t,n=2e3){return new Promise(s=>{const r=e.createAnalyser();r.fftSize=2048;const o=e.createMediaStreamSource(t);o.connect(r);const a=r.frequencyBinCount,c=new Float32Array(a),l=[],h=Date.now(),u=()=>{if(Date.now()-h>=n){const d={};for(let f=0;f<a;f++){const p=f*e.sampleRate/r.fftSize;let m=0;for(const g of l)m+=g[f];d[Math.round(p)]=m/l.length}o.disconnect(),s(d);return}r.getFloatFrequencyData(c),l.push(new Float32Array(c)),setTimeout(u,100)};u()})}async calibrateVolumeLevels(e,t,n=3e3){return new Promise(s=>{const r=e.createAnalyser();r.fftSize=1024;const o=e.createMediaStreamSource(t);o.connect(r);const a=r.fftSize,c=new Float32Array(a),l=[],h=Date.now(),u=()=>{if(Date.now()-h>=n){l.sort((b,C)=>b-C);const p=l[0]||0,m=l[l.length-1]||1,T=.3-(l[Math.floor(l.length/2)]||.5);o.disconnect(),s({offset:T,range:{min:p,max:m}});return}r.getFloatTimeDomainData(c);let d=0;for(let p=0;p<a;p++)d+=c[p]*c[p];const f=Math.sqrt(d/a);l.push(f),setTimeout(u,50)};u()})}async measureFrequencyResponse(e,t,n=5e3){return new Promise(s=>{const r=e.createAnalyser();r.fftSize=4096;const o=e.createMediaStreamSource(t);o.connect(r);const a=r.frequencyBinCount,c=new Float32Array(a),l={},h=Date.now(),u=()=>{if(Date.now()-h>=n){const d={};Object.keys(l).forEach(f=>{const p=parseInt(f),m=l[p],g=m.reduce((_,T)=>_+T,0)/m.length;d[p]=g}),o.disconnect(),s(d);return}r.getFloatFrequencyData(c);for(let d=0;d<a;d++){const f=Math.round(d*e.sampleRate/r.fftSize);f>=80&&f<=1e3&&(l[f]||(l[f]=[]),l[f].push(c[d]))}setTimeout(u,100)};u()})}calculateOptimalSettings(e,t,n){const s=this.getDefaultSettings(),r=Math.max(.5,Math.min(2,1-t.offset)),o=s.sensitivity*r,c=Object.keys(e).map(C=>parseInt(C)).filter(C=>C>=100&&C<=800).map(C=>e[C]),l=c.length>0?c.reduce((C,y)=>C+y,0)/c.length:-60,h=Math.max(-20,l+10),u=Math.max(s.noiseGate,Math.abs(h)/1e3),f=Object.keys(n).map(C=>parseInt(C)).sort((C,y)=>C-y).map(C=>n[C]),p=f.slice(0,Math.floor(f.length*.3)),m=f.slice(Math.floor(f.length*.3),Math.floor(f.length*.7)),g=f.slice(Math.floor(f.length*.7)),_=p.reduce((C,y)=>C+y,0)/p.length,T=m.reduce((C,y)=>C+y,0)/m.length,b=g.reduce((C,y)=>C+y,0)/g.length;return{sensitivity:Math.round(o*10)/10,noiseGate:Math.round(u*1e3)/1e3,volumeOffset:t.offset,filterSettings:{highpassFreq:_<T-5?100:80,lowpassFreq:b>T+3?600:800,notchFreq:60,highpassQ:.7,lowpassQ:.7,notchQ:10},deviceAdjustments:{lowFreqCompensation:Math.max(.8,Math.min(1.5,T/(_||-60))),highFreqCompensation:Math.max(.8,Math.min(1.2,T/(b||-60)))}}}getDefaultSettings(){return{sensitivity:this.deviceSpecs.sensitivity,noiseGate:this.deviceSpecs.noiseGate,volumeOffset:0,filterSettings:{highpassFreq:80,lowpassFreq:800,notchFreq:60,highpassQ:.7,lowpassQ:.7,notchQ:10}}}applyCalibration(e){if(!this.isCalibrated||!this.calibrationData)return console.warn("⚠️ [CalibrationSystem] No calibration data available"),!1;try{const t=this.calibrationData.optimalSettings;return e.setSensitivity&&e.setSensitivity(t.sensitivity),e.setNoiseGate&&e.setNoiseGate(t.noiseGate),e.updateFilterSettings&&e.updateFilterSettings(t.filterSettings),console.log("✅ [CalibrationSystem] Calibration applied successfully"),!0}catch(t){return console.error("❌ [CalibrationSystem] Failed to apply calibration:",t),!1}}getCalibrationStatus(){return{isCalibrated:this.isCalibrated,inProgress:this.calibrationInProgress,deviceSpecs:this.deviceSpecs,calibrationData:this.calibrationData}}reset(){this.isCalibrated=!1,this.calibrationInProgress=!1,this.calibrationData=null,console.log("🔄 [CalibrationSystem] Calibration reset")}saveCalibration(){if(!this.isCalibrated||!this.calibrationData)return!1;try{const e=`pitchpro_calibration_${this.deviceSpecs.deviceType}`,t={deviceSpecs:this.deviceSpecs,calibrationData:this.calibrationData,timestamp:Date.now()};return localStorage.setItem(e,JSON.stringify(t)),console.log("💾 [CalibrationSystem] Calibration saved"),!0}catch(e){return console.error("❌ [CalibrationSystem] Failed to save calibration:",e),!1}}loadCalibration(){try{const e=`pitchpro_calibration_${this.deviceSpecs.deviceType}`,t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t),s=7*24*60*60*1e3;return Date.now()-n.timestamp>s?(console.log("⏰ [CalibrationSystem] Saved calibration is too old, ignoring"),!1):n.deviceSpecs.deviceType!==this.deviceSpecs.deviceType?(console.log("📱 [CalibrationSystem] Device type mismatch, ignoring saved calibration"),!1):(this.calibrationData=n.calibrationData,this.isCalibrated=!0,console.log("📂 [CalibrationSystem] Calibration loaded successfully"),!0)}catch(e){return console.error("❌ [CalibrationSystem] Failed to load calibration:",e),!1}}}const Si="15.1.22",Ci=(i,e,t)=>({endTime:e,insertTime:t,type:"exponentialRampToValue",value:i}),Ti=(i,e,t)=>({endTime:e,insertTime:t,type:"linearRampToValue",value:i}),ds=(i,e)=>({startTime:e,type:"setValue",value:i}),wi=(i,e,t)=>({duration:t,startTime:e,type:"setValueCurve",values:i}),bi=(i,e,{startTime:t,target:n,timeConstant:s})=>n+(e-n)*Math.exp((t-i)/s),Pt=i=>i.type==="exponentialRampToValue",En=i=>i.type==="linearRampToValue",yt=i=>Pt(i)||En(i),fs=i=>i.type==="setValue",ct=i=>i.type==="setValueCurve",xn=(i,e,t,n)=>{const s=i[e];return s===void 0?n:yt(s)||fs(s)?s.value:ct(s)?s.values[s.values.length-1]:bi(t,xn(i,e-1,s.startTime,n),s)},Ai=(i,e,t,n,s)=>t===void 0?[n.insertTime,s]:yt(t)?[t.endTime,t.value]:fs(t)?[t.startTime,t.value]:ct(t)?[t.startTime+t.duration,t.values[t.values.length-1]]:[t.startTime,xn(i,e-1,t.startTime,s)],ps=i=>i.type==="cancelAndHold",ms=i=>i.type==="cancelScheduledValues",vt=i=>ps(i)||ms(i)?i.cancelTime:Pt(i)||En(i)?i.endTime:i.startTime,Mi=(i,e,t,{endTime:n,value:s})=>t===s?s:0<t&&0<s||t<0&&s<0?t*(s/t)**((i-e)/(n-e)):0,Ei=(i,e,t,{endTime:n,value:s})=>t+(i-e)/(n-e)*(s-t),fo=(i,e)=>{const t=Math.floor(e),n=Math.ceil(e);return t===n?i[t]:(1-(e-t))*i[t]+(1-(n-e))*i[n]},po=(i,{duration:e,startTime:t,values:n})=>{const s=(i-t)/e*(n.length-1);return fo(n,s)},Nn=i=>i.type==="setTarget";class mo{constructor(e){this._automationEvents=[],this._currenTime=0,this._defaultValue=e}[Symbol.iterator](){return this._automationEvents[Symbol.iterator]()}add(e){const t=vt(e);if(ps(e)||ms(e)){const n=this._automationEvents.findIndex(r=>ms(e)&&ct(r)?r.startTime+r.duration>=t:vt(r)>=t),s=this._automationEvents[n];if(n!==-1&&(this._automationEvents=this._automationEvents.slice(0,n)),ps(e)){const r=this._automationEvents[this._automationEvents.length-1];if(s!==void 0&&yt(s)){if(r!==void 0&&Nn(r))throw new Error("The internal list is malformed.");const o=r===void 0?s.insertTime:ct(r)?r.startTime+r.duration:vt(r),a=r===void 0?this._defaultValue:ct(r)?r.values[r.values.length-1]:r.value,c=Pt(s)?Mi(t,o,a,s):Ei(t,o,a,s),l=Pt(s)?Ci(c,t,this._currenTime):Ti(c,t,this._currenTime);this._automationEvents.push(l)}if(r!==void 0&&Nn(r)&&this._automationEvents.push(ds(this.getValue(t),t)),r!==void 0&&ct(r)&&r.startTime+r.duration>t){const o=t-r.startTime,a=(r.values.length-1)/r.duration,c=Math.max(2,1+Math.ceil(o*a)),l=o/(c-1)*a,h=r.values.slice(0,c);if(l<1)for(let u=1;u<c;u+=1){const d=l*u%1;h[u]=r.values[u-1]*(1-d)+r.values[u]*d}this._automationEvents[this._automationEvents.length-1]=wi(h,r.startTime,o)}}}else{const n=this._automationEvents.findIndex(o=>vt(o)>t),s=n===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[n-1];if(s!==void 0&&ct(s)&&vt(s)+s.duration>t)return!1;const r=Pt(e)?Ci(e.value,e.endTime,this._currenTime):En(e)?Ti(e.value,t,this._currenTime):e;if(n===-1)this._automationEvents.push(r);else{if(ct(e)&&t+e.duration>vt(this._automationEvents[n]))return!1;this._automationEvents.splice(n,0,r)}}return!0}flush(e){const t=this._automationEvents.findIndex(n=>vt(n)>e);if(t>1){const n=this._automationEvents.slice(t-1),s=n[0];Nn(s)&&n.unshift(ds(xn(this._automationEvents,t-2,s.startTime,this._defaultValue),s.startTime)),this._automationEvents=n}}getValue(e){if(this._automationEvents.length===0)return this._defaultValue;const t=this._automationEvents.findIndex(o=>vt(o)>e),n=this._automationEvents[t],s=(t===-1?this._automationEvents.length:t)-1,r=this._automationEvents[s];if(r!==void 0&&Nn(r)&&(n===void 0||!yt(n)||n.insertTime>e))return bi(e,xn(this._automationEvents,s-1,r.startTime,this._defaultValue),r);if(r!==void 0&&fs(r)&&(n===void 0||!yt(n)))return r.value;if(r!==void 0&&ct(r)&&(n===void 0||!yt(n)||r.startTime+r.duration>e))return e<r.startTime+r.duration?po(e,r):r.values[r.values.length-1];if(r!==void 0&&yt(r)&&(n===void 0||!yt(n)))return r.value;if(n!==void 0&&Pt(n)){const[o,a]=Ai(this._automationEvents,s,r,n,this._defaultValue);return Mi(e,o,a,n)}if(n!==void 0&&En(n)){const[o,a]=Ai(this._automationEvents,s,r,n,this._defaultValue);return Ei(e,o,a,n)}return this._defaultValue}}const go=i=>({cancelTime:i,type:"cancelAndHold"}),_o=i=>({cancelTime:i,type:"cancelScheduledValues"}),yo=(i,e)=>({endTime:e,type:"exponentialRampToValue",value:i}),vo=(i,e)=>({endTime:e,type:"linearRampToValue",value:i}),So=(i,e,t)=>({startTime:e,target:i,timeConstant:t,type:"setTarget"}),Co=()=>new DOMException("","AbortError"),To=i=>(e,t,[n,s,r],o)=>{i(e[s],[t,n,r],a=>a[0]===t&&a[1]===n,o)},wo=i=>(e,t,n)=>{const s=[];for(let r=0;r<n.numberOfInputs;r+=1)s.push(new Set);i.set(e,{activeInputs:s,outputs:new Set,passiveInputs:new WeakMap,renderer:t})},bo=i=>(e,t)=>{i.set(e,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:t})},qt=new WeakSet,xi=new WeakMap,gs=new WeakMap,Ni=new WeakMap,_s=new WeakMap,In=new WeakMap,Ii=new WeakMap,ys=new WeakMap,vs=new WeakMap,Ss=new WeakMap,ki={construct(){return ki}},Ao=i=>{try{const e=new Proxy(i,ki);new e}catch{return!1}return!0},Di=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,Fi=(i,e)=>{const t=[];let n=i.replace(/^[\s]+/,""),s=n.match(Di);for(;s!==null;){const r=s[1].slice(1,-1),o=s[0].replace(/([\s]+)?;?$/,"").replace(r,new URL(r,e).toString());t.push(o),n=n.slice(s[0].length).replace(/^[\s]+/,""),s=n.match(Di)}return[t.join(";"),n]},Oi=i=>{if(i!==void 0&&!Array.isArray(i))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},Ri=i=>{if(!Ao(i))throw new TypeError("The given value for processorCtor should be a constructor.");if(i.prototype===null||typeof i.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},Mo=(i,e,t,n,s,r,o,a,c,l,h,u,d)=>{let f=0;return(p,m,g={credentials:"omit"})=>{const _=h.get(p);if(_!==void 0&&_.has(m))return Promise.resolve();const T=l.get(p);if(T!==void 0){const y=T.get(m);if(y!==void 0)return y}const b=r(p),C=b.audioWorklet===void 0?s(m).then(([y,S])=>{const[w,v]=Fi(y,S),x=`${w};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${v}
})})(window,'_AWGS')`;return t(x)}).then(()=>{const y=d._AWGS.pop();if(y===void 0)throw new SyntaxError;n(b.currentTime,b.sampleRate,()=>y(class{},void 0,(S,w)=>{if(S.trim()==="")throw e();const v=vs.get(b);if(v!==void 0){if(v.has(S))throw e();Ri(w),Oi(w.parameterDescriptors),v.set(S,w)}else Ri(w),Oi(w.parameterDescriptors),vs.set(b,new Map([[S,w]]))},b.sampleRate,void 0,void 0))}):Promise.all([s(m),Promise.resolve(i(u,u))]).then(([[y,S],w])=>{const v=f+1;f=v;const[x,E]=Fi(y,S),N=`${x};((AudioWorkletProcessor,registerProcessor)=>{${E}
})(${w?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${w?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${w?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${v}',class extends AudioWorkletProcessor{process(){return !1}})`,R=new Blob([N],{type:"application/javascript; charset=utf-8"}),D=URL.createObjectURL(R);return b.audioWorklet.addModule(D,g).then(()=>{if(a(b))return b;const F=o(b);return F.audioWorklet.addModule(D,g).then(()=>F)}).then(F=>{if(c===null)throw new SyntaxError;try{new c(F,`__sac${v}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(D))});return T===void 0?l.set(p,new Map([[m,C]])):T.set(m,C),C.then(()=>{const y=h.get(p);y===void 0?h.set(p,new Set([m])):y.add(m)}).finally(()=>{const y=l.get(p);y!==void 0&&y.delete(m)}),C}},He=(i,e)=>{const t=i.get(e);if(t===void 0)throw new Error("A value with the given key could not be found.");return t},kn=(i,e)=>{const t=Array.from(i).filter(e);if(t.length>1)throw Error("More than one element was found.");if(t.length===0)throw Error("No element was found.");const[n]=t;return i.delete(n),n},Pi=(i,e,t,n)=>{const s=He(i,e),r=kn(s,o=>o[0]===t&&o[1]===n);return s.size===0&&i.delete(e),r},cn=i=>He(Ii,i),Vt=i=>{if(qt.has(i))throw new Error("The AudioNode is already stored.");qt.add(i),cn(i).forEach(e=>e(!0))},qi=i=>"port"in i,ln=i=>{if(!qt.has(i))throw new Error("The AudioNode is not stored.");qt.delete(i),cn(i).forEach(e=>e(!1))},Cs=(i,e)=>{!qi(i)&&e.every(t=>t.size===0)&&ln(i)},Eo=(i,e,t,n,s,r,o,a,c,l,h,u,d)=>{const f=new WeakMap;return(p,m,g,_,T)=>{const{activeInputs:b,passiveInputs:C}=r(m),{outputs:y}=r(p),S=a(p),w=v=>{const x=c(m),E=c(p);if(v){const M=Pi(C,p,g,_);i(b,p,M,!1),!T&&!u(p)&&t(E,x,g,_),d(m)&&Vt(m)}else{const M=n(b,p,g,_);e(C,_,M,!1),!T&&!u(p)&&s(E,x,g,_);const A=o(m);if(A===0)h(m)&&Cs(m,b);else{const I=f.get(m);I!==void 0&&clearTimeout(I),f.set(m,setTimeout(()=>{h(m)&&Cs(m,b)},A*1e3))}}};return l(y,[m,g,_],v=>v[0]===m&&v[1]===g&&v[2]===_,!0)?(S.add(w),h(p)?i(b,p,[g,_,w],!0):e(C,_,[p,g,w],!0),!0):!1}},xo=i=>(e,t,[n,s,r],o)=>{const a=e.get(n);a===void 0?e.set(n,new Set([[s,t,r]])):i(a,[s,t,r],c=>c[0]===s&&c[1]===t,o)},No=i=>(e,t)=>{const n=i(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});t.connect(n).connect(e.destination);const s=()=>{t.removeEventListener("ended",s),t.disconnect(n),n.disconnect()};t.addEventListener("ended",s)},Io=i=>(e,t)=>{i(e).add(t)},ko={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},Do=(i,e,t,n,s,r)=>class extends i{constructor(a,c){const l=s(a),h={...ko,...c},u=n(l,h),d=r(l)?e():null;super(a,!1,u,d),this._nativeAnalyserNode=u}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(a){this._nativeAnalyserNode.fftSize=a}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(a){const c=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=a,!(a>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=c,t()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(a){const c=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=a,!(this._nativeAnalyserNode.maxDecibels>a))throw this._nativeAnalyserNode.minDecibels=c,t()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(a){this._nativeAnalyserNode.smoothingTimeConstant=a}getByteFrequencyData(a){this._nativeAnalyserNode.getByteFrequencyData(a)}getByteTimeDomainData(a){this._nativeAnalyserNode.getByteTimeDomainData(a)}getFloatFrequencyData(a){this._nativeAnalyserNode.getFloatFrequencyData(a)}getFloatTimeDomainData(a){this._nativeAnalyserNode.getFloatTimeDomainData(a)}},Te=(i,e)=>i.context===e,Fo=(i,e,t)=>()=>{const n=new WeakMap,s=async(r,o)=>{let a=e(r);if(!Te(a,o)){const l={channelCount:a.channelCount,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,fftSize:a.fftSize,maxDecibels:a.maxDecibels,minDecibels:a.minDecibels,smoothingTimeConstant:a.smoothingTimeConstant};a=i(o,l)}return n.set(o,a),await t(r,o,a),a};return{render(r,o){const a=n.get(o);return a!==void 0?Promise.resolve(a):s(r,o)}}},Dn=i=>{try{i.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},et=()=>new DOMException("","IndexSizeError"),Ts=i=>{i.getChannelData=(e=>t=>{try{return e.call(i,t)}catch(n){throw n.code===12?et():n}})(i.getChannelData)},Oo={numberOfChannels:1},Ro=(i,e,t,n,s,r,o,a)=>{let c=null;return class Hr{constructor(h){if(s===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:u,numberOfChannels:d,sampleRate:f}={...Oo,...h};c===null&&(c=new s(1,1,44100));const p=n!==null&&e(r,r)?new n({length:u,numberOfChannels:d,sampleRate:f}):c.createBuffer(d,u,f);if(p.numberOfChannels===0)throw t();return typeof p.copyFromChannel!="function"?(o(p),Ts(p)):e(Dn,()=>Dn(p))||a(p),i.add(p),p}static[Symbol.hasInstance](h){return h!==null&&typeof h=="object"&&Object.getPrototypeOf(h)===Hr.prototype||i.has(h)}}},De=-34028234663852886e22,Ae=-De,lt=i=>qt.has(i),Po={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},qo=(i,e,t,n,s,r,o,a)=>class extends i{constructor(l,h){const u=r(l),d={...Po,...h},f=s(u,d),p=o(u),m=p?e():null;super(l,!1,f,m),this._audioBufferSourceNodeRenderer=m,this._isBufferNullified=!1,this._isBufferSet=d.buffer!==null,this._nativeAudioBufferSourceNode=f,this._onended=null,this._playbackRate=t(this,p,f.playbackRate,Ae,De)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(l){if(this._nativeAudioBufferSourceNode.buffer=l,l!==null){if(this._isBufferSet)throw n();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(l){this._nativeAudioBufferSourceNode.loop=l}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(l){this._nativeAudioBufferSourceNode.loopEnd=l}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(l){this._nativeAudioBufferSourceNode.loopStart=l}get onended(){return this._onended}set onended(l){const h=typeof l=="function"?a(this,l):null;this._nativeAudioBufferSourceNode.onended=h;const u=this._nativeAudioBufferSourceNode.onended;this._onended=u!==null&&u===h?l:u}get playbackRate(){return this._playbackRate}start(l=0,h=0,u){if(this._nativeAudioBufferSourceNode.start(l,h,u),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=u===void 0?[l,h]:[l,h,u]),this.context.state!=="closed"){Vt(this);const d=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",d),lt(this)&&ln(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",d)}}stop(l=0){this._nativeAudioBufferSourceNode.stop(l),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=l)}},Vo=(i,e,t,n,s)=>()=>{const r=new WeakMap;let o=null,a=null;const c=async(l,h)=>{let u=t(l);const d=Te(u,h);if(!d){const f={buffer:u.buffer,channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,loop:u.loop,loopEnd:u.loopEnd,loopStart:u.loopStart,playbackRate:u.playbackRate.value};u=e(h,f),o!==null&&u.start(...o),a!==null&&u.stop(a)}return r.set(h,u),d?await i(h,l.playbackRate,u.playbackRate):await n(h,l.playbackRate,u.playbackRate),await s(l,h,u),u};return{set start(l){o=l},set stop(l){a=l},render(l,h){const u=r.get(h);return u!==void 0?Promise.resolve(u):c(l,h)}}},Lo=i=>"playbackRate"in i,Bo=i=>"frequency"in i&&"gain"in i,Uo=i=>"offset"in i,zo=i=>!("frequency"in i)&&"gain"in i,Wo=i=>"detune"in i&&"frequency"in i&&!("gain"in i),$o=i=>"pan"in i,Me=i=>He(xi,i),hn=i=>He(Ni,i),ws=(i,e)=>{const{activeInputs:t}=Me(i);t.forEach(s=>s.forEach(([r])=>{e.includes(i)||ws(r,[...e,i])}));const n=Lo(i)?[i.playbackRate]:qi(i)?Array.from(i.parameters.values()):Bo(i)?[i.Q,i.detune,i.frequency,i.gain]:Uo(i)?[i.offset]:zo(i)?[i.gain]:Wo(i)?[i.detune,i.frequency]:$o(i)?[i.pan]:[];for(const s of n){const r=hn(s);r!==void 0&&r.activeInputs.forEach(([o])=>ws(o,e))}lt(i)&&ln(i)},Vi=i=>{ws(i.destination,[])},jo=i=>i===void 0||typeof i=="number"||typeof i=="string"&&(i==="balanced"||i==="interactive"||i==="playback"),Go=(i,e,t,n,s,r,o,a,c)=>class extends i{constructor(h={}){if(c===null)throw new Error("Missing the native AudioContext constructor.");let u;try{u=new c(h)}catch(p){throw p.code===12&&p.message==="sampleRate is not in range"?t():p}if(u===null)throw n();if(!jo(h.latencyHint))throw new TypeError(`The provided value '${h.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(h.sampleRate!==void 0&&u.sampleRate!==h.sampleRate)throw t();super(u,2);const{latencyHint:d}=h,{sampleRate:f}=u;if(this._baseLatency=typeof u.baseLatency=="number"?u.baseLatency:d==="balanced"?512/f:d==="interactive"||d===void 0?256/f:d==="playback"?1024/f:Math.max(2,Math.min(128,Math.round(d*f/128)))*128/f,this._nativeAudioContext=u,c.name==="webkitAudioContext"?(this._nativeGainNode=u.createGain(),this._nativeOscillatorNode=u.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(u.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,u.state==="running"){this._state="suspended";const p=()=>{this._state==="suspended"&&(this._state=null),u.removeEventListener("statechange",p)};u.addEventListener("statechange",p)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then(()=>{throw e()}):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then(()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),Vi(this)}))}createMediaElementSource(h){return new s(this,{mediaElement:h})}createMediaStreamDestination(){return new r(this)}createMediaStreamSource(h){return new o(this,{mediaStream:h})}createMediaStreamTrackSource(h){return new a(this,{mediaStreamTrack:h})}resume(){return this._state==="suspended"?new Promise((h,u)=>{const d=()=>{this._nativeAudioContext.removeEventListener("statechange",d),this._nativeAudioContext.state==="running"?h():this.resume().then(h,u)};this._nativeAudioContext.addEventListener("statechange",d)}):this._nativeAudioContext.resume().catch(h=>{throw h===void 0||h.code===15?e():h})}suspend(){return this._nativeAudioContext.suspend().catch(h=>{throw h===void 0?e():h})}},Ho=(i,e,t,n,s,r,o,a)=>class extends i{constructor(l,h){const u=r(l),d=o(u),f=s(u,h,d),p=d?e(a):null;super(l,!1,f,p),this._isNodeOfNativeOfflineAudioContext=d,this._nativeAudioDestinationNode=f}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(l){if(this._isNodeOfNativeOfflineAudioContext)throw n();if(l>this._nativeAudioDestinationNode.maxChannelCount)throw t();this._nativeAudioDestinationNode.channelCount=l}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(l){if(this._isNodeOfNativeOfflineAudioContext)throw n();this._nativeAudioDestinationNode.channelCountMode=l}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}},Qo=i=>{const e=new WeakMap,t=async(n,s)=>{const r=s.destination;return e.set(s,r),await i(n,s,r),r};return{render(n,s){const r=e.get(s);return r!==void 0?Promise.resolve(r):t(n,s)}}},Xo=(i,e,t,n,s,r,o,a)=>(c,l)=>{const h=l.listener,u=()=>{const y=new Float32Array(1),S=e(l,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),w=o(l);let v=!1,x=[0,0,-1,0,1,0],E=[0,0,0];const M=()=>{if(v)return;v=!0;const R=n(l,256,9,0);R.onaudioprocess=({inputBuffer:D})=>{const F=[r(D,y,0),r(D,y,1),r(D,y,2),r(D,y,3),r(D,y,4),r(D,y,5)];F.some((P,L)=>P!==x[L])&&(h.setOrientation(...F),x=F);const B=[r(D,y,6),r(D,y,7),r(D,y,8)];B.some((P,L)=>P!==E[L])&&(h.setPosition(...B),E=B)},S.connect(R)},A=R=>D=>{D!==x[R]&&(x[R]=D,h.setOrientation(...x))},I=R=>D=>{D!==E[R]&&(E[R]=D,h.setPosition(...E))},N=(R,D,F)=>{const B=t(l,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:D});B.connect(S,0,R),B.start(),Object.defineProperty(B.offset,"defaultValue",{get(){return D}});const P=i({context:c},w,B.offset,Ae,De);return a(P,"value",L=>()=>L.call(P),L=>V=>{try{L.call(P,V)}catch(Q){if(Q.code!==9)throw Q}M(),w&&F(V)}),P.cancelAndHoldAtTime=(L=>w?()=>{throw s()}:(...V)=>{const Q=L.apply(P,V);return M(),Q})(P.cancelAndHoldAtTime),P.cancelScheduledValues=(L=>w?()=>{throw s()}:(...V)=>{const Q=L.apply(P,V);return M(),Q})(P.cancelScheduledValues),P.exponentialRampToValueAtTime=(L=>w?()=>{throw s()}:(...V)=>{const Q=L.apply(P,V);return M(),Q})(P.exponentialRampToValueAtTime),P.linearRampToValueAtTime=(L=>w?()=>{throw s()}:(...V)=>{const Q=L.apply(P,V);return M(),Q})(P.linearRampToValueAtTime),P.setTargetAtTime=(L=>w?()=>{throw s()}:(...V)=>{const Q=L.apply(P,V);return M(),Q})(P.setTargetAtTime),P.setValueAtTime=(L=>w?()=>{throw s()}:(...V)=>{const Q=L.apply(P,V);return M(),Q})(P.setValueAtTime),P.setValueCurveAtTime=(L=>w?()=>{throw s()}:(...V)=>{const Q=L.apply(P,V);return M(),Q})(P.setValueCurveAtTime),P};return{forwardX:N(0,0,A(0)),forwardY:N(1,0,A(1)),forwardZ:N(2,-1,A(2)),positionX:N(6,0,I(0)),positionY:N(7,0,I(1)),positionZ:N(8,0,I(2)),upX:N(3,0,A(3)),upY:N(4,1,A(4)),upZ:N(5,0,A(5))}},{forwardX:d,forwardY:f,forwardZ:p,positionX:m,positionY:g,positionZ:_,upX:T,upY:b,upZ:C}=h.forwardX===void 0?u():h;return{get forwardX(){return d},get forwardY(){return f},get forwardZ(){return p},get positionX(){return m},get positionY(){return g},get positionZ(){return _},get upX(){return T},get upY(){return b},get upZ(){return C}}},Fn=i=>"context"in i,un=i=>Fn(i[0]),Mt=(i,e,t,n)=>{for(const s of i)if(t(s)){if(n)return!1;throw Error("The set contains at least one similar element.")}return i.add(e),!0},Li=(i,e,[t,n],s)=>{Mt(i,[e,t,n],r=>r[0]===e&&r[1]===t,s)},Bi=(i,[e,t,n],s)=>{const r=i.get(e);r===void 0?i.set(e,new Set([[t,n]])):Mt(r,[t,n],o=>o[0]===t,s)},Lt=i=>"inputs"in i,On=(i,e,t,n)=>{if(Lt(e)){const s=e.inputs[n];return i.connect(s,t,0),[s,t,0]}return i.connect(e,t,n),[e,t,n]},Ui=(i,e,t)=>{for(const n of i)if(n[0]===e&&n[1]===t)return i.delete(n),n;return null},Yo=(i,e,t)=>kn(i,n=>n[0]===e&&n[1]===t),zi=(i,e)=>{if(!cn(i).delete(e))throw new Error("Missing the expected event listener.")},Wi=(i,e,t)=>{const n=He(i,e),s=kn(n,r=>r[0]===t);return n.size===0&&i.delete(e),s},Rn=(i,e,t,n)=>{Lt(e)?i.disconnect(e.inputs[n],t,0):i.disconnect(e,t,n)},te=i=>He(gs,i),dn=i=>He(_s,i),Et=i=>ys.has(i),Pn=i=>!qt.has(i),$i=(i,e)=>new Promise(t=>{if(e!==null)t(!0);else{const n=i.createScriptProcessor(256,1,1),s=i.createGain(),r=i.createBuffer(1,2,44100),o=r.getChannelData(0);o[0]=1,o[1]=1;const a=i.createBufferSource();a.buffer=r,a.loop=!0,a.connect(n).connect(i.destination),a.connect(s),a.disconnect(s),n.onaudioprocess=c=>{const l=c.inputBuffer.getChannelData(0);Array.prototype.some.call(l,h=>h===1)?t(!0):t(!1),a.stop(),n.onaudioprocess=null,a.disconnect(n),n.disconnect(i.destination)},a.start()}}),bs=(i,e)=>{const t=new Map;for(const n of i)for(const s of n){const r=t.get(s);t.set(s,r===void 0?1:r+1)}t.forEach((n,s)=>e(s,n))},qn=i=>"context"in i,Zo=i=>{const e=new Map;i.connect=(t=>(n,s=0,r=0)=>{const o=qn(n)?t(n,s,r):t(n,s),a=e.get(n);return a===void 0?e.set(n,[{input:r,output:s}]):a.every(c=>c.input!==r||c.output!==s)&&a.push({input:r,output:s}),o})(i.connect.bind(i)),i.disconnect=(t=>(n,s,r)=>{if(t.apply(i),n===void 0)e.clear();else if(typeof n=="number")for(const[o,a]of e){const c=a.filter(l=>l.output!==n);c.length===0?e.delete(o):e.set(o,c)}else if(e.has(n))if(s===void 0)e.delete(n);else{const o=e.get(n);if(o!==void 0){const a=o.filter(c=>c.output!==s&&(c.input!==r||r===void 0));a.length===0?e.delete(n):e.set(n,a)}}for(const[o,a]of e)a.forEach(c=>{qn(o)?i.connect(o,c.output,c.input):i.connect(o,c.output)})})(i.disconnect)},Jo=(i,e,t,n)=>{const{activeInputs:s,passiveInputs:r}=hn(e),{outputs:o}=Me(i),a=cn(i),c=l=>{const h=te(i),u=dn(e);if(l){const d=Wi(r,i,t);Li(s,i,d,!1),!n&&!Et(i)&&h.connect(u,t)}else{const d=Yo(s,i,t);Bi(r,d,!1),!n&&!Et(i)&&h.disconnect(u,t)}};return Mt(o,[e,t],l=>l[0]===e&&l[1]===t,!0)?(a.add(c),lt(i)?Li(s,i,[t,c],!0):Bi(r,[i,t,c],!0),!0):!1},Ko=(i,e,t,n)=>{const{activeInputs:s,passiveInputs:r}=Me(e),o=Ui(s[n],i,t);return o===null?[Pi(r,i,t,n)[2],!1]:[o[2],!0]},ea=(i,e,t)=>{const{activeInputs:n,passiveInputs:s}=hn(e),r=Ui(n,i,t);return r===null?[Wi(s,i,t)[1],!1]:[r[2],!0]},As=(i,e,t,n,s)=>{const[r,o]=Ko(i,t,n,s);if(r!==null&&(zi(i,r),o&&!e&&!Et(i)&&Rn(te(i),te(t),n,s)),lt(t)){const{activeInputs:a}=Me(t);Cs(t,a)}},Ms=(i,e,t,n)=>{const[s,r]=ea(i,t,n);s!==null&&(zi(i,s),r&&!e&&!Et(i)&&te(i).disconnect(dn(t),n))},ta=(i,e)=>{const t=Me(i),n=[];for(const s of t.outputs)un(s)?As(i,e,...s):Ms(i,e,...s),n.push(s[0]);return t.outputs.clear(),n},na=(i,e,t)=>{const n=Me(i),s=[];for(const r of n.outputs)r[1]===t&&(un(r)?As(i,e,...r):Ms(i,e,...r),s.push(r[0]),n.outputs.delete(r));return s},sa=(i,e,t,n,s)=>{const r=Me(i);return Array.from(r.outputs).filter(o=>o[0]===t&&(n===void 0||o[1]===n)&&(s===void 0||o[2]===s)).map(o=>(un(o)?As(i,e,...o):Ms(i,e,...o),r.outputs.delete(o),o[0]))},ia=(i,e,t,n,s,r,o,a,c,l,h,u,d,f,p,m)=>class extends l{constructor(_,T,b,C){super(b),this._context=_,this._nativeAudioNode=b;const y=h(_);u(y)&&t($i,()=>$i(y,m))!==!0&&Zo(b),gs.set(this,b),Ii.set(this,new Set),_.state!=="closed"&&T&&Vt(this),i(this,C,b)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(_){this._nativeAudioNode.channelCount=_}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(_){this._nativeAudioNode.channelCountMode=_}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(_){this._nativeAudioNode.channelInterpretation=_}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(_,T=0,b=0){if(T<0||T>=this._nativeAudioNode.numberOfOutputs)throw s();const C=h(this._context),y=p(C);if(d(_)||f(_))throw r();if(Fn(_)){const v=te(_);try{const E=On(this._nativeAudioNode,v,T,b),M=Pn(this);(y||M)&&this._nativeAudioNode.disconnect(...E),this.context.state!=="closed"&&!M&&Pn(_)&&Vt(_)}catch(E){throw E.code===12?r():E}if(e(this,_,T,b,y)){const E=c([this],_);bs(E,n(y))}return _}const S=dn(_);if(S.name==="playbackRate"&&S.maxValue===1024)throw o();try{this._nativeAudioNode.connect(S,T),(y||Pn(this))&&this._nativeAudioNode.disconnect(S,T)}catch(v){throw v.code===12?r():v}if(Jo(this,_,T,y)){const v=c([this],_);bs(v,n(y))}}disconnect(_,T,b){let C;const y=h(this._context),S=p(y);if(_===void 0)C=ta(this,S);else if(typeof _=="number"){if(_<0||_>=this.numberOfOutputs)throw s();C=na(this,S,_)}else{if(T!==void 0&&(T<0||T>=this.numberOfOutputs)||Fn(_)&&b!==void 0&&(b<0||b>=_.numberOfInputs))throw s();if(C=sa(this,S,_,T,b),C.length===0)throw r()}for(const w of C){const v=c([this],w);bs(v,a)}}},ra=(i,e,t,n,s,r,o,a,c,l,h,u,d)=>(f,p,m,g=null,_=null)=>{const T=m.value,b=new mo(T),C=p?n(b):null,y={get defaultValue(){return T},get maxValue(){return g===null?m.maxValue:g},get minValue(){return _===null?m.minValue:_},get value(){return m.value},set value(S){m.value=S,y.setValueAtTime(S,f.context.currentTime)},cancelAndHoldAtTime(S){if(typeof m.cancelAndHoldAtTime=="function")C===null&&b.flush(f.context.currentTime),b.add(s(S)),m.cancelAndHoldAtTime(S);else{const w=Array.from(b).pop();C===null&&b.flush(f.context.currentTime),b.add(s(S));const v=Array.from(b).pop();m.cancelScheduledValues(S),w!==v&&v!==void 0&&(v.type==="exponentialRampToValue"?m.exponentialRampToValueAtTime(v.value,v.endTime):v.type==="linearRampToValue"?m.linearRampToValueAtTime(v.value,v.endTime):v.type==="setValue"?m.setValueAtTime(v.value,v.startTime):v.type==="setValueCurve"&&m.setValueCurveAtTime(v.values,v.startTime,v.duration))}return y},cancelScheduledValues(S){return C===null&&b.flush(f.context.currentTime),b.add(r(S)),m.cancelScheduledValues(S),y},exponentialRampToValueAtTime(S,w){if(S===0)throw new RangeError;if(!Number.isFinite(w)||w<0)throw new RangeError;const v=f.context.currentTime;return C===null&&b.flush(v),Array.from(b).length===0&&(b.add(l(T,v)),m.setValueAtTime(T,v)),b.add(o(S,w)),m.exponentialRampToValueAtTime(S,w),y},linearRampToValueAtTime(S,w){const v=f.context.currentTime;return C===null&&b.flush(v),Array.from(b).length===0&&(b.add(l(T,v)),m.setValueAtTime(T,v)),b.add(a(S,w)),m.linearRampToValueAtTime(S,w),y},setTargetAtTime(S,w,v){return C===null&&b.flush(f.context.currentTime),b.add(c(S,w,v)),m.setTargetAtTime(S,w,v),y},setValueAtTime(S,w){return C===null&&b.flush(f.context.currentTime),b.add(l(S,w)),m.setValueAtTime(S,w),y},setValueCurveAtTime(S,w,v){const x=S instanceof Float32Array?S:new Float32Array(S);if(u!==null&&u.name==="webkitAudioContext"){const E=w+v,M=f.context.sampleRate,A=Math.ceil(w*M),I=Math.floor(E*M),N=I-A,R=new Float32Array(N);for(let F=0;F<N;F+=1){const B=(x.length-1)/v*((A+F)/M-w),P=Math.floor(B),L=Math.ceil(B);R[F]=P===L?x[P]:(1-(B-P))*x[P]+(1-(L-B))*x[L]}C===null&&b.flush(f.context.currentTime),b.add(h(R,w,v)),m.setValueCurveAtTime(R,w,v);const D=I/M;D<E&&d(y,R[R.length-1],D),d(y,x[x.length-1],E)}else C===null&&b.flush(f.context.currentTime),b.add(h(x,w,v)),m.setValueCurveAtTime(x,w,v);return y}};return t.set(y,m),e.set(y,f),i(y,C),y},oa=i=>({replay(e){for(const t of i)if(t.type==="exponentialRampToValue"){const{endTime:n,value:s}=t;e.exponentialRampToValueAtTime(s,n)}else if(t.type==="linearRampToValue"){const{endTime:n,value:s}=t;e.linearRampToValueAtTime(s,n)}else if(t.type==="setTarget"){const{startTime:n,target:s,timeConstant:r}=t;e.setTargetAtTime(s,n,r)}else if(t.type==="setValue"){const{startTime:n,value:s}=t;e.setValueAtTime(s,n)}else if(t.type==="setValueCurve"){const{duration:n,startTime:s,values:r}=t;e.setValueCurveAtTime(r,s,n)}else throw new Error("Can't apply an unknown automation.")}});class ji{constructor(e){this._map=new Map(e)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(e,t=null){return this._map.forEach((n,s)=>e.call(t,n,s,this))}get(e){return this._map.get(e)}has(e){return this._map.has(e)}keys(){return this._map.keys()}values(){return this._map.values()}}const aa={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}},ca=(i,e,t,n,s,r,o,a,c,l,h,u,d,f)=>class extends e{constructor(m,g,_){var T;const b=a(m),C=c(b),y=h({...aa,..._});d(y);const S=vs.get(b),w=S==null?void 0:S.get(g),v=C||b.state!=="closed"?b:(T=o(b))!==null&&T!==void 0?T:b,x=s(v,C?null:m.baseLatency,l,g,w,y),E=C?n(g,y,w):null;super(m,!0,x,E);const M=[];x.parameters.forEach((I,N)=>{const R=t(this,C,I);M.push([N,R])}),this._nativeAudioWorkletNode=x,this._onprocessorerror=null,this._parameters=new ji(M),C&&i(b,this);const{activeInputs:A}=r(this);u(x,A)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(m){const g=typeof m=="function"?f(this,m):null;this._nativeAudioWorkletNode.onprocessorerror=g;const _=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=_!==null&&_===g?m:_}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}};function Vn(i,e,t,n,s){if(typeof i.copyFromChannel=="function")e[t].byteLength===0&&(e[t]=new Float32Array(128)),i.copyFromChannel(e[t],n,s);else{const r=i.getChannelData(n);if(e[t].byteLength===0)e[t]=r.slice(s,s+128);else{const o=new Float32Array(r.buffer,s*Float32Array.BYTES_PER_ELEMENT,128);e[t].set(o)}}}const Gi=(i,e,t,n,s)=>{typeof i.copyToChannel=="function"?e[t].byteLength!==0&&i.copyToChannel(e[t],n,s):e[t].byteLength!==0&&i.getChannelData(n).set(e[t],s)},Ln=(i,e)=>{const t=[];for(let n=0;n<i;n+=1){const s=[],r=typeof e=="number"?e:e[n];for(let o=0;o<r;o+=1)s.push(new Float32Array(128));t.push(s)}return t},la=(i,e)=>{const t=He(Ss,i),n=te(e);return He(t,n)},ha=async(i,e,t,n,s,r,o)=>{const a=e===null?Math.ceil(i.context.length/128)*128:e.length,c=n.channelCount*n.numberOfInputs,l=s.reduce((g,_)=>g+_,0),h=l===0?null:t.createBuffer(l,a,t.sampleRate);if(r===void 0)throw new Error("Missing the processor constructor.");const u=Me(i),d=await la(t,i),f=Ln(n.numberOfInputs,n.channelCount),p=Ln(n.numberOfOutputs,s),m=Array.from(i.parameters.keys()).reduce((g,_)=>({...g,[_]:new Float32Array(128)}),{});for(let g=0;g<a;g+=128){if(n.numberOfInputs>0&&e!==null)for(let _=0;_<n.numberOfInputs;_+=1)for(let T=0;T<n.channelCount;T+=1)Vn(e,f[_],T,T,g);r.parameterDescriptors!==void 0&&e!==null&&r.parameterDescriptors.forEach(({name:_},T)=>{Vn(e,m,_,c+T,g)});for(let _=0;_<n.numberOfInputs;_+=1)for(let T=0;T<s[_];T+=1)p[_][T].byteLength===0&&(p[_][T]=new Float32Array(128));try{const _=f.map((b,C)=>u.activeInputs[C].size===0?[]:b),T=o(g/t.sampleRate,t.sampleRate,()=>d.process(_,p,m));if(h!==null)for(let b=0,C=0;b<n.numberOfOutputs;b+=1){for(let y=0;y<s[b];y+=1)Gi(h,p[b],y,C+y,g);C+=s[b]}if(!T)break}catch(_){i.dispatchEvent(new ErrorEvent("processorerror",{colno:_.colno,filename:_.filename,lineno:_.lineno,message:_.message}));break}}return h},ua=(i,e,t,n,s,r,o,a,c,l,h,u,d,f,p,m)=>(g,_,T)=>{const b=new WeakMap;let C=null;const y=async(S,w)=>{let v=h(S),x=null;const E=Te(v,w),M=Array.isArray(_.outputChannelCount)?_.outputChannelCount:Array.from(_.outputChannelCount);if(u===null){const A=M.reduce((D,F)=>D+F,0),I=s(w,{channelCount:Math.max(1,A),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,A)}),N=[];for(let D=0;D<S.numberOfOutputs;D+=1)N.push(n(w,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:M[D]}));const R=o(w,{channelCount:_.channelCount,channelCountMode:_.channelCountMode,channelInterpretation:_.channelInterpretation,gain:1});R.connect=e.bind(null,N),R.disconnect=c.bind(null,N),x=[I,N,R]}else E||(v=new u(w,g));if(b.set(w,x===null?v:x[2]),x!==null){if(C===null){if(T===void 0)throw new Error("Missing the processor constructor.");if(d===null)throw new Error("Missing the native OfflineAudioContext constructor.");const F=S.channelCount*S.numberOfInputs,B=T.parameterDescriptors===void 0?0:T.parameterDescriptors.length,P=F+B;C=ha(S,P===0?null:await(async()=>{const V=new d(P,Math.ceil(S.context.length/128)*128,w.sampleRate),Q=[],ge=[];for(let X=0;X<_.numberOfInputs;X+=1)Q.push(o(V,{channelCount:_.channelCount,channelCountMode:_.channelCountMode,channelInterpretation:_.channelInterpretation,gain:1})),ge.push(s(V,{channelCount:_.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:_.channelCount}));const _e=await Promise.all(Array.from(S.parameters.values()).map(async X=>{const le=r(V,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:X.value});return await f(V,X,le.offset),le})),U=n(V,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,F+B)});for(let X=0;X<_.numberOfInputs;X+=1){Q[X].connect(ge[X]);for(let le=0;le<_.channelCount;le+=1)ge[X].connect(U,le,X*_.channelCount+le)}for(const[X,le]of _e.entries())le.connect(U,0,F+X),le.start(0);return U.connect(V.destination),await Promise.all(Q.map(X=>p(S,V,X))),m(V)})(),w,_,M,T,l)}const A=await C,I=t(w,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[N,R,D]=x;A!==null&&(I.buffer=A,I.start(0)),I.connect(N);for(let F=0,B=0;F<S.numberOfOutputs;F+=1){const P=R[F];for(let L=0;L<M[F];L+=1)N.connect(P,B+L,L);B+=M[F]}return D}if(E)for(const[A,I]of S.parameters.entries())await i(w,I,v.parameters.get(A));else for(const[A,I]of S.parameters.entries())await f(w,I,v.parameters.get(A));return await p(S,w,v),v};return{render(S,w){a(w,S);const v=b.get(w);return v!==void 0?Promise.resolve(v):y(S,w)}}},da=(i,e,t,n,s,r,o,a,c,l,h,u,d,f,p,m,g,_,T,b)=>class extends p{constructor(y,S){super(y,S),this._nativeContext=y,this._audioWorklet=i===void 0?void 0:{addModule:(w,v)=>i(this,w,v)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new e(this)}createBiquadFilter(){return new s(this)}createBuffer(y,S,w){return new t({length:S,numberOfChannels:y,sampleRate:w})}createBufferSource(){return new n(this)}createChannelMerger(y=6){return new r(this,{numberOfInputs:y})}createChannelSplitter(y=6){return new o(this,{numberOfOutputs:y})}createConstantSource(){return new a(this)}createConvolver(){return new c(this)}createDelay(y=1){return new h(this,{maxDelayTime:y})}createDynamicsCompressor(){return new u(this)}createGain(){return new d(this)}createIIRFilter(y,S){return new f(this,{feedback:S,feedforward:y})}createOscillator(){return new m(this)}createPanner(){return new g(this)}createPeriodicWave(y,S,w={disableNormalization:!1}){return new _(this,{...w,imag:S,real:y})}createStereoPanner(){return new T(this)}createWaveShaper(){return new b(this)}decodeAudioData(y,S,w){return l(this._nativeContext,y).then(v=>(typeof S=="function"&&S(v),v),v=>{throw typeof w=="function"&&w(v),v})}},fa={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},pa=(i,e,t,n,s,r,o,a)=>class extends i{constructor(l,h){const u=r(l),d={...fa,...h},f=s(u,d),p=o(u),m=p?t():null;super(l,!1,f,m),this._Q=e(this,p,f.Q,Ae,De),this._detune=e(this,p,f.detune,1200*Math.log2(Ae),-1200*Math.log2(Ae)),this._frequency=e(this,p,f.frequency,l.sampleRate/2,0),this._gain=e(this,p,f.gain,40*Math.log10(Ae),De),this._nativeBiquadFilterNode=f,a(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(l){this._nativeBiquadFilterNode.type=l}getFrequencyResponse(l,h,u){try{this._nativeBiquadFilterNode.getFrequencyResponse(l,h,u)}catch(d){throw d.code===11?n():d}if(l.length!==h.length||h.length!==u.length)throw n()}},ma=(i,e,t,n,s)=>()=>{const r=new WeakMap,o=async(a,c)=>{let l=t(a);const h=Te(l,c);if(!h){const u={Q:l.Q.value,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,detune:l.detune.value,frequency:l.frequency.value,gain:l.gain.value,type:l.type};l=e(c,u)}return r.set(c,l),h?(await i(c,a.Q,l.Q),await i(c,a.detune,l.detune),await i(c,a.frequency,l.frequency),await i(c,a.gain,l.gain)):(await n(c,a.Q,l.Q),await n(c,a.detune,l.detune),await n(c,a.frequency,l.frequency),await n(c,a.gain,l.gain)),await s(a,c,l),l};return{render(a,c){const l=r.get(c);return l!==void 0?Promise.resolve(l):o(a,c)}}},ga=(i,e)=>(t,n)=>{const s=e.get(t);if(s!==void 0)return s;const r=i.get(t);if(r!==void 0)return r;try{const o=n();return o instanceof Promise?(i.set(t,o),o.catch(()=>!1).then(a=>(i.delete(t),e.set(t,a),a))):(e.set(t,o),o)}catch{return e.set(t,!1),!1}},_a={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},ya=(i,e,t,n,s)=>class extends i{constructor(o,a){const c=n(o),l={..._a,...a},h=t(c,l),u=s(c)?e():null;super(o,!1,h,u)}},va=(i,e,t)=>()=>{const n=new WeakMap,s=async(r,o)=>{let a=e(r);if(!Te(a,o)){const l={channelCount:a.channelCount,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,numberOfInputs:a.numberOfInputs};a=i(o,l)}return n.set(o,a),await t(r,o,a),a};return{render(r,o){const a=n.get(o);return a!==void 0?Promise.resolve(a):s(r,o)}}},Sa={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},Ca=(i,e,t,n,s,r)=>class extends i{constructor(a,c){const l=n(a),h=r({...Sa,...c}),u=t(l,h),d=s(l)?e():null;super(a,!1,u,d)}},Ta=(i,e,t)=>()=>{const n=new WeakMap,s=async(r,o)=>{let a=e(r);if(!Te(a,o)){const l={channelCount:a.channelCount,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,numberOfOutputs:a.numberOfOutputs};a=i(o,l)}return n.set(o,a),await t(r,o,a),a};return{render(r,o){const a=n.get(o);return a!==void 0?Promise.resolve(a):s(r,o)}}},wa=i=>(e,t,n)=>i(t,e,n),ba=i=>(e,t,n=0,s=0)=>{const r=e[n];if(r===void 0)throw i();return qn(t)?r.connect(t,0,s):r.connect(t,0)},Aa=i=>(e,t)=>{const n=i(e,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),s=e.createBuffer(1,2,44100);return n.buffer=s,n.loop=!0,n.connect(t),n.start(),()=>{n.stop(),n.disconnect(t)}},Ma={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},Ea=(i,e,t,n,s,r,o)=>class extends i{constructor(c,l){const h=s(c),u={...Ma,...l},d=n(h,u),f=r(h),p=f?t():null;super(c,!1,d,p),this._constantSourceNodeRenderer=p,this._nativeConstantSourceNode=d,this._offset=e(this,f,d.offset,Ae,De),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(c){const l=typeof c=="function"?o(this,c):null;this._nativeConstantSourceNode.onended=l;const h=this._nativeConstantSourceNode.onended;this._onended=h!==null&&h===l?c:h}start(c=0){if(this._nativeConstantSourceNode.start(c),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=c),this.context.state!=="closed"){Vt(this);const l=()=>{this._nativeConstantSourceNode.removeEventListener("ended",l),lt(this)&&ln(this)};this._nativeConstantSourceNode.addEventListener("ended",l)}}stop(c=0){this._nativeConstantSourceNode.stop(c),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=c)}},xa=(i,e,t,n,s)=>()=>{const r=new WeakMap;let o=null,a=null;const c=async(l,h)=>{let u=t(l);const d=Te(u,h);if(!d){const f={channelCount:u.channelCount,channelCountMode:u.channelCountMode,channelInterpretation:u.channelInterpretation,offset:u.offset.value};u=e(h,f),o!==null&&u.start(o),a!==null&&u.stop(a)}return r.set(h,u),d?await i(h,l.offset,u.offset):await n(h,l.offset,u.offset),await s(l,h,u),u};return{set start(l){o=l},set stop(l){a=l},render(l,h){const u=r.get(h);return u!==void 0?Promise.resolve(u):c(l,h)}}},Na=i=>e=>(i[0]=e,i[0]),Ia={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},ka=(i,e,t,n,s,r)=>class extends i{constructor(a,c){const l=n(a),h={...Ia,...c},u=t(l,h),f=s(l)?e():null;super(a,!1,u,f),this._isBufferNullified=!1,this._nativeConvolverNode=u,h.buffer!==null&&r(this,h.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(a){if(this._nativeConvolverNode.buffer=a,a===null&&this._nativeConvolverNode.buffer!==null){const c=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=c.createBuffer(1,1,c.sampleRate),this._isBufferNullified=!0,r(this,0)}else this._isBufferNullified=!1,r(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(a){this._nativeConvolverNode.normalize=a}},Da=(i,e,t)=>()=>{const n=new WeakMap,s=async(r,o)=>{let a=e(r);if(!Te(a,o)){const l={buffer:a.buffer,channelCount:a.channelCount,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,disableNormalization:!a.normalize};a=i(o,l)}return n.set(o,a),Lt(a)?await t(r,o,a.inputs[0]):await t(r,o,a),a};return{render(r,o){const a=n.get(o);return a!==void 0?Promise.resolve(a):s(r,o)}}},Fa=(i,e)=>(t,n,s)=>{if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new e(t,n,s)}catch(r){throw r.name==="SyntaxError"?i():r}},Oa=()=>new DOMException("","DataCloneError"),Hi=i=>{const{port1:e,port2:t}=new MessageChannel;return new Promise(n=>{const s=()=>{t.onmessage=null,e.close(),t.close(),n()};t.onmessage=()=>s();try{e.postMessage(i,[i])}catch{}finally{s()}})},Ra=(i,e,t,n,s,r,o,a,c,l,h)=>(u,d)=>{const f=o(u)?u:r(u);if(s.has(d)){const p=t();return Promise.reject(p)}try{s.add(d)}catch{}return e(c,()=>c(f))?f.decodeAudioData(d).then(p=>(Hi(d).catch(()=>{}),e(a,()=>a(p))||h(p),i.add(p),p)):new Promise((p,m)=>{const g=async()=>{try{await Hi(d)}catch{}},_=T=>{m(T),g()};try{f.decodeAudioData(d,T=>{typeof T.copyFromChannel!="function"&&(l(T),Ts(T)),i.add(T),g().then(()=>p(T))},T=>{_(T===null?n():T)})}catch(T){_(T)}})},Pa=(i,e,t,n,s,r,o,a)=>(c,l)=>{const h=e.get(c);if(h===void 0)throw new Error("Missing the expected cycle count.");const u=r(c.context),d=a(u);if(h===l){if(e.delete(c),!d&&o(c)){const f=n(c),{outputs:p}=t(c);for(const m of p)if(un(m)){const g=n(m[0]);i(f,g,m[1],m[2])}else{const g=s(m[0]);f.connect(g,m[1])}}}else e.set(c,h-l)},qa={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},Va=(i,e,t,n,s,r,o)=>class extends i{constructor(c,l){const h=s(c),u={...qa,...l},d=n(h,u),f=r(h),p=f?t(u.maxDelayTime):null;super(c,!1,d,p),this._delayTime=e(this,f,d.delayTime),o(this,u.maxDelayTime)}get delayTime(){return this._delayTime}},La=(i,e,t,n,s)=>r=>{const o=new WeakMap,a=async(c,l)=>{let h=t(c);const u=Te(h,l);if(!u){const d={channelCount:h.channelCount,channelCountMode:h.channelCountMode,channelInterpretation:h.channelInterpretation,delayTime:h.delayTime.value,maxDelayTime:r};h=e(l,d)}return o.set(l,h),u?await i(l,c.delayTime,h.delayTime):await n(l,c.delayTime,h.delayTime),await s(c,l,h),h};return{render(c,l){const h=o.get(l);return h!==void 0?Promise.resolve(h):a(c,l)}}},Ba=i=>(e,t,n,s)=>i(e[s],r=>r[0]===t&&r[1]===n),Ua=i=>(e,t)=>{i(e).delete(t)},za=i=>"delayTime"in i,Wa=(i,e,t)=>function n(s,r){const o=Fn(r)?r:t(i,r);if(za(o))return[];if(s[0]===o)return[s];if(s.includes(o))return[];const{outputs:a}=e(o);return Array.from(a).map(c=>n([...s,o],c[0])).reduce((c,l)=>c.concat(l),[])},Bn=(i,e,t)=>{const n=e[t];if(n===void 0)throw i();return n},$a=i=>(e,t=void 0,n=void 0,s=0)=>t===void 0?e.forEach(r=>r.disconnect()):typeof t=="number"?Bn(i,e,t).disconnect():qn(t)?n===void 0?e.forEach(r=>r.disconnect(t)):s===void 0?Bn(i,e,n).disconnect(t,0):Bn(i,e,n).disconnect(t,0,s):n===void 0?e.forEach(r=>r.disconnect(t)):Bn(i,e,n).disconnect(t,0),ja={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},Ga=(i,e,t,n,s,r,o,a)=>class extends i{constructor(l,h){const u=r(l),d={...ja,...h},f=n(u,d),p=o(u),m=p?t():null;super(l,!1,f,m),this._attack=e(this,p,f.attack),this._knee=e(this,p,f.knee),this._nativeDynamicsCompressorNode=f,this._ratio=e(this,p,f.ratio),this._release=e(this,p,f.release),this._threshold=e(this,p,f.threshold),a(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(l){const h=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=l,l>2)throw this._nativeDynamicsCompressorNode.channelCount=h,s()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(l){const h=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=l,l==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=h,s()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}},Ha=(i,e,t,n,s)=>()=>{const r=new WeakMap,o=async(a,c)=>{let l=t(a);const h=Te(l,c);if(!h){const u={attack:l.attack.value,channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,knee:l.knee.value,ratio:l.ratio.value,release:l.release.value,threshold:l.threshold.value};l=e(c,u)}return r.set(c,l),h?(await i(c,a.attack,l.attack),await i(c,a.knee,l.knee),await i(c,a.ratio,l.ratio),await i(c,a.release,l.release),await i(c,a.threshold,l.threshold)):(await n(c,a.attack,l.attack),await n(c,a.knee,l.knee),await n(c,a.ratio,l.ratio),await n(c,a.release,l.release),await n(c,a.threshold,l.threshold)),await s(a,c,l),l};return{render(a,c){const l=r.get(c);return l!==void 0?Promise.resolve(l):o(a,c)}}},Qa=()=>new DOMException("","EncodingError"),Xa=i=>e=>new Promise((t,n)=>{if(i===null){n(new SyntaxError);return}const s=i.document.head;if(s===null)n(new SyntaxError);else{const r=i.document.createElement("script"),o=new Blob([e],{type:"application/javascript"}),a=URL.createObjectURL(o),c=i.onerror,l=()=>{i.onerror=c,URL.revokeObjectURL(a)};i.onerror=(h,u,d,f,p)=>{if(u===a||u===i.location.href&&d===1&&f===1)return l(),n(p),!1;if(c!==null)return c(h,u,d,f,p)},r.onerror=()=>{l(),n(new SyntaxError)},r.onload=()=>{l(),t()},r.src=a,r.type="module",s.appendChild(r)}}),Ya=i=>class{constructor(t){this._nativeEventTarget=t,this._listeners=new WeakMap}addEventListener(t,n,s){if(n!==null){let r=this._listeners.get(n);r===void 0&&(r=i(this,n),typeof n=="function"&&this._listeners.set(n,r)),this._nativeEventTarget.addEventListener(t,r,s)}}dispatchEvent(t){return this._nativeEventTarget.dispatchEvent(t)}removeEventListener(t,n,s){const r=n===null?void 0:this._listeners.get(n);this._nativeEventTarget.removeEventListener(t,r===void 0?null:r,s)}},Za=i=>(e,t,n)=>{Object.defineProperties(i,{currentFrame:{configurable:!0,get(){return Math.round(e*t)}},currentTime:{configurable:!0,get(){return e}}});try{return n()}finally{i!==null&&(delete i.currentFrame,delete i.currentTime)}},Ja=i=>async e=>{try{const t=await fetch(e);if(t.ok)return[await t.text(),t.url]}catch{}throw i()},Ka={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},ec=(i,e,t,n,s,r)=>class extends i{constructor(a,c){const l=s(a),h={...Ka,...c},u=n(l,h),d=r(l),f=d?t():null;super(a,!1,u,f),this._gain=e(this,d,u.gain,Ae,De)}get gain(){return this._gain}},tc=(i,e,t,n,s)=>()=>{const r=new WeakMap,o=async(a,c)=>{let l=t(a);const h=Te(l,c);if(!h){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,gain:l.gain.value};l=e(c,u)}return r.set(c,l),h?await i(c,a.gain,l.gain):await n(c,a.gain,l.gain),await s(a,c,l),l};return{render(a,c){const l=r.get(c);return l!==void 0?Promise.resolve(l):o(a,c)}}},nc=(i,e)=>t=>e(i,t),sc=i=>e=>{const t=i(e);if(t.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return t.renderer},ic=i=>e=>{var t;return(t=i.get(e))!==null&&t!==void 0?t:0},rc=i=>e=>{const t=i(e);if(t.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return t.renderer},oc=i=>e=>i.get(e),ye=()=>new DOMException("","InvalidStateError"),ac=i=>e=>{const t=i.get(e);if(t===void 0)throw ye();return t},cc=(i,e)=>t=>{let n=i.get(t);if(n!==void 0)return n;if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");return n=new e(1,1,44100),i.set(t,n),n},lc=i=>e=>{const t=i.get(e);if(t===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return t},Un=()=>new DOMException("","InvalidAccessError"),hc=i=>{i.getFrequencyResponse=(e=>(t,n,s)=>{if(t.length!==n.length||n.length!==s.length)throw Un();return e.call(i,t,n,s)})(i.getFrequencyResponse)},uc={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},dc=(i,e,t,n,s,r)=>class extends i{constructor(a,c){const l=n(a),h=s(l),u={...uc,...c},d=e(l,h?null:a.baseLatency,u),f=h?t(u.feedback,u.feedforward):null;super(a,!1,d,f),hc(d),this._nativeIIRFilterNode=d,r(this,1)}getFrequencyResponse(a,c,l){return this._nativeIIRFilterNode.getFrequencyResponse(a,c,l)}},Qi=(i,e,t,n,s,r,o,a,c,l,h)=>{const u=l.length;let d=a;for(let f=0;f<u;f+=1){let p=t[0]*l[f];for(let m=1;m<s;m+=1){const g=d-m&c-1;p+=t[m]*r[g],p-=i[m]*o[g]}for(let m=s;m<n;m+=1)p+=t[m]*r[d-m&c-1];for(let m=s;m<e;m+=1)p-=i[m]*o[d-m&c-1];r[d]=l[f],o[d]=p,d=d+1&c-1,h[f]=p}return d},fc=(i,e,t,n)=>{const s=t instanceof Float64Array?t:new Float64Array(t),r=n instanceof Float64Array?n:new Float64Array(n),o=s.length,a=r.length,c=Math.min(o,a);if(s[0]!==1){for(let p=0;p<o;p+=1)r[p]/=s[0];for(let p=1;p<a;p+=1)s[p]/=s[0]}const l=32,h=new Float32Array(l),u=new Float32Array(l),d=e.createBuffer(i.numberOfChannels,i.length,i.sampleRate),f=i.numberOfChannels;for(let p=0;p<f;p+=1){const m=i.getChannelData(p),g=d.getChannelData(p);h.fill(0),u.fill(0),Qi(s,o,r,a,c,h,u,0,l,m,g)}return d},pc=(i,e,t,n,s)=>(r,o)=>{const a=new WeakMap;let c=null;const l=async(h,u)=>{let d=null,f=e(h);const p=Te(f,u);if(u.createIIRFilter===void 0?d=i(u,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):p||(f=u.createIIRFilter(o,r)),a.set(u,d===null?f:d),d!==null){if(c===null){if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");const g=new t(h.context.destination.channelCount,h.context.length,u.sampleRate);c=(async()=>{await n(h,g,g.destination);const _=await s(g);return fc(_,u,r,o)})()}const m=await c;return d.buffer=m,d.start(0),d}return await n(h,u,f),f};return{render(h,u){const d=a.get(u);return d!==void 0?Promise.resolve(d):l(h,u)}}},mc=(i,e,t,n,s,r)=>o=>(a,c)=>{const l=i.get(a);if(l===void 0){if(!o&&r(a)){const h=n(a),{outputs:u}=t(a);for(const d of u)if(un(d)){const f=n(d[0]);e(h,f,d[1],d[2])}else{const f=s(d[0]);h.disconnect(f,d[1])}}i.set(a,c)}else i.set(a,l+c)},gc=(i,e)=>t=>{const n=i.get(t);return e(n)||e(t)},_c=(i,e)=>t=>i.has(t)||e(t),yc=(i,e)=>t=>i.has(t)||e(t),vc=(i,e)=>t=>{const n=i.get(t);return e(n)||e(t)},Sc=i=>e=>i!==null&&e instanceof i,Cc=i=>e=>i!==null&&typeof i.AudioNode=="function"&&e instanceof i.AudioNode,Tc=i=>e=>i!==null&&typeof i.AudioParam=="function"&&e instanceof i.AudioParam,wc=(i,e)=>t=>i(t)||e(t),bc=i=>e=>i!==null&&e instanceof i,Ac=i=>i!==null&&i.isSecureContext,Mc=(i,e,t,n)=>class extends i{constructor(r,o){const a=t(r),c=e(a,o);if(n(a))throw TypeError();super(r,!0,c,null),this._nativeMediaElementAudioSourceNode=c}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}},Ec={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},xc=(i,e,t,n)=>class extends i{constructor(r,o){const a=t(r);if(n(a))throw new TypeError;const c={...Ec,...o},l=e(a,c);super(r,!1,l,null),this._nativeMediaStreamAudioDestinationNode=l}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}},Nc=(i,e,t,n)=>class extends i{constructor(r,o){const a=t(r),c=e(a,o);if(n(a))throw new TypeError;super(r,!0,c,null),this._nativeMediaStreamAudioSourceNode=c}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}},Ic=(i,e,t)=>class extends i{constructor(s,r){const o=t(s),a=e(o,r);super(s,!0,a,null)}},kc=(i,e,t,n,s,r)=>class extends t{constructor(a,c){super(a),this._nativeContext=a,In.set(this,a),n(a)&&s.set(a,new Set),this._destination=new i(this,c),this._listener=e(this,a),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(a){const c=typeof a=="function"?r(this,a):null;this._nativeContext.onstatechange=c;const l=this._nativeContext.onstatechange;this._onstatechange=l!==null&&l===c?a:l}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}},fn=i=>{const e=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const t=i.decodeAudioData(e.buffer,()=>{});return t===void 0?!1:(t.catch(()=>{}),!0)}catch{}return!1},Dc=(i,e)=>(t,n,s)=>{const r=new Set;return t.connect=(o=>(a,c=0,l=0)=>{const h=r.size===0;if(e(a))return o.call(t,a,c,l),i(r,[a,c,l],u=>u[0]===a&&u[1]===c&&u[2]===l,!0),h&&n(),a;o.call(t,a,c),i(r,[a,c],u=>u[0]===a&&u[1]===c,!0),h&&n()})(t.connect),t.disconnect=(o=>(a,c,l)=>{const h=r.size>0;if(a===void 0)o.apply(t),r.clear();else if(typeof a=="number"){o.call(t,a);for(const d of r)d[1]===a&&r.delete(d)}else{e(a)?o.call(t,a,c,l):o.call(t,a,c);for(const d of r)d[0]===a&&(c===void 0||d[1]===c)&&(l===void 0||d[2]===l)&&r.delete(d)}const u=r.size===0;h&&u&&s()})(t.disconnect),t},ie=(i,e,t)=>{const n=e[t];n!==void 0&&n!==i[t]&&(i[t]=n)},me=(i,e)=>{ie(i,e,"channelCount"),ie(i,e,"channelCountMode"),ie(i,e,"channelInterpretation")},Xi=i=>typeof i.getFloatTimeDomainData=="function",Fc=i=>{i.getFloatTimeDomainData=e=>{const t=new Uint8Array(e.length);i.getByteTimeDomainData(t);const n=Math.max(t.length,i.fftSize);for(let s=0;s<n;s+=1)e[s]=(t[s]-128)*.0078125;return e}},Oc=(i,e)=>(t,n)=>{const s=t.createAnalyser();if(me(s,n),!(n.maxDecibels>n.minDecibels))throw e();return ie(s,n,"fftSize"),ie(s,n,"maxDecibels"),ie(s,n,"minDecibels"),ie(s,n,"smoothingTimeConstant"),i(Xi,()=>Xi(s))||Fc(s),s},Rc=i=>i===null?null:i.hasOwnProperty("AudioBuffer")?i.AudioBuffer:null,ae=(i,e,t)=>{const n=e[t];n!==void 0&&n!==i[t].value&&(i[t].value=n)},Pc=i=>{i.start=(e=>{let t=!1;return(n=0,s=0,r)=>{if(t)throw ye();e.call(i,n,s,r),t=!0}})(i.start)},Es=i=>{i.start=(e=>(t=0,n=0,s)=>{if(typeof s=="number"&&s<0||n<0||t<0)throw new RangeError("The parameters can't be negative.");e.call(i,t,n,s)})(i.start)},xs=i=>{i.stop=(e=>(t=0)=>{if(t<0)throw new RangeError("The parameter can't be negative.");e.call(i,t)})(i.stop)},qc=(i,e,t,n,s,r,o,a,c,l,h)=>(u,d)=>{const f=u.createBufferSource();return me(f,d),ae(f,d,"playbackRate"),ie(f,d,"buffer"),ie(f,d,"loop"),ie(f,d,"loopEnd"),ie(f,d,"loopStart"),e(t,()=>t(u))||Pc(f),e(n,()=>n(u))||c(f),e(s,()=>s(u))||l(f,u),e(r,()=>r(u))||Es(f),e(o,()=>o(u))||h(f,u),e(a,()=>a(u))||xs(f),i(u,f),f},Vc=i=>i===null?null:i.hasOwnProperty("AudioContext")?i.AudioContext:i.hasOwnProperty("webkitAudioContext")?i.webkitAudioContext:null,Lc=(i,e)=>(t,n,s)=>{const r=t.destination;if(r.channelCount!==n)try{r.channelCount=n}catch{}s&&r.channelCountMode!=="explicit"&&(r.channelCountMode="explicit"),r.maxChannelCount===0&&Object.defineProperty(r,"maxChannelCount",{value:n});const o=i(t,{channelCount:n,channelCountMode:r.channelCountMode,channelInterpretation:r.channelInterpretation,gain:1});return e(o,"channelCount",a=>()=>a.call(o),a=>c=>{a.call(o,c);try{r.channelCount=c}catch(l){if(c>r.maxChannelCount)throw l}}),e(o,"channelCountMode",a=>()=>a.call(o),a=>c=>{a.call(o,c),r.channelCountMode=c}),e(o,"channelInterpretation",a=>()=>a.call(o),a=>c=>{a.call(o,c),r.channelInterpretation=c}),Object.defineProperty(o,"maxChannelCount",{get:()=>r.maxChannelCount}),o.connect(r),o},Bc=i=>i===null?null:i.hasOwnProperty("AudioWorkletNode")?i.AudioWorkletNode:null,Uc=i=>{const{port1:e}=new MessageChannel;try{e.postMessage(i)}finally{e.close()}},zc=(i,e,t,n,s)=>(r,o,a,c,l,h)=>{if(a!==null)try{const u=new a(r,c,h),d=new Map;let f=null;if(Object.defineProperties(u,{channelCount:{get:()=>h.channelCount,set:()=>{throw i()}},channelCountMode:{get:()=>"explicit",set:()=>{throw i()}},onprocessorerror:{get:()=>f,set:p=>{typeof f=="function"&&u.removeEventListener("processorerror",f),f=typeof p=="function"?p:null,typeof f=="function"&&u.addEventListener("processorerror",f)}}}),u.addEventListener=(p=>(...m)=>{if(m[0]==="processorerror"){const g=typeof m[1]=="function"?m[1]:typeof m[1]=="object"&&m[1]!==null&&typeof m[1].handleEvent=="function"?m[1].handleEvent:null;if(g!==null){const _=d.get(m[1]);_!==void 0?m[1]=_:(m[1]=T=>{T.type==="error"?(Object.defineProperties(T,{type:{value:"processorerror"}}),g(T)):g(new ErrorEvent(m[0],{...T}))},d.set(g,m[1]))}}return p.call(u,"error",m[1],m[2]),p.call(u,...m)})(u.addEventListener),u.removeEventListener=(p=>(...m)=>{if(m[0]==="processorerror"){const g=d.get(m[1]);g!==void 0&&(d.delete(m[1]),m[1]=g)}return p.call(u,"error",m[1],m[2]),p.call(u,m[0],m[1],m[2])})(u.removeEventListener),h.numberOfOutputs!==0){const p=t(r,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return u.connect(p).connect(r.destination),s(u,()=>p.disconnect(),()=>p.connect(r.destination))}return u}catch(u){throw u.code===11?n():u}if(l===void 0)throw n();return Uc(h),e(r,o,l,h)},Yi=(i,e)=>i===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(i*e))))),Wc=i=>new Promise((e,t)=>{const{port1:n,port2:s}=new MessageChannel;n.onmessage=({data:r})=>{n.close(),s.close(),e(r)},n.onmessageerror=({data:r})=>{n.close(),s.close(),t(r)},s.postMessage(i)}),$c=async(i,e)=>{const t=await Wc(e);return new i(t)},jc=(i,e,t,n)=>{let s=Ss.get(i);s===void 0&&(s=new WeakMap,Ss.set(i,s));const r=$c(t,n);return s.set(e,r),r},Gc=(i,e,t,n,s,r,o,a,c,l,h,u,d)=>(f,p,m,g)=>{if(g.numberOfInputs===0&&g.numberOfOutputs===0)throw c();const _=Array.isArray(g.outputChannelCount)?g.outputChannelCount:Array.from(g.outputChannelCount);if(_.some(k=>k<1))throw c();if(_.length!==g.numberOfOutputs)throw e();if(g.channelCountMode!=="explicit")throw c();const T=g.channelCount*g.numberOfInputs,b=_.reduce((k,q)=>k+q,0),C=m.parameterDescriptors===void 0?0:m.parameterDescriptors.length;if(T+C>6||b>6)throw c();const y=new MessageChannel,S=[],w=[];for(let k=0;k<g.numberOfInputs;k+=1)S.push(o(f,{channelCount:g.channelCount,channelCountMode:g.channelCountMode,channelInterpretation:g.channelInterpretation,gain:1})),w.push(s(f,{channelCount:g.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:g.channelCount}));const v=[];if(m.parameterDescriptors!==void 0)for(const{defaultValue:k,maxValue:q,minValue:oe,name:J}of m.parameterDescriptors){const H=r(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:g.parameterData[J]!==void 0?g.parameterData[J]:k===void 0?0:k});Object.defineProperties(H.offset,{defaultValue:{get:()=>k===void 0?0:k},maxValue:{get:()=>q===void 0?Ae:q},minValue:{get:()=>oe===void 0?De:oe}}),v.push(H)}const x=n(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,T+C)}),E=Yi(p,f.sampleRate),M=a(f,E,T+C,Math.max(1,b)),A=s(f,{channelCount:Math.max(1,b),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,b)}),I=[];for(let k=0;k<g.numberOfOutputs;k+=1)I.push(n(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:_[k]}));for(let k=0;k<g.numberOfInputs;k+=1){S[k].connect(w[k]);for(let q=0;q<g.channelCount;q+=1)w[k].connect(x,q,k*g.channelCount+q)}const N=new ji(m.parameterDescriptors===void 0?[]:m.parameterDescriptors.map(({name:k},q)=>{const oe=v[q];return oe.connect(x,0,T+q),oe.start(0),[k,oe.offset]}));x.connect(M);let R=g.channelInterpretation,D=null;const F=g.numberOfOutputs===0?[M]:I,B={get bufferSize(){return E},get channelCount(){return g.channelCount},set channelCount(k){throw t()},get channelCountMode(){return g.channelCountMode},set channelCountMode(k){throw t()},get channelInterpretation(){return R},set channelInterpretation(k){for(const q of S)q.channelInterpretation=k;R=k},get context(){return M.context},get inputs(){return S},get numberOfInputs(){return g.numberOfInputs},get numberOfOutputs(){return g.numberOfOutputs},get onprocessorerror(){return D},set onprocessorerror(k){typeof D=="function"&&B.removeEventListener("processorerror",D),D=typeof k=="function"?k:null,typeof D=="function"&&B.addEventListener("processorerror",D)},get parameters(){return N},get port(){return y.port2},addEventListener(...k){return M.addEventListener(k[0],k[1],k[2])},connect:i.bind(null,F),disconnect:l.bind(null,F),dispatchEvent(...k){return M.dispatchEvent(k[0])},removeEventListener(...k){return M.removeEventListener(k[0],k[1],k[2])}},P=new Map;y.port1.addEventListener=(k=>(...q)=>{if(q[0]==="message"){const oe=typeof q[1]=="function"?q[1]:typeof q[1]=="object"&&q[1]!==null&&typeof q[1].handleEvent=="function"?q[1].handleEvent:null;if(oe!==null){const J=P.get(q[1]);J!==void 0?q[1]=J:(q[1]=H=>{h(f.currentTime,f.sampleRate,()=>oe(H))},P.set(oe,q[1]))}}return k.call(y.port1,q[0],q[1],q[2])})(y.port1.addEventListener),y.port1.removeEventListener=(k=>(...q)=>{if(q[0]==="message"){const oe=P.get(q[1]);oe!==void 0&&(P.delete(q[1]),q[1]=oe)}return k.call(y.port1,q[0],q[1],q[2])})(y.port1.removeEventListener);let L=null;Object.defineProperty(y.port1,"onmessage",{get:()=>L,set:k=>{typeof L=="function"&&y.port1.removeEventListener("message",L),L=typeof k=="function"?k:null,typeof L=="function"&&(y.port1.addEventListener("message",L),y.port1.start())}}),m.prototype.port=y.port1;let V=null;jc(f,B,m,g).then(k=>V=k);const ge=Ln(g.numberOfInputs,g.channelCount),_e=Ln(g.numberOfOutputs,_),U=m.parameterDescriptors===void 0?[]:m.parameterDescriptors.reduce((k,{name:q})=>({...k,[q]:new Float32Array(128)}),{});let X=!0;const le=()=>{g.numberOfOutputs>0&&M.disconnect(A);for(let k=0,q=0;k<g.numberOfOutputs;k+=1){const oe=I[k];for(let J=0;J<_[k];J+=1)A.disconnect(oe,q+J,J);q+=_[k]}},O=new Map;M.onaudioprocess=({inputBuffer:k,outputBuffer:q})=>{if(V!==null){const oe=u(B);for(let J=0;J<E;J+=128){for(let H=0;H<g.numberOfInputs;H+=1)for(let ee=0;ee<g.channelCount;ee+=1)Vn(k,ge[H],ee,ee,J);m.parameterDescriptors!==void 0&&m.parameterDescriptors.forEach(({name:H},ee)=>{Vn(k,U,H,T+ee,J)});for(let H=0;H<g.numberOfInputs;H+=1)for(let ee=0;ee<_[H];ee+=1)_e[H][ee].byteLength===0&&(_e[H][ee]=new Float32Array(128));try{const H=ge.map((Pe,rt)=>{if(oe[rt].size>0)return O.set(rt,E/128),Pe;const Mn=O.get(rt);return Mn===void 0?[]:(Pe.every(li=>li.every(hi=>hi===0))&&(Mn===1?O.delete(rt):O.set(rt,Mn-1)),Pe)});X=h(f.currentTime+J/f.sampleRate,f.sampleRate,()=>V.process(H,_e,U));for(let Pe=0,rt=0;Pe<g.numberOfOutputs;Pe+=1){for(let Ot=0;Ot<_[Pe];Ot+=1)Gi(q,_e[Pe],Ot,rt+Ot,J);rt+=_[Pe]}}catch(H){X=!1,B.dispatchEvent(new ErrorEvent("processorerror",{colno:H.colno,filename:H.filename,lineno:H.lineno,message:H.message}))}if(!X){for(let H=0;H<g.numberOfInputs;H+=1){S[H].disconnect(w[H]);for(let ee=0;ee<g.channelCount;ee+=1)w[J].disconnect(x,ee,H*g.channelCount+ee)}if(m.parameterDescriptors!==void 0){const H=m.parameterDescriptors.length;for(let ee=0;ee<H;ee+=1){const Pe=v[ee];Pe.disconnect(x,0,T+ee),Pe.stop()}}x.disconnect(M),M.onaudioprocess=null,Le?le():je();break}}}};let Le=!1;const Re=o(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),Be=()=>M.connect(Re).connect(f.destination),je=()=>{M.disconnect(Re),Re.disconnect()},sn=()=>{if(X){je(),g.numberOfOutputs>0&&M.connect(A);for(let k=0,q=0;k<g.numberOfOutputs;k+=1){const oe=I[k];for(let J=0;J<_[k];J+=1)A.connect(oe,q+J,J);q+=_[k]}}Le=!0},An=()=>{X&&(Be(),le()),Le=!1};return Be(),d(B,sn,An)},Zi=(i,e)=>{const t=i.createBiquadFilter();return me(t,e),ae(t,e,"Q"),ae(t,e,"detune"),ae(t,e,"frequency"),ae(t,e,"gain"),ie(t,e,"type"),t},Hc=(i,e)=>(t,n)=>{const s=t.createChannelMerger(n.numberOfInputs);return i!==null&&i.name==="webkitAudioContext"&&e(t,s),me(s,n),s},Qc=i=>{const e=i.numberOfOutputs;Object.defineProperty(i,"channelCount",{get:()=>e,set:t=>{if(t!==e)throw ye()}}),Object.defineProperty(i,"channelCountMode",{get:()=>"explicit",set:t=>{if(t!=="explicit")throw ye()}}),Object.defineProperty(i,"channelInterpretation",{get:()=>"discrete",set:t=>{if(t!=="discrete")throw ye()}})},pn=(i,e)=>{const t=i.createChannelSplitter(e.numberOfOutputs);return me(t,e),Qc(t),t},Xc=(i,e,t,n,s)=>(r,o)=>{if(r.createConstantSource===void 0)return t(r,o);const a=r.createConstantSource();return me(a,o),ae(a,o,"offset"),e(n,()=>n(r))||Es(a),e(s,()=>s(r))||xs(a),i(r,a),a},Bt=(i,e)=>(i.connect=e.connect.bind(e),i.disconnect=e.disconnect.bind(e),i),Yc=(i,e,t,n)=>(s,{offset:r,...o})=>{const a=s.createBuffer(1,2,44100),c=e(s,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),l=t(s,{...o,gain:r}),h=a.getChannelData(0);h[0]=1,h[1]=1,c.buffer=a,c.loop=!0;const u={get bufferSize(){},get channelCount(){return l.channelCount},set channelCount(p){l.channelCount=p},get channelCountMode(){return l.channelCountMode},set channelCountMode(p){l.channelCountMode=p},get channelInterpretation(){return l.channelInterpretation},set channelInterpretation(p){l.channelInterpretation=p},get context(){return l.context},get inputs(){return[]},get numberOfInputs(){return c.numberOfInputs},get numberOfOutputs(){return l.numberOfOutputs},get offset(){return l.gain},get onended(){return c.onended},set onended(p){c.onended=p},addEventListener(...p){return c.addEventListener(p[0],p[1],p[2])},dispatchEvent(...p){return c.dispatchEvent(p[0])},removeEventListener(...p){return c.removeEventListener(p[0],p[1],p[2])},start(p=0){c.start.call(c,p)},stop(p=0){c.stop.call(c,p)}},d=()=>c.connect(l),f=()=>c.disconnect(l);return i(s,c),n(Bt(u,l),d,f)},Zc=(i,e)=>(t,n)=>{const s=t.createConvolver();if(me(s,n),n.disableNormalization===s.normalize&&(s.normalize=!n.disableNormalization),ie(s,n,"buffer"),n.channelCount>2||(e(s,"channelCount",r=>()=>r.call(s),r=>o=>{if(o>2)throw i();return r.call(s,o)}),n.channelCountMode==="max"))throw i();return e(s,"channelCountMode",r=>()=>r.call(s),r=>o=>{if(o==="max")throw i();return r.call(s,o)}),s},Ji=(i,e)=>{const t=i.createDelay(e.maxDelayTime);return me(t,e),ae(t,e,"delayTime"),t},Jc=i=>(e,t)=>{const n=e.createDynamicsCompressor();if(me(n,t),t.channelCount>2||t.channelCountMode==="max")throw i();return ae(n,t,"attack"),ae(n,t,"knee"),ae(n,t,"ratio"),ae(n,t,"release"),ae(n,t,"threshold"),n},Fe=(i,e)=>{const t=i.createGain();return me(t,e),ae(t,e,"gain"),t},Kc=i=>(e,t,n)=>{if(e.createIIRFilter===void 0)return i(e,t,n);const s=e.createIIRFilter(n.feedforward,n.feedback);return me(s,n),s};function el(i,e){const t=e[0]*e[0]+e[1]*e[1];return[(i[0]*e[0]+i[1]*e[1])/t,(i[1]*e[0]-i[0]*e[1])/t]}function tl(i,e){return[i[0]*e[0]-i[1]*e[1],i[0]*e[1]+i[1]*e[0]]}function Ki(i,e){let t=[0,0];for(let n=i.length-1;n>=0;n-=1)t=tl(t,e),t[0]+=i[n];return t}const nl=(i,e,t,n)=>(s,r,{channelCount:o,channelCountMode:a,channelInterpretation:c,feedback:l,feedforward:h})=>{const u=Yi(r,s.sampleRate),d=l instanceof Float64Array?l:new Float64Array(l),f=h instanceof Float64Array?h:new Float64Array(h),p=d.length,m=f.length,g=Math.min(p,m);if(p===0||p>20)throw n();if(d[0]===0)throw e();if(m===0||m>20)throw n();if(f[0]===0)throw e();if(d[0]!==1){for(let v=0;v<m;v+=1)f[v]/=d[0];for(let v=1;v<p;v+=1)d[v]/=d[0]}const _=t(s,u,o,o);_.channelCount=o,_.channelCountMode=a,_.channelInterpretation=c;const T=32,b=[],C=[],y=[];for(let v=0;v<o;v+=1){b.push(0);const x=new Float32Array(T),E=new Float32Array(T);x.fill(0),E.fill(0),C.push(x),y.push(E)}_.onaudioprocess=v=>{const x=v.inputBuffer,E=v.outputBuffer,M=x.numberOfChannels;for(let A=0;A<M;A+=1){const I=x.getChannelData(A),N=E.getChannelData(A);b[A]=Qi(d,p,f,m,g,C[A],y[A],b[A],T,I,N)}};const S=s.sampleRate/2;return Bt({get bufferSize(){return u},get channelCount(){return _.channelCount},set channelCount(v){_.channelCount=v},get channelCountMode(){return _.channelCountMode},set channelCountMode(v){_.channelCountMode=v},get channelInterpretation(){return _.channelInterpretation},set channelInterpretation(v){_.channelInterpretation=v},get context(){return _.context},get inputs(){return[_]},get numberOfInputs(){return _.numberOfInputs},get numberOfOutputs(){return _.numberOfOutputs},addEventListener(...v){return _.addEventListener(v[0],v[1],v[2])},dispatchEvent(...v){return _.dispatchEvent(v[0])},getFrequencyResponse(v,x,E){if(v.length!==x.length||x.length!==E.length)throw i();const M=v.length;for(let A=0;A<M;A+=1){const I=-Math.PI*(v[A]/S),N=[Math.cos(I),Math.sin(I)],R=Ki(f,N),D=Ki(d,N),F=el(R,D);x[A]=Math.sqrt(F[0]*F[0]+F[1]*F[1]),E[A]=Math.atan2(F[1],F[0])}},removeEventListener(...v){return _.removeEventListener(v[0],v[1],v[2])}},_)},sl=(i,e)=>i.createMediaElementSource(e.mediaElement),il=(i,e)=>{const t=i.createMediaStreamDestination();return me(t,e),t.numberOfOutputs===1&&Object.defineProperty(t,"numberOfOutputs",{get:()=>0}),t},rl=(i,{mediaStream:e})=>{const t=e.getAudioTracks();t.sort((r,o)=>r.id<o.id?-1:r.id>o.id?1:0);const n=t.slice(0,1),s=i.createMediaStreamSource(new MediaStream(n));return Object.defineProperty(s,"mediaStream",{value:e}),s},ol=(i,e)=>(t,{mediaStreamTrack:n})=>{if(typeof t.createMediaStreamTrackSource=="function")return t.createMediaStreamTrackSource(n);const s=new MediaStream([n]),r=t.createMediaStreamSource(s);if(n.kind!=="audio")throw i();if(e(t))throw new TypeError;return r},al=i=>i===null?null:i.hasOwnProperty("OfflineAudioContext")?i.OfflineAudioContext:i.hasOwnProperty("webkitOfflineAudioContext")?i.webkitOfflineAudioContext:null,cl=(i,e,t,n,s,r)=>(o,a)=>{const c=o.createOscillator();return me(c,a),ae(c,a,"detune"),ae(c,a,"frequency"),a.periodicWave!==void 0?c.setPeriodicWave(a.periodicWave):ie(c,a,"type"),e(t,()=>t(o))||Es(c),e(n,()=>n(o))||r(c,o),e(s,()=>s(o))||xs(c),i(o,c),c},ll=i=>(e,t)=>{const n=e.createPanner();return n.orientationX===void 0?i(e,t):(me(n,t),ae(n,t,"orientationX"),ae(n,t,"orientationY"),ae(n,t,"orientationZ"),ae(n,t,"positionX"),ae(n,t,"positionY"),ae(n,t,"positionZ"),ie(n,t,"coneInnerAngle"),ie(n,t,"coneOuterAngle"),ie(n,t,"coneOuterGain"),ie(n,t,"distanceModel"),ie(n,t,"maxDistance"),ie(n,t,"panningModel"),ie(n,t,"refDistance"),ie(n,t,"rolloffFactor"),n)},hl=(i,e,t,n,s,r,o,a,c,l)=>(h,{coneInnerAngle:u,coneOuterAngle:d,coneOuterGain:f,distanceModel:p,maxDistance:m,orientationX:g,orientationY:_,orientationZ:T,panningModel:b,positionX:C,positionY:y,positionZ:S,refDistance:w,rolloffFactor:v,...x})=>{const E=h.createPanner();if(x.channelCount>2||x.channelCountMode==="max")throw o();me(E,x);const M={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},A=t(h,{...M,channelInterpretation:"speakers",numberOfInputs:6}),I=n(h,{...x,gain:1}),N=n(h,{...M,gain:1}),R=n(h,{...M,gain:0}),D=n(h,{...M,gain:0}),F=n(h,{...M,gain:0}),B=n(h,{...M,gain:0}),P=n(h,{...M,gain:0}),L=s(h,256,6,1),V=r(h,{...M,curve:new Float32Array([1,1]),oversample:"none"});let Q=[g,_,T],ge=[C,y,S];const _e=new Float32Array(1);L.onaudioprocess=({inputBuffer:O})=>{const Le=[c(O,_e,0),c(O,_e,1),c(O,_e,2)];Le.some((Be,je)=>Be!==Q[je])&&(E.setOrientation(...Le),Q=Le);const Re=[c(O,_e,3),c(O,_e,4),c(O,_e,5)];Re.some((Be,je)=>Be!==ge[je])&&(E.setPosition(...Re),ge=Re)},Object.defineProperty(R.gain,"defaultValue",{get:()=>0}),Object.defineProperty(D.gain,"defaultValue",{get:()=>0}),Object.defineProperty(F.gain,"defaultValue",{get:()=>0}),Object.defineProperty(B.gain,"defaultValue",{get:()=>0}),Object.defineProperty(P.gain,"defaultValue",{get:()=>0});const U={get bufferSize(){},get channelCount(){return E.channelCount},set channelCount(O){if(O>2)throw o();I.channelCount=O,E.channelCount=O},get channelCountMode(){return E.channelCountMode},set channelCountMode(O){if(O==="max")throw o();I.channelCountMode=O,E.channelCountMode=O},get channelInterpretation(){return E.channelInterpretation},set channelInterpretation(O){I.channelInterpretation=O,E.channelInterpretation=O},get coneInnerAngle(){return E.coneInnerAngle},set coneInnerAngle(O){E.coneInnerAngle=O},get coneOuterAngle(){return E.coneOuterAngle},set coneOuterAngle(O){E.coneOuterAngle=O},get coneOuterGain(){return E.coneOuterGain},set coneOuterGain(O){if(O<0||O>1)throw e();E.coneOuterGain=O},get context(){return E.context},get distanceModel(){return E.distanceModel},set distanceModel(O){E.distanceModel=O},get inputs(){return[I]},get maxDistance(){return E.maxDistance},set maxDistance(O){if(O<0)throw new RangeError;E.maxDistance=O},get numberOfInputs(){return E.numberOfInputs},get numberOfOutputs(){return E.numberOfOutputs},get orientationX(){return N.gain},get orientationY(){return R.gain},get orientationZ(){return D.gain},get panningModel(){return E.panningModel},set panningModel(O){E.panningModel=O},get positionX(){return F.gain},get positionY(){return B.gain},get positionZ(){return P.gain},get refDistance(){return E.refDistance},set refDistance(O){if(O<0)throw new RangeError;E.refDistance=O},get rolloffFactor(){return E.rolloffFactor},set rolloffFactor(O){if(O<0)throw new RangeError;E.rolloffFactor=O},addEventListener(...O){return I.addEventListener(O[0],O[1],O[2])},dispatchEvent(...O){return I.dispatchEvent(O[0])},removeEventListener(...O){return I.removeEventListener(O[0],O[1],O[2])}};u!==U.coneInnerAngle&&(U.coneInnerAngle=u),d!==U.coneOuterAngle&&(U.coneOuterAngle=d),f!==U.coneOuterGain&&(U.coneOuterGain=f),p!==U.distanceModel&&(U.distanceModel=p),m!==U.maxDistance&&(U.maxDistance=m),g!==U.orientationX.value&&(U.orientationX.value=g),_!==U.orientationY.value&&(U.orientationY.value=_),T!==U.orientationZ.value&&(U.orientationZ.value=T),b!==U.panningModel&&(U.panningModel=b),C!==U.positionX.value&&(U.positionX.value=C),y!==U.positionY.value&&(U.positionY.value=y),S!==U.positionZ.value&&(U.positionZ.value=S),w!==U.refDistance&&(U.refDistance=w),v!==U.rolloffFactor&&(U.rolloffFactor=v),(Q[0]!==1||Q[1]!==0||Q[2]!==0)&&E.setOrientation(...Q),(ge[0]!==0||ge[1]!==0||ge[2]!==0)&&E.setPosition(...ge);const X=()=>{I.connect(E),i(I,V,0,0),V.connect(N).connect(A,0,0),V.connect(R).connect(A,0,1),V.connect(D).connect(A,0,2),V.connect(F).connect(A,0,3),V.connect(B).connect(A,0,4),V.connect(P).connect(A,0,5),A.connect(L).connect(h.destination)},le=()=>{I.disconnect(E),a(I,V,0,0),V.disconnect(N),N.disconnect(A),V.disconnect(R),R.disconnect(A),V.disconnect(D),D.disconnect(A),V.disconnect(F),F.disconnect(A),V.disconnect(B),B.disconnect(A),V.disconnect(P),P.disconnect(A),A.disconnect(L),L.disconnect(h.destination)};return l(Bt(U,E),X,le)},ul=i=>(e,{disableNormalization:t,imag:n,real:s})=>{const r=n instanceof Float32Array?n:new Float32Array(n),o=s instanceof Float32Array?s:new Float32Array(s),a=e.createPeriodicWave(o,r,{disableNormalization:t});if(Array.from(n).length<2)throw i();return a},mn=(i,e,t,n)=>i.createScriptProcessor(e,t,n),dl=(i,e)=>(t,n)=>{const s=n.channelCountMode;if(s==="clamped-max")throw e();if(t.createStereoPanner===void 0)return i(t,n);const r=t.createStereoPanner();return me(r,n),ae(r,n,"pan"),Object.defineProperty(r,"channelCountMode",{get:()=>s,set:o=>{if(o!==s)throw e()}}),r},fl=(i,e,t,n,s,r)=>{const a=new Float32Array([1,1]),c=Math.PI/2,l={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},h={...l,oversample:"none"},u=(p,m,g,_)=>{const T=new Float32Array(16385),b=new Float32Array(16385);for(let x=0;x<16385;x+=1){const E=x/16384*c;T[x]=Math.cos(E),b[x]=Math.sin(E)}const C=t(p,{...l,gain:0}),y=n(p,{...h,curve:T}),S=n(p,{...h,curve:a}),w=t(p,{...l,gain:0}),v=n(p,{...h,curve:b});return{connectGraph(){m.connect(C),m.connect(S.inputs===void 0?S:S.inputs[0]),m.connect(w),S.connect(g),g.connect(y.inputs===void 0?y:y.inputs[0]),g.connect(v.inputs===void 0?v:v.inputs[0]),y.connect(C.gain),v.connect(w.gain),C.connect(_,0,0),w.connect(_,0,1)},disconnectGraph(){m.disconnect(C),m.disconnect(S.inputs===void 0?S:S.inputs[0]),m.disconnect(w),S.disconnect(g),g.disconnect(y.inputs===void 0?y:y.inputs[0]),g.disconnect(v.inputs===void 0?v:v.inputs[0]),y.disconnect(C.gain),v.disconnect(w.gain),C.disconnect(_,0,0),w.disconnect(_,0,1)}}},d=(p,m,g,_)=>{const T=new Float32Array(16385),b=new Float32Array(16385),C=new Float32Array(16385),y=new Float32Array(16385),S=Math.floor(16385/2);for(let F=0;F<16385;F+=1)if(F>S){const B=(F-S)/(16384-S)*c;T[F]=Math.cos(B),b[F]=Math.sin(B),C[F]=0,y[F]=1}else{const B=F/(16384-S)*c;T[F]=1,b[F]=0,C[F]=Math.cos(B),y[F]=Math.sin(B)}const w=e(p,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),v=t(p,{...l,gain:0}),x=n(p,{...h,curve:T}),E=t(p,{...l,gain:0}),M=n(p,{...h,curve:b}),A=n(p,{...h,curve:a}),I=t(p,{...l,gain:0}),N=n(p,{...h,curve:C}),R=t(p,{...l,gain:0}),D=n(p,{...h,curve:y});return{connectGraph(){m.connect(w),m.connect(A.inputs===void 0?A:A.inputs[0]),w.connect(v,0),w.connect(E,0),w.connect(I,1),w.connect(R,1),A.connect(g),g.connect(x.inputs===void 0?x:x.inputs[0]),g.connect(M.inputs===void 0?M:M.inputs[0]),g.connect(N.inputs===void 0?N:N.inputs[0]),g.connect(D.inputs===void 0?D:D.inputs[0]),x.connect(v.gain),M.connect(E.gain),N.connect(I.gain),D.connect(R.gain),v.connect(_,0,0),I.connect(_,0,0),E.connect(_,0,1),R.connect(_,0,1)},disconnectGraph(){m.disconnect(w),m.disconnect(A.inputs===void 0?A:A.inputs[0]),w.disconnect(v,0),w.disconnect(E,0),w.disconnect(I,1),w.disconnect(R,1),A.disconnect(g),g.disconnect(x.inputs===void 0?x:x.inputs[0]),g.disconnect(M.inputs===void 0?M:M.inputs[0]),g.disconnect(N.inputs===void 0?N:N.inputs[0]),g.disconnect(D.inputs===void 0?D:D.inputs[0]),x.disconnect(v.gain),M.disconnect(E.gain),N.disconnect(I.gain),D.disconnect(R.gain),v.disconnect(_,0,0),I.disconnect(_,0,0),E.disconnect(_,0,1),R.disconnect(_,0,1)}}},f=(p,m,g,_,T)=>{if(m===1)return u(p,g,_,T);if(m===2)return d(p,g,_,T);throw s()};return(p,{channelCount:m,channelCountMode:g,pan:_,...T})=>{if(g==="max")throw s();const b=i(p,{...T,channelCount:1,channelCountMode:g,numberOfInputs:2}),C=t(p,{...T,channelCount:m,channelCountMode:g,gain:1}),y=t(p,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:_});let{connectGraph:S,disconnectGraph:w}=f(p,m,C,y,b);Object.defineProperty(y.gain,"defaultValue",{get:()=>0}),Object.defineProperty(y.gain,"maxValue",{get:()=>1}),Object.defineProperty(y.gain,"minValue",{get:()=>-1});const v={get bufferSize(){},get channelCount(){return C.channelCount},set channelCount(A){C.channelCount!==A&&(x&&w(),{connectGraph:S,disconnectGraph:w}=f(p,A,C,y,b),x&&S()),C.channelCount=A},get channelCountMode(){return C.channelCountMode},set channelCountMode(A){if(A==="clamped-max"||A==="max")throw s();C.channelCountMode=A},get channelInterpretation(){return C.channelInterpretation},set channelInterpretation(A){C.channelInterpretation=A},get context(){return C.context},get inputs(){return[C]},get numberOfInputs(){return C.numberOfInputs},get numberOfOutputs(){return C.numberOfOutputs},get pan(){return y.gain},addEventListener(...A){return C.addEventListener(A[0],A[1],A[2])},dispatchEvent(...A){return C.dispatchEvent(A[0])},removeEventListener(...A){return C.removeEventListener(A[0],A[1],A[2])}};let x=!1;const E=()=>{S(),x=!0},M=()=>{w(),x=!1};return r(Bt(v,b),E,M)}},pl=(i,e,t,n,s,r,o)=>(a,c)=>{const l=a.createWaveShaper();if(r!==null&&r.name==="webkitAudioContext"&&a.createGain().gain.automationRate===void 0)return t(a,c);me(l,c);const h=c.curve===null||c.curve instanceof Float32Array?c.curve:new Float32Array(c.curve);if(h!==null&&h.length<2)throw e();ie(l,{curve:h},"curve"),ie(l,c,"oversample");let u=null,d=!1;return o(l,"curve",m=>()=>m.call(l),m=>g=>(m.call(l,g),d&&(n(g)&&u===null?u=i(a,l):!n(g)&&u!==null&&(u(),u=null)),g)),s(l,()=>{d=!0,n(l.curve)&&(u=i(a,l))},()=>{d=!1,u!==null&&(u(),u=null)})},ml=(i,e,t,n,s)=>(r,{curve:o,oversample:a,...c})=>{const l=r.createWaveShaper(),h=r.createWaveShaper();me(l,c),me(h,c);const u=t(r,{...c,gain:1}),d=t(r,{...c,gain:-1}),f=t(r,{...c,gain:1}),p=t(r,{...c,gain:-1});let m=null,g=!1,_=null;const T={get bufferSize(){},get channelCount(){return l.channelCount},set channelCount(y){u.channelCount=y,d.channelCount=y,l.channelCount=y,f.channelCount=y,h.channelCount=y,p.channelCount=y},get channelCountMode(){return l.channelCountMode},set channelCountMode(y){u.channelCountMode=y,d.channelCountMode=y,l.channelCountMode=y,f.channelCountMode=y,h.channelCountMode=y,p.channelCountMode=y},get channelInterpretation(){return l.channelInterpretation},set channelInterpretation(y){u.channelInterpretation=y,d.channelInterpretation=y,l.channelInterpretation=y,f.channelInterpretation=y,h.channelInterpretation=y,p.channelInterpretation=y},get context(){return l.context},get curve(){return _},set curve(y){if(y!==null&&y.length<2)throw e();if(y===null)l.curve=y,h.curve=y;else{const S=y.length,w=new Float32Array(S+2-S%2),v=new Float32Array(S+2-S%2);w[0]=y[0],v[0]=-y[S-1];const x=Math.ceil((S+1)/2),E=(S+1)/2-1;for(let M=1;M<x;M+=1){const A=M/x*E,I=Math.floor(A),N=Math.ceil(A);w[M]=I===N?y[I]:(1-(A-I))*y[I]+(1-(N-A))*y[N],v[M]=I===N?-y[S-1-I]:-((1-(A-I))*y[S-1-I])-(1-(N-A))*y[S-1-N]}w[x]=S%2===1?y[x-1]:(y[x-2]+y[x-1])/2,l.curve=w,h.curve=v}_=y,g&&(n(_)&&m===null?m=i(r,u):m!==null&&(m(),m=null))},get inputs(){return[u]},get numberOfInputs(){return l.numberOfInputs},get numberOfOutputs(){return l.numberOfOutputs},get oversample(){return l.oversample},set oversample(y){l.oversample=y,h.oversample=y},addEventListener(...y){return u.addEventListener(y[0],y[1],y[2])},dispatchEvent(...y){return u.dispatchEvent(y[0])},removeEventListener(...y){return u.removeEventListener(y[0],y[1],y[2])}};o!==null&&(T.curve=o instanceof Float32Array?o:new Float32Array(o)),a!==T.oversample&&(T.oversample=a);const b=()=>{u.connect(l).connect(f),u.connect(d).connect(h).connect(p).connect(f),g=!0,n(_)&&(m=i(r,u))},C=()=>{u.disconnect(l),l.disconnect(f),u.disconnect(d),d.disconnect(h),h.disconnect(p),p.disconnect(f),g=!1,m!==null&&(m(),m=null)};return s(Bt(T,f),b,C)},Ee=()=>new DOMException("","NotSupportedError"),gl={numberOfChannels:1},_l=(i,e,t,n,s)=>class extends i{constructor(o,a,c){let l;if(typeof o=="number"&&a!==void 0&&c!==void 0)l={length:a,numberOfChannels:o,sampleRate:c};else if(typeof o=="object")l=o;else throw new Error("The given parameters are not valid.");const{length:h,numberOfChannels:u,sampleRate:d}={...gl,...l},f=n(u,h,d);e(fn,()=>fn(f))||f.addEventListener("statechange",(()=>{let p=0;const m=g=>{this._state==="running"&&(p>0?(f.removeEventListener("statechange",m),g.stopImmediatePropagation(),this._waitForThePromiseToSettle(g)):p+=1)};return m})()),super(f,u),this._length=h,this._nativeOfflineAudioContext=f,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(t()):(this._state="running",s(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,Vi(this)}))}_waitForThePromiseToSettle(o){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(o):setTimeout(()=>this._waitForThePromiseToSettle(o))}},yl={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},vl=(i,e,t,n,s,r,o)=>class extends i{constructor(c,l){const h=s(c),u={...yl,...l},d=t(h,u),f=r(h),p=f?n():null,m=c.sampleRate/2;super(c,!1,d,p),this._detune=e(this,f,d.detune,153600,-153600),this._frequency=e(this,f,d.frequency,m,-m),this._nativeOscillatorNode=d,this._onended=null,this._oscillatorNodeRenderer=p,this._oscillatorNodeRenderer!==null&&u.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=u.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(c){const l=typeof c=="function"?o(this,c):null;this._nativeOscillatorNode.onended=l;const h=this._nativeOscillatorNode.onended;this._onended=h!==null&&h===l?c:h}get type(){return this._nativeOscillatorNode.type}set type(c){this._nativeOscillatorNode.type=c,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(c){this._nativeOscillatorNode.setPeriodicWave(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=c)}start(c=0){if(this._nativeOscillatorNode.start(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=c),this.context.state!=="closed"){Vt(this);const l=()=>{this._nativeOscillatorNode.removeEventListener("ended",l),lt(this)&&ln(this)};this._nativeOscillatorNode.addEventListener("ended",l)}}stop(c=0){this._nativeOscillatorNode.stop(c),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=c)}},Sl=(i,e,t,n,s)=>()=>{const r=new WeakMap;let o=null,a=null,c=null;const l=async(h,u)=>{let d=t(h);const f=Te(d,u);if(!f){const p={channelCount:d.channelCount,channelCountMode:d.channelCountMode,channelInterpretation:d.channelInterpretation,detune:d.detune.value,frequency:d.frequency.value,periodicWave:o===null?void 0:o,type:d.type};d=e(u,p),a!==null&&d.start(a),c!==null&&d.stop(c)}return r.set(u,d),f?(await i(u,h.detune,d.detune),await i(u,h.frequency,d.frequency)):(await n(u,h.detune,d.detune),await n(u,h.frequency,d.frequency)),await s(h,u,d),d};return{set periodicWave(h){o=h},set start(h){a=h},set stop(h){c=h},render(h,u){const d=r.get(u);return d!==void 0?Promise.resolve(d):l(h,u)}}},Cl={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},Tl=(i,e,t,n,s,r,o)=>class extends i{constructor(c,l){const h=s(c),u={...Cl,...l},d=t(h,u),f=r(h),p=f?n():null;super(c,!1,d,p),this._nativePannerNode=d,this._orientationX=e(this,f,d.orientationX,Ae,De),this._orientationY=e(this,f,d.orientationY,Ae,De),this._orientationZ=e(this,f,d.orientationZ,Ae,De),this._positionX=e(this,f,d.positionX,Ae,De),this._positionY=e(this,f,d.positionY,Ae,De),this._positionZ=e(this,f,d.positionZ,Ae,De),o(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(c){this._nativePannerNode.coneInnerAngle=c}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(c){this._nativePannerNode.coneOuterAngle=c}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(c){this._nativePannerNode.coneOuterGain=c}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(c){this._nativePannerNode.distanceModel=c}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(c){this._nativePannerNode.maxDistance=c}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(c){this._nativePannerNode.panningModel=c}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(c){this._nativePannerNode.refDistance=c}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(c){this._nativePannerNode.rolloffFactor=c}},wl=(i,e,t,n,s,r,o,a,c,l)=>()=>{const h=new WeakMap;let u=null;const d=async(f,p)=>{let m=null,g=r(f);const _={channelCount:g.channelCount,channelCountMode:g.channelCountMode,channelInterpretation:g.channelInterpretation},T={..._,coneInnerAngle:g.coneInnerAngle,coneOuterAngle:g.coneOuterAngle,coneOuterGain:g.coneOuterGain,distanceModel:g.distanceModel,maxDistance:g.maxDistance,panningModel:g.panningModel,refDistance:g.refDistance,rolloffFactor:g.rolloffFactor},b=Te(g,p);if("bufferSize"in g)m=n(p,{..._,gain:1});else if(!b){const C={...T,orientationX:g.orientationX.value,orientationY:g.orientationY.value,orientationZ:g.orientationZ.value,positionX:g.positionX.value,positionY:g.positionY.value,positionZ:g.positionZ.value};g=s(p,C)}if(h.set(p,m===null?g:m),m!==null){if(u===null){if(o===null)throw new Error("Missing the native OfflineAudioContext constructor.");const M=new o(6,f.context.length,p.sampleRate),A=e(M,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});A.connect(M.destination),u=(async()=>{const I=await Promise.all([f.orientationX,f.orientationY,f.orientationZ,f.positionX,f.positionY,f.positionZ].map(async(N,R)=>{const D=t(M,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:R===0?1:0});return await a(M,N,D.offset),D}));for(let N=0;N<6;N+=1)I[N].connect(A,0,N),I[N].start(0);return l(M)})()}const C=await u,y=n(p,{..._,gain:1});await c(f,p,y);const S=[];for(let M=0;M<C.numberOfChannels;M+=1)S.push(C.getChannelData(M));let w=[S[0][0],S[1][0],S[2][0]],v=[S[3][0],S[4][0],S[5][0]],x=n(p,{..._,gain:1}),E=s(p,{...T,orientationX:w[0],orientationY:w[1],orientationZ:w[2],positionX:v[0],positionY:v[1],positionZ:v[2]});y.connect(x).connect(E.inputs[0]),E.connect(m);for(let M=128;M<C.length;M+=128){const A=[S[0][M],S[1][M],S[2][M]],I=[S[3][M],S[4][M],S[5][M]];if(A.some((N,R)=>N!==w[R])||I.some((N,R)=>N!==v[R])){w=A,v=I;const N=M/p.sampleRate;x.gain.setValueAtTime(0,N),x=n(p,{..._,gain:0}),E=s(p,{...T,orientationX:w[0],orientationY:w[1],orientationZ:w[2],positionX:v[0],positionY:v[1],positionZ:v[2]}),x.gain.setValueAtTime(1,N),y.connect(x).connect(E.inputs[0]),E.connect(m)}}return m}return b?(await i(p,f.orientationX,g.orientationX),await i(p,f.orientationY,g.orientationY),await i(p,f.orientationZ,g.orientationZ),await i(p,f.positionX,g.positionX),await i(p,f.positionY,g.positionY),await i(p,f.positionZ,g.positionZ)):(await a(p,f.orientationX,g.orientationX),await a(p,f.orientationY,g.orientationY),await a(p,f.orientationZ,g.orientationZ),await a(p,f.positionX,g.positionX),await a(p,f.positionY,g.positionY),await a(p,f.positionZ,g.positionZ)),Lt(g)?await c(f,p,g.inputs[0]):await c(f,p,g),g};return{render(f,p){const m=h.get(p);return m!==void 0?Promise.resolve(m):d(f,p)}}},bl={disableNormalization:!1},Al=(i,e,t,n)=>class Qr{constructor(r,o){const a=e(r),c=n({...bl,...o}),l=i(a,c);return t.add(l),l}static[Symbol.hasInstance](r){return r!==null&&typeof r=="object"&&Object.getPrototypeOf(r)===Qr.prototype||t.has(r)}},Ml=(i,e)=>(t,n,s)=>(i(n).replay(s),e(n,t,s)),El=(i,e,t)=>async(n,s,r)=>{const o=i(n);await Promise.all(o.activeInputs.map((a,c)=>Array.from(a).map(async([l,h])=>{const d=await e(l).render(l,s),f=n.context.destination;!t(l)&&(n!==f||!t(n))&&d.connect(r,h,c)})).reduce((a,c)=>[...a,...c],[]))},xl=(i,e,t)=>async(n,s,r)=>{const o=e(n);await Promise.all(Array.from(o.activeInputs).map(async([a,c])=>{const h=await i(a).render(a,s);t(a)||h.connect(r,c)}))},Nl=(i,e,t,n)=>s=>i(fn,()=>fn(s))?Promise.resolve(i(n,n)).then(r=>{if(!r){const o=t(s,512,0,1);s.oncomplete=()=>{o.onaudioprocess=null,o.disconnect()},o.onaudioprocess=()=>s.currentTime,o.connect(s.destination)}return s.startRendering()}):new Promise(r=>{const o=e(s,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});s.oncomplete=a=>{o.disconnect(),r(a.renderedBuffer)},o.connect(s.destination),s.startRendering()}),Il=i=>(e,t)=>{i.set(e,t)},kl=i=>(e,t)=>i.set(e,t),Dl=(i,e,t,n,s,r,o,a)=>(c,l)=>t(c).render(c,l).then(()=>Promise.all(Array.from(n(l)).map(h=>t(h).render(h,l)))).then(()=>s(l)).then(h=>(typeof h.copyFromChannel!="function"?(o(h),Ts(h)):e(r,()=>r(h))||a(h),i.add(h),h)),Fl={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},Ol=(i,e,t,n,s,r)=>class extends i{constructor(a,c){const l=s(a),h={...Fl,...c},u=t(l,h),d=r(l),f=d?n():null;super(a,!1,u,f),this._pan=e(this,d,u.pan)}get pan(){return this._pan}},Rl=(i,e,t,n,s)=>()=>{const r=new WeakMap,o=async(a,c)=>{let l=t(a);const h=Te(l,c);if(!h){const u={channelCount:l.channelCount,channelCountMode:l.channelCountMode,channelInterpretation:l.channelInterpretation,pan:l.pan.value};l=e(c,u)}return r.set(c,l),h?await i(c,a.pan,l.pan):await n(c,a.pan,l.pan),Lt(l)?await s(a,c,l.inputs[0]):await s(a,c,l),l};return{render(a,c){const l=r.get(c);return l!==void 0?Promise.resolve(l):o(a,c)}}},Pl=i=>()=>{if(i===null)return!1;try{new i({length:1,sampleRate:44100})}catch{return!1}return!0},ql=(i,e)=>async()=>{if(i===null)return!0;if(e===null)return!1;const t=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),n=new e(1,128,44100),s=URL.createObjectURL(t);let r=!1,o=!1;try{await n.audioWorklet.addModule(s);const a=new i(n,"a",{numberOfOutputs:0}),c=n.createOscillator();a.port.onmessage=()=>r=!0,a.onprocessorerror=()=>o=!0,c.connect(a),c.start(0),await n.startRendering(),await new Promise(l=>setTimeout(l))}catch{}finally{URL.revokeObjectURL(s)}return r&&!o},Vl=(i,e)=>()=>{if(e===null)return Promise.resolve(!1);const t=new e(1,1,44100),n=i(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(s=>{t.oncomplete=()=>{n.disconnect(),s(t.currentTime!==0)},t.startRendering()})},Ll=()=>new DOMException("","UnknownError"),Bl={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},Ul=(i,e,t,n,s,r,o)=>class extends i{constructor(c,l){const h=s(c),u={...Bl,...l},d=t(h,u),p=r(h)?n():null;super(c,!0,d,p),this._isCurveNullified=!1,this._nativeWaveShaperNode=d,o(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(c){if(c===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(c.length<2)throw e();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=c}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(c){this._nativeWaveShaperNode.oversample=c}},zl=(i,e,t)=>()=>{const n=new WeakMap,s=async(r,o)=>{let a=e(r);if(!Te(a,o)){const l={channelCount:a.channelCount,channelCountMode:a.channelCountMode,channelInterpretation:a.channelInterpretation,curve:a.curve,oversample:a.oversample};a=i(o,l)}return n.set(o,a),Lt(a)?await t(r,o,a.inputs[0]):await t(r,o,a),a};return{render(r,o){const a=n.get(o);return a!==void 0?Promise.resolve(a):s(r,o)}}},Wl=()=>typeof window>"u"?null:window,$l=(i,e)=>t=>{t.copyFromChannel=(n,s,r=0)=>{const o=i(r),a=i(s);if(a>=t.numberOfChannels)throw e();const c=t.length,l=t.getChannelData(a),h=n.length;for(let u=o<0?-o:0;u+o<c&&u<h;u+=1)n[u]=l[u+o]},t.copyToChannel=(n,s,r=0)=>{const o=i(r),a=i(s);if(a>=t.numberOfChannels)throw e();const c=t.length,l=t.getChannelData(a),h=n.length;for(let u=o<0?-o:0;u+o<c&&u<h;u+=1)l[u+o]=n[u]}},jl=i=>e=>{e.copyFromChannel=(t=>(n,s,r=0)=>{const o=i(r),a=i(s);if(o<e.length)return t.call(e,n,a,o)})(e.copyFromChannel),e.copyToChannel=(t=>(n,s,r=0)=>{const o=i(r),a=i(s);if(o<e.length)return t.call(e,n,a,o)})(e.copyToChannel)},Gl=i=>(e,t)=>{const n=t.createBuffer(1,1,44100);e.buffer===null&&(e.buffer=n),i(e,"buffer",s=>()=>{const r=s.call(e);return r===n?null:r},s=>r=>s.call(e,r===null?n:r))},Hl=(i,e)=>(t,n)=>{n.channelCount=1,n.channelCountMode="explicit",Object.defineProperty(n,"channelCount",{get:()=>1,set:()=>{throw i()}}),Object.defineProperty(n,"channelCountMode",{get:()=>"explicit",set:()=>{throw i()}});const s=t.createBufferSource();e(n,()=>{const a=n.numberOfInputs;for(let c=0;c<a;c+=1)s.connect(n,0,c)},()=>s.disconnect(n))},er=(i,e,t)=>i.copyFromChannel===void 0?i.getChannelData(t)[0]:(i.copyFromChannel(e,t),e[0]),tr=i=>{if(i===null)return!1;const e=i.length;return e%2!==0?i[Math.floor(e/2)]!==0:i[e/2-1]+i[e/2]!==0},gn=(i,e,t,n)=>{let s=i;for(;!s.hasOwnProperty(e);)s=Object.getPrototypeOf(s);const{get:r,set:o}=Object.getOwnPropertyDescriptor(s,e);Object.defineProperty(i,e,{get:t(r),set:n(o)})},Ql=i=>({...i,outputChannelCount:i.outputChannelCount!==void 0?i.outputChannelCount:i.numberOfInputs===1&&i.numberOfOutputs===1?[i.channelCount]:Array.from({length:i.numberOfOutputs},()=>1)}),Xl=i=>({...i,channelCount:i.numberOfOutputs}),Yl=i=>{const{imag:e,real:t}=i;return e===void 0?t===void 0?{...i,imag:[0,0],real:[0,0]}:{...i,imag:Array.from(t,()=>0),real:t}:t===void 0?{...i,imag:e,real:Array.from(e,()=>0)}:{...i,imag:e,real:t}},nr=(i,e,t)=>{try{i.setValueAtTime(e,t)}catch(n){if(n.code!==9)throw n;nr(i,e,t+1e-7)}},Zl=i=>{const e=i.createBufferSource();e.start();try{e.start()}catch{return!0}return!1},Jl=i=>{const e=i.createBufferSource(),t=i.createBuffer(1,1,44100);e.buffer=t;try{e.start(0,1)}catch{return!1}return!0},Kl=i=>{const e=i.createBufferSource();e.start();try{e.stop()}catch{return!1}return!0},Ns=i=>{const e=i.createOscillator();try{e.start(-1)}catch(t){return t instanceof RangeError}return!1},sr=i=>{const e=i.createBuffer(1,1,44100),t=i.createBufferSource();t.buffer=e,t.start(),t.stop();try{return t.stop(),!0}catch{return!1}},Is=i=>{const e=i.createOscillator();try{e.stop(-1)}catch(t){return t instanceof RangeError}return!1},eh=i=>{const{port1:e,port2:t}=new MessageChannel;try{e.postMessage(i)}finally{e.close(),t.close()}},th=i=>{i.start=(e=>(t=0,n=0,s)=>{const r=i.buffer,o=r===null?n:Math.min(r.duration,n);r!==null&&o>r.duration-.5/i.context.sampleRate?e.call(i,t,0,0):e.call(i,t,o,s)})(i.start)},ir=(i,e)=>{const t=e.createGain();i.connect(t);const n=(s=>()=>{s.call(i,t),i.removeEventListener("ended",n)})(i.disconnect);i.addEventListener("ended",n),Bt(i,t),i.stop=(s=>{let r=!1;return(o=0)=>{if(r)try{s.call(i,o)}catch{t.gain.setValueAtTime(0,o)}else s.call(i,o),r=!0}})(i.stop)},Ut=(i,e)=>t=>{const n={value:i};return Object.defineProperties(t,{currentTarget:n,target:n}),typeof e=="function"?e.call(i,t):e.handleEvent.call(i,t)},nh=To(Mt),sh=xo(Mt),ih=Ba(kn),rr=new WeakMap,rh=ic(rr),Qe=ga(new Map,new WeakMap),tt=Wl(),or=Oc(Qe,et),ks=sc(Me),Se=El(Me,ks,Et),oh=Fo(or,te,Se),K=ac(In),ht=al(tt),Y=bc(ht),ar=new WeakMap,cr=Ya(Ut),_n=Vc(tt),Ds=Sc(_n),Fs=Cc(tt),lr=Tc(tt),yn=Bc(tt),he=ia(wo(xi),Eo(nh,sh,On,ih,Rn,Me,rh,cn,te,Mt,lt,Et,Pn),Qe,mc(ys,Rn,Me,te,dn,lt),et,Un,Ee,Pa(On,ys,Me,te,dn,K,lt,Y),Wa(ar,Me,He),cr,K,Ds,Fs,lr,Y,yn),ah=Do(he,oh,et,or,K,Y),Os=new WeakSet,hr=Rc(tt),ur=Na(new Uint32Array(1)),Rs=$l(ur,et),Ps=jl(ur),dr=Ro(Os,Qe,Ee,hr,ht,Pl(hr),Rs,Ps),zn=No(Fe),fr=xl(ks,hn,Et),nt=wa(fr),zt=qc(zn,Qe,Zl,Jl,Kl,Ns,sr,Is,th,Gl(gn),ir),st=Ml(rc(hn),fr),ch=Vo(nt,zt,te,st,Se),Xe=ra(bo(Ni),ar,_s,oa,go,_o,yo,vo,So,ds,wi,_n,nr),lh=qo(he,ch,Xe,ye,zt,K,Y,Ut),hh=Ho(he,Qo,et,ye,Lc(Fe,gn),K,Y,Se),uh=ma(nt,Zi,te,st,Se),xt=kl(rr),dh=pa(he,Xe,uh,Un,Zi,K,Y,xt),St=Dc(Mt,Fs),fh=Hl(ye,St),Ct=Hc(_n,fh),ph=va(Ct,te,Se),mh=ya(he,ph,Ct,K,Y),gh=Ta(pn,te,Se),_h=Ca(he,gh,pn,K,Y,Xl),yh=Yc(zn,zt,Fe,St),Wt=Xc(zn,Qe,yh,Ns,Is),vh=xa(nt,Wt,te,st,Se),Sh=Ea(he,Xe,vh,Wt,K,Y,Ut),pr=Zc(Ee,gn),Ch=Da(pr,te,Se),Th=ka(he,Ch,pr,K,Y,xt),wh=La(nt,Ji,te,st,Se),bh=Va(he,Xe,wh,Ji,K,Y,xt),mr=Jc(Ee),Ah=Ha(nt,mr,te,st,Se),Mh=Ga(he,Xe,Ah,mr,Ee,K,Y,xt),Eh=tc(nt,Fe,te,st,Se),xh=ec(he,Xe,Eh,Fe,K,Y),Nh=nl(Un,ye,mn,Ee),Wn=Nl(Qe,Fe,mn,Vl(Fe,ht)),Ih=pc(zt,te,ht,Se,Wn),kh=Kc(Nh),Dh=dc(he,kh,Ih,K,Y,xt),Fh=Xo(Xe,Ct,Wt,mn,Ee,er,Y,gn),gr=new WeakMap,Oh=kc(hh,Fh,cr,Y,gr,Ut),_r=cl(zn,Qe,Ns,sr,Is,ir),Rh=Sl(nt,_r,te,st,Se),Ph=vl(he,Xe,_r,Rh,K,Y,Ut),yr=Aa(zt),qh=ml(yr,ye,Fe,tr,St),$n=pl(yr,ye,qh,tr,St,_n,gn),Vh=hl(On,ye,Ct,Fe,mn,$n,Ee,Rn,er,St),vr=ll(Vh),Lh=wl(nt,Ct,Wt,Fe,vr,te,ht,st,Se,Wn),Bh=Tl(he,Xe,vr,Lh,K,Y,xt),Uh=ul(et),zh=Al(Uh,K,new WeakSet,Yl),Wh=fl(Ct,pn,Fe,$n,Ee,St),Sr=dl(Wh,Ee),$h=Rl(nt,Sr,te,st,Se),jh=Ol(he,Xe,Sr,$h,K,Y),Gh=zl($n,te,Se),Hh=Ul(he,ye,$n,Gh,K,Y,xt),Cr=Ac(tt),qs=Za(tt),Tr=new WeakMap,Qh=cc(Tr,ht),Xh=Cr?Mo(Qe,Ee,Xa(tt),qs,Ja(Co),K,Qh,Y,yn,new WeakMap,new WeakMap,ql(yn,ht),tt):void 0,Yh=wc(Ds,Y),Zh=Ra(Os,Qe,Oa,Qa,new WeakSet,K,Yh,Dn,fn,Rs,Ps),wr=da(Xh,ah,dr,lh,dh,mh,_h,Sh,Th,Zh,bh,Mh,xh,Dh,Oh,Ph,Bh,zh,jh,Hh),Jh=Mc(he,sl,K,Y),Kh=xc(he,il,K,Y),eu=Nc(he,rl,K,Y),tu=ol(ye,Y),nu=Ic(he,tu,K),su=Go(wr,ye,Ee,Ll,Jh,Kh,eu,nu,_n),Vs=lc(gr),iu=Io(Vs),br=ba(et),ru=Ua(Vs),Ar=$a(et),Mr=new WeakMap,ou=nc(Mr,He),au=Gc(br,et,ye,Ct,pn,Wt,Fe,mn,Ee,Ar,qs,ou,St),cu=zc(ye,au,Fe,Ee,St),lu=ua(nt,br,zt,Ct,pn,Wt,Fe,ru,Ar,qs,te,yn,ht,st,Se,Wn),hu=oc(Tr),uu=Il(Mr),Er=Cr?ca(iu,he,Xe,lu,cu,Me,hu,K,Y,yn,Ql,uu,eh,Ut):void 0,du=Fa(Ee,ht),fu=Dl(Os,Qe,ks,Vs,Wn,Dn,Rs,Ps),pu=_l(wr,Qe,ye,du,fu),mu=gc(In,Ds),gu=_c(gs,Fs),_u=yc(_s,lr),yu=vc(In,Y);function Ue(i){return i===void 0}function G(i){return i!==void 0}function vu(i){return typeof i=="function"}function Nt(i){return typeof i=="number"}function It(i){return Object.prototype.toString.call(i)==="[object Object]"&&i.constructor===Object}function Su(i){return typeof i=="boolean"}function Ye(i){return Array.isArray(i)}function ut(i){return typeof i=="string"}function jn(i){return ut(i)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(i)}function W(i,e){if(!i)throw new Error(e)}function Tt(i,e,t=1/0){if(!(e<=i&&i<=t))throw new RangeError(`Value must be within [${e}, ${t}], got: ${i}`)}function xr(i){!i.isOffline&&i.state!=="running"&&Ls('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let Nr=!1,Ir=!1;function kr(i){Nr=i}function Cu(i){Ue(i)&&Nr&&!Ir&&(Ir=!0,Ls("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let Dr=console;function Tu(...i){Dr.log(...i)}function Ls(...i){Dr.warn(...i)}function wu(i){return new su(i)}function bu(i,e,t){return new pu(i,e,t)}const qe=typeof self=="object"?self:null,Au=qe&&(qe.hasOwnProperty("AudioContext")||qe.hasOwnProperty("webkitAudioContext"));function Mu(i,e,t){return W(G(Er),"AudioWorkletNode only works in a secure context (https or localhost)"),new(i instanceof(qe==null?void 0:qe.BaseAudioContext)?qe==null?void 0:qe.AudioWorkletNode:Er)(i,e,t)}function Ze(i,e,t,n){var s=arguments.length,r=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,t):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(i,e,t,n);else for(var a=i.length-1;a>=0;a--)(o=i[a])&&(r=(s<3?o(r):s>3?o(e,t,r):o(e,t))||r);return s>3&&r&&Object.defineProperty(e,t,r),r}function de(i,e,t,n){function s(r){return r instanceof t?r:new t(function(o){o(r)})}return new(t||(t=Promise))(function(r,o){function a(h){try{l(n.next(h))}catch(u){o(u)}}function c(h){try{l(n.throw(h))}catch(u){o(u)}}function l(h){h.done?r(h.value):s(h.value).then(a,c)}l((n=n.apply(i,e||[])).next())})}typeof SuppressedError=="function"&&SuppressedError;class Eu{constructor(e,t,n,s){this._callback=e,this._type=t,this._minimumUpdateInterval=Math.max(128/(s||44100),.001),this.updateInterval=n,this._createClock()}_createWorker(){const e=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(this._updateInterval*1e3).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),t=URL.createObjectURL(e),n=new Worker(t);n.onmessage=this._callback.bind(this),this._worker=n}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},this._updateInterval*1e3)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(e){var t;this._updateInterval=Math.max(e,this._minimumUpdateInterval),this._type==="worker"&&((t=this._worker)===null||t===void 0||t.postMessage(this._updateInterval*1e3))}get type(){return this._type}set type(e){this._disposeClock(),this._type=e,this._createClock()}dispose(){this._disposeClock()}}function kt(i){return _u(i)}function wt(i){return gu(i)}function Gn(i){return yu(i)}function $t(i){return mu(i)}function xu(i){return i instanceof dr}function Nu(i,e){return i==="value"||kt(e)||wt(e)||xu(e)}function jt(i,...e){if(!e.length)return i;const t=e.shift();if(It(i)&&It(t))for(const n in t)Nu(n,t[n])?i[n]=t[n]:It(t[n])?(i[n]||Object.assign(i,{[n]:{}}),jt(i[n],t[n])):Object.assign(i,{[n]:t[n]});return jt(i,...e)}function Iu(i,e){return i.length===e.length&&i.every((t,n)=>e[n]===t)}function z(i,e,t=[],n){const s={},r=Array.from(e);if(It(r[0])&&n&&!Reflect.has(r[0],n)&&(Object.keys(r[0]).some(a=>Reflect.has(i,a))||(jt(s,{[n]:r[0]}),t.splice(t.indexOf(n),1),r.shift())),r.length===1&&It(r[0]))jt(s,r[0]);else for(let o=0;o<t.length;o++)G(r[o])&&(s[t[o]]=r[o]);return jt(i,s)}function ku(i){return i.constructor.getDefaults()}function Gt(i,e){return Ue(i)?e:i}function Fr(i,e){return e.forEach(t=>{Reflect.has(i,t)&&delete i[t]}),i}/**
 * Tone.js
 * @author Yotam Mann
 * @license http://opensource.org/licenses/MIT MIT License
 * @copyright 2014-2024 Yotam Mann
 */class dt{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...e){(this.debug||qe&&this.toString()===qe.TONE_DEBUG_CLASS)&&Tu(this,...e)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}dt.version=Si;const Bs=1e-6;function Ht(i,e){return i>e+Bs}function Us(i,e){return Ht(i,e)||Je(i,e)}function Hn(i,e){return i+Bs<e}function Je(i,e){return Math.abs(i-e)<Bs}function Du(i,e,t){return Math.max(Math.min(i,t),e)}class ze extends dt{constructor(){super(),this.name="Timeline",this._timeline=[];const e=z(ze.getDefaults(),arguments,["memory"]);this.memory=e.memory,this.increasing=e.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(e){if(W(Reflect.has(e,"time"),"Timeline: events must have a time attribute"),e.time=e.time.valueOf(),this.increasing&&this.length){const t=this._timeline[this.length-1];W(Us(e.time,t.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(e)}else{const t=this._search(e.time);this._timeline.splice(t+1,0,e)}if(this.length>this.memory){const t=this.length-this.memory;this._timeline.splice(0,t)}return this}remove(e){const t=this._timeline.indexOf(e);return t!==-1&&this._timeline.splice(t,1),this}get(e,t="time"){const n=this._search(e,t);return n!==-1?this._timeline[n]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(e,t="time"){const n=this._search(e,t);return n+1<this._timeline.length?this._timeline[n+1]:null}getBefore(e){const t=this._timeline.length;if(t>0&&this._timeline[t-1].time<e)return this._timeline[t-1];const n=this._search(e);return n-1>=0?this._timeline[n-1]:null}cancel(e){if(this._timeline.length>1){let t=this._search(e);if(t>=0)if(Je(this._timeline[t].time,e)){for(let n=t;n>=0&&Je(this._timeline[n].time,e);n--)t=n;this._timeline=this._timeline.slice(0,t)}else this._timeline=this._timeline.slice(0,t+1);else this._timeline=[]}else this._timeline.length===1&&Us(this._timeline[0].time,e)&&(this._timeline=[]);return this}cancelBefore(e){const t=this._search(e);return t>=0&&(this._timeline=this._timeline.slice(t+1)),this}previousEvent(e){const t=this._timeline.indexOf(e);return t>0?this._timeline[t-1]:null}_search(e,t="time"){if(this._timeline.length===0)return-1;let n=0;const s=this._timeline.length;let r=s;if(s>0&&this._timeline[s-1][t]<=e)return s-1;for(;n<r;){let o=Math.floor(n+(r-n)/2);const a=this._timeline[o],c=this._timeline[o+1];if(Je(a[t],e)){for(let l=o;l<this._timeline.length;l++){const h=this._timeline[l];if(Je(h[t],e))o=l;else break}return o}else{if(Hn(a[t],e)&&Ht(c[t],e))return o;Ht(a[t],e)?r=o:n=o+1}}return-1}_iterate(e,t=0,n=this._timeline.length-1){this._timeline.slice(t,n+1).forEach(e)}forEach(e){return this._iterate(e),this}forEachBefore(e,t){const n=this._search(e);return n!==-1&&this._iterate(t,0,n),this}forEachAfter(e,t){const n=this._search(e);return this._iterate(t,n+1),this}forEachBetween(e,t,n){let s=this._search(e),r=this._search(t);return s!==-1&&r!==-1?(this._timeline[s].time!==e&&(s+=1),this._timeline[r].time===t&&(r-=1),this._iterate(n,s,r)):s===-1&&this._iterate(n,0,r),this}forEachFrom(e,t){let n=this._search(e);for(;n>=0&&this._timeline[n].time>=e;)n--;return this._iterate(t,n+1),this}forEachAtTime(e,t){const n=this._search(e);if(n!==-1&&Je(this._timeline[n].time,e)){let s=n;for(let r=n;r>=0&&Je(this._timeline[r].time,e);r--)s=r;this._iterate(r=>{t(r)},s,n)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const Or=[];function Qn(i){Or.push(i)}function Fu(i){Or.forEach(e=>e(i))}const Rr=[];function Xn(i){Rr.push(i)}function Ou(i){Rr.forEach(e=>e(i))}class vn extends dt{constructor(){super(...arguments),this.name="Emitter"}on(e,t){return e.split(/\W+/).forEach(s=>{Ue(this._events)&&(this._events={}),this._events.hasOwnProperty(s)||(this._events[s]=[]),this._events[s].push(t)}),this}once(e,t){const n=(...s)=>{t(...s),this.off(e,n)};return this.on(e,n),this}off(e,t){return e.split(/\W+/).forEach(s=>{if(Ue(this._events)&&(this._events={}),this._events.hasOwnProperty(s))if(Ue(t))this._events[s]=[];else{const r=this._events[s];for(let o=r.length-1;o>=0;o--)r[o]===t&&r.splice(o,1)}}),this}emit(e,...t){if(this._events&&this._events.hasOwnProperty(e)){const n=this._events[e].slice(0);for(let s=0,r=n.length;s<r;s++)n[s].apply(this,t)}return this}static mixin(e){["on","once","off","emit"].forEach(t=>{const n=Object.getOwnPropertyDescriptor(vn.prototype,t);Object.defineProperty(e.prototype,t,n)})}dispose(){return super.dispose(),this._events=void 0,this}}class Pr extends vn{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class Sn extends Pr{constructor(){var e,t;super(),this.name="Context",this._constants=new Map,this._timeouts=new ze,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const n=z(Sn.getDefaults(),arguments,["context"]);n.context?(this._context=n.context,this._latencyHint=((e=arguments[0])===null||e===void 0?void 0:e.latencyHint)||""):(this._context=wu({latencyHint:n.latencyHint}),this._latencyHint=n.latencyHint),this._ticker=new Eu(this.emit.bind(this,"tick"),n.clockSource,n.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((t=arguments[0])===null||t===void 0)&&t.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=n.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){return this._initialized||(Fu(this),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(e,t,n){return this._context.createBuffer(e,t,n)}createChannelMerger(e){return this._context.createChannelMerger(e)}createChannelSplitter(e){return this._context.createChannelSplitter(e)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(e){return this._context.createDelay(e)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(e,t){return this._context.createIIRFilter(e,t)}createPanner(){return this._context.createPanner()}createPeriodicWave(e,t,n){return this._context.createPeriodicWave(e,t,n)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(e){return W($t(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(e)}createMediaElementSource(e){return W($t(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(e)}createMediaStreamDestination(){return W($t(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(e){return this._context.decodeAudioData(e)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(e){W(!this._initialized,"The listener cannot be set after initialization."),this._listener=e}get transport(){return this.initialize(),this._transport}set transport(e){W(!this._initialized,"The transport cannot be set after initialization."),this._transport=e}get draw(){return this.initialize(),this._draw}set draw(e){W(!this._initialized,"Draw cannot be set after initialization."),this._draw=e}get destination(){return this.initialize(),this._destination}set destination(e){W(!this._initialized,"The destination cannot be set after initialization."),this._destination=e}createAudioWorkletNode(e,t){return Mu(this.rawContext,e,t)}addAudioWorkletModule(e){return de(this,void 0,void 0,function*(){W(G(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(e)),yield this._workletPromise})}workletsAreReady(){return de(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(e){this._ticker.updateInterval=e}get clockSource(){return this._ticker.type}set clockSource(e){this._ticker.type=e}get lookAhead(){return this._lookAhead}set lookAhead(e){this._lookAhead=e,this.updateInterval=e?e/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return $t(this._context)?this._context.resume():Promise.resolve()}close(){return de(this,void 0,void 0,function*(){$t(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&Ou(this)})}getConstant(e){if(this._constants.has(e))return this._constants.get(e);{const t=this._context.createBuffer(1,128,this._context.sampleRate),n=t.getChannelData(0);for(let r=0;r<n.length;r++)n[r]=e;const s=this._context.createBufferSource();return s.channelCount=1,s.channelCountMode="explicit",s.buffer=t,s.loop=!0,s.start(0),this._constants.set(e,s),s}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(e=>this._constants[e].disconnect()),this.close(),this}_timeoutLoop(){const e=this.now();this._timeouts.forEachBefore(e,t=>{t.callback(),this._timeouts.remove(t)})}setTimeout(e,t){this._timeoutIds++;const n=this.now();return this._timeouts.add({callback:e,id:this._timeoutIds,time:n+t}),this._timeoutIds}clearTimeout(e){return this._timeouts.forEach(t=>{t.id===e&&this._timeouts.remove(t)}),this}clearInterval(e){return this.clearTimeout(e)}setInterval(e,t){const n=++this._timeoutIds,s=()=>{const r=this.now();this._timeouts.add({callback:()=>{e(),s()},id:n,time:r+t})};return s(),n}}class Ru extends Pr{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(e,t,n){return{}}createChannelMerger(e){return{}}createChannelSplitter(e){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(e){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(e,t){return{}}createPanner(){return{}}createPeriodicWave(e,t,n){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(e){return{}}createMediaElementSource(e){return{}}createMediaStreamDestination(){return{}}decodeAudioData(e){return Promise.resolve({})}createAudioWorkletNode(e,t){return{}}get rawContext(){return{}}addAudioWorkletModule(e){return de(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(e,t){return 0}clearTimeout(e){return this}setInterval(e,t){return 0}clearInterval(e){return this}getConstant(e){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(e){}get destination(){return{}}set destination(e){}now(){return 0}immediate(){return 0}}function ce(i,e){Ye(e)?e.forEach(t=>ce(i,t)):Object.defineProperty(i,e,{enumerable:!0,writable:!1})}function qr(i,e){Ye(e)?e.forEach(t=>qr(i,t)):Object.defineProperty(i,e,{writable:!0})}const Z=()=>{};class ne extends dt{constructor(){super(),this.name="ToneAudioBuffer",this.onload=Z;const e=z(ne.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=e.reverse,this.onload=e.onload,ut(e.url)?this.load(e.url).catch(e.onerror):e.url&&this.set(e.url)}static getDefaults(){return{onerror:Z,onload:Z,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:We().sampleRate}set(e){return e instanceof ne?e.loaded?this._buffer=e.get():e.onload=()=>{this.set(e),this.onload(this)}:this._buffer=e,this._reversed&&this._reverse(),this}get(){return this._buffer}load(e){return de(this,void 0,void 0,function*(){const t=ne.load(e).then(n=>{this.set(n),this.onload(this)});ne.downloads.push(t);try{yield t}finally{const n=ne.downloads.indexOf(t);ne.downloads.splice(n,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(e){const t=Ye(e)&&e[0].length>0,n=t?e.length:1,s=t?e[0].length:e.length,r=We(),o=r.createBuffer(n,s,r.sampleRate),a=!t&&n===1?[e]:e;for(let c=0;c<n;c++)o.copyToChannel(a[c],c);return this._buffer=o,this}toMono(e){if(Nt(e))this.fromArray(this.toArray(e));else{let t=new Float32Array(this.length);const n=this.numberOfChannels;for(let s=0;s<n;s++){const r=this.toArray(s);for(let o=0;o<r.length;o++)t[o]+=r[o]}t=t.map(s=>s/n),this.fromArray(t)}return this}toArray(e){if(Nt(e))return this.getChannelData(e);if(this.numberOfChannels===1)return this.toArray(0);{const t=[];for(let n=0;n<this.numberOfChannels;n++)t[n]=this.getChannelData(n);return t}}getChannelData(e){return this._buffer?this._buffer.getChannelData(e):new Float32Array(0)}slice(e,t=this.duration){W(this.loaded,"Buffer is not loaded");const n=Math.floor(e*this.sampleRate),s=Math.floor(t*this.sampleRate);W(n<s,"The start time must be less than the end time");const r=s-n,o=We().createBuffer(this.numberOfChannels,r,this.sampleRate);for(let a=0;a<this.numberOfChannels;a++)o.copyToChannel(this.getChannelData(a).subarray(n,s),a);return new ne(o)}_reverse(){if(this.loaded)for(let e=0;e<this.numberOfChannels;e++)this.getChannelData(e).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(e){this._reversed!==e&&(this._reversed=e,this._reverse())}static fromArray(e){return new ne().fromArray(e)}static fromUrl(e){return de(this,void 0,void 0,function*(){return yield new ne().load(e)})}static load(e){return de(this,void 0,void 0,function*(){const t=ne.baseUrl===""||ne.baseUrl.endsWith("/")?ne.baseUrl:ne.baseUrl+"/",n=yield fetch(t+e);if(!n.ok)throw new Error(`could not load url: ${e}`);const s=yield n.arrayBuffer();return yield We().decodeAudioData(s)})}static supportsType(e){const t=e.split("."),n=t[t.length-1];return document.createElement("audio").canPlayType("audio/"+n)!==""}static loaded(){return de(this,void 0,void 0,function*(){for(yield Promise.resolve();ne.downloads.length;)yield ne.downloads[0]})}}ne.baseUrl="",ne.downloads=[];class zs extends Sn{constructor(){super({clockSource:"offline",context:Gn(arguments[0])?arguments[0]:bu(arguments[0],arguments[1]*arguments[2],arguments[2]),lookAhead:0,updateInterval:Gn(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=Gn(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(e){return de(this,void 0,void 0,function*(){let t=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,t++;const n=Math.floor(this.sampleRate/128);e&&t%n===0&&(yield new Promise(s=>setTimeout(s,1)))}})}render(){return de(this,arguments,void 0,function*(e=!0){yield this.workletsAreReady(),yield this._renderClock(e);const t=yield this._context.startRendering();return new ne(t)})}close(){return Promise.resolve()}}const Vr=new Ru;let Dt=Vr;function We(){return Dt===Vr&&Au&&Pu(new Sn),Dt}function Pu(i,e=!1){e&&Dt.dispose(),$t(i)?Dt=new Sn(i):Gn(i)?Dt=new zs(i):Dt=i}function qu(){return Dt.resume()}if(qe&&!qe.TONE_SILENCE_LOGGING){const e=` * Tone.js v${Si} * `;console.log(`%c${e}`,"background: #000; color: #fff")}function Vu(i){return Math.pow(10,i/20)}function Lu(i){return 20*(Math.log(i)/Math.LN10)}function Lr(i){return Math.pow(2,i/12)}let Yn=440;function Bu(){return Yn}function Uu(i){Yn=i}function Ws(i){return Math.round(Br(i))}function Br(i){return 69+12*Math.log2(i/Yn)}function zu(i){return Yn*Math.pow(2,(i-69)/12)}class $s extends dt{constructor(e,t,n){super(),this.defaultUnits="s",this._val=t,this._units=n,this.context=e,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:e=>this._frequencyToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:e=>this._ticksToUnits(parseInt(e,10)),regexp:/^(\d+)i$/i},m:{method:e=>this._beatsToUnits(parseInt(e,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(e,t)=>{const n=parseInt(e,10),s=t==="."?1.5:1;return n===1?this._beatsToUnits(this._getTimeSignature())*s:this._beatsToUnits(4/n)*s},regexp:/^(\d+)n(\.?)$/i},number:{method:e=>this._expressions[this.defaultUnits].method.call(this,e),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:e=>this._secondsToUnits(parseFloat(e)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:e=>parseInt(e,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:e=>{const t=parseInt(e,10);return this._beatsToUnits(8/(Math.floor(t)*3))},regexp:/^(\d+)t$/i},tr:{method:(e,t,n)=>{let s=0;return e&&e!=="0"&&(s+=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&t!=="0"&&(s+=this._beatsToUnits(parseFloat(t))),n&&n!=="0"&&(s+=this._beatsToUnits(parseFloat(n)/4)),s},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof $s&&this.fromType(this._val),Ue(this._val))return this._noArg();if(ut(this._val)&&Ue(this._units)){for(const e in this._expressions)if(this._expressions[e].regexp.test(this._val.trim())){this._units=e;break}}else if(It(this._val)){let e=0;for(const t in this._val)if(G(this._val[t])){const n=this._val[t],s=new this.constructor(this.context,t).valueOf()*n;e+=s}return e}if(G(this._units)){const e=this._expressions[this._units],t=this._val.toString().trim().match(e.regexp);return t?e.method.apply(this,t.slice(1)):e.method.call(this,this._val)}else return ut(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(e){return 1/e}_beatsToUnits(e){return 60/this._getBpm()*e}_secondsToUnits(e){return e}_ticksToUnits(e){return e*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(e){switch(this._units=void 0,this.defaultUnits){case"s":this._val=e.toSeconds();break;case"i":this._val=e.toTicks();break;case"hz":this._val=e.toFrequency();break;case"midi":this._val=e.toMidi();break}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return this.toSeconds()*1e3}}class Ke extends $s{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:e=>this._now()+new this.constructor(this.context,e).valueOf(),regexp:/^\+(.+)/},quantize:{method:e=>{const t=new Ke(this.context,e).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(t))},regexp:/^@(.+)/}})}quantize(e,t=1){const n=new this.constructor(this.context,e).valueOf(),s=this.valueOf(),a=Math.round(s/n)*n-s;return s+a*t}toNotation(){const e=this.toSeconds(),t=["1m"];for(let r=1;r<9;r++){const o=Math.pow(2,r);t.push(o+"n."),t.push(o+"n"),t.push(o+"t")}t.push("0");let n=t[0],s=new Ke(this.context,t[0]).toSeconds();return t.forEach(r=>{const o=new Ke(this.context,r).toSeconds();Math.abs(o-e)<Math.abs(s-e)&&(n=r,s=o)}),n}toBarsBeatsSixteenths(){const e=this._beatsToUnits(1);let t=this.valueOf()/e;t=parseFloat(t.toFixed(4));const n=Math.floor(t/this._getTimeSignature());let s=t%1*4;t=Math.floor(t)%this._getTimeSignature();const r=s.toString();return r.length>3&&(s=parseFloat(parseFloat(r).toFixed(3))),[n,t,s].join(":")}toTicks(){const e=this._beatsToUnits(1);return this.valueOf()/e*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return Ws(this.toFrequency())}_now(){return this.context.now()}}class $e extends Ke{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return Bu()}static set A4(e){Uu(e)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(e){return this.defaultUnits==="midi"?e:$e.mtof(e)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(e,t){const s=Wu[e.toLowerCase()]+(parseInt(t,10)+1)*12;return this.defaultUnits==="midi"?s:$e.mtof(s)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(e,t,n){let s=1;return e&&e!=="0"&&(s*=this._beatsToUnits(this._getTimeSignature()*parseFloat(e))),t&&t!=="0"&&(s*=this._beatsToUnits(parseFloat(t))),n&&n!=="0"&&(s*=this._beatsToUnits(parseFloat(n)/4)),s}}})}transpose(e){return new $e(this.context,this.valueOf()*Lr(e))}harmonize(e){return e.map(t=>this.transpose(t))}toMidi(){return Ws(this.valueOf())}toNote(){const e=this.toFrequency(),t=Math.log2(e/$e.A4);let n=Math.round(12*t)+57;const s=Math.floor(n/12);return s<0&&(n+=-12*s),$u[n%12]+s.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const e=this._beatsToUnits(1),t=this.valueOf()/e;return Math.floor(t*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(e){return e}_ticksToUnits(e){return 1/(e*60/(this._getBpm()*this._getPPQ()))}_beatsToUnits(e){return 1/super._beatsToUnits(e)}_secondsToUnits(e){return 1/e}static mtof(e){return zu(e)}static ftom(e){return Ws(e)}}const Wu={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},$u=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];class Cn extends Ke{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}class Oe extends dt{constructor(){super();const e=z(Oe.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=e.context}static getDefaults(){return{context:We()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(e){return Cu(e),new Ke(this.context,e).toSeconds()}toFrequency(e){return new $e(this.context,e).toFrequency()}toTicks(e){return new Cn(this.context,e).toTicks()}_getPartialProperties(e){const t=this.get();return Object.keys(t).forEach(n=>{Ue(e[n])&&delete t[n]}),t}get(){const e=ku(this);return Object.keys(e).forEach(t=>{if(Reflect.has(this,t)){const n=this[t];G(n)&&G(n.value)&&G(n.setValueAtTime)?e[t]=n.value:n instanceof Oe?e[t]=n._getPartialProperties(e[t]):Ye(n)||Nt(n)||ut(n)||Su(n)?e[t]=n:delete e[t]}}),e}set(e){return Object.keys(e).forEach(t=>{Reflect.has(this,t)&&G(this[t])&&(this[t]&&G(this[t].value)&&G(this[t].setValueAtTime)?this[t].value!==e[t]&&(this[t].value=e[t]):this[t]instanceof Oe?this[t].set(e[t]):this[t]=e[t])}),this}}class js extends ze{constructor(e="stopped"){super(),this.name="StateTimeline",this._initial=e,this.setStateAtTime(this._initial,0)}getValueAtTime(e){const t=this.get(e);return t!==null?t.state:this._initial}setStateAtTime(e,t,n){return Tt(t,0),this.add(Object.assign({},n,{state:e,time:t})),this}getLastState(e,t){const n=this._search(t);for(let s=n;s>=0;s--){const r=this._timeline[s];if(r.state===e)return r}}getNextState(e,t){const n=this._search(t);if(n!==-1)for(let s=n;s<this._timeline.length;s++){const r=this._timeline[s];if(r.state===e)return r}}}class re extends Oe{constructor(){const e=z(re.getDefaults(),arguments,["param","units","convert"]);for(super(e),this.name="Param",this.overridden=!1,this._minOutput=1e-7,W(G(e.param)&&(kt(e.param)||e.param instanceof re),"param must be an AudioParam");!kt(e.param);)e.param=e.param._param;this._swappable=G(e.swappable)?e.swappable:!1,this._swappable?(this.input=this.context.createGain(),this._param=e.param,this.input.connect(this._param)):this._param=this.input=e.param,this._events=new ze(1e3),this._initialValue=this._param.defaultValue,this.units=e.units,this.convert=e.convert,this._minValue=e.minValue,this._maxValue=e.maxValue,G(e.value)&&e.value!==this._toType(this._initialValue)&&this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(Oe.getDefaults(),{convert:!0,units:"number"})}get value(){const e=this.now();return this.getValueAtTime(e)}set value(e){this.cancelScheduledValues(this.now()),this.setValueAtTime(e,this.now())}get minValue(){return G(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return G(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(e,t){return this.units===t}_assertRange(e){return G(this.maxValue)&&G(this.minValue)&&Tt(e,this._fromType(this.minValue),this._fromType(this.maxValue)),e}_fromType(e){return this.convert&&!this.overridden?this._is(e,"time")?this.toSeconds(e):this._is(e,"decibels")?Vu(e):this._is(e,"frequency")?this.toFrequency(e):e:this.overridden?0:e}_toType(e){return this.convert&&this.units==="decibels"?Lu(e):e}setValueAtTime(e,t){const n=this.toSeconds(t),s=this._fromType(e);return W(isFinite(s)&&isFinite(n),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(s),this.log(this.units,"setValueAtTime",e,n),this._events.add({time:n,type:"setValueAtTime",value:s}),this._param.setValueAtTime(s,n),this}getValueAtTime(e){const t=Math.max(this.toSeconds(e),0),n=this._events.getAfter(t),s=this._events.get(t);let r=this._initialValue;if(s===null)r=this._initialValue;else if(s.type==="setTargetAtTime"&&(n===null||n.type==="setValueAtTime")){const o=this._events.getBefore(s.time);let a;o===null?a=this._initialValue:a=o.value,s.type==="setTargetAtTime"&&(r=this._exponentialApproach(s.time,a,s.value,s.constant,t))}else if(n===null)r=s.value;else if(n.type==="linearRampToValueAtTime"||n.type==="exponentialRampToValueAtTime"){let o=s.value;if(s.type==="setTargetAtTime"){const a=this._events.getBefore(s.time);a===null?o=this._initialValue:o=a.value}n.type==="linearRampToValueAtTime"?r=this._linearInterpolate(s.time,o,n.time,n.value,t):r=this._exponentialInterpolate(s.time,o,n.time,n.value,t)}else r=s.value;return this._toType(r)}setRampPoint(e){e=this.toSeconds(e);let t=this.getValueAtTime(e);return this.cancelAndHoldAtTime(e),this._fromType(t)===0&&(t=this._toType(this._minOutput)),this.setValueAtTime(t,e),this}linearRampToValueAtTime(e,t){const n=this._fromType(e),s=this.toSeconds(t);return W(isFinite(n)&&isFinite(s),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._assertRange(n),this._events.add({time:s,type:"linearRampToValueAtTime",value:n}),this.log(this.units,"linearRampToValueAtTime",e,s),this._param.linearRampToValueAtTime(n,s),this}exponentialRampToValueAtTime(e,t){let n=this._fromType(e);n=Je(n,0)?this._minOutput:n,this._assertRange(n);const s=this.toSeconds(t);return W(isFinite(n)&&isFinite(s),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({time:s,type:"exponentialRampToValueAtTime",value:n}),this.log(this.units,"exponentialRampToValueAtTime",e,s),this._param.exponentialRampToValueAtTime(n,s),this}exponentialRampTo(e,t,n){return n=this.toSeconds(n),this.setRampPoint(n),this.exponentialRampToValueAtTime(e,n+this.toSeconds(t)),this}linearRampTo(e,t,n){return n=this.toSeconds(n),this.setRampPoint(n),this.linearRampToValueAtTime(e,n+this.toSeconds(t)),this}targetRampTo(e,t,n){return n=this.toSeconds(n),this.setRampPoint(n),this.exponentialApproachValueAtTime(e,n,t),this}exponentialApproachValueAtTime(e,t,n){t=this.toSeconds(t),n=this.toSeconds(n);const s=Math.log(n+1)/Math.log(200);return this.setTargetAtTime(e,t,s),this.cancelAndHoldAtTime(t+n*.9),this.linearRampToValueAtTime(e,t+n),this}setTargetAtTime(e,t,n){const s=this._fromType(e);W(isFinite(n)&&n>0,"timeConstant must be a number greater than 0");const r=this.toSeconds(t);return this._assertRange(s),W(isFinite(s)&&isFinite(r),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(e)}, ${JSON.stringify(t)}`),this._events.add({constant:n,time:r,type:"setTargetAtTime",value:s}),this.log(this.units,"setTargetAtTime",e,r,n),this._param.setTargetAtTime(s,r,n),this}setValueCurveAtTime(e,t,n,s=1){n=this.toSeconds(n),t=this.toSeconds(t);const r=this._fromType(e[0])*s;this.setValueAtTime(this._toType(r),t);const o=n/(e.length-1);for(let a=1;a<e.length;a++){const c=this._fromType(e[a])*s;this.linearRampToValueAtTime(this._toType(c),t+a*o)}return this}cancelScheduledValues(e){const t=this.toSeconds(e);return W(isFinite(t),`Invalid argument to cancelScheduledValues: ${JSON.stringify(e)}`),this._events.cancel(t),this._param.cancelScheduledValues(t),this.log(this.units,"cancelScheduledValues",t),this}cancelAndHoldAtTime(e){const t=this.toSeconds(e),n=this._fromType(this.getValueAtTime(t));W(isFinite(t),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(e)}`),this.log(this.units,"cancelAndHoldAtTime",t,"value="+n);const s=this._events.get(t),r=this._events.getAfter(t);return s&&Je(s.time,t)?r?(this._param.cancelScheduledValues(r.time),this._events.cancel(r.time)):(this._param.cancelAndHoldAtTime(t),this._events.cancel(t+this.sampleTime)):r&&(this._param.cancelScheduledValues(r.time),this._events.cancel(r.time),r.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(n),t):r.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(n),t)),this._events.add({time:t,type:"setValueAtTime",value:n}),this._param.setValueAtTime(n,t),this}rampTo(e,t=.1,n){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(e,t,n):this.linearRampTo(e,t,n),this}apply(e){const t=this.context.currentTime;e.setValueAtTime(this.getValueAtTime(t),t);const n=this._events.get(t);if(n&&n.type==="setTargetAtTime"){const s=this._events.getAfter(n.time),r=s?s.time:t+2,o=(r-t)/10;for(let a=t;a<r;a+=o)e.linearRampToValueAtTime(this.getValueAtTime(a),a)}return this._events.forEachAfter(this.context.currentTime,s=>{s.type==="cancelScheduledValues"?e.cancelScheduledValues(s.time):s.type==="setTargetAtTime"?e.setTargetAtTime(s.value,s.time,s.constant):e[s.type](s.value,s.time)}),this}setParam(e){W(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const t=this.input;return t.disconnect(this._param),this.apply(e),this._param=e,t.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(e,t,n,s,r){return n+(t-n)*Math.exp(-(r-e)/s)}_linearInterpolate(e,t,n,s,r){return t+(s-t)*((r-e)/(n-e))}_exponentialInterpolate(e,t,n,s,r){return t*Math.pow(s/t,(r-e)/(n-e))}}class j extends Oe{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return G(this.input)?kt(this.input)||this.input instanceof re?1:this.input.numberOfInputs:0}get numberOfOutputs(){return G(this.output)?this.output.numberOfOutputs:0}_isAudioNode(e){return G(e)&&(e instanceof j||wt(e))}_getInternalNodes(){const e=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&e.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&e.push(this.output),e}_setChannelProperties(e){this._getInternalNodes().forEach(n=>{n.channelCount=e.channelCount,n.channelCountMode=e.channelCountMode,n.channelInterpretation=e.channelInterpretation})}_getChannelProperties(){const e=this._getInternalNodes();W(e.length>0,"ToneAudioNode does not have any internal nodes");const t=e[0];return{channelCount:t.channelCount,channelCountMode:t.channelCountMode,channelInterpretation:t.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCount:e}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelCountMode:e}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(e){const t=this._getChannelProperties();this._setChannelProperties(Object.assign(t,{channelInterpretation:e}))}connect(e,t=0,n=0){return Qt(this,e,t,n),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return Ls("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(e,t=0,n=0){return ju(this,e,t,n),this}chain(...e){return Gs(this,...e),this}fan(...e){return e.forEach(t=>this.connect(t)),this}dispose(){return super.dispose(),G(this.input)&&(this.input instanceof j?this.input.dispose():wt(this.input)&&this.input.disconnect()),G(this.output)&&(this.output instanceof j?this.output.dispose():wt(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function Gs(...i){const e=i.shift();i.reduce((t,n)=>(t instanceof j?t.connect(n):wt(t)&&Qt(t,n),n),e)}function Qt(i,e,t=0,n=0){for(W(G(i),"Cannot connect from undefined node"),W(G(e),"Cannot connect to undefined node"),(e instanceof j||wt(e))&&W(e.numberOfInputs>0,"Cannot connect to node with no inputs"),W(i.numberOfOutputs>0,"Cannot connect from node with no outputs");e instanceof j||e instanceof re;)G(e.input)&&(e=e.input);for(;i instanceof j;)G(i.output)&&(i=i.output);kt(e)?i.connect(e,t):i.connect(e,t,n)}function ju(i,e,t=0,n=0){if(G(e))for(;e instanceof j;)e=e.input;for(;!wt(i);)G(i.output)&&(i=i.output);kt(e)?i.disconnect(e,t):wt(e)?i.disconnect(e,t,n):i.disconnect()}class we extends j{constructor(){const e=z(we.getDefaults(),arguments,["gain","units"]);super(e),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new re({context:this.context,convert:e.convert,param:this._gainNode.gain,units:e.units,value:e.gain,minValue:e.minValue,maxValue:e.maxValue}),ce(this,"gain")}static getDefaults(){return Object.assign(j.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class Xt extends j{constructor(e){super(e),this.onended=Z,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new we({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(t){const n=this.toSeconds(t);return this._startTime!==-1&&n>=this._startTime&&(this._stopTime===-1||n<=this._stopTime)?"started":"stopped"},this._fadeIn=e.fadeIn,this._fadeOut=e.fadeOut,this._curve=e.curve,this.onended=e.onended}static getDefaults(){return Object.assign(j.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:Z})}_startGain(e,t=1){W(this._startTime===-1,"Source cannot be started more than once");const n=this.toSeconds(this._fadeIn);return this._startTime=e+n,this._startTime=Math.max(this._startTime,this.context.currentTime),n>0?(this._gainNode.gain.setValueAtTime(0,e),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(t,e+n):this._gainNode.gain.exponentialApproachValueAtTime(t,e,n)):this._gainNode.gain.setValueAtTime(t,e),this}stop(e){return this.log("stop",e),this._stopGain(this.toSeconds(e)),this}_stopGain(e){W(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const t=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(e)+t,this._stopTime=Math.max(this._stopTime,this.now()),t>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,t,e):this._gainNode.gain.targetRampTo(0,t,e):(this._gainNode.gain.cancelAndHoldAtTime(e),this._gainNode.gain.setValueAtTime(0,e)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const n=this._curve==="exponential"?t*2:0;this._stopSource(this.now()+n),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==Z&&(this.onended(this),this.onended=Z,!this.context.isOffline)){const e=()=>this.dispose();typeof requestIdleCallback<"u"?requestIdleCallback(e):setTimeout(e,10)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),W(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=Z,this}}class Hs extends Xt{constructor(){const e=z(Hs.getDefaults(),arguments,["offset"]);super(e),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),Qt(this._source,this._gainNode),this.offset=new re({context:this.context,convert:e.convert,param:this._source.offset,units:e.units,value:e.offset,minValue:e.minValue,maxValue:e.maxValue})}static getDefaults(){return Object.assign(Xt.getDefaults(),{convert:!0,offset:1,units:"number"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._source.start(t),this}_stopSource(e){this._source.stop(e)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class ve extends j{constructor(){const e=z(ve.getDefaults(),arguments,["value","units"]);super(e),this.name="Signal",this.override=!0,this.output=this._constantSource=new Hs({context:this.context,convert:e.convert,offset:e.value,units:e.units,minValue:e.minValue,maxValue:e.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(j.getDefaults(),{convert:!0,units:"number",value:0})}connect(e,t=0,n=0){return Qs(this,e,t,n),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(e,t){return this._param.setValueAtTime(e,t),this}getValueAtTime(e){return this._param.getValueAtTime(e)}setRampPoint(e){return this._param.setRampPoint(e),this}linearRampToValueAtTime(e,t){return this._param.linearRampToValueAtTime(e,t),this}exponentialRampToValueAtTime(e,t){return this._param.exponentialRampToValueAtTime(e,t),this}exponentialRampTo(e,t,n){return this._param.exponentialRampTo(e,t,n),this}linearRampTo(e,t,n){return this._param.linearRampTo(e,t,n),this}targetRampTo(e,t,n){return this._param.targetRampTo(e,t,n),this}exponentialApproachValueAtTime(e,t,n){return this._param.exponentialApproachValueAtTime(e,t,n),this}setTargetAtTime(e,t,n){return this._param.setTargetAtTime(e,t,n),this}setValueCurveAtTime(e,t,n,s){return this._param.setValueCurveAtTime(e,t,n,s),this}cancelScheduledValues(e){return this._param.cancelScheduledValues(e),this}cancelAndHoldAtTime(e){return this._param.cancelAndHoldAtTime(e),this}rampTo(e,t,n){return this._param.rampTo(e,t,n),this}get value(){return this._param.value}set value(e){this._param.value=e}get convert(){return this._param.convert}set convert(e){this._param.convert=e}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(e){this._param.overridden=e}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(e){return this._param.apply(e),this}}function Qs(i,e,t,n){(e instanceof re||kt(e)||e instanceof ve&&e.override)&&(e.cancelScheduledValues(0),e.setValueAtTime(0,0),e instanceof ve&&(e.overridden=!0)),Qt(i,e,t,n)}class Xs extends re{constructor(){const e=z(Xs.getDefaults(),arguments,["value"]);super(e),this.name="TickParam",this._events=new ze(1/0),this._multiplier=1,this._multiplier=e.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(e.value)}),this.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(re.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(e,t,n){t=this.toSeconds(t),this.setRampPoint(t);const s=this._fromType(e),r=this._events.get(t),o=Math.round(Math.max(1/n,1));for(let a=0;a<=o;a++){const c=n*a+t,l=this._exponentialApproach(r.time,r.value,s,n,c);this.linearRampToValueAtTime(this._toType(l),c)}return this}setValueAtTime(e,t){const n=this.toSeconds(t);super.setValueAtTime(e,t);const s=this._events.get(n),r=this._events.previousEvent(s),o=this._getTicksUntilEvent(r,n);return s.ticks=Math.max(o,0),this}linearRampToValueAtTime(e,t){const n=this.toSeconds(t);super.linearRampToValueAtTime(e,t);const s=this._events.get(n),r=this._events.previousEvent(s),o=this._getTicksUntilEvent(r,n);return s.ticks=Math.max(o,0),this}exponentialRampToValueAtTime(e,t){t=this.toSeconds(t);const n=this._fromType(e),s=this._events.get(t),r=Math.round(Math.max((t-s.time)*10,1)),o=(t-s.time)/r;for(let a=0;a<=r;a++){const c=o*a+s.time,l=this._exponentialInterpolate(s.time,s.value,t,n,c);this.linearRampToValueAtTime(this._toType(l),c)}return this}_getTicksUntilEvent(e,t){if(e===null)e={ticks:0,time:0,type:"setValueAtTime",value:0};else if(Ue(e.ticks)){const o=this._events.previousEvent(e);e.ticks=this._getTicksUntilEvent(o,e.time)}const n=this._fromType(this.getValueAtTime(e.time));let s=this._fromType(this.getValueAtTime(t));const r=this._events.get(t);return r&&r.time===t&&r.type==="setValueAtTime"&&(s=this._fromType(this.getValueAtTime(t-this.sampleTime))),.5*(t-e.time)*(n+s)+e.ticks}getTicksAtTime(e){const t=this.toSeconds(e),n=this._events.get(t);return Math.max(this._getTicksUntilEvent(n,t),0)}getDurationOfTicks(e,t){const n=this.toSeconds(t),s=this.getTicksAtTime(t);return this.getTimeOfTick(s+e)-n}getTimeOfTick(e){const t=this._events.get(e,"ticks"),n=this._events.getAfter(e,"ticks");if(t&&t.ticks===e)return t.time;if(t&&n&&n.type==="linearRampToValueAtTime"&&t.value!==n.value){const s=this._fromType(this.getValueAtTime(t.time)),o=(this._fromType(this.getValueAtTime(n.time))-s)/(n.time-t.time),a=Math.sqrt(Math.pow(s,2)-2*o*(t.ticks-e)),c=(-s+a)/o,l=(-s-a)/o;return(c>0?c:l)+t.time}else return t?t.value===0?1/0:t.time+(e-t.ticks)/t.value:e/this._initialValue}ticksToTime(e,t){return this.getDurationOfTicks(e,t)}timeToTicks(e,t){const n=this.toSeconds(t),s=this.toSeconds(e),r=this.getTicksAtTime(n);return this.getTicksAtTime(n+s)-r}_fromType(e){return this.units==="bpm"&&this.multiplier?1/(60/e/this.multiplier):super._fromType(e)}_toType(e){return this.units==="bpm"&&this.multiplier?e/this.multiplier*60:super._toType(e)}get multiplier(){return this._multiplier}set multiplier(e){const t=this.value;this._multiplier=e,this.cancelScheduledValues(0),this.setValueAtTime(t,0)}}class Ys extends ve{constructor(){const e=z(Ys.getDefaults(),arguments,["value"]);super(e),this.name="TickSignal",this.input=this._param=new Xs({context:this.context,convert:e.convert,multiplier:e.multiplier,param:this._constantSource.offset,units:e.units,value:e.value})}static getDefaults(){return Object.assign(ve.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(e,t){return this._param.ticksToTime(e,t)}timeToTicks(e,t){return this._param.timeToTicks(e,t)}getTimeOfTick(e){return this._param.getTimeOfTick(e)}getDurationOfTicks(e,t){return this._param.getDurationOfTicks(e,t)}getTicksAtTime(e){return this._param.getTicksAtTime(e)}get multiplier(){return this._param.multiplier}set multiplier(e){this._param.multiplier=e}dispose(){return super.dispose(),this._param.dispose(),this}}class Zs extends Oe{constructor(){const e=z(Zs.getDefaults(),arguments,["frequency"]);super(e),this.name="TickSource",this._state=new js,this._tickOffset=new ze,this._ticksAtTime=new ze,this._secondsAtTime=new ze,this.frequency=new Ys({context:this.context,units:e.units,value:e.frequency}),ce(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},Oe.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(e,t){const n=this.toSeconds(e);return this._state.getValueAtTime(n)!=="started"&&(this._state.setStateAtTime("started",n),G(t)&&this.setTicksAtTime(t,n),this._ticksAtTime.cancel(n),this._secondsAtTime.cancel(n)),this}stop(e){const t=this.toSeconds(e);if(this._state.getValueAtTime(t)==="stopped"){const n=this._state.get(t);n&&n.time>0&&(this._tickOffset.cancel(n.time),this._state.cancel(n.time))}return this._state.cancel(t),this._state.setStateAtTime("stopped",t),this.setTicksAtTime(0,t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}pause(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)==="started"&&(this._state.setStateAtTime("paused",t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t)),this}cancel(e){return e=this.toSeconds(e),this._state.cancel(e),this._tickOffset.cancel(e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}getTicksAtTime(e){const t=this.toSeconds(e),n=this._state.getLastState("stopped",t),s=this._ticksAtTime.get(t),r={state:"paused",time:t};this._state.add(r);let o=s||n,a=s?s.ticks:0,c=null;return this._state.forEachBetween(o.time,t+this.sampleTime,l=>{let h=o.time;const u=this._tickOffset.get(l.time);u&&u.time>=o.time&&(a=u.ticks,h=u.time),o.state==="started"&&l.state!=="started"&&(a+=this.frequency.getTicksAtTime(l.time)-this.frequency.getTicksAtTime(h),l.time!==r.time&&(c={state:l.state,time:l.time,ticks:a})),o=l}),this._state.remove(r),c&&this._ticksAtTime.add(c),a}get ticks(){return this.getTicksAtTime(this.now())}set ticks(e){this.setTicksAtTime(e,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(e){const t=this.now(),n=this.frequency.timeToTicks(e,t);this.setTicksAtTime(n,t)}getSecondsAtTime(e){e=this.toSeconds(e);const t=this._state.getLastState("stopped",e),n={state:"paused",time:e};this._state.add(n);const s=this._secondsAtTime.get(e);let r=s||t,o=s?s.seconds:0,a=null;return this._state.forEachBetween(r.time,e+this.sampleTime,c=>{let l=r.time;const h=this._tickOffset.get(c.time);h&&h.time>=r.time&&(o=h.seconds,l=h.time),r.state==="started"&&c.state!=="started"&&(o+=c.time-l,c.time!==n.time&&(a={state:c.state,time:c.time,seconds:o})),r=c}),this._state.remove(n),a&&this._secondsAtTime.add(a),o}setTicksAtTime(e,t){return t=this.toSeconds(t),this._tickOffset.cancel(t),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(e,t),ticks:e,time:t}),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getStateAtTime(e){return e=this.toSeconds(e),this._state.getValueAtTime(e)}getTimeOfTick(e,t=this.now()){const n=this._tickOffset.get(t),s=this._state.get(t),r=Math.max(n.time,s.time),o=this.frequency.getTicksAtTime(r)+e-n.ticks;return this.frequency.getTimeOfTick(o)}forEachTickBetween(e,t,n){let s=this._state.get(e);this._state.forEachBetween(e,t,o=>{s&&s.state==="started"&&o.state!=="started"&&this.forEachTickBetween(Math.max(s.time,e),o.time-this.sampleTime,n),s=o});let r=null;if(s&&s.state==="started"){const o=Math.max(s.time,e),a=this.frequency.getTicksAtTime(o),c=this.frequency.getTicksAtTime(s.time),l=a-c;let h=Math.ceil(l)-l;h=Je(h,1)?0:h;let u=this.frequency.getTimeOfTick(a+h);for(;u<t;){try{n(u,Math.round(this.getTicksAtTime(u)))}catch(d){r=d;break}u+=this.frequency.getDurationOfTicks(1,u)}}if(r)throw r;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class Zn extends Oe{constructor(){const e=z(Zn.getDefaults(),arguments,["callback","frequency"]);super(e),this.name="Clock",this.callback=Z,this._lastUpdate=0,this._state=new js("stopped"),this._boundLoop=this._loop.bind(this),this.callback=e.callback,this._tickSource=new Zs({context:this.context,frequency:e.frequency,units:e.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,ce(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(Oe.getDefaults(),{callback:Z,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(e,t){xr(this.context);const n=this.toSeconds(e);return this.log("start",n),this._state.getValueAtTime(n)!=="started"&&(this._state.setStateAtTime("started",n),this._tickSource.start(n,t),n<this._lastUpdate&&this.emit("start",n,t)),this}stop(e){const t=this.toSeconds(e);return this.log("stop",t),this._state.cancel(t),this._state.setStateAtTime("stopped",t),this._tickSource.stop(t),t<this._lastUpdate&&this.emit("stop",t),this}pause(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)==="started"&&(this._state.setStateAtTime("paused",t),this._tickSource.pause(t),t<this._lastUpdate&&this.emit("pause",t)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(e){this._tickSource.ticks=e}get seconds(){return this._tickSource.seconds}set seconds(e){this._tickSource.seconds=e}getSecondsAtTime(e){return this._tickSource.getSecondsAtTime(e)}setTicksAtTime(e,t){return this._tickSource.setTicksAtTime(e,t),this}getTimeOfTick(e,t=this.now()){return this._tickSource.getTimeOfTick(e,t)}getTicksAtTime(e){return this._tickSource.getTicksAtTime(e)}nextTickTime(e,t){const n=this.toSeconds(t),s=this.getTicksAtTime(n);return this._tickSource.getTimeOfTick(s+e,n)}_loop(){const e=this._lastUpdate,t=this.now();this._lastUpdate=t,this.log("loop",e,t),e!==t&&(this._state.forEachBetween(e,t,n=>{switch(n.state){case"started":const s=this._tickSource.getTicksAtTime(n.time);this.emit("start",n.time,s);break;case"stopped":n.time!==0&&this.emit("stop",n.time);break;case"paused":this.emit("pause",n.time);break}}),this._tickSource.forEachTickBetween(e,t,(n,s)=>{this.callback(n,s)}))}getStateAtTime(e){const t=this.toSeconds(e);return this._state.getValueAtTime(t)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}vn.mixin(Zn);class Yt extends j{constructor(){const e=z(Yt.getDefaults(),arguments,["volume"]);super(e),this.name="Volume",this.input=this.output=new we({context:this.context,gain:e.volume,units:"decibels"}),this.volume=this.output.gain,ce(this,"volume"),this._unmutedVolume=e.volume,this.mute=e.mute}static getDefaults(){return Object.assign(j.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(e){!this.mute&&e?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!e&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class Js extends j{constructor(){const e=z(Js.getDefaults(),arguments);super(e),this.name="Destination",this.input=new Yt({context:this.context}),this.output=new we({context:this.context}),this.volume=this.input.volume,Gs(this.input,this.output,this.context.rawContext.destination),this.mute=e.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(j.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(e){this.input.mute=e}chain(...e){return this.input.disconnect(),e.unshift(this.input),e.push(this.output),Gs(...e),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}Qn(i=>{i.destination=new Js({context:i})}),Xn(i=>{i.destination.dispose()});class Gu extends j{constructor(){super(...arguments),this.name="Listener",this.positionX=new re({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new re({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new re({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new re({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new re({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new re({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new re({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new re({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new re({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(j.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}Qn(i=>{i.listener=new Gu({context:i})}),Xn(i=>{i.listener.dispose()});class Ks extends dt{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const e=z(Ks.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=e.baseUrl,Object.keys(e.urls).forEach(t=>{this._loadingCount++;const n=e.urls[t];this.add(t,n,this._bufferLoaded.bind(this,e.onload),e.onerror)})}static getDefaults(){return{baseUrl:"",onerror:Z,onload:Z,urls:{}}}has(e){return this._buffers.has(e.toString())}get(e){return W(this.has(e),`ToneAudioBuffers has no buffer named: ${e}`),this._buffers.get(e.toString())}_bufferLoaded(e){this._loadingCount--,this._loadingCount===0&&e&&e()}get loaded(){return Array.from(this._buffers).every(([e,t])=>t.loaded)}add(e,t,n=Z,s=Z){return ut(t)?(this.baseUrl&&t.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(e.toString(),new ne(this.baseUrl+t,n,s))):this._buffers.set(e.toString(),new ne(t,n,s)),this}dispose(){return super.dispose(),this._buffers.forEach(e=>e.dispose()),this._buffers.clear(),this}}class Zt extends Cn{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(e){return this._getPPQ()*e}_secondsToUnits(e){return Math.floor(e/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(e){return e}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}class Hu extends Oe{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new ze,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(e,t){return this._events.add({callback:e,time:this.toSeconds(t)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(e){return this._events.cancel(this.toSeconds(e)),this}_drawLoop(){const e=this.context.currentTime;this._events.forEachBefore(e+this.anticipation,t=>{e-t.time<=this.expiration&&t.callback(),this._events.remove(t)}),this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}Qn(i=>{i.draw=new Hu({context:i})}),Xn(i=>{i.draw.dispose()});class Qu extends dt{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(e){W(G(e.time),"Events must have a time property"),W(G(e.duration),"Events must have a duration parameter"),e.time=e.time.valueOf();let t=new Xu(e.time,e.time+e.duration,e);for(this._root===null?this._root=t:this._root.insert(t),this._length++;t!==null;)t.updateHeight(),t.updateMax(),this._rebalance(t),t=t.parent;return this}remove(e){if(this._root!==null){const t=[];this._root.search(e.time,t);for(const n of t)if(n.event===e){this._removeNode(n),this._length--;break}}return this}get length(){return this._length}cancel(e){return this.forEachFrom(e,t=>this.remove(t)),this}_setRoot(e){this._root=e,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(e,t){e.parent!==null?(e.isLeftChild()?e.parent.left=t:e.parent.right=t,this._rebalance(e.parent)):this._setRoot(t)}_removeNode(e){if(e.left===null&&e.right===null)this._replaceNodeInParent(e,null);else if(e.right===null)this._replaceNodeInParent(e,e.left);else if(e.left===null)this._replaceNodeInParent(e,e.right);else{const t=e.getBalance();let n,s=null;if(t>0)if(e.left.right===null)n=e.left,n.right=e.right,s=n;else{for(n=e.left.right;n.right!==null;)n=n.right;n.parent&&(n.parent.right=n.left,s=n.parent,n.left=e.left,n.right=e.right)}else if(e.right.left===null)n=e.right,n.left=e.left,s=n;else{for(n=e.right.left;n.left!==null;)n=n.left;n.parent&&(n.parent.left=n.right,s=n.parent,n.left=e.left,n.right=e.right)}e.parent!==null?e.isLeftChild()?e.parent.left=n:e.parent.right=n:this._setRoot(n),s&&this._rebalance(s)}e.dispose()}_rotateLeft(e){const t=e.parent,n=e.isLeftChild(),s=e.right;s&&(e.right=s.left,s.left=e),t!==null?n?t.left=s:t.right=s:this._setRoot(s)}_rotateRight(e){const t=e.parent,n=e.isLeftChild(),s=e.left;s&&(e.left=s.right,s.right=e),t!==null?n?t.left=s:t.right=s:this._setRoot(s)}_rebalance(e){const t=e.getBalance();t>1&&e.left?e.left.getBalance()<0?this._rotateLeft(e.left):this._rotateRight(e):t<-1&&e.right&&(e.right.getBalance()>0?this._rotateRight(e.right):this._rotateLeft(e))}get(e){if(this._root!==null){const t=[];if(this._root.search(e,t),t.length>0){let n=t[0];for(let s=1;s<t.length;s++)t[s].low>n.low&&(n=t[s]);return n.event}}return null}forEach(e){if(this._root!==null){const t=[];this._root.traverse(n=>t.push(n)),t.forEach(n=>{n.event&&e(n.event)})}return this}forEachAtTime(e,t){if(this._root!==null){const n=[];this._root.search(e,n),n.forEach(s=>{s.event&&t(s.event)})}return this}forEachFrom(e,t){if(this._root!==null){const n=[];this._root.searchAfter(e,n),n.forEach(s=>{s.event&&t(s.event)})}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse(e=>e.dispose()),this._root=null,this}}class Xu{constructor(e,t,n){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=n,this.low=e,this.high=t,this.max=this.high}insert(e){e.low<=this.low?this.left===null?this.left=e:this.left.insert(e):this.right===null?this.right=e:this.right.insert(e)}search(e,t){e>this.max||(this.left!==null&&this.left.search(e,t),this.low<=e&&this.high>e&&t.push(this),!(this.low>e)&&this.right!==null&&this.right.search(e,t))}searchAfter(e,t){this.low>=e&&(t.push(this),this.left!==null&&this.left.searchAfter(e,t)),this.right!==null&&this.right.searchAfter(e,t)}traverse(e){e(this),this.left!==null&&this.left.traverse(e),this.right!==null&&this.right.traverse(e)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let e=0;return this.left!==null&&this.right!==null?e=this.left.height-this.right.height:this.left!==null?e=this.left.height+1:this.right!==null&&(e=-(this.right.height+1)),e}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(e){this._left=e,e!==null&&(e.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(e){this._right=e,e!==null&&(e.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class Yu extends dt{constructor(e){super(),this.name="TimelineValue",this._timeline=new ze({memory:10}),this._initialValue=e}set(e,t){return this._timeline.add({value:e,time:t}),this}get(e){const t=this._timeline.get(e);return t?t.value:this._initialValue}}class Jt extends j{constructor(){super(z(Jt.getDefaults(),arguments,["context"]))}connect(e,t=0,n=0){return Qs(this,e,t,n),this}}class Tn extends Jt{constructor(){const e=z(Tn.getDefaults(),arguments,["mapping","length"]);super(e),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,Ye(e.mapping)||e.mapping instanceof Float32Array?this.curve=Float32Array.from(e.mapping):vu(e.mapping)&&this.setMap(e.mapping,e.length)}static getDefaults(){return Object.assign(ve.getDefaults(),{length:1024})}setMap(e,t=1024){const n=new Float32Array(t);for(let s=0,r=t;s<r;s++){const o=s/(r-1)*2-1;n[s]=e(o,s)}return this.curve=n,this}get curve(){return this._shaper.curve}set curve(e){this._shaper.curve=e}get oversample(){return this._shaper.oversample}set oversample(e){const t=["none","2x","4x"].some(n=>n.includes(e));W(t,"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=e}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class ei extends Jt{constructor(){const e=z(ei.getDefaults(),arguments,["value"]);super(e),this.name="Pow",this._exponentScaler=this.input=this.output=new Tn({context:this.context,mapping:this._expFunc(e.value),length:8192}),this._exponent=e.value}static getDefaults(){return Object.assign(Jt.getDefaults(),{value:1})}_expFunc(e){return t=>Math.pow(Math.abs(t),e)}get value(){return this._exponent}set value(e){this._exponent=e,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class bt{constructor(e,t){this.id=bt._eventId++,this._remainderTime=0;const n=Object.assign(bt.getDefaults(),t);this.transport=e,this.callback=n.callback,this._once=n.once,this.time=Math.floor(n.time),this._remainderTime=n.time-this.time}static getDefaults(){return{callback:Z,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(e){if(this.callback){const t=this.transport.bpm.getDurationOfTicks(1,e);this.callback(e+this._remainderTime*t),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}bt._eventId=0;class ti extends bt{constructor(e,t){super(e,t),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const n=Object.assign(ti.getDefaults(),t);this.duration=n.duration,this._interval=n.interval,this._nextTick=n.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},bt.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(e){this._createEvents(e),super.invoke(e)}_createEvent(){return Hn(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new Zt(this.context,this._nextTick).toSeconds()):-1}_createEvents(e){Hn(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new Zt(this.context,this._nextTick).toSeconds()))}_restart(e){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const t=this.transport.getTicksAtTime(e);Ht(t,this.time)&&(this._nextTick=this.floatTime+Math.ceil((t-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class Jn extends Oe{constructor(){const e=z(Jn.getDefaults(),arguments);super(e),this.name="Transport",this._loop=new Yu(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new ze,this._repeatedEvents=new Qu,this._syncedSignals=[],this._swingAmount=0,this._ppq=e.ppq,this._clock=new Zn({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=e.ppq,this.bpm.setValueAtTime(e.bpm,0),ce(this,"bpm"),this._timeSignature=e.timeSignature,this._swingTicks=e.ppq/2}static getDefaults(){return Object.assign(Oe.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(e,t){if(this._loop.get(e)&&t>=this._loopEnd&&(this.emit("loopEnd",e),this._clock.setTicksAtTime(this._loopStart,e),t=this._loopStart,this.emit("loopStart",e,this._clock.getSecondsAtTime(e)),this.emit("loop",e)),this._swingAmount>0&&t%this._ppq!==0&&t%(this._swingTicks*2)!==0){const n=t%(this._swingTicks*2)/(this._swingTicks*2),s=Math.sin(n*Math.PI)*this._swingAmount;e+=new Zt(this.context,this._swingTicks*2/3).toSeconds()*s}kr(!0),this._timeline.forEachAtTime(t,n=>n.invoke(e)),kr(!1)}schedule(e,t){const n=new bt(this,{callback:e,time:new Cn(this.context,t).toTicks()});return this._addEvent(n,this._timeline)}scheduleRepeat(e,t,n,s=1/0){const r=new ti(this,{callback:e,duration:new Ke(this.context,s).toTicks(),interval:new Ke(this.context,t).toTicks(),time:new Cn(this.context,n).toTicks()});return this._addEvent(r,this._repeatedEvents)}scheduleOnce(e,t){const n=new bt(this,{callback:e,once:!0,time:new Cn(this.context,t).toTicks()});return this._addEvent(n,this._timeline)}clear(e){if(this._scheduledEvents.hasOwnProperty(e)){const t=this._scheduledEvents[e.toString()];t.timeline.remove(t.event),t.event.dispose(),delete this._scheduledEvents[e.toString()]}return this}_addEvent(e,t){return this._scheduledEvents[e.id.toString()]={event:e,timeline:t},t.add(e),e.id}cancel(e=0){const t=this.toTicks(e);return this._timeline.forEachFrom(t,n=>this.clear(n.id)),this._repeatedEvents.forEachFrom(t,n=>this.clear(n.id)),this}_bindClockEvents(){this._clock.on("start",(e,t)=>{t=new Zt(this.context,t).toSeconds(),this.emit("start",e,t)}),this._clock.on("stop",e=>{this.emit("stop",e)}),this._clock.on("pause",e=>{this.emit("pause",e)})}get state(){return this._clock.getStateAtTime(this.now())}start(e,t){this.context.resume();let n;return G(t)&&(n=this.toTicks(t)),this._clock.start(e,n),this}stop(e){return this._clock.stop(e),this}pause(e){return this._clock.pause(e),this}toggle(e){return e=this.toSeconds(e),this._clock.getStateAtTime(e)!=="started"?this.start(e):this.stop(e),this}get timeSignature(){return this._timeSignature}set timeSignature(e){Ye(e)&&(e=e[0]/e[1]*4),this._timeSignature=e}get loopStart(){return new Ke(this.context,this._loopStart,"i").toSeconds()}set loopStart(e){this._loopStart=this.toTicks(e)}get loopEnd(){return new Ke(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(e){this._loopEnd=this.toTicks(e)}get loop(){return this._loop.get(this.now())}set loop(e){this._loop.set(e,this.now())}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get swing(){return this._swingAmount}set swing(e){this._swingAmount=e}get swingSubdivision(){return new Zt(this.context,this._swingTicks).toNotation()}set swingSubdivision(e){this._swingTicks=this.toTicks(e)}get position(){const e=this.now(),t=this._clock.getTicksAtTime(e);return new Zt(this.context,t).toBarsBeatsSixteenths()}set position(e){const t=this.toTicks(e);this.ticks=t}get seconds(){return this._clock.seconds}set seconds(e){const t=this.now(),n=this._clock.frequency.timeToTicks(e,t);this.ticks=n}get progress(){if(this.loop){const e=this.now();return(this._clock.getTicksAtTime(e)-this._loopStart)/(this._loopEnd-this._loopStart)}else return 0}get ticks(){return this._clock.ticks}set ticks(e){if(this._clock.ticks!==e){const t=this.now();if(this.state==="started"){const n=this._clock.getTicksAtTime(t),s=this._clock.frequency.getDurationOfTicks(Math.ceil(n)-n,t),r=t+s;this.emit("stop",r),this._clock.setTicksAtTime(e,r),this.emit("start",r,this._clock.getSecondsAtTime(r))}else this.emit("ticks",t),this._clock.setTicksAtTime(e,t)}}getTicksAtTime(e){return this._clock.getTicksAtTime(e)}getSecondsAtTime(e){return this._clock.getSecondsAtTime(e)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(e){this._clock.frequency.multiplier=e}nextSubdivision(e){if(e=this.toTicks(e),this.state!=="started")return 0;{const t=this.now(),n=this.getTicksAtTime(t),s=e-n%e;return this._clock.nextTickTime(s,t)}}syncSignal(e,t){const n=this.now();let s=this.bpm,r=1/(60/s.getValueAtTime(n)/this.PPQ),o=[];if(e.units==="time"){const c=.015625/r,l=new we(c),h=new ei(-1),u=new we(c);s.chain(l,h,u),s=u,r=1/r,o=[l,h,u]}t||(e.getValueAtTime(n)!==0?t=e.getValueAtTime(n)/r:t=0);const a=new we(t);return s.connect(a),a.connect(e._param),o.push(a),this._syncedSignals.push({initial:e.value,nodes:o,signal:e}),e.value=0,this}unsyncSignal(e){for(let t=this._syncedSignals.length-1;t>=0;t--){const n=this._syncedSignals[t];n.signal===e&&(n.nodes.forEach(s=>s.dispose()),n.signal.value=n.initial,this._syncedSignals.splice(t,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),qr(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}vn.mixin(Jn),Qn(i=>{i.transport=new Jn({context:i})}),Xn(i=>{i.transport.dispose()});class Ve extends j{constructor(e){super(e),this.input=void 0,this._state=new js("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=Z,this._syncedStop=Z,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new Yt({context:this.context,mute:e.mute,volume:e.volume}),this.volume=this._volume.volume,ce(this,"volume"),this.onstop=e.onstop}static getDefaults(){return Object.assign(j.getDefaults(),{mute:!1,onstop:Z,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}_clampToCurrentTime(e){return this._synced?e:Math.max(e,this.context.currentTime)}start(e,t,n){let s=Ue(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(s=this._clampToCurrentTime(s),!this._synced&&this._state.getValueAtTime(s)==="started")W(Ht(s,this._state.get(s).time),"Start time must be strictly greater than previous start time"),this._state.cancel(s),this._state.setStateAtTime("started",s),this.log("restart",s),this.restart(s,t,n);else if(this.log("start",s),this._state.setStateAtTime("started",s),this._synced){const r=this._state.get(s);r&&(r.offset=this.toSeconds(Gt(t,0)),r.duration=n?this.toSeconds(n):void 0);const o=this.context.transport.schedule(a=>{this._start(a,t,n)},s);this._scheduled.push(o),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>s&&this._syncedStart(this.now(),this.context.transport.seconds)}else xr(this.context),this._start(s,t,n);return this}stop(e){let t=Ue(e)&&this._synced?this.context.transport.seconds:this.toSeconds(e);if(t=this._clampToCurrentTime(t),this._state.getValueAtTime(t)==="started"||G(this._state.getNextState("started",t))){if(this.log("stop",t),!this._synced)this._stop(t);else{const n=this.context.transport.schedule(this._stop.bind(this),t);this._scheduled.push(n)}this._state.cancel(t),this._state.setStateAtTime("stopped",t)}return this}restart(e,t,n){return e=this.toSeconds(e),this._state.getValueAtTime(e)==="started"&&(this._state.cancel(e),this._restart(e,t,n)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(e,t)=>{if(Ht(t,0)){const n=this._state.get(t);if(n&&n.state==="started"&&n.time!==t){const s=t-this.toSeconds(n.time);let r;n.duration&&(r=this.toSeconds(n.duration)-s),this._start(e,this.toSeconds(n.offset)+s,r)}}},this._syncedStop=e=>{const t=this.context.transport.getSecondsAtTime(Math.max(e-this.sampleTime,0));this._state.getValueAtTime(t)==="started"&&this._stop(e)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(e=>this.context.transport.clear(e)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=Z,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class Kn extends Xt{constructor(){const e=z(Kn.getDefaults(),arguments,["url","onload"]);super(e),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,Qt(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new re({context:this.context,param:this._source.playbackRate,units:"positive",value:e.playbackRate}),this.loop=e.loop,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this._buffer=new ne(e.url,e.onload,e.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(Xt.getDefaults(),{url:new ne,loop:!1,loopEnd:0,loopStart:0,onload:Z,onerror:Z,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(e){this._fadeIn=e}get fadeOut(){return this._fadeOut}set fadeOut(e){this._fadeOut=e}get curve(){return this._curve}set curve(e){this._curve=e}start(e,t,n,s=1){W(this.buffer.loaded,"buffer is either not set or not loaded");const r=this.toSeconds(e);this._startGain(r,s),this.loop?t=Gt(t,this.loopStart):t=Gt(t,0);let o=Math.max(this.toSeconds(t),0);if(this.loop){const a=this.toSeconds(this.loopEnd)||this.buffer.duration,c=this.toSeconds(this.loopStart),l=a-c;Us(o,a)&&(o=(o-c)%l+c),Je(o,this.buffer.duration)&&(o=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,Hn(o,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(r,o)),G(n)){let a=this.toSeconds(n);a=Math.max(a,0),this.stop(r+a)}return this}_stopSource(e){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(e)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(e){this._source.loopStart=this.toSeconds(e)}get loopEnd(){return this._source.loopEnd}set loopEnd(e){this._source.loopEnd=this.toSeconds(e)}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._source.loop}set loop(e){this._source.loop=e,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}function Ft(i,e){return de(this,void 0,void 0,function*(){const t=e/i.context.sampleRate,n=new zs(1,t,i.context.sampleRate);return new i.constructor(Object.assign(i.get(),{frequency:2/t,detune:0,context:n})).toDestination().start(0),(yield n.render()).getChannelData(0)})}class ni extends Xt{constructor(){const e=z(ni.getDefaults(),arguments,["frequency","type"]);super(e),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],Qt(this._oscillator,this._gainNode),this.type=e.type,this.frequency=new re({context:this.context,param:this._oscillator.frequency,units:"frequency",value:e.frequency}),this.detune=new re({context:this.context,param:this._oscillator.detune,units:"cents",value:e.detune}),ce(this,["frequency","detune"])}static getDefaults(){return Object.assign(Xt.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(e){const t=this.toSeconds(e);return this.log("start",t),this._startGain(t),this._oscillator.start(t),this}_stopSource(e){this._oscillator.stop(e)}setPeriodicWave(e){return this._oscillator.setPeriodicWave(e),this}get type(){return this._oscillator.type}set type(e){this._oscillator.type=e}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class fe extends Ve{constructor(){const e=z(fe.getDefaults(),arguments,["frequency","type"]);super(e),this.name="Oscillator",this._oscillator=null,this.frequency=new ve({context:this.context,units:"frequency",value:e.frequency}),ce(this,"frequency"),this.detune=new ve({context:this.context,units:"cents",value:e.detune}),ce(this,"detune"),this._partials=e.partials,this._partialCount=e.partialCount,this._type=e.type,e.partialCount&&e.type!=="custom"&&(this._type=this.baseType+e.partialCount.toString()),this.phase=e.phase}static getDefaults(){return Object.assign(Ve.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(e){const t=this.toSeconds(e),n=new ni({context:this.context,onended:()=>this.onstop(this)});this._oscillator=n,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(t)}_stop(e){const t=this.toSeconds(e);this._oscillator&&this._oscillator.stop(t)}_restart(e){const t=this.toSeconds(e);return this.log("restart",t),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(t),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return fe._periodicWaveCache.find(t=>t.phase===this._phase&&Iu(t.partials,this._partials));{const e=fe._periodicWaveCache.find(t=>t.type===this._type&&t.phase===this._phase);return this._partialCount=e?e.partialCount:this._partialCount,e}}get type(){return this._type}set type(e){this._type=e;const t=["sine","square","sawtooth","triangle"].indexOf(e)!==-1;if(this._phase===0&&t)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=e);else{const n=this._getCachedPeriodicWave();if(G(n)){const{partials:s,wave:r}=n;this._wave=r,this._partials=s,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[s,r]=this._getRealImaginary(e,this._phase),o=this.context.createPeriodicWave(s,r);this._wave=o,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),fe._periodicWaveCache.push({imag:r,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:s,type:this._type,wave:this._wave}),fe._periodicWaveCache.length>100&&fe._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(e){this.partialCount&&this._type!=="custom"&&e!=="custom"?this.type=e+this.partialCount:this.type=e}get partialCount(){return this._partialCount}set partialCount(e){Tt(e,0);let t=this._type;const n=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(n&&(t=n[1]),this._type!=="custom")e===0?this.type=t:this.type=t+e.toString();else{const s=new Float32Array(e);this._partials.forEach((r,o)=>s[o]=r),this._partials=Array.from(s),this.type=this._type}}_getRealImaginary(e,t){let s=2048;const r=new Float32Array(s),o=new Float32Array(s);let a=1;if(e==="custom"){if(a=this._partials.length+1,this._partialCount=this._partials.length,s=a,this._partials.length===0)return[r,o]}else{const c=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(e);c?(a=parseInt(c[2],10)+1,this._partialCount=parseInt(c[2],10),e=c[1],a=Math.max(a,2),s=a):this._partialCount=0,this._partials=[]}for(let c=1;c<s;++c){const l=2/(c*Math.PI);let h;switch(e){case"sine":h=c<=a?1:0,this._partials[c-1]=h;break;case"square":h=c&1?2*l:0,this._partials[c-1]=h;break;case"sawtooth":h=l*(c&1?1:-1),this._partials[c-1]=h;break;case"triangle":c&1?h=2*(l*l)*(c-1>>1&1?-1:1):h=0,this._partials[c-1]=h;break;case"custom":h=this._partials[c-1];break;default:throw new TypeError("Oscillator: invalid type: "+e)}h!==0?(r[c]=-h*Math.sin(t*c),o[c]=h*Math.cos(t*c)):(r[c]=0,o[c]=0)}return[r,o]}_inverseFFT(e,t,n){let s=0;const r=e.length;for(let o=0;o<r;o++)s+=e[o]*Math.cos(o*n)+t[o]*Math.sin(o*n);return s}getInitialValue(){const[e,t]=this._getRealImaginary(this._type,0);let n=0;const s=Math.PI*2,r=32;for(let o=0;o<r;o++)n=Math.max(this._inverseFFT(e,t,o/r*s),n);return Du(-this._inverseFFT(e,t,this._phase)/n,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(e){this._phase=e*Math.PI/180,this.type=this._type}asArray(){return de(this,arguments,void 0,function*(e=1024){return Ft(this,e)})}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}fe._periodicWaveCache=[];class Zu extends Jt{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new Tn({context:this.context,mapping:e=>(e+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class Kt extends ve{constructor(){const e=z(Kt.getDefaults(),arguments,["value"]);super(e),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new we({context:this.context,minValue:e.minValue,maxValue:e.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(e.value,0)}static getDefaults(){return Object.assign(ve.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class es extends Ve{constructor(){const e=z(es.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="AMOscillator",this._modulationScale=new Zu({context:this.context}),this._modulationNode=new we({context:this.context}),this._carrier=new fe({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new fe({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new Kt({context:this.context,units:"positive",value:e.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),ce(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(fe.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){this._modulator.restart(e),this._carrier.restart(e)}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return de(this,arguments,void 0,function*(e=1024){return Ft(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class ts extends Ve{constructor(){const e=z(ts.getDefaults(),arguments,["frequency","type","modulationType"]);super(e),this.name="FMOscillator",this._modulationNode=new we({context:this.context,gain:0}),this._carrier=new fe({context:this.context,detune:e.detune,frequency:0,onstop:()=>this.onstop(this),phase:e.phase,type:e.type}),this.detune=this._carrier.detune,this.frequency=new ve({context:this.context,units:"frequency",value:e.frequency}),this._modulator=new fe({context:this.context,phase:e.phase,type:e.modulationType}),this.harmonicity=new Kt({context:this.context,units:"positive",value:e.harmonicity}),this.modulationIndex=new Kt({context:this.context,units:"positive",value:e.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),ce(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(fe.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(e){this._modulator.start(e),this._carrier.start(e)}_stop(e){this._modulator.stop(e),this._carrier.stop(e)}_restart(e){return this._modulator.restart(e),this._carrier.restart(e),this}get type(){return this._carrier.type}set type(e){this._carrier.type=e}get baseType(){return this._carrier.baseType}set baseType(e){this._carrier.baseType=e}get partialCount(){return this._carrier.partialCount}set partialCount(e){this._carrier.partialCount=e}get modulationType(){return this._modulator.type}set modulationType(e){this._modulator.type=e}get phase(){return this._carrier.phase}set phase(e){this._carrier.phase=e,this._modulator.phase=e}get partials(){return this._carrier.partials}set partials(e){this._carrier.partials=e}asArray(){return de(this,arguments,void 0,function*(e=1024){return Ft(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class wn extends Ve{constructor(){const e=z(wn.getDefaults(),arguments,["frequency","width"]);super(e),this.name="PulseOscillator",this._widthGate=new we({context:this.context,gain:0}),this._thresh=new Tn({context:this.context,mapping:t=>t<=0?-1:1}),this.width=new ve({context:this.context,units:"audioRange",value:e.width}),this._triangle=new fe({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),ce(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(Ve.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(e){e=this.toSeconds(e),this._triangle.start(e),this._widthGate.gain.setValueAtTime(1,e)}_stop(e){e=this.toSeconds(e),this._triangle.stop(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(0,e)}_restart(e){this._triangle.restart(e),this._widthGate.gain.cancelScheduledValues(e),this._widthGate.gain.setValueAtTime(1,e)}get phase(){return this._triangle.phase}set phase(e){this._triangle.phase=e}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(e){this._triangle.type=e}asArray(){return de(this,arguments,void 0,function*(e=1024){return Ft(this,e)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class ns extends Ve{constructor(){const e=z(ns.getDefaults(),arguments,["frequency","type","spread"]);super(e),this.name="FatOscillator",this._oscillators=[],this.frequency=new ve({context:this.context,units:"frequency",value:e.frequency}),this.detune=new ve({context:this.context,units:"cents",value:e.detune}),this._spread=e.spread,this._type=e.type,this._phase=e.phase,this._partials=e.partials,this._partialCount=e.partialCount,this.count=e.count,ce(this,["frequency","detune"])}static getDefaults(){return Object.assign(fe.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(e){e=this.toSeconds(e),this._forEach(t=>t.start(e))}_stop(e){e=this.toSeconds(e),this._forEach(t=>t.stop(e))}_restart(e){this._forEach(t=>t.restart(e))}_forEach(e){for(let t=0;t<this._oscillators.length;t++)e(this._oscillators[t],t)}get type(){return this._type}set type(e){this._type=e,this._forEach(t=>t.type=e)}get spread(){return this._spread}set spread(e){if(this._spread=e,this._oscillators.length>1){const t=-e/2,n=e/(this._oscillators.length-1);this._forEach((s,r)=>s.detune.value=t+n*r)}}get count(){return this._oscillators.length}set count(e){if(Tt(e,1),this._oscillators.length!==e){this._forEach(t=>t.dispose()),this._oscillators=[];for(let t=0;t<e;t++){const n=new fe({context:this.context,volume:-6-e*1.1,type:this._type,phase:this._phase+t/e*360,partialCount:this._partialCount,onstop:t===0?()=>this.onstop(this):Z});this.type==="custom"&&(n.partials=this._partials),this.frequency.connect(n.frequency),this.detune.connect(n.detune),n.detune.overridden=!1,n.connect(this.output),this._oscillators[t]=n}this.spread=this._spread,this.state==="started"&&this._forEach(t=>t.start())}}get phase(){return this._phase}set phase(e){this._phase=e,this._forEach((t,n)=>t.phase=this._phase+n/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(e){this._forEach(t=>t.baseType=e),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(e){this._partials=e,this._partialCount=this._partials.length,e.length&&(this._type="custom",this._forEach(t=>t.partials=e))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(e){this._partialCount=e,this._forEach(t=>t.partialCount=e),this._type=this._oscillators[0].type}asArray(){return de(this,arguments,void 0,function*(e=1024){return Ft(this,e)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(e=>e.dispose()),this}}class ss extends Ve{constructor(){const e=z(ss.getDefaults(),arguments,["frequency","modulationFrequency"]);super(e),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new Kt({context:this.context,value:2}),this._pulse=new wn({context:this.context,frequency:e.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new fe({context:this.context,detune:e.detune,frequency:e.frequency,onstop:()=>this.onstop(this),phase:e.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),ce(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(Ve.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(e){e=this.toSeconds(e),this._modulator.start(e),this._pulse.start(e)}_stop(e){e=this.toSeconds(e),this._modulator.stop(e),this._pulse.stop(e)}_restart(e){this._modulator.restart(e),this._pulse.restart(e)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(e){this._modulator.phase=e}asArray(){return de(this,arguments,void 0,function*(e=1024){return Ft(this,e)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const Ur={am:es,fat:ns,fm:ts,oscillator:fe,pulse:wn,pwm:ss};class is extends Ve{constructor(){const e=z(is.getDefaults(),arguments,["frequency","type"]);super(e),this.name="OmniOscillator",this.frequency=new ve({context:this.context,units:"frequency",value:e.frequency}),this.detune=new ve({context:this.context,units:"cents",value:e.detune}),ce(this,["frequency","detune"]),this.set(e)}static getDefaults(){return Object.assign(fe.getDefaults(),ts.getDefaults(),es.getDefaults(),ns.getDefaults(),wn.getDefaults(),ss.getDefaults())}_start(e){this._oscillator.start(e)}_stop(e){this._oscillator.stop(e)}_restart(e){return this._oscillator.restart(e),this}get type(){let e="";return["am","fm","fat"].some(t=>this._sourceType===t)&&(e=this._sourceType),e+this._oscillator.type}set type(e){e.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):e.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(2)):e.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=e.substr(3)):e==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):e==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=e)}get partials(){return this._oscillator.partials}set partials(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partials=e)}get partialCount(){return this._oscillator.partialCount}set partialCount(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&(this._oscillator.partialCount=e)}set(e){return Reflect.has(e,"type")&&e.type&&(this.type=e.type),super.set(e),this}_createNewOscillator(e){if(e!==this._sourceType){this._sourceType=e;const t=Ur[e],n=this.now();if(this._oscillator){const s=this._oscillator;s.stop(n),this.context.setTimeout(()=>s.dispose(),this.blockTime)}this._oscillator=new t({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(n)}}get phase(){return this._oscillator.phase}set phase(e){this._oscillator.phase=e}get sourceType(){return this._sourceType}set sourceType(e){let t="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(t=this._oscillator.type),e==="fm"?this.type="fm"+t:e==="am"?this.type="am"+t:e==="fat"?this.type="fat"+t:e==="oscillator"?this.type=t:e==="pulse"?this.type="pulse":e==="pwm"&&(this.type="pwm")}_getOscType(e,t){return e instanceof Ur[t]}get baseType(){return this._oscillator.baseType}set baseType(e){!this._getOscType(this._oscillator,"pulse")&&!this._getOscType(this._oscillator,"pwm")&&e!=="pulse"&&e!=="pwm"&&(this._oscillator.baseType=e)}get width(){if(this._getOscType(this._oscillator,"pulse"))return this._oscillator.width}get count(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.count}set count(e){this._getOscType(this._oscillator,"fat")&&Nt(e)&&(this._oscillator.count=e)}get spread(){if(this._getOscType(this._oscillator,"fat"))return this._oscillator.spread}set spread(e){this._getOscType(this._oscillator,"fat")&&Nt(e)&&(this._oscillator.spread=e)}get modulationType(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.modulationType}set modulationType(e){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&ut(e)&&(this._oscillator.modulationType=e)}get modulationIndex(){if(this._getOscType(this._oscillator,"fm"))return this._oscillator.modulationIndex}get harmonicity(){if(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))return this._oscillator.harmonicity}get modulationFrequency(){if(this._getOscType(this._oscillator,"pwm"))return this._oscillator.modulationFrequency}asArray(){return de(this,arguments,void 0,function*(e=1024){return Ft(this,e)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}function zr(i,e=1/0){const t=new WeakMap;return function(n,s){Reflect.defineProperty(n,s,{configurable:!0,enumerable:!0,get:function(){return t.get(this)},set:function(r){Tt(r,i,e),t.set(this,r)}})}}function ft(i,e=1/0){const t=new WeakMap;return function(n,s){Reflect.defineProperty(n,s,{configurable:!0,enumerable:!0,get:function(){return t.get(this)},set:function(r){Tt(this.toSeconds(r),i,e),t.set(this,r)}})}}class rs extends Ve{constructor(){const e=z(rs.getDefaults(),arguments,["url","onload"]);super(e),this.name="Player",this._activeSources=new Set,this._buffer=new ne({onload:this._onload.bind(this,e.onload),onerror:e.onerror,reverse:e.reverse,url:e.url}),this.autostart=e.autostart,this._loop=e.loop,this._loopStart=e.loopStart,this._loopEnd=e.loopEnd,this._playbackRate=e.playbackRate,this.fadeIn=e.fadeIn,this.fadeOut=e.fadeOut}static getDefaults(){return Object.assign(Ve.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:Z,onerror:Z,playbackRate:1,reverse:!1})}load(e){return de(this,void 0,void 0,function*(){return yield this._buffer.load(e),this._onload(),this})}_onload(e=Z){e(),this.autostart&&this.start()}_onSourceEnd(e){this.onstop(this),this._activeSources.delete(e),this._activeSources.size===0&&!this._synced&&this._state.getValueAtTime(this.now())==="started"&&(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(e,t,n){return super.start(e,t,n),this}_start(e,t,n){this._loop?t=Gt(t,this._loopStart):t=Gt(t,0);const s=this.toSeconds(t),r=n;n=Gt(n,Math.max(this._buffer.duration-s,0));let o=this.toSeconds(n);o=o/this._playbackRate,e=this.toSeconds(e);const a=new Kn({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);!this._loop&&!this._synced&&(this._state.cancel(e+o),this._state.setStateAtTime("stopped",e+o,{implicitEnd:!0})),this._activeSources.add(a),this._loop&&Ue(r)?a.start(e,s):a.start(e,s,o-this.toSeconds(this.fadeOut))}_stop(e){const t=this.toSeconds(e);this._activeSources.forEach(n=>n.stop(t))}restart(e,t,n){return super.restart(e,t,n),this}_restart(e,t,n){var s;(s=[...this._activeSources].pop())===null||s===void 0||s.stop(e),this._start(e,t,n)}seek(e,t){const n=this.toSeconds(t);if(this._state.getValueAtTime(n)==="started"){const s=this.toSeconds(e);this._stop(n),this._start(n,s)}return this}setLoopPoints(e,t){return this.loopStart=e,this.loopEnd=t,this}get loopStart(){return this._loopStart}set loopStart(e){this._loopStart=e,this.buffer.loaded&&Tt(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopStart=e})}get loopEnd(){return this._loopEnd}set loopEnd(e){this._loopEnd=e,this.buffer.loaded&&Tt(this.toSeconds(e),0,this.buffer.duration),this._activeSources.forEach(t=>{t.loopEnd=e})}get buffer(){return this._buffer}set buffer(e){this._buffer.set(e)}get loop(){return this._loop}set loop(e){if(this._loop!==e&&(this._loop=e,this._activeSources.forEach(t=>{t.loop=e}),e)){const t=this._state.getNextState("stopped",this.now());t&&this._state.cancel(t.time)}}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e;const t=this.now(),n=this._state.getNextState("stopped",t);n&&n.implicitEnd&&(this._state.cancel(n.time),this._activeSources.forEach(s=>s.cancelStop())),this._activeSources.forEach(s=>{s.playbackRate.setValueAtTime(e,t)})}get reverse(){return this._buffer.reverse}set reverse(e){this._buffer.reverse=e}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(e=>e.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}Ze([ft(0)],rs.prototype,"fadeIn",void 0),Ze([ft(0)],rs.prototype,"fadeOut",void 0);class At extends j{constructor(){const e=z(At.getDefaults(),arguments,["attack","decay","sustain","release"]);super(e),this.name="Envelope",this._sig=new ve({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=e.attack,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.attackCurve=e.attackCurve,this.releaseCurve=e.releaseCurve,this.decayCurve=e.decayCurve}static getDefaults(){return Object.assign(j.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(e,t){if(ut(e))return e;{let n;for(n in os)if(os[n][t]===e)return n;return e}}_setCurve(e,t,n){if(ut(n)&&Reflect.has(os,n)){const s=os[n];It(s)?e!=="_decayCurve"&&(this[e]=s[t]):this[e]=s}else if(Ye(n)&&e!=="_decayCurve")this[e]=n;else throw new Error("Envelope: invalid curve: "+n)}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(e){this._setCurve("_attackCurve","In",e)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(e){this._setCurve("_releaseCurve","Out",e)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(e){this._setCurve("_decayCurve","Out",e)}triggerAttack(e,t=1){this.log("triggerAttack",e,t),e=this.toSeconds(e);let s=this.toSeconds(this.attack);const r=this.toSeconds(this.decay),o=this.getValueAtTime(e);if(o>0){const a=1/s;s=(1-o)/a}if(s<this.sampleTime)this._sig.cancelScheduledValues(e),this._sig.setValueAtTime(t,e);else if(this._attackCurve==="linear")this._sig.linearRampTo(t,s,e);else if(this._attackCurve==="exponential")this._sig.targetRampTo(t,s,e);else{this._sig.cancelAndHoldAtTime(e);let a=this._attackCurve;for(let c=1;c<a.length;c++)if(a[c-1]<=o&&o<=a[c]){a=this._attackCurve.slice(c),a[0]=o;break}this._sig.setValueCurveAtTime(a,e,s,t)}if(r&&this.sustain<1){const a=t*this.sustain,c=e+s;this.log("decay",c),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(a,r+c):this._sig.exponentialApproachValueAtTime(a,c,r)}return this}triggerRelease(e){this.log("triggerRelease",e),e=this.toSeconds(e);const t=this.getValueAtTime(e);if(t>0){const n=this.toSeconds(this.release);n<this.sampleTime?this._sig.setValueAtTime(0,e):this._releaseCurve==="linear"?this._sig.linearRampTo(0,n,e):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,n,e):(W(Ye(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(e),this._sig.setValueCurveAtTime(this._releaseCurve,e,n,t))}return this}getValueAtTime(e){return this._sig.getValueAtTime(e)}triggerAttackRelease(e,t,n=1){return t=this.toSeconds(t),this.triggerAttack(t,n),this.triggerRelease(t+this.toSeconds(e)),this}cancel(e){return this._sig.cancelScheduledValues(this.toSeconds(e)),this}connect(e,t=0,n=0){return Qs(this,e,t,n),this}asArray(){return de(this,arguments,void 0,function*(e=1024){const t=e/this.context.sampleRate,n=new zs(1,t,this.context.sampleRate),s=this.toSeconds(this.attack)+this.toSeconds(this.decay),r=s+this.toSeconds(this.release),o=r*.1,a=r+o,c=new this.constructor(Object.assign(this.get(),{attack:t*this.toSeconds(this.attack)/a,decay:t*this.toSeconds(this.decay)/a,release:t*this.toSeconds(this.release)/a,context:n}));return c._sig.toDestination(),c.triggerAttackRelease(t*(s+o)/a,0),(yield n.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}Ze([ft(0)],At.prototype,"attack",void 0),Ze([ft(0)],At.prototype,"decay",void 0),Ze([zr(0,1)],At.prototype,"sustain",void 0),Ze([ft(0)],At.prototype,"release",void 0);const os=(()=>{let e,t;const n=[];for(e=0;e<128;e++)n[e]=Math.sin(e/127*(Math.PI/2));const s=[],r=6.4;for(e=0;e<127;e++){t=e/127;const d=Math.sin(t*(Math.PI*2)*r-Math.PI/2)+1;s[e]=d/10+t*.83}s[127]=1;const o=[],a=5;for(e=0;e<128;e++)o[e]=Math.ceil(e/127*a)/a;const c=[];for(e=0;e<128;e++)t=e/127,c[e]=.5*(1-Math.cos(Math.PI*t));const l=[];for(e=0;e<128;e++){t=e/127;const d=Math.pow(t,3)*4+.2,f=Math.cos(d*Math.PI*2*t);l[e]=Math.abs(f*(1-t))}function h(d){const f=new Array(d.length);for(let p=0;p<d.length;p++)f[p]=1-d[p];return f}function u(d){return d.slice(0).reverse()}return{bounce:{In:h(l),Out:l},cosine:{In:n,Out:u(n)},exponential:"exponential",linear:"linear",ripple:{In:s,Out:h(s)},sine:{In:c,Out:h(c)},step:{In:o,Out:h(o)}}})();class en extends j{constructor(){const e=z(en.getDefaults(),arguments);super(e),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=t=>this._original_triggerRelease(t),this._volume=this.output=new Yt({context:this.context,volume:e.volume}),this.volume=this._volume.volume,ce(this,"volume")}static getDefaults(){return Object.assign(j.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let e=!1;return this._synced||(this._synced=!0,e=!0),e}_syncMethod(e,t){const n=this["_original_"+e]=this[e];this[e]=(...s)=>{const r=s[t],o=this.context.transport.schedule(a=>{s[t]=a,n.apply(this,s)},r);this._scheduledEvents.push(o)}}unsync(){return this._scheduledEvents.forEach(e=>this.context.transport.clear(e)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(e,t,n,s){const r=this.toSeconds(n),o=this.toSeconds(t);return this.triggerAttack(e,r,s),this.triggerRelease(r+o),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class tn extends en{constructor(){const e=z(tn.getDefaults(),arguments);super(e),this.portamento=e.portamento,this.onsilence=e.onsilence}static getDefaults(){return Object.assign(en.getDefaults(),{detune:0,onsilence:Z,portamento:0})}triggerAttack(e,t,n=1){this.log("triggerAttack",e,t,n);const s=this.toSeconds(t);return this._triggerEnvelopeAttack(s,n),this.setNote(e,s),this}triggerRelease(e){this.log("triggerRelease",e);const t=this.toSeconds(e);return this._triggerEnvelopeRelease(t),this}setNote(e,t){const n=this.toSeconds(t),s=e instanceof $e?e.toFrequency():e;if(this.portamento>0&&this.getLevelAtTime(n)>.05){const r=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(s,r,n)}else this.frequency.setValueAtTime(s,n);return this}}Ze([ft(0)],tn.prototype,"portamento",void 0);class si extends At{constructor(){super(z(si.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new we({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class as extends tn{constructor(){const e=z(as.getDefaults(),arguments);super(e),this.name="Synth",this.oscillator=new is(Object.assign({context:this.context,detune:e.detune,onstop:()=>this.onsilence(this)},e.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new si(Object.assign({context:this.context},e.envelope)),this.oscillator.chain(this.envelope,this.output),ce(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(tn.getDefaults(),{envelope:Object.assign(Fr(At.getDefaults(),Object.keys(j.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign(Fr(is.getDefaults(),[...Object.keys(Ve.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(e,t){if(this.envelope.triggerAttack(e,t),this.oscillator.start(e),this.envelope.sustain===0){const n=this.toSeconds(this.envelope.attack),s=this.toSeconds(this.envelope.decay);this.oscillator.stop(e+n+s)}}_triggerEnvelopeRelease(e){this.envelope.triggerRelease(e),this.oscillator.stop(e+this.toSeconds(this.envelope.release))}getLevelAtTime(e){return e=this.toSeconds(e),this.envelope.getValueAtTime(e)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class cs extends as{constructor(){const e=z(cs.getDefaults(),arguments);super(e),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=e.pitchDecay,this.octaves=e.octaves,ce(this,["oscillator","envelope"])}static getDefaults(){return jt(tn.getDefaults(),as.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(e,t){const n=this.toSeconds(t),s=this.toFrequency(e instanceof $e?e.toFrequency():e),r=s*this.octaves;return this.oscillator.frequency.setValueAtTime(r,n),this.oscillator.frequency.exponentialRampToValueAtTime(s,n+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}Ze([zr(0)],cs.prototype,"octaves",void 0),Ze([ft(0)],cs.prototype,"pitchDecay",void 0);const Wr=new Set;function ii(i){Wr.add(i)}function $r(i,e){const t=`registerProcessor("${i}", ${e})`;Wr.add(t)}ii(`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`),ii(`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`),ii(`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`),$r("feedback-comb-filter",`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`);class bn extends en{constructor(){const e=z(bn.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(e),this.name="Sampler",this._activeSources=new Map;const t={};Object.keys(e.urls).forEach(n=>{const s=parseInt(n,10);if(W(jn(n)||Nt(s)&&isFinite(s),`url key is neither a note or midi pitch: ${n}`),jn(n)){const r=new $e(this.context,n).toMidi();t[r]=e.urls[n]}else Nt(s)&&isFinite(s)&&(t[s]=e.urls[s])}),this._buffers=new Ks({urls:t,onload:e.onload,baseUrl:e.baseUrl,onerror:e.onerror}),this.attack=e.attack,this.release=e.release,this.curve=e.curve,this._buffers.loaded&&Promise.resolve().then(e.onload)}static getDefaults(){return Object.assign(en.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:Z,onerror:Z,release:.1,urls:{}})}_findClosest(e){let n=0;for(;n<96;){if(this._buffers.has(e+n))return-n;if(this._buffers.has(e-n))return n;n++}throw new Error(`No available buffers for note: ${e}`)}triggerAttack(e,t,n=1){return this.log("triggerAttack",e,t,n),Array.isArray(e)||(e=[e]),e.forEach(s=>{const r=Br(new $e(this.context,s).toFrequency()),o=Math.round(r),a=r-o,c=this._findClosest(o),l=o-c,h=this._buffers.get(l),u=Lr(c+a),d=new Kn({url:h,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:u}).connect(this.output);d.start(t,0,h.duration/u,n),Ye(this._activeSources.get(o))||this._activeSources.set(o,[]),this._activeSources.get(o).push(d),d.onended=()=>{if(this._activeSources&&this._activeSources.has(o)){const f=this._activeSources.get(o),p=f.indexOf(d);p!==-1&&f.splice(p,1)}}}),this}triggerRelease(e,t){return this.log("triggerRelease",e,t),Array.isArray(e)||(e=[e]),e.forEach(n=>{const s=new $e(this.context,n).toMidi();if(this._activeSources.has(s)&&this._activeSources.get(s).length){const r=this._activeSources.get(s);t=this.toSeconds(t),r.forEach(o=>{o.stop(t)}),this._activeSources.set(s,[])}}),this}releaseAll(e){const t=this.toSeconds(e);return this._activeSources.forEach(n=>{for(;n.length;)n.shift().stop(t)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(e,t,n,s=1){const r=this.toSeconds(n);return this.triggerAttack(e,r,s),Ye(t)?(W(Ye(e),"notes must be an array when duration is array"),e.forEach((o,a)=>{const c=t[Math.min(a,t.length-1)];this.triggerRelease(o,r+this.toSeconds(c))})):this.triggerRelease(e,r+this.toSeconds(t)),this}add(e,t,n){if(W(jn(e)||isFinite(e),`note must be a pitch or midi: ${e}`),jn(e)){const s=new $e(this.context,e).toMidi();this._buffers.add(s,t,n)}else this._buffers.add(e,t,n);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(e=>{e.forEach(t=>t.dispose())}),this._activeSources.clear(),this}}Ze([ft(0)],bn.prototype,"attack",void 0),Ze([ft(0)],bn.prototype,"release",void 0);class ri extends j{constructor(){const e=z(ri.getDefaults(),arguments,["pan"]);super(e),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new re({context:this.context,param:this._panner.pan,value:e.pan,minValue:-1,maxValue:1}),this._panner.channelCount=e.channelCount,this._panner.channelCountMode="explicit",ce(this,"pan")}static getDefaults(){return Object.assign(j.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}$r("bit-crusher",`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`);class pe extends j{constructor(){const e=z(pe.getDefaults(),arguments,["solo"]);super(e),this.name="Solo",this.input=this.output=new we({context:this.context}),pe._allSolos.has(this.context)||pe._allSolos.set(this.context,new Set),pe._allSolos.get(this.context).add(this),this.solo=e.solo}static getDefaults(){return Object.assign(j.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(e){e?this._addSolo():this._removeSolo(),pe._allSolos.get(this.context).forEach(t=>t._updateSolo())}get muted(){return this.input.gain.value===0}_addSolo(){pe._soloed.has(this.context)||pe._soloed.set(this.context,new Set),pe._soloed.get(this.context).add(this)}_removeSolo(){pe._soloed.has(this.context)&&pe._soloed.get(this.context).delete(this)}_isSoloed(){return pe._soloed.has(this.context)&&pe._soloed.get(this.context).has(this)}_noSolos(){return!pe._soloed.has(this.context)||pe._soloed.has(this.context)&&pe._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()?this.input.gain.value=1:this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),pe._allSolos.get(this.context).delete(this),this._removeSolo(),this}}pe._allSolos=new Map,pe._soloed=new Map;class oi extends j{constructor(){const e=z(oi.getDefaults(),arguments,["pan","volume"]);super(e),this.name="PanVol",this._panner=this.input=new ri({context:this.context,pan:e.pan,channelCount:e.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new Yt({context:this.context,volume:e.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=e.mute,ce(this,["pan","volume"])}static getDefaults(){return Object.assign(j.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(e){this._volume.mute=e}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class nn extends j{constructor(){const e=z(nn.getDefaults(),arguments,["volume","pan"]);super(e),this.name="Channel",this._solo=this.input=new pe({solo:e.solo,context:this.context}),this._panVol=this.output=new oi({context:this.context,pan:e.pan,volume:e.volume,mute:e.mute,channelCount:e.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),ce(this,["pan","volume"])}static getDefaults(){return Object.assign(j.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(e){this._solo.solo=e}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(e){this._panVol.mute=e}_getBus(e){return nn.buses.has(e)||nn.buses.set(e,new we({context:this.context})),nn.buses.get(e)}send(e,t=0){const n=this._getBus(e),s=new we({context:this.context,units:"decibels",gain:t});return this.connect(s),s.connect(n),s}receive(e){return this._getBus(e).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}nn.buses=new Map,We().transport,We().destination,We().destination,We().listener,We().draw,We();function Ju(){return ne.loaded()}const it=class it{constructor(e={}){this.sampler=null,this.isInitialized=!1,this.isPlaying=!1,this.config={baseUrl:e.baseUrl||"/audio/piano/",release:e.release??1.5,volume:e.volume??-6,noteRange:e.noteRange||it.AVAILABLE_NOTES.map(t=>t.note)}}async initialize(){if(this.isInitialized){console.warn("⚠️ [PitchShifter] Already initialized");return}try{console.log("🎹 [PitchShifter] Initializing..."),We().state!=="running"&&(await qu(),console.log("🔊 [PitchShifter] AudioContext started")),this.sampler=new bn({urls:{C4:"C4.mp3"},baseUrl:this.config.baseUrl,release:this.config.release}).toDestination(),this.sampler.volume.value=this.config.volume,console.log("📥 [PitchShifter] Loading audio sample..."),await Ju(),this.isInitialized=!0,console.log("✅ [PitchShifter] Initialization complete")}catch(e){throw console.error("❌ [PitchShifter] Initialization failed:",e),new Error(`PitchShifter initialization failed: ${e}`)}}async playNote(e,t=2,n=.8){if(!this.isInitialized||!this.sampler)throw new Error("PitchShifter not initialized. Call initialize() first.");if(this.isPlaying){console.warn("⚠️ [PitchShifter] Already playing, skipping");return}try{this.isPlaying=!0;const s=it.AVAILABLE_NOTES.find(r=>r.note===e);if(!s)throw new Error(`Invalid note: ${e}`);console.log(`🎵 [PitchShifter] Playing ${e} (${s.frequency.toFixed(2)}Hz) for ${t}s`),this.sampler.triggerAttack(e,void 0,n),setTimeout(()=>{this.sampler&&(this.sampler.triggerRelease(e),console.log(`🔇 [PitchShifter] Released ${e}`)),this.isPlaying=!1},t*1e3)}catch(s){throw this.isPlaying=!1,console.error("❌ [PitchShifter] Play note failed:",s),s}}async playRandomNote(e=2){const t=it.AVAILABLE_NOTES[Math.floor(Math.random()*it.AVAILABLE_NOTES.length)];return console.log(`🎲 [PitchShifter] Random note selected: ${t.note} (${t.japaneseName})`),await this.playNote(t.note,e),t}stopNote(e){if(!this.sampler){console.warn("⚠️ [PitchShifter] Not initialized");return}this.sampler.triggerRelease(e),this.isPlaying=!1,console.log(`🛑 [PitchShifter] Stopped ${e}`)}stopAll(){if(!this.sampler){console.warn("⚠️ [PitchShifter] Not initialized");return}this.sampler.releaseAll(),this.isPlaying=!1,console.log("🛑 [PitchShifter] Stopped all notes")}setVolume(e){if(!this.sampler){console.warn("⚠️ [PitchShifter] Not initialized");return}this.sampler.volume.value=e,console.log(`🔊 [PitchShifter] Volume set to ${e}dB`)}static getNoteInfo(e){return it.AVAILABLE_NOTES.find(t=>t.note===e)}static getNoteByFrequency(e){let t=it.AVAILABLE_NOTES[0],n=Math.abs(e-t.frequency);for(const s of it.AVAILABLE_NOTES){const r=Math.abs(e-s.frequency);r<n&&(n=r,t=s)}return t}isCurrentlyPlaying(){return this.isPlaying}dispose(){this.sampler&&(this.sampler.dispose(),this.sampler=null),this.isInitialized=!1,this.isPlaying=!1,console.log("🗑️ [PitchShifter] Disposed")}};it.AVAILABLE_NOTES=[{note:"C4",frequency:261.63,japaneseName:"ド（低）"},{note:"C#4",frequency:277.18,japaneseName:"ド♯（低）"},{note:"D4",frequency:293.66,japaneseName:"レ（低）"},{note:"D#4",frequency:311.13,japaneseName:"レ♯（低）"},{note:"E4",frequency:329.63,japaneseName:"ミ（低）"},{note:"F4",frequency:349.23,japaneseName:"ファ（低）"},{note:"F#4",frequency:369.99,japaneseName:"ファ♯（低）"},{note:"G4",frequency:392,japaneseName:"ソ（低）"},{note:"G#4",frequency:415.3,japaneseName:"ソ♯（低）"},{note:"A4",frequency:440,japaneseName:"ラ（中）"},{note:"A#4",frequency:466.16,japaneseName:"ラ♯（中）"},{note:"B4",frequency:493.88,japaneseName:"シ（中）"},{note:"C5",frequency:523.25,japaneseName:"ド（高）"},{note:"D5",frequency:587.33,japaneseName:"レ（高）"},{note:"E5",frequency:659.25,japaneseName:"ミ（高）"}];let ai=it;const xe=class xe{static generateScale(e,t="major"){const n=xe.SCALE_PATTERNS[t];if(!n)throw new Error(`Unknown scale type: ${t}`);return n.map(s=>{const r=e*Math.pow(2,s/12);return be.frequencyToNote(r)})}static generateChord(e,t="major"){const n=xe.CHORD_PATTERNS[t];if(!n)throw new Error(`Unknown chord type: ${t}`);return n.map(s=>{const r=e*Math.pow(2,s/12);return be.frequencyToNote(r)})}static identifyScale(e){if(e.length<3)return[];const t=e.sort((o,a)=>o-a),n=t[0],s=t.map(o=>Math.round(12*Math.log2(o/n))),r=[];return Object.entries(xe.SCALE_PATTERNS).forEach(([o,a])=>{for(let c=0;c<12;c++){const l=a.map(f=>(f+c)%12).sort((f,p)=>f-p),h=s.map(f=>f%12).sort((f,p)=>f-p);let u=0;h.forEach(f=>{l.includes(f)&&u++});const d=u/Math.max(h.length,l.length);if(d>.5){const f=n*Math.pow(2,-c/12);r.push({scale:o,confidence:d,root:be.frequencyToNote(f)})}}}),r.sort((o,a)=>a.confidence-o.confidence).slice(0,5)}static identifyChord(e){if(e.length<2)return[];const t=e.sort((s,r)=>s-r),n=[];return Object.entries(xe.CHORD_PATTERNS).forEach(([s,r])=>{for(let o=0;o<r.length;o++){const a=[...r.slice(o),...r.slice(0,o).map(c=>c+12)];t.forEach((c,l)=>{const h=t.map(p=>Math.round(12*Math.log2(p/c)));let u=0;const d=new Set(a);h.forEach(p=>{const m=p%12;(d.has(m)||d.has(m+12))&&u++});const f=u/Math.max(h.length,r.length);if(f>.6){const p=o===0?c:c*Math.pow(2,-r[o]/12);n.push({chord:s,confidence:f,root:be.frequencyToNote(p),inversion:o>0?o:void 0})}})}}),n.sort((s,r)=>r.confidence-s.confidence).slice(0,3)}static getKeySignature(e,t="major"){const n=["F","C","G","D","A","E","B"],s=["B","E","A","D","G","C","F"],r={C:{sharps:0,flats:0},G:{sharps:1,flats:0},D:{sharps:2,flats:0},A:{sharps:3,flats:0},E:{sharps:4,flats:0},B:{sharps:5,flats:0},"F#":{sharps:6,flats:0},"C#":{sharps:7,flats:0},F:{sharps:0,flats:1},Bb:{sharps:0,flats:2},Eb:{sharps:0,flats:3},Ab:{sharps:0,flats:4},Db:{sharps:0,flats:5},Gb:{sharps:0,flats:6},Cb:{sharps:0,flats:7}};let o=r[e];if(!o&&t==="minor"){const h={A:"C",E:"G",B:"D","F#":"A","C#":"E","G#":"B","D#":"F#","A#":"C#",D:"F",G:"Bb",C:"Eb",F:"Ab",Bb:"Db",Eb:"Gb",Ab:"Cb"}[e];h&&(o=r[h])}if(!o)return{sharps:[],flats:[],accidentalCount:0};const a=n.slice(0,o.sharps).map(l=>l+"#"),c=s.slice(0,o.flats).map(l=>l+"b");return{sharps:a,flats:c,accidentalCount:o.sharps||o.flats}}static getHarmonicSeries(e,t=16){const n=[];for(let s=1;s<=t;s++){const r=e*s;n.push(be.frequencyToNote(r))}return n}static getJustIntonationRatios(){return{unison:{ratio:1/1,cents:0},minorSecond:{ratio:16/15,cents:112},majorSecond:{ratio:9/8,cents:204},minorThird:{ratio:6/5,cents:316},majorThird:{ratio:5/4,cents:386},perfectFourth:{ratio:4/3,cents:498},tritone:{ratio:45/32,cents:590},perfectFifth:{ratio:3/2,cents:702},minorSixth:{ratio:8/5,cents:814},majorSixth:{ratio:5/3,cents:884},minorSeventh:{ratio:16/9,cents:996},majorSeventh:{ratio:15/8,cents:1088},octave:{ratio:2/1,cents:1200}}}static equalTemperamentToJustIntonation(e){const t=e*100,n=xe.getJustIntonationRatios();let s,r=1/0;return Object.entries(n).forEach(([a,{cents:c}])=>{const l=Math.abs(t-c);l<r&&(r=l,s=a)}),{ratio:Math.pow(2,e/12),cents:t,closestJustInterval:s,centsDeviation:s?r:void 0}}static analyzeMelody(e){if(e.length<2)return[];const t=[];for(let n=1;n<e.length;n++){const s=e[n-1],r=e[n],o=be.frequencyToNote(s),a=be.frequencyToNote(r),c=be.getSignedInterval(s,r),l=be.getIntervalInfo(Math.abs(c)),h=c>0?"up":c<0?"down":"same";t.push({fromNote:o,toNote:a,interval:l,direction:h})}return t}static generateChordProgression(e,t="major",n=[1,4,5,1]){const s=be.scientificPitchToFrequency(e+"4");if(s===0)throw new Error(`Invalid key: ${e}`);const r=xe.generateScale(s,t==="minor"?"naturalMinor":"major"),o=[];return n.forEach(a=>{const c=r[(a-1)%r.length],l=t==="major"?xe.getMajorScaleChordType(a):xe.getMinorScaleChordType(a),h=xe.generateChord(c.frequency,l);o.push(h)}),o}static getMajorScaleChordType(e){return["major","minor","minor","major","major","minor","diminished"][(e-1)%7]}static getMinorScaleChordType(e){return["minor","diminished","major","minor","minor","major","major"][(e-1)%7]}};xe.SCALE_PATTERNS={major:[0,2,4,5,7,9,11],naturalMinor:[0,2,3,5,7,8,10],harmonicMinor:[0,2,3,5,7,8,11],melodicMinor:[0,2,3,5,7,9,11],dorian:[0,2,3,5,7,9,10],phrygian:[0,1,3,5,7,8,10],lydian:[0,2,4,6,7,9,11],mixolydian:[0,2,4,5,7,9,10],locrian:[0,1,3,5,6,8,10],pentatonicMajor:[0,2,4,7,9],pentatonicMinor:[0,3,5,7,10],blues:[0,3,5,6,7,10],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11]},xe.CHORD_PATTERNS={major:[0,4,7],minor:[0,3,7],diminished:[0,3,6],augmented:[0,4,8],sus2:[0,2,7],sus4:[0,5,7],major7:[0,4,7,11],minor7:[0,3,7,10],dominant7:[0,4,7,10],majorMaj7:[0,4,7,11],halfDiminished7:[0,3,6,10],diminished7:[0,3,6,9],add9:[0,4,7,14],major9:[0,4,7,11,14],minor9:[0,3,7,10,14]},xe.CIRCLE_OF_FIFTHS=["C","G","D","A","E","B","F#","C#","Ab","Eb","Bb","F"],xe.INTERVAL_NAMES={0:"Perfect Unison",1:"Minor Second",2:"Major Second",3:"Minor Third",4:"Major Third",5:"Perfect Fourth",6:"Tritone",7:"Perfect Fifth",8:"Minor Sixth",9:"Major Sixth",10:"Minor Seventh",11:"Major Seventh",12:"Perfect Octave"};let ci=xe;const Ku=new Date().toISOString(),ed={pitchDetector:{fftSize:4096,smoothing:.1,clarityThreshold:.4,minVolumeAbsolute:.02},audioManager:{sampleRate:44100,channelCount:1,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1},noiseFilter:{highpassFreq:50,lowpassFreq:800,notchFreq:50,highpassQ:.7,lowpassQ:.7,notchQ:10}};$.AudioDetectionComponent=us,$.AudioManager=mi,$.BUILD_DATE=Ku,$.BUILD_TIMESTAMP=Xr,$.CalibrationSystem=uo,$.DEFAULT_CONFIG=ed,$.DeviceDetection=mt,$.ErrorNotificationSystem=yi,$.FrequencyUtils=be,$.HarmonicCorrection=lo,$.LogLevel=on,$.Logger=Rt,$.MicrophoneController=vi,$.MicrophoneHealthError=di,$.MicrophoneLifecycleManager=_i,$.MusicTheory=ci,$.NoiseFilter=io,$.PitchDetector=gi,$.PitchShifter=ai,$.VERSION=Ne,$.VERSION_STRING=ot,$.VoiceAnalyzer=ho,$.debug=ro,$.defaultLogger=an,$.error=co,$.info=oo,$.warn=ao,Object.defineProperty($,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=pitchpro.umd.js.map
