<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ PitchPro ãƒ‡ãƒãƒƒã‚°ãƒ»åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ</title>

    <!-- å¼·åŠ›ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #ffffff;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #2d2d30;
            padding: 20px;
            border-radius: 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #007ACC;
            border-radius: 8px;
        }

        .step-section {
            background: #252526;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #007ACC;
        }

        .step-section.success {
            border-left-color: #4CAF50;
            background: #1e3a1e;
        }

        .step-section.error {
            border-left-color: #F44336;
            background: #3a1e1e;
        }

        .step-section.warning {
            border-left-color: #FF9800;
            background: #3a2e1e;
        }

        .log-container {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
            margin: 10px 0;
        }

        .log-entry {
            margin: 3px 0;
            padding: 3px 8px;
            border-radius: 3px;
        }

        .log-success { background: rgba(76,175,80,0.2); color: #4CAF50; }
        .log-error { background: rgba(244,67,54,0.2); color: #F44336; }
        .log-warning { background: rgba(255,152,0,0.2); color: #FF9800; }
        .log-info { background: rgba(33,150,243,0.2); color: #2196F3; }
        .log-debug { background: rgba(156,39,176,0.2); color: #9C27B0; }

        button {
            background: #007ACC;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        button:hover {
            background: #005a9e;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .value-display {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            font-family: monospace;
        }

        .highlight {
            background: #FFD700;
            color: #000;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ PitchPro ãƒ‡ãƒãƒƒã‚°ãƒ»åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ</h1>
            <p>åˆæœŸåŒ–å•é¡Œã®è©³ç´°è¨ºæ–­ã¨è§£æ±º</p>
        </div>

        <div id="step1" class="step-section">
            <h3>ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿</h3>
            <div id="step1Status">å¾…æ©Ÿä¸­...</div>
        </div>

        <div id="step2" class="step-section">
            <h3>ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ãƒã‚§ãƒƒã‚¯</h3>
            <div id="step2Status">å¾…æ©Ÿä¸­...</div>
        </div>

        <div id="step3" class="step-section">
            <h3>ã‚¹ãƒ†ãƒƒãƒ—3: AudioManageråˆæœŸåŒ–</h3>
            <div id="step3Status">å¾…æ©Ÿä¸­...</div>
        </div>

        <div id="step4" class="step-section">
            <h3>ã‚¹ãƒ†ãƒƒãƒ—4: AudioDetectionComponentåˆæœŸåŒ–</h3>
            <div id="step4Status">å¾…æ©Ÿä¸­...</div>
        </div>

        <div class="step-section">
            <h3>ğŸ® æ‰‹å‹•ãƒ†ã‚¹ãƒˆ</h3>
            <button id="startManualTest" onclick="runManualTest()" disabled>æ‰‹å‹•åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <button onclick="clearLogs()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <button onclick="copyLogs()">ãƒ­ã‚°ã‚³ãƒ”ãƒ¼</button>
        </div>

        <div class="step-section">
            <h3>ğŸ“‹ è©³ç´°ãƒ­ã‚°</h3>
            <div id="logContainer" class="log-container">
                <!-- ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>

        <div id="configSection" class="step-section" style="display: none;">
            <h3>âš™ï¸ è¨­å®šå€¤ç¢ºèª</h3>
            <div id="configDisplay">
                <!-- è¨­å®šå€¤ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <script>
        let logBuffer = [];
        let currentStep = 0;
        let PitchProLib = null;
        let audioManager = null;
        let audioDetection = null;

        function addLog(level, message, details = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${level}`;

            let logText = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
            if (details) {
                logText += '\n  ' + JSON.stringify(details, null, 2);
            }

            entry.textContent = logText;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;

            logBuffer.push(logText);
            console.log(`[PitchPro Debug] ${logText}`);
        }

        function updateStepStatus(stepNum, status, className = '') {
            const stepElement = document.getElementById(`step${stepNum}`);
            const statusElement = document.getElementById(`step${stepNum}Status`);

            if (className) {
                stepElement.className = `step-section ${className}`;
            }
            statusElement.textContent = status;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            logBuffer = [];
            addLog('info', 'ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†');
        }

        function copyLogs() {
            const logText = logBuffer.join('\n');
            navigator.clipboard.writeText(logText).then(() => {
                addLog('success', 'ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(err => {
                addLog('error', 'ãƒ­ã‚°ã‚³ãƒ”ãƒ¼ã«å¤±æ•—', err.message);
            });
        }

        // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿
        function loadLibrary() {
            addLog('info', 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿é–‹å§‹');
            updateStepStatus(1, 'èª­ã¿è¾¼ã¿ä¸­...');

            const timestamp = Date.now();
            const script = document.createElement('script');

            // GitHub Pagesç”¨ã®ãƒ‘ã‚¹
            const isGitHubPages = window.location.hostname.includes('github.io');
            const basePath = isGitHubPages ? 'https://kiyopi.github.io/pitchpro-audio-processing/' : './';

            script.src = `${basePath}dist/pitchpro.umd.js?v=${timestamp}&r=${Math.random()}`;

            script.onload = function() {
                addLog('success', 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å®Œäº†', { url: script.src });
                updateStepStatus(1, 'âœ… èª­ã¿è¾¼ã¿å®Œäº†', 'success');

                // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç¢ºèª
                if (typeof window.PitchPro !== 'undefined') {
                    PitchProLib = window.PitchPro;
                    addLog('success', 'PitchPro ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç¢ºèª', Object.keys(PitchProLib));
                } else {
                    addLog('error', 'PitchPro ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    addLog('debug', 'åˆ©ç”¨å¯èƒ½ãªã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ',
                        Object.keys(window).filter(key => key.toLowerCase().includes('pitch') || key.toLowerCase().includes('audio'))
                    );
                }

                runStep2();
            };

            script.onerror = function(error) {
                addLog('error', 'ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å¤±æ•—', {
                    url: script.src,
                    error: error.message || 'Unknown error'
                });
                updateStepStatus(1, 'âŒ èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
            };

            document.head.appendChild(script);
        }

        // ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ãƒã‚§ãƒƒã‚¯
        function runStep2() {
            addLog('info', 'ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ãƒã‚§ãƒƒã‚¯é–‹å§‹');
            updateStepStatus(2, 'ãƒã‚§ãƒƒã‚¯ä¸­...');

            const compatibility = {
                userAgent: navigator.userAgent,
                audioContext: !!(window.AudioContext || window.webkitAudioContext),
                mediaDevices: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
                promises: typeof Promise !== 'undefined',
                async: typeof async !== 'undefined'
            };

            addLog('info', 'ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±', compatibility);

            if (!compatibility.audioContext) {
                addLog('error', 'AudioContext ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                updateStepStatus(2, 'âŒ AudioContextæœªå¯¾å¿œ', 'error');
                return;
            }

            if (!compatibility.mediaDevices) {
                addLog('error', 'MediaDevices API ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                updateStepStatus(2, 'âŒ MediaDevicesæœªå¯¾å¿œ', 'error');
                return;
            }

            addLog('success', 'ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ãƒã‚§ãƒƒã‚¯å®Œäº†');
            updateStepStatus(2, 'âœ… äº’æ›æ€§OK', 'success');

            runStep3();
        }

        // ã‚¹ãƒ†ãƒƒãƒ—3: AudioManageråˆæœŸåŒ–
        async function runStep3() {
            addLog('info', 'AudioManageråˆæœŸåŒ–é–‹å§‹');
            updateStepStatus(3, 'åˆæœŸåŒ–ä¸­...');

            try {
                if (!PitchProLib || !PitchProLib.AudioManager) {
                    throw new Error('AudioManager ã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                audioManager = new PitchProLib.AudioManager();
                addLog('success', 'AudioManager ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆå®Œäº†');

                // åˆæœŸåŒ–ã®å®Ÿè¡Œ
                await audioManager.initialize();
                addLog('success', 'AudioManageråˆæœŸåŒ–å®Œäº†');
                updateStepStatus(3, 'âœ… åˆæœŸåŒ–å®Œäº†', 'success');

                runStep4();

            } catch (error) {
                addLog('error', 'AudioManageråˆæœŸåŒ–å¤±æ•—', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                updateStepStatus(3, `âŒ åˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error');

                // ã‚ˆãã‚ã‚‹å•é¡Œã®è¨ºæ–­
                if (error.message.includes('Permission denied') || error.name === 'NotAllowedError') {
                    addLog('warning', 'ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™');
                    updateStepStatus(3, 'âš ï¸ ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦', 'warning');
                } else if (error.message.includes('AudioContext')) {
                    addLog('warning', 'AudioContexté–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã§ã™');
                } else if (error.message.includes('getUserMedia')) {
                    addLog('warning', 'getUserMediaé–¢é€£ã®ã‚¨ãƒ©ãƒ¼ã§ã™');
                }
            }
        }

        // ã‚¹ãƒ†ãƒƒãƒ—4: AudioDetectionComponentåˆæœŸåŒ–
        async function runStep4() {
            addLog('info', 'AudioDetectionComponentåˆæœŸåŒ–é–‹å§‹');
            updateStepStatus(4, 'åˆæœŸåŒ–ä¸­...');

            try {
                if (!PitchProLib || !PitchProLib.AudioDetectionComponent) {
                    throw new Error('AudioDetectionComponent ã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                // è¨­å®šä¸Šæ›¸ããªã—ã§åˆæœŸåŒ–
                audioDetection = new PitchProLib.AudioDetectionComponent({
                    autoUpdateUI: false,
                    debug: true
                });

                await audioDetection.initialize();
                addLog('success', 'AudioDetectionComponentåˆæœŸåŒ–å®Œäº†');
                updateStepStatus(4, 'âœ… åˆæœŸåŒ–å®Œäº†', 'success');

                // è¨­å®šå€¤ã®è¡¨ç¤º
                displayConfig();

                // æ‰‹å‹•ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                document.getElementById('startManualTest').disabled = false;

            } catch (error) {
                addLog('error', 'AudioDetectionComponentåˆæœŸåŒ–å¤±æ•—', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                updateStepStatus(4, `âŒ åˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error');
            }
        }

        function displayConfig() {
            if (!audioDetection) return;

            const config = audioDetection.config;
            const deviceSpecs = audioDetection.deviceSpecs;

            const configHtml = `
                <div class="value-display">
                    <strong>minVolumeAbsolute:</strong> <span class="highlight">${config.minVolumeAbsolute}</span><br>
                    <strong>ãƒã‚¤ã‚ºã‚²ãƒ¼ãƒˆé–¾å€¤:</strong> <span class="highlight">${(config.minVolumeAbsolute * 500).toFixed(1)}%</span><br>
                    <strong>ãƒ‡ãƒã‚¤ã‚¹:</strong> <span class="highlight">${deviceSpecs.deviceType}</span><br>
                    <strong>æ„Ÿåº¦:</strong> <span class="highlight">${deviceSpecs.sensitivity}x</span><br>
                    <strong>clarityThreshold:</strong> <span class="highlight">${config.clarityThreshold}</span>
                </div>
            `;

            document.getElementById('configDisplay').innerHTML = configHtml;
            document.getElementById('configSection').style.display = 'block';

            addLog('info', 'è¨­å®šå€¤ç¢ºèªå®Œäº†', {
                minVolumeAbsolute: config.minVolumeAbsolute,
                thresholdPercent: config.minVolumeAbsolute * 500,
                deviceType: deviceSpecs.deviceType,
                sensitivity: deviceSpecs.sensitivity
            });
        }

        async function runManualTest() {
            addLog('info', 'æ‰‹å‹•ãƒ†ã‚¹ãƒˆé–‹å§‹');

            try {
                if (!audioDetection) {
                    throw new Error('AudioDetectionComponent ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                const started = audioDetection.startDetection();
                if (started) {
                    addLog('success', 'ãƒ”ãƒƒãƒæ¤œå‡ºé–‹å§‹');

                    // 3ç§’å¾Œã«åœæ­¢
                    setTimeout(() => {
                        audioDetection.stopDetection();
                        addLog('info', 'ãƒ”ãƒƒãƒæ¤œå‡ºåœæ­¢');
                    }, 3000);
                } else {
                    addLog('error', 'ãƒ”ãƒƒãƒæ¤œå‡ºé–‹å§‹ã«å¤±æ•—');
                }

            } catch (error) {
                addLog('error', 'æ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼', {
                    message: error.message,
                    stack: error.stack
                });
            }
        }

        // åˆæœŸåŒ–é–‹å§‹
        addLog('info', 'ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹');
        loadLibrary();
    </script>
</body>
</html>