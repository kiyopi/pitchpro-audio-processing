<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchPro ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            font-size: 18px;
            padding: 10px 20px;
            margin: 10px;
        }
        #output {
            margin-top: 20px;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 8px;
            min-height: 200px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-left: 3px solid #4CAF50;
        }
    </style>
</head>
<body>
    <h1>PitchPro ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆ</h1>
    
    <button id="test-library">1. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèª</button>
    <button id="test-audio">2. AudioManagerä½œæˆ</button>
    <button id="test-pitch">3. PitchDetectorä½œæˆ</button>
    <button id="start-detection">4. æ¤œå‡ºé–‹å§‹</button>
    <button id="stop-detection">5. æ¤œå‡ºåœæ­¢</button>
    
    <div id="output">
        <h3>ãƒ­ã‚°:</h3>
    </div>

    <!-- PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="./js/pitchpro-audio/index.umd.js"></script>
    
    <script>
        const output = document.getElementById('output');
        let audioManager = null;
        let pitchDetector = null;
        
        function log(message, data = null) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            if (data) {
                entry.innerHTML += `<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            output.appendChild(entry);
            console.log(message, data);
        }
        
        // 1. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèª
        document.getElementById('test-library').addEventListener('click', () => {
            log('PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèª...');
            
            if (typeof PitchPro === 'undefined') {
                log('âŒ PitchProãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            log('âœ… PitchProèª­ã¿è¾¼ã¿æˆåŠŸ');
            log('åˆ©ç”¨å¯èƒ½ãªã‚¯ãƒ©ã‚¹:', {
                AudioManager: !!PitchPro.AudioManager,
                PitchDetector: !!PitchPro.PitchDetector,
                DeviceDetection: !!PitchPro.DeviceDetection,
                MicrophoneController: !!PitchPro.MicrophoneController
            });
        });
        
        // 2. AudioManagerä½œæˆ
        document.getElementById('test-audio').addEventListener('click', async () => {
            try {
                log('AudioManagerä½œæˆä¸­...');
                audioManager = new PitchPro.AudioManager();
                log('âœ… AudioManagerä½œæˆæˆåŠŸ', audioManager);
                
                // åˆæœŸåŒ–
                log('AudioManageråˆæœŸåŒ–ä¸­...');
                const resources = await audioManager.initialize();
                log('âœ… åˆæœŸåŒ–æˆåŠŸ', {
                    audioContext: resources.audioContext.state,
                    mediaStream: resources.mediaStream.active
                });
                
            } catch (error) {
                log('âŒ AudioManagerã‚¨ãƒ©ãƒ¼:', error.message);
            }
        });
        
        // 3. PitchDetectorä½œæˆ
        document.getElementById('test-pitch').addEventListener('click', async () => {
            try {
                if (!audioManager) {
                    log('âŒ AudioManagerã‚’å…ˆã«ä½œæˆã—ã¦ãã ã•ã„');
                    return;
                }
                
                log('PitchDetectorä½œæˆä¸­...');
                pitchDetector = new PitchPro.PitchDetector(audioManager, {
                    fftSize: 4096,
                    smoothing: 0.1,
                    clarityThreshold: 0.6
                });
                
                // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
                pitchDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        log('ğŸµ ãƒ”ãƒƒãƒæ¤œå‡º:', {
                            frequency: result.frequency?.toFixed(1) + ' Hz',
                            note: result.note,
                            octave: result.octave,
                            volume: (result.volume * 100).toFixed(1) + '%'
                        });
                    },
                    onError: (error) => {
                        log('âŒ ã‚¨ãƒ©ãƒ¼:', error.message);
                    }
                });
                
                log('âœ… PitchDetectorä½œæˆæˆåŠŸ');
                
                // åˆæœŸåŒ–
                log('PitchDetectoråˆæœŸåŒ–ä¸­...');
                await pitchDetector.initialize();
                log('âœ… åˆæœŸåŒ–æˆåŠŸ');
                
            } catch (error) {
                log('âŒ PitchDetectorã‚¨ãƒ©ãƒ¼:', error.message);
            }
        });
        
        // 4. æ¤œå‡ºé–‹å§‹
        document.getElementById('start-detection').addEventListener('click', () => {
            if (!pitchDetector) {
                log('âŒ PitchDetectorã‚’å…ˆã«ä½œæˆã—ã¦ãã ã•ã„');
                return;
            }
            
            log('æ¤œå‡ºé–‹å§‹...');
            const started = pitchDetector.startDetection();
            if (started) {
                log('âœ… æ¤œå‡ºé–‹å§‹æˆåŠŸ');
            } else {
                log('âŒ æ¤œå‡ºé–‹å§‹å¤±æ•—');
            }
        });
        
        // 5. æ¤œå‡ºåœæ­¢
        document.getElementById('stop-detection').addEventListener('click', () => {
            if (!pitchDetector) {
                log('âŒ PitchDetectorãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            pitchDetector.stopDetection();
            log('â¹ æ¤œå‡ºåœæ­¢');
        });
        
        // åˆæœŸãƒã‚§ãƒƒã‚¯
        window.addEventListener('load', () => {
            log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            if (typeof PitchPro !== 'undefined') {
                log('âœ… PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ¤œå‡º');
            } else {
                log('âŒ PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        });
    </script>
</body>
</html>