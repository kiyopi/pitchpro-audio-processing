<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchPro シンプルテスト</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            font-size: 18px;
            padding: 10px 20px;
            margin: 10px;
        }
        #output {
            margin-top: 20px;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 8px;
            min-height: 200px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-left: 3px solid #4CAF50;
        }
    </style>
</head>
<body>
    <h1>PitchPro シンプルテスト</h1>
    
    <button id="test-library">1. ライブラリ確認</button>
    <button id="test-audio">2. AudioManager作成</button>
    <button id="test-pitch">3. PitchDetector作成</button>
    <button id="start-detection">4. 検出開始</button>
    <button id="stop-detection">5. 検出停止</button>
    
    <div id="output">
        <h3>ログ:</h3>
    </div>

    <!-- PitchProライブラリ -->
    <script src="./js/pitchpro-audio/index.umd.js"></script>
    
    <script>
        const output = document.getElementById('output');
        let audioManager = null;
        let pitchDetector = null;
        
        function log(message, data = null) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            if (data) {
                entry.innerHTML += `<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            output.appendChild(entry);
            console.log(message, data);
        }
        
        // 1. ライブラリ確認
        document.getElementById('test-library').addEventListener('click', () => {
            log('PitchProライブラリ確認...');
            
            if (typeof PitchPro === 'undefined') {
                log('❌ PitchProが読み込まれていません');
                return;
            }
            
            log('✅ PitchPro読み込み成功');
            log('利用可能なクラス:', {
                AudioManager: !!PitchPro.AudioManager,
                PitchDetector: !!PitchPro.PitchDetector,
                DeviceDetection: !!PitchPro.DeviceDetection,
                MicrophoneController: !!PitchPro.MicrophoneController
            });
        });
        
        // 2. AudioManager作成
        document.getElementById('test-audio').addEventListener('click', async () => {
            try {
                log('AudioManager作成中...');
                audioManager = new PitchPro.AudioManager();
                log('✅ AudioManager作成成功', audioManager);
                
                // 初期化
                log('AudioManager初期化中...');
                const resources = await audioManager.initialize();
                log('✅ 初期化成功', {
                    audioContext: resources.audioContext.state,
                    mediaStream: resources.mediaStream.active
                });
                
            } catch (error) {
                log('❌ AudioManagerエラー:', error.message);
            }
        });
        
        // 3. PitchDetector作成
        document.getElementById('test-pitch').addEventListener('click', async () => {
            try {
                if (!audioManager) {
                    log('❌ AudioManagerを先に作成してください');
                    return;
                }
                
                log('PitchDetector作成中...');
                pitchDetector = new PitchPro.PitchDetector(audioManager, {
                    fftSize: 4096,
                    smoothing: 0.1,
                    clarityThreshold: 0.6
                });
                
                // コールバック設定
                pitchDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        log('🎵 ピッチ検出:', {
                            frequency: result.frequency?.toFixed(1) + ' Hz',
                            note: result.note,
                            octave: result.octave,
                            volume: (result.volume * 100).toFixed(1) + '%'
                        });
                    },
                    onError: (error) => {
                        log('❌ エラー:', error.message);
                    }
                });
                
                log('✅ PitchDetector作成成功');
                
                // 初期化
                log('PitchDetector初期化中...');
                await pitchDetector.initialize();
                log('✅ 初期化成功');
                
            } catch (error) {
                log('❌ PitchDetectorエラー:', error.message);
            }
        });
        
        // 4. 検出開始
        document.getElementById('start-detection').addEventListener('click', () => {
            if (!pitchDetector) {
                log('❌ PitchDetectorを先に作成してください');
                return;
            }
            
            log('検出開始...');
            const started = pitchDetector.startDetection();
            if (started) {
                log('✅ 検出開始成功');
            } else {
                log('❌ 検出開始失敗');
            }
        });
        
        // 5. 検出停止
        document.getElementById('stop-detection').addEventListener('click', () => {
            if (!pitchDetector) {
                log('❌ PitchDetectorがありません');
                return;
            }
            
            pitchDetector.stopDetection();
            log('⏹ 検出停止');
        });
        
        // 初期チェック
        window.addEventListener('load', () => {
            log('ページ読み込み完了');
            if (typeof PitchPro !== 'undefined') {
                log('✅ PitchProライブラリ検出');
            } else {
                log('❌ PitchProライブラリが見つかりません');
            }
        });
    </script>
</body>
</html>