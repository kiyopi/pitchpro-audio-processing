<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ PitchPro v1.2.9-FINAL è¨­å®šæ¤œè¨¼ãƒ†ã‚¹ãƒˆ</title>

    <!-- å®Œå…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿è¨­å®š -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #4CAF50;
            border-radius: 8px;
        }

        .test-section {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }

        .config-display {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 2px solid #FFD700;
        }

        .value-highlight {
            background: #FFD700;
            color: #000;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 14px;
        }

        .success { color: #4CAF50; }
        .error { color: #F44336; }
        .warning { color: #FF9800; }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        button:hover {
            background: #45a049;
        }

        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            margin: 3px 0;
            padding: 3px 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ PitchPro v1.2.9-FINAL è¨­å®šæ¤œè¨¼ãƒ†ã‚¹ãƒˆ</h1>
            <p>å®Œå…¨æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ« - ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œå›é¿å°‚ç”¨</p>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ æœŸå¾…ã™ã‚‹è¨­å®šå€¤</h2>
            <div class="config-display">
                <div><strong>minVolumeAbsolute:</strong> <span class="value-highlight">0.020</span> (10%é–¾å€¤)</div>
                <div><strong>ãƒã‚¤ã‚ºã‚²ãƒ¼ãƒˆé–¾å€¤:</strong> <span class="value-highlight">10.0%</span> (0.020 Ã— 500)</div>
                <div><strong>ç›®æ¨™:</strong> ç’°å¢ƒãƒã‚¤ã‚º(3.8%-6.2%)ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã€æœ‰åŠ¹éŸ³å£°(10%è¶…)ã‚’é€šé</div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š å®Ÿéš›ã®è¨­å®šå€¤ç¢ºèª</h2>
            <div id="actualConfig" class="config-display">
                <div id="configStatus">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰...</div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
            <button id="startBtn" onclick="runConfigTest()">è¨­å®šå€¤æ¤œè¨¼ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
            <button id="stopBtn" onclick="stopTest()" disabled>ãƒ†ã‚¹ãƒˆåœæ­¢</button>
            <button onclick="clearLogs()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <button onclick="exportLogs()">ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>

        <div class="test-section">
            <h2>ğŸ“‹ ãƒ†ã‚¹ãƒˆãƒ­ã‚°</h2>
            <div id="testLogs" style="max-height: 400px; overflow-y: auto;">
                <!-- ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <script>
        // å®Œå…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿
        const timestamp = Date.now();
        const randomId = Math.random().toString(36).substring(2);
        const script = document.createElement('script');

        // è¤‡æ•°ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒˆæ‰‹æ³•ã‚’çµ„ã¿åˆã‚ã›
        script.src = `dist/pitchpro.umd.js?v=final-${timestamp}&r=${randomId}&_cb=${Date.now()}&nocache=true`;
        script.onload = function() {
            addLog('success', 'âœ… PitchPro ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å®Œäº†');
            addLog('info', `ğŸ“ URL: ${script.src}`);

            // UMDãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ§‹é€ ç¢ºèª
            addLog('info', 'ğŸ” ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ§‹é€ ç¢ºèªä¸­...');

            // PitchProã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç¢ºèª
            if (typeof window.PitchPro !== 'undefined') {
                addLog('success', 'âœ… PitchPro ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç™ºè¦‹');
                console.log('PitchPro contents:', Object.keys(window.PitchPro));

                if (window.PitchPro.PitchDetector) {
                    addLog('success', 'âœ… PitchPro.PitchDetector ç¢ºèªå®Œäº†');
                    window.PitchDetector = window.PitchPro; // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
                } else {
                    addLog('error', 'âŒ PitchPro.PitchDetector ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } else if (typeof window.PitchDetector !== 'undefined') {
                addLog('success', 'âœ… PitchDetector ã‚¯ãƒ©ã‚¹ç¢ºèªå®Œäº†');
            } else {
                addLog('error', 'âŒ PitchDetector/PitchPro ã©ã¡ã‚‰ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                addLog('info', 'ğŸ” åˆ©ç”¨å¯èƒ½ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ:');
                const pitchRelated = Object.keys(window).filter(key =>
                    key.toLowerCase().includes('pitch') || key.toLowerCase().includes('audio')
                );
                console.log('Pitch/Audio related objects:', pitchRelated);
                pitchRelated.forEach(key => addLog('info', `  - ${key}`));
            }
        };
        script.onerror = function(error) {
            addLog('error', `âŒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å¤±æ•—: ${error}`);
            addLog('info', `ğŸ” è©¦è¡ŒURL: ${script.src}`);
        };
        document.head.appendChild(script);

        let audioManager = null;
        let pitchDetector = null;
        let testTimeout = null;
        let isTestRunning = false;
        let logBuffer = [];

        function addLog(type, message) {
            const logContainer = document.getElementById('testLogs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            const logText = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEntry.innerHTML = logText;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // ãƒ­ã‚°ãƒãƒƒãƒ•ã‚¡ã«è¿½åŠ ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ï¼‰
            logBuffer.push(logText);
        }

        function clearLogs() {
            document.getElementById('testLogs').innerHTML = '';
            logBuffer = [];
            addLog('info', 'ğŸ“„ ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†');
        }

        function exportLogs() {
            const logText = logBuffer.join('\n');
            navigator.clipboard.writeText(logText).then(() => {
                addLog('success', 'âœ… ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(err => {
                addLog('error', 'âŒ ãƒ­ã‚°ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                console.error('Copy error:', err);
            });
        }

        function stopTest() {
            isTestRunning = false;

            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
            if (testTimeout) {
                clearTimeout(testTimeout);
                testTimeout = null;
            }

            // ãƒ”ãƒƒãƒæ¤œå‡ºã‚’åœæ­¢
            if (pitchDetector) {
                pitchDetector.stopDetection();
                addLog('info', 'â¹ï¸ ãƒ”ãƒƒãƒæ¤œå‡ºåœæ­¢');
            }

            // ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            if (audioManager) {
                audioManager.forceCleanup();
                audioManager = null;
                addLog('info', 'ğŸ§¹ AudioManagerã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
            }

            pitchDetector = null;

            // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;

            addLog('info', 'ğŸ›‘ ãƒ†ã‚¹ãƒˆåœæ­¢å®Œäº†');
        }

        async function runConfigTest() {
            try {
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                isTestRunning = true;

                addLog('info', 'ğŸš€ è¨­å®šå€¤æ¤œè¨¼ãƒ†ã‚¹ãƒˆé–‹å§‹');

                // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å–å¾—
                let PitchProLib = null;
                if (typeof window.PitchPro !== 'undefined') {
                    PitchProLib = window.PitchPro;
                    addLog('success', 'âœ… PitchPro ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨');
                } else if (typeof window.PitchDetector !== 'undefined') {
                    PitchProLib = window.PitchDetector;
                    addLog('success', 'âœ… PitchDetector ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨');
                } else {
                    addLog('error', 'âŒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæœªå®šç¾© - èª­ã¿è¾¼ã¿ç¢ºèªãŒå¿…è¦');
                    return;
                }

                // AudioManageråˆæœŸåŒ–
                if (!PitchProLib.AudioManager) {
                    addLog('error', 'âŒ AudioManager ã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    console.log('Available classes:', Object.keys(PitchProLib));
                    return;
                }

                audioManager = new PitchProLib.AudioManager();
                await audioManager.initialize();
                addLog('success', 'âœ… AudioManageråˆæœŸåŒ–å®Œäº†');

                // PitchDetectoråˆæœŸåŒ–ï¼ˆè¨­å®šä¸Šæ›¸ããªã—ï¼‰
                if (!PitchProLib.PitchDetector) {
                    addLog('error', 'âŒ PitchDetector ã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                pitchDetector = new PitchProLib.PitchDetector(audioManager);
                addLog('info', 'ğŸ”§ PitchDetectoråˆæœŸåŒ–ä¸­...');

                await pitchDetector.initialize();
                addLog('success', 'âœ… PitchDetectoråˆæœŸåŒ–å®Œäº†');

                // è¨­å®šå€¤ã®è©³ç´°ç¢ºèª
                const config = pitchDetector.config;
                addLog('info', 'ğŸ“Š è¨­å®šå€¤è©³ç´°ç¢ºèª:');

                // minVolumeAbsoluteç¢ºèª
                const actualMinVolume = config.minVolumeAbsolute;
                addLog('info', `  minVolumeAbsolute: ${actualMinVolume}`);

                if (actualMinVolume === 0.020) {
                    addLog('success', 'âœ… minVolumeAbsolute = 0.020 (æœŸå¾…å€¤ã¨ä¸€è‡´)');
                } else {
                    addLog('error', `âŒ minVolumeAbsolute = ${actualMinVolume} (æœŸå¾…å€¤: 0.020)`);
                }

                // ãƒã‚¤ã‚ºã‚²ãƒ¼ãƒˆé–¾å€¤è¨ˆç®—
                const NOISE_GATE_SCALING_FACTOR = 500;
                const calculatedThreshold = actualMinVolume * NOISE_GATE_SCALING_FACTOR;
                addLog('info', `  è¨ˆç®—ã•ã‚ŒãŸãƒã‚¤ã‚ºã‚²ãƒ¼ãƒˆé–¾å€¤: ${calculatedThreshold.toFixed(2)}%`);

                if (Math.abs(calculatedThreshold - 10.0) < 0.1) {
                    addLog('success', 'âœ… ãƒã‚¤ã‚ºã‚²ãƒ¼ãƒˆé–¾å€¤ = 10.0% (æœŸå¾…å€¤ã¨ä¸€è‡´)');
                } else {
                    addLog('error', `âŒ ãƒã‚¤ã‚ºã‚²ãƒ¼ãƒˆé–¾å€¤ = ${calculatedThreshold.toFixed(2)}% (æœŸå¾…å€¤: 10.0%)`);
                }

                // è¨­å®šè¡¨ç¤ºã‚’æ›´æ–°
                document.getElementById('configStatus').innerHTML = `
                    <div><strong>å®Ÿéš›ã®minVolumeAbsolute:</strong> <span class="value-highlight">${actualMinVolume}</span></div>
                    <div><strong>å®Ÿéš›ã®ãƒã‚¤ã‚ºã‚²ãƒ¼ãƒˆé–¾å€¤:</strong> <span class="value-highlight">${calculatedThreshold.toFixed(2)}%</span></div>
                    <div><strong>åˆ¤å®š:</strong> <span class="${actualMinVolume === 0.020 ? 'success' : 'error'}">${actualMinVolume === 0.020 ? 'âœ… æ­£å¸¸' : 'âŒ ç•°å¸¸'}</span></div>
                `;

                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ†ã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                addLog('info', 'ğŸ¤ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‹•ä½œãƒ†ã‚¹ãƒˆé–‹å§‹ï¼ˆ5ç§’é–“ï¼‰');

                let updateCount = 0;
                pitchDetector.setCallbacks({
                    onPitchUpdate: function(result) {
                        if (!isTestRunning) return;

                        const volume = result.volume || 0;
                        if (volume > 0) {
                            updateCount++;
                            if (updateCount <= 5) { // æœ€åˆã®5å›ã®ã¿ãƒ­ã‚°è¡¨ç¤º
                                addLog('success', `ğŸ”Š æœ‰åŠ¹ä¿¡å·: ${volume.toFixed(1)}%`);
                            }
                        }
                    }
                });

                const started = pitchDetector.startDetection();
                if (started) {
                    addLog('success', 'âœ… ãƒ”ãƒƒãƒæ¤œå‡ºé–‹å§‹');

                    // 5ç§’å¾Œã«è‡ªå‹•åœæ­¢
                    testTimeout = setTimeout(() => {
                        if (isTestRunning) {
                            stopTest();
                            addLog('info', 'âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ†ã‚¹ãƒˆå®Œäº†ï¼ˆ5ç§’çµŒéï¼‰');
                        }
                    }, 5000);
                } else {
                    addLog('error', 'âŒ ãƒ”ãƒƒãƒæ¤œå‡ºé–‹å§‹å¤±æ•—');
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                }

            } catch (error) {
                addLog('error', `âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                console.error('Test error:', error);

                // ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                stopTest();
            }
        }
    </script>
</body>
</html>